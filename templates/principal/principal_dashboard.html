{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">{{ page_title }}</h1>
            <p class="text-muted">{% trans "Principal oversight and academic leadership dashboard" %}</p>
        </div>
        <div class="d-flex gap-2">
            {% if current_session %}
                <span class="badge bg-primary fs-6">{{ current_session.name }}</span>
            {% endif %}
            <small class="text-muted">{{ request.user.get_full_name }}</small>
        </div>
    </div>

    <!-- Principal Quick Stats Cards -->
    <div class="row mb-4">
        <!-- Average Class Performance -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                {% trans "Avg Class Performance" %}
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ principal_stats.avg_class_performance }}%</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-chart-line fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Students at Risk -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-danger shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                                {% trans "Students at Risk" %}
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ principal_stats.students_at_risk }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Monthly Behavior Incidents -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                {% trans "Monthly Incidents" %}
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ principal_stats.monthly_behavior_incidents }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-flag fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Active Academic Warnings -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                {% trans "Active Warnings" %}
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ principal_stats.active_academic_warnings }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-bell fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Principal Navigation Cards -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">{% trans "Principal Oversight Areas" %}</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Academic Performance Monitoring -->
                        <div class="col-lg-3 col-md-6 mb-4">
                            <div class="card bg-gradient-primary text-white shadow h-100">
                                <div class="card-body">
                                    <div class="text-center">
                                        <i class="fas fa-chart-bar fa-3x mb-3"></i>
                                        <h5>{% trans "Performance Monitoring" %}</h5>
                                        <p class="mb-0">{% trans "Track academic performance and trends" %}</p>
                                        <a href="{% url 'core:principal_performance_monitoring' %}" class="btn btn-light btn-sm mt-3">
                                            {% trans "View Details" %}
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Teacher Management -->
                        <div class="col-lg-3 col-md-6 mb-4">
                            <div class="card bg-gradient-success text-white shadow h-100">
                                <div class="card-body">
                                    <div class="text-center">
                                        <i class="fas fa-chalkboard-teacher fa-3x mb-3"></i>
                                        <h5>{% trans "Teacher Management" %}</h5>
                                        <p class="mb-0">{% trans "Oversee teacher assignments and performance" %}</p>
                                        <a href="{% url 'core:principal_teacher_management' %}" class="btn btn-light btn-sm mt-3">
                                            {% trans "View Details" %}
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Student Welfare -->
                        <div class="col-lg-3 col-md-6 mb-4">
                            <div class="card bg-gradient-info text-white shadow h-100">
                                <div class="card-body">
                                    <div class="text-center">
                                        <i class="fas fa-heart fa-3x mb-3"></i>
                                        <h5>{% trans "Student Welfare" %}</h5>
                                        <p class="mb-0">{% trans "Monitor behavior and academic warnings" %}</p>
                                        <a href="{% url 'core:principal_student_welfare' %}" class="btn btn-light btn-sm mt-3">
                                            {% trans "View Details" %}
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Curriculum Planning -->
                        <div class="col-lg-3 col-md-6 mb-4">
                            <div class="card bg-gradient-warning text-white shadow h-100">
                                <div class="card-body">
                                    <div class="text-center">
                                        <i class="fas fa-book fa-3x mb-3"></i>
                                        <h5>{% trans "Curriculum Planning" %}</h5>
                                        <p class="mb-0">{% trans "Academic planning and oversight" %}</p>
                                        <a href="{% url 'core:principal_curriculum_planning' %}" class="btn btn-light btn-sm mt-3">
                                            {% trans "View Details" %}
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Standard School Stats (inherited from admin dashboard) -->
    <div class="row mb-4">
        <!-- Students -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                {% trans "Total Students" %}
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ quick_stats.total_students }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-users fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Teachers -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                {% trans "Total Teachers" %}
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ quick_stats.total_teachers }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-chalkboard-teacher fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Classes -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                {% trans "Total Classes" %}
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ quick_stats.total_classes }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-school fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Attendance Rate -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                {% trans "Avg Attendance" %}
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ quick_stats.attendance_rate }}%</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-calendar-check fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activities and Alerts -->
    <div class="row">
        <!-- Pending Applications -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">{% trans "Pending Applications" %}</h6>
                    <a href="{% url 'users:pending_applications' %}" class="btn btn-sm btn-outline-primary">
                        {% trans "View All" %}
                    </a>
                </div>
                <div class="card-body">
                    {% if pending_student_applications or pending_staff_applications %}
                        <div class="list-group list-group-flush">
                            {% for app in pending_student_applications %}
                            <div class="list-group-item px-0">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>{{ app.first_name }} {{ app.last_name }}</strong>
                                        <br><small class="text-muted">{% trans "Student Application" %} • {{ app.application_date|date:"M d, Y" }}</small>
                                    </div>
                                    <span class="badge bg-warning">{% trans "Pending" %}</span>
                                </div>
                            </div>
                            {% endfor %}

                            {% for app in pending_staff_applications %}
                            <div class="list-group-item px-0">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>{{ app.first_name }} {{ app.last_name }}</strong>
                                        <br><small class="text-muted">{% trans "Staff Application" %} • {{ app.application_date|date:"M d, Y" }}</small>
                                    </div>
                                    <span class="badge bg-info">{% trans "Pending" %}</span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                            <h5>{% trans "All Caught Up!" %}</h5>
                            <p class="text-muted">{% trans "No pending applications to review." %}</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Recent Announcements -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">{% trans "Recent Announcements" %}</h6>
                    <a href="{% url 'communication:announcement_list' %}" class="btn btn-sm btn-outline-primary">
                        {% trans "View All" %}
                    </a>
                </div>
                <div class="card-body">
                    {% if recent_announcements %}
                        <div class="list-group list-group-flush">
                            {% for announcement in recent_announcements %}
                            <div class="list-group-item px-0">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <strong>{{ announcement.title }}</strong>
                                        <br><small class="text-muted">{{ announcement.get_announcement_type_display }} • {{ announcement.published_at|date:"M d, Y" }}</small>
                                    </div>
                                    {% if announcement.priority == 'urgent' %}
                                        <span class="badge bg-danger ms-2">{% trans "Urgent" %}</span>
                                    {% elif announcement.priority == 'high' %}
                                        <span class="badge bg-warning ms-2">{% trans "High" %}</span>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-bullhorn fa-3x text-muted mb-3"></i>
                            <h5>{% trans "No Recent Announcements" %}</h5>
                            <p class="text-muted">{% trans "Create announcements to communicate with stakeholders." %}</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Communication Quick Actions -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">{% trans "Quick Communication Actions" %}</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <a href="{% url 'core:principal_communication' %}" class="btn btn-outline-primary btn-block">
                                <i class="fas fa-envelope"></i> {% trans "Send Principal Message" %}
                            </a>
                        </div>
                        <div class="col-md-4 mb-3">
                            <a href="{% url 'communication:announcement_create' %}" class="btn btn-outline-success btn-block">
                                <i class="fas fa-bullhorn"></i> {% trans "Create Announcement" %}
                            </a>
                        </div>
                        <div class="col-md-4 mb-3">
                            <a href="{% url 'communication:message_create' %}" class="btn btn-outline-info btn-block">
                                <i class="fas fa-comments"></i> {% trans "Bulk Messaging" %}
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<style>
/* Principal Dashboard Styles */
.card {
    border: none;
    border-radius: 0.5rem;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    transition: box-shadow 0.15s ease-in-out;
}

.card:hover {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
}

.border-left-primary {
    border-left: 0.25rem solid #4e73df !important;
}

.border-left-success {
    border-left: 0.25rem solid #1cc88a !important;
}

.border-left-info {
    border-left: 0.25rem solid #36b9cc !important;
}

.border-left-warning {
    border-left: 0.25rem solid #f6c23e !important;
}

.border-left-danger {
    border-left: 0.25rem solid #e74a3b !important;
}

.text-primary {
    color: #5a5c69 !important;
}

.text-success {
    color: #1cc88a !important;
}

.text-danger {
    color: #e74a3b !important;
}

.text-warning {
    color: #f6c23e !important;
}

.text-info {
    color: #36b9cc !important;
}

.btn-outline-primary {
    color: #4e73df;
    border-color: #4e73df;
}

.btn-outline-primary:hover {
    color: #fff;
    background-color: #4e73df;
    border-color: #4e73df;
}

.btn-outline-success {
    color: #1cc88a;
    border-color: #1cc88a;
}

.btn-outline-success:hover {
    color: #fff;
    background-color: #1cc88a;
    border-color: #1cc88a;
}

.btn-outline-info {
    color: #36b9cc;
    border-color: #36b9cc;
}

.btn-outline-info:hover {
    color: #fff;
    background-color: #36b9cc;
    border-color: #36b9cc;
}

/* Gradient backgrounds for principal cards */
.bg-gradient-primary {
    background: linear-gradient(45deg, #4e73df, #224abe);
}

.bg-gradient-success {
    background: linear-gradient(45deg, #1cc88a, #13855c);
}

.bg-gradient-info {
    background: linear-gradient(45deg, #36b9cc, #2c85a0);
}

.bg-gradient-warning {
    background: linear-gradient(45deg, #f6c23e, #dda20a);
}

/* Card animations */
.card-body {
    transition: transform 0.2s ease-in-out;
}

.card:hover .card-body {
    transform: translateY(-2px);
}

/* Badge styles */
.badge {
    font-size: 0.7em;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .container-fluid {
        padding-left: 15px;
        padding-right: 15px;
    }

    .card-body .row {
        margin-left: -5px;
        margin-right: -5px;
    }

    .card-body .row > div {
        padding-left: 5px;
        padding-right: 5px;
    }
}

/* Loading states */
.card-loading {
    position: relative;
    pointer-events: none;
}

.card-loading::after {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
}

.card-loading::before {
    content: "";
    position: absolute;
    top: 50%;
    left: 50%;
    width: 20px;
    height: 20px;
    margin: -10px 0 0 -10px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    z-index: 11;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

<script>
// Principal Dashboard JavaScript
document.addEventListener('DOMContentLoaded', function() {
    console.log('Principal Dashboard loaded');

    // Initialize dashboard
    initializePrincipalDashboard();

    // Auto-refresh functionality
    let autoRefreshInterval = setInterval(function() {
        refreshPrincipalMetrics();
    }, 300000); // Refresh every 5 minutes

    // Quick action buttons
    initializeQuickActions();

    // Navigation cards hover effects
    initializeNavigationCards();

    // Communication actions
    initializeCommunicationActions();

    function initializePrincipalDashboard() {
        // Add loading states
        addLoadingStates();

        // Initialize tooltips
        initializeTooltips();

        // Setup responsive design
        setupResponsiveDesign();

        // Initialize metric cards
        initializeMetricCards();
    }

    function addLoadingStates() {
        // Add loading indicators to cards that might be updated
        const metricCards = document.querySelectorAll('.card');
        metricCards.forEach(card => {
            card.addEventListener('click', function(e) {
                if (this.querySelector('a') && !this.classList.contains('bg-gradient-primary')) {
                    showLoadingState(this);
                }
            });
        });
    }

    function showLoadingState(element) {
        element.classList.add('card-loading');
        setTimeout(() => {
            element.classList.remove('card-loading');
        }, 2000);
    }

    function initializeTooltips() {
        // Add tooltips to metric cards
        const tooltipElements = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        tooltipElements.forEach(element => {
            new bootstrap.Tooltip(element);
        });

        // Add dynamic tooltips
        const metricCards = document.querySelectorAll('.card');
        metricCards.forEach(card => {
            const header = card.querySelector('.card-header h6, .card-body h5');
            if (header && !card.classList.contains('bg-gradient-primary')) {
                header.setAttribute('data-bs-toggle', 'tooltip');
                header.setAttribute('title', 'Click to view detailed information');
                new bootstrap.Tooltip(header);
            }
        });
    }

    function setupResponsiveDesign() {
        // Handle mobile responsiveness
        const handleResize = () => {
            const width = window.innerWidth;
            const cards = document.querySelectorAll('.col-xl-3, .col-md-6');

            if (width < 768) {
                // Mobile: stack cards vertically
                cards.forEach(card => {
                    card.classList.remove('col-xl-3', 'col-md-6');
                    card.classList.add('col-12', 'mb-3');
                });
            } else {
                // Desktop: restore grid layout
                cards.forEach(card => {
                    card.classList.remove('col-12');
                    card.classList.add('col-xl-3', 'col-md-6');
                });
            }
        };

        window.addEventListener('resize', handleResize);
        handleResize(); // Initial call
    }

    function initializeMetricCards() {
        // Add click handlers for metric cards
        const metricCards = document.querySelectorAll('.card.border-left-primary, .card.border-left-success, .card.border-left-info, .card.border-left-warning, .card.border-left-danger');

        metricCards.forEach(card => {
            card.style.cursor = 'pointer';
            card.addEventListener('click', function() {
                // Navigate to appropriate section based on card type
                const headerText = this.querySelector('.text-uppercase').textContent.trim();

                if (headerText.includes('Performance')) {
                    window.location.href = '/core/principal/performance-monitoring/';
                } else if (headerText.includes('Students at Risk') || headerText.includes('Incidents') || headerText.includes('Warnings')) {
                    window.location.href = '/core/principal/student-welfare/';
                }
            });
        });
    }

    function initializeQuickActions() {
        const quickActionButtons = document.querySelectorAll('.btn-outline-primary, .btn-outline-success, .btn-outline-info');

        quickActionButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                // Add click tracking
                trackQuickAction(this.textContent.trim());

                // Add visual feedback
                this.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    this.style.transform = 'scale(1)';
                }, 150);
            });
        });
    }

    function initializeNavigationCards() {
        const navigationCards = document.querySelectorAll('.bg-gradient-primary, .bg-gradient-success, .bg-gradient-info, .bg-gradient-warning');

        navigationCards.forEach(card => {
            card.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-5px)';
                this.style.boxShadow = '0 1rem 3rem rgba(0, 0, 0, 0.175)';
            });

            card.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0)';
                this.style.boxShadow = '';
            });
        });
    }

    function initializeCommunicationActions() {
        // Add confirmation for communication actions
        const communicationButtons = document.querySelectorAll('a[href*="communication"], a[href*="message"]');

        communicationButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                // Could add confirmation dialog here if needed
                console.log('Communication action clicked:', this.href);
            });
        });
    }

    async function refreshPrincipalMetrics() {
        try {
            // Fetch updated metrics from API
            const response = await fetch('/core/api/principal/metrics/', {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCSRFToken()
                }
            });

            if (response.ok) {
                const data = await response.json();
                updatePrincipalMetrics(data);
            }
        } catch (error) {
            console.warn('Failed to refresh principal metrics:', error);
        }
    }

    function updatePrincipalMetrics(data) {
        // Update principal-specific metrics
        if (data.avg_class_performance !== undefined) {
            updateMetric('.border-left-success .h5', data.avg_class_performance + '%');
        }

        if (data.students_at_risk !== undefined) {
            updateMetric('.border-left-danger .h5', data.students_at_risk);
        }

        if (data.monthly_behavior_incidents !== undefined) {
            updateMetric('.border-left-warning .h5', data.monthly_behavior_incidents);
        }

        if (data.active_academic_warnings !== undefined) {
            updateMetric('.border-left-info .h5', data.active_academic_warnings);
        }

        // Update standard metrics
        if (data.total_students !== undefined) {
            updateMetric('.border-left-primary .h5', data.total_students);
        }

        if (data.attendance_rate !== undefined) {
            updateMetric('.border-left-warning .h5', data.attendance_rate + '%');
        }

        // Show update notification
        showUpdateNotification();
    }

    function updateMetric(selector, value) {
        const element = document.querySelector(selector);
        if (element) {
            // Add transition effect
            element.style.transition = 'all 0.3s ease';
            element.style.transform = 'scale(1.05)';

            setTimeout(() => {
                element.textContent = value;
                element.style.transform = 'scale(1)';
            }, 150);
        }
    }

    function showUpdateNotification() {
        // Create and show a small notification
        const notification = document.createElement('div');
        notification.className = 'alert alert-info alert-dismissible fade show position-fixed';
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        notification.innerHTML = `
            <i class="fas fa-sync-alt"></i> Dashboard updated
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        document.body.appendChild(notification);

        // Auto-remove after 3 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 3000);
    }

    function trackQuickAction(action) {
        // Track user interactions (could send to analytics)
        console.log('Principal quick action clicked:', action);

        // Could send to analytics service
        if (typeof gtag !== 'undefined') {
            gtag('event', 'principal_quick_action', {
                'action_name': action,
                'page_location': window.location.href
            });
        }
    }

    function getCSRFToken() {
        // Get CSRF token from cookies or meta tag
        const tokenElement = document.querySelector('meta[name="csrf-token"]');
        if (tokenElement) {
            return tokenElement.getAttribute('content');
        }

        // Fallback: get from cookies
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            const [name, value] = cookie.trim().split('=');
            if (name === 'csrftoken') {
                return value;
            }
        }
        return '';
    }

    // Add keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Ctrl/Cmd + R to refresh dashboard
        if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
            e.preventDefault();
            refreshPrincipalMetrics();
            showUpdateNotification();
        }

        // Alt + P to go to performance monitoring
        if (e.altKey && e.key === 'p') {
            e.preventDefault();
            window.location.href = '/core/principal/performance-monitoring/';
        }

        // Alt + T to go to teacher management
        if (e.altKey && e.key === 't') {
            e.preventDefault();
            window.location.href = '/core/principal/teacher-management/';
        }

        // Alt + S to go to student welfare
        if (e.altKey && e.key === 's') {
            e.preventDefault();
            window.location.href = '/core/principal/student-welfare/';
        }

        // Alt + C to go to curriculum planning
        if (e.altKey && e.key === 'c') {
            e.preventDefault();
            window.location.href = '/core/principal/curriculum-planning/';
        }
    });

    // Performance monitoring
    if ('performance' in window && 'getEntriesByType' in performance) {
        window.addEventListener('load', function() {
            setTimeout(() => {
                const navigation = performance.getEntriesByType('navigation')[0];
                const loadTime = navigation.loadEventEnd - navigation.fetchStart;

                console.log(`Principal dashboard loaded in ${loadTime.toFixed(2)}ms`);

                // Could send performance data to analytics
                if (typeof gtag !== 'undefined') {
                    gtag('event', 'principal_dashboard_load_time', {
                        'page_title': document.title,
                        'load_time': loadTime
                    });
                }
            }, 0);
        });
    }

    // Error handling
    window.addEventListener('error', function(e) {
        console.error('Principal dashboard error:', e.error);

        // Show user-friendly error message
        const errorDiv = document.createElement('div');
        errorDiv.className = 'alert alert-danger alert-dismissible fade show position-fixed';
        errorDiv.style.cssText = 'bottom: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        errorDiv.innerHTML = `
            <i class="fas fa-exclamation-triangle"></i> Something went wrong. Please refresh the page.
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        document.body.appendChild(errorDiv);

        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (errorDiv.parentNode) {
                errorDiv.remove();
            }
        }, 5000);
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
        }
    });
});
</script>
{% endblock %}
