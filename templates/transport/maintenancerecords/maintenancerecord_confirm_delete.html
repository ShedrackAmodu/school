<!-- templates/transport/maintenancerecords/maintenancerecord_confirm_delete.html -->
{% extends 'base/base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Delete Maintenance Record" %} - {{ object.vehicle.vehicle_number }}{% endblock %}

{% block page_title %}{% trans "Delete Maintenance Record" %}{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'users:dashboard' %}">{% trans "Home" %}</a></li>
<li class="breadcrumb-item"><a href="{% url 'transport:dashboard' %}">{% trans "Transport" %}</a></li>
<li class="breadcrumb-item"><a href="{% url 'transport:maintenancerecord_list' %}">{% trans "Maintenance Records" %}</a></li>
<li class="breadcrumb-item"><a href="{% url 'transport:maintenancerecord_update' object.pk %}">{% trans "Maintenance Details" %}</a></li>
<li class="breadcrumb-item active" aria-current="page">{% trans "Delete Record" %}</li>
{% endblock %}

{% block extra_css %}
<style>
    /* Delete Confirmation Specific Styles */
    .delete-confirmation-container {
        max-width: 800px;
        margin: 0 auto;
    }
    
    .confirmation-card {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border-left: 4px solid #dc3545;
        overflow: hidden;
    }
    
    .confirmation-header {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 1.5rem 2rem;
        border-bottom: 1px solid #dee2e6;
        text-align: center;
    }
    
    .warning-icon {
        font-size: 3rem;
        color: #dc3545;
        margin-bottom: 1rem;
    }
    
    .confirmation-body {
        padding: 2rem;
    }
    
    .maintenance-preview {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border-left: 4px solid #0d6efd;
    }
    
    .preview-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .preview-item {
        display: flex;
        flex-direction: column;
    }
    
    .preview-label {
        font-size: 0.875rem;
        font-weight: 600;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.25rem;
    }
    
    .preview-value {
        font-size: 1rem;
        color: #2c3e50;
        font-weight: 500;
    }
    
    .maintenance-type-badge {
        padding: 0.4rem 0.8rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .type-routine { background-color: #28a745; color: white; }
    .type-repair { background-color: #fd7e14; color: white; }
    .type-breakdown { background-color: #dc3545; color: white; }
    .type-accident { background-color: #6f42c1; color: white; }
    .type-upgrade { background-color: #20c997; color: white; }
    
    .cost-badge {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        padding: 0.4rem 0.8rem;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 700;
    }
    
    .consequences-list {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .consequences-list ul {
        margin-bottom: 0;
        padding-left: 1.5rem;
    }
    
    .consequences-list li {
        margin-bottom: 0.5rem;
        color: #856404;
    }
    
    .confirmation-actions {
        background: #f8f9fa;
        padding: 1.5rem 2rem;
        border-top: 1px solid #dee2e6;
        text-align: center;
    }
    
    .action-buttons {
        display: flex;
        gap: 1rem;
        justify-content: center;
        flex-wrap: wrap;
    }
    
    .btn-delete {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        border: none;
        color: white;
        font-weight: 600;
        padding: 0.75rem 2rem;
        border-radius: 8px;
        transition: all 0.3s ease;
    }
    
    .btn-delete:hover {
        background: linear-gradient(135deg, #c82333 0%, #bd2130 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
    }
    
    .btn-cancel {
        background: #6c757d;
        border: none;
        color: white;
        font-weight: 600;
        padding: 0.75rem 2rem;
        border-radius: 8px;
        transition: all 0.3s ease;
    }
    
    .btn-cancel:hover {
        background: #5a6268;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(108, 117, 125, 0.3);
    }
    
    .security-check {
        background: #e7f3ff;
        border: 1px solid #b3d7ff;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .type-confirmation {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-top: 1rem;
    }
    
    .confirmation-input {
        flex: 1;
    }
    
    .maintenance-details {
        background: #e7f3ff;
        border: 1px solid #b3d7ff;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
    }
    
    .detail-item {
        display: flex;
        justify-content: between;
        margin-bottom: 0.5rem;
    }
    
    .detail-label {
        font-weight: 600;
        color: #495057;
        min-width: 120px;
    }
    
    .detail-value {
        color: #6c757d;
        flex: 1;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .confirmation-header {
            padding: 1.25rem;
        }
        
        .confirmation-body {
            padding: 1.25rem;
        }
        
        .confirmation-actions {
            padding: 1.25rem;
        }
        
        .action-buttons {
            flex-direction: column;
        }
        
        .action-buttons .btn {
            width: 100%;
        }
        
        .preview-grid {
            grid-template-columns: 1fr;
        }
        
        .type-confirmation {
            flex-direction: column;
            align-items: stretch;
        }
    }
    
    /* Animation for warning */
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    
    .pulse-warning {
        animation: pulse 2s ease-in-out infinite;
    }
    
    /* Shake animation for invalid input */
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        75% { transform: translateX(5px); }
    }
    
    .shake {
        animation: shake 0.5s ease-in-out;
    }
</style>
{% endblock %}

{% block content %}
<div class="delete-confirmation-container">
    <div class="confirmation-card">
        <div class="confirmation-header">
            <div class="warning-icon pulse-warning">
                <i class="fas fa-tools"></i>
            </div>
            <h2 class="text-danger mb-2">{% trans "Confirm Maintenance Record Deletion" %}</h2>
            <p class="text-muted mb-0">{% trans "You are about to permanently delete a maintenance record. This action cannot be undone." %}</p>
        </div>

        <div class="confirmation-body">
            <!-- Maintenance Record Preview -->
            <div class="maintenance-preview">
                <h5 class="mb-3">{% trans "Maintenance Record to be Deleted" %}</h5>
                <div class="preview-grid">
                    <div class="preview-item">
                        <span class="preview-label">{% trans "Vehicle" %}</span>
                        <span class="preview-value">{{ object.vehicle.vehicle_number }}</span>
                        <small class="text-muted">{{ object.vehicle.make }} {{ object.vehicle.model }}</small>
                    </div>
                    <div class="preview-item">
                        <span class="preview-label">{% trans "Maintenance Type" %}</span>
                        <span class="preview-value">
                            <span class="maintenance-type-badge type-{{ object.maintenance_type }}">
                                {{ object.get_maintenance_type_display }}
                            </span>
                        </span>
                    </div>
                    <div class="preview-item">
                        <span class="preview-label">{% trans "Date" %}</span>
                        <span class="preview-value">{{ object.date|date:"F d, Y" }}</span>
                    </div>
                    <div class="preview-item">
                        <span class="preview-label">{% trans "Odometer" %}</span>
                        <span class="preview-value">{{ object.odometer_reading|floatformat:0 }} km</span>
                    </div>
                    <div class="preview-item">
                        <span class="preview-label">{% trans "Cost" %}</span>
                        <span class="cost-badge">
                            <i class="fas fa-rupee-sign me-1"></i> {{ object.cost|floatformat:0 }}
                        </span>
                    </div>
                    <div class="preview-item">
                        <span class="preview-label">{% trans "Service Center" %}</span>
                        <span class="preview-value">{{ object.service_center|default:"N/A" }}</span>
                    </div>
                </div>
                
                {% if object.description %}
                <div class="mt-3">
                    <span class="preview-label">{% trans "Description" %}</span>
                    <p class="preview-value mt-1" style="font-size: 0.9rem; color: #6c757d;">
                        {{ object.description|truncatewords:30 }}
                    </p>
                </div>
                {% endif %}
                
                {% if object.work_done %}
                <div class="maintenance-details">
                    <strong class="preview-label">{% trans "Work Performed" %}</strong>
                    <p class="preview-value mt-1">{{ object.work_done|truncatewords:20 }}</p>
                </div>
                {% endif %}
            </div>

            <!-- Consequences Warning -->
            <div class="consequences-list">
                <h6 class="text-warning mb-3">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    {% trans "Important: Before you proceed, please note:" %}
                </h6>
                <ul>
                    <li>{% trans "This maintenance record will be permanently deleted from the system" %}</li>
                    <li>{% trans "All associated data will be removed, including:" %}
                        <ul>
                            <li>{% trans "Maintenance description and work details" %}</li>
                            <li>{% trans "Parts replacement records" %}</li>
                            <li>{% trans "Cost information" %}</li>
                            <li>{% trans "Service center details" %}</li>
                            <li>{% trans "Invoice references" %}</li>
                        </ul>
                    </li>
                    <li>{% trans "This action cannot be undone or recovered" %}</li>
                    <li>{% trans "Deleted records may affect:" %}
                        <ul>
                            <li>{% trans "Vehicle maintenance history" %}</li>
                            <li>{% trans "Warranty claims" %}</li>
                            <li>{% trans "Resale value documentation" %}</li>
                            <li>{% trans "Compliance reporting" %}</li>
                        </ul>
                    </li>
                    {% if object.next_due_date %}
                    <li class="text-danger">
                        <strong>{% trans "Warning: This record includes next maintenance scheduling. Deleting it may disrupt maintenance planning." %}</strong>
                    </li>
                    {% endif %}
                </ul>
            </div>

            <!-- Security Check -->
            <div class="security-check">
                <h6 class="text-primary mb-3">
                    <i class="fas fa-shield-alt me-2"></i>
                    {% trans "Security Verification" %}
                </h6>
                <p class="mb-3">{% trans "To confirm deletion, please type the vehicle number in the box below:" %}</p>
                
                <div class="type-confirmation">
                    <div class="confirmation-input">
                        <input type="text" 
                               class="form-control" 
                               id="confirmationInput" 
                               placeholder="{% trans 'Type the vehicle number here' %}"
                               autocomplete="off">
                        <div class="form-text">{% trans "Type exactly:" %} <strong>"{{ object.vehicle.vehicle_number }}"</strong></div>
                    </div>
                    <div>
                        <span id="matchIndicator" class="badge bg-secondary">{% trans "Not Matching" %}</span>
                    </div>
                </div>
            </div>

            <!-- Additional Options -->
            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="exportBackup">
                <label class="form-check-label" for="exportBackup">
                    {% trans "Export a backup of this maintenance record before deletion" %}
                </label>
            </div>

            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="updateVehicleMileage">
                <label class="form-check-label" for="updateVehicleMileage">
                    {% trans "Update vehicle current mileage to reflect this deletion" %}
                </label>
            </div>
        </div>

        <div class="confirmation-actions">
            <form method="post" id="deleteForm">
                {% csrf_token %}
                
                <div class="action-buttons">
                    <button type="button" class="btn btn-cancel" onclick="cancelDeletion()">
                        <i class="fas fa-times me-2"></i> {% trans "Cancel Deletion" %}
                    </button>
                    
                    <button type="submit" 
                            class="btn btn-delete" 
                            id="deleteButton" 
                            disabled>
                        <i class="fas fa-trash me-2"></i> {% trans "Permanently Delete" %}
                    </button>
                </div>
                
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        {% trans "This action will be logged in the maintenance audit trail" %}
                    </small>
                </div>
            </form>
        </div>
    </div>

    <!-- Alternative Actions -->
    <div class="mt-4 text-center">
        <p class="text-muted mb-3">{% trans "Consider these alternatives instead of deletion:" %}</p>
        <div class="d-flex justify-content-center gap-2 flex-wrap">
            <a href="{% url 'transport:maintenancerecord_update' object.pk %}" class="btn btn-outline-primary btn-sm">
                <i class="fas fa-edit me-1"></i> {% trans "Edit Maintenance Record" %}
            </a>
            <a href="{% url 'transport:vehicle_detail' object.vehicle.pk %}" class="btn btn-outline-info btn-sm">
                <i class="fas fa-truck me-1"></i> {% trans "View Vehicle Details" %}
            </a>
            <button class="btn btn-outline-warning btn-sm" onclick="archiveInstead()">
                <i class="fas fa-archive me-1"></i> {% trans "Archive Instead" %}
            </button>
            <button class="btn btn-outline-success btn-sm" onclick="createSimilarRecord()">
                <i class="fas fa-copy me-1"></i> {% trans "Create Similar Record" %}
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const confirmationInput = document.getElementById('confirmationInput');
        const matchIndicator = document.getElementById('matchIndicator');
        const deleteButton = document.getElementById('deleteButton');
        const deleteForm = document.getElementById('deleteForm');
        const requiredText = "{{ object.vehicle.vehicle_number }}";
        
        let deletionConfirmed = false;
        
        // Type confirmation logic
        confirmationInput.addEventListener('input', function() {
            const inputText = this.value.trim();
            
            if (inputText === requiredText) {
                matchIndicator.className = 'badge bg-success';
                matchIndicator.textContent = '{% trans "Matching" %}';
                deleteButton.disabled = false;
                deletionConfirmed = true;
            } else {
                matchIndicator.className = 'badge bg-danger';
                matchIndicator.textContent = '{% trans "Not Matching" %}';
                deleteButton.disabled = true;
                deletionConfirmed = false;
            }
        });
        
        // Form submission handling
        deleteForm.addEventListener('submit', function(e) {
            if (!deletionConfirmed) {
                e.preventDefault();
                showNotification('{% trans "Please confirm the vehicle number before deletion" %}', 'error');
                confirmationInput.classList.add('shake');
                setTimeout(() => confirmationInput.classList.remove('shake'), 500);
                return;
            }
            
            // Additional confirmation for costly maintenance records
            if ({{ object.cost }} > 10000) {
                e.preventDefault();
                showCostlyConfirmation();
                return;
            }
            
            // Show loading state
            deleteButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> {% trans "Deleting..." %}';
            deleteButton.disabled = true;
            
            // Update form with additional options
            const exportBackup = document.getElementById('exportBackup');
            const updateMileage = document.getElementById('updateVehicleMileage');
            
            if (exportBackup.checked) {
                // Add hidden field for backup export
                const backupField = document.createElement('input');
                backupField.type = 'hidden';
                backupField.name = 'export_backup';
                backupField.value = 'true';
                deleteForm.appendChild(backupField);
            }
            
            if (updateMileage.checked) {
                // Add hidden field for mileage update
                const mileageField = document.createElement('input');
                mileageField.type = 'hidden';
                mileageField.name = 'update_mileage';
                mileageField.value = 'true';
                deleteForm.appendChild(mileageField);
            }
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Escape to cancel
            if (e.key === 'Escape') {
                cancelDeletion();
            }
            
            // Ctrl+Enter to submit if confirmed
            if (e.ctrlKey && e.key === 'Enter' && deletionConfirmed) {
                deleteForm.requestSubmit();
            }
        });
        
        // Focus on confirmation input
        confirmationInput.focus();
        
        // Auto-check backup export for costly records
        if ({{ object.cost }} > 5000) {
            document.getElementById('exportBackup').checked = true;
            showNotification('{% trans "Backup export recommended for costly maintenance records" %}', 'info');
        }
    });
    
    function showCostlyConfirmation() {
        const costlyMessage = `
            <div class="alert alert-warning" id="costlyWarning">
                <h5><i class="fas fa-exclamation-triangle me-2"></i>{% trans "High-Cost Maintenance Record" %}</h5>
                <p>{% trans "You are about to delete a maintenance record with significant cost (â‚¹${ {{ object.cost|floatformat:0 }} }). This may have financial reporting implications. Are you absolutely sure?" %}</p>
                <div class="mt-3">
                    <button type="button" class="btn btn-danger me-2" onclick="proceedWithCostlyDeletion()">
                        {% trans "Yes, Delete Anyway" %}
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="hideCostlyWarning()">
                        {% trans "Cancel" %}
                    </button>
                </div>
            </div>
        `;
        
        const warningDiv = document.createElement('div');
        warningDiv.innerHTML = costlyMessage;
        document.querySelector('.confirmation-body').appendChild(warningDiv);
    }
    
    function proceedWithCostlyDeletion() {
        const deleteButton = document.getElementById('deleteButton');
        deleteButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> {% trans "Deleting..." %}';
        deleteButton.disabled = true;
        
        document.getElementById('deleteForm').submit();
    }
    
    function hideCostlyWarning() {
        const warningDiv = document.getElementById('costlyWarning');
        if (warningDiv) {
            warningDiv.remove();
        }
    }
    
    function cancelDeletion() {
        if (confirm('{% trans "Are you sure you want to cancel? Any unsaved changes will be lost." %}')) {
            window.location.href = "{% url 'transport:maintenancerecord_update' object.pk %}";
        }
    }
    
    function archiveInstead() {
        if (confirm('{% trans "Would you like to archive this maintenance record instead of deleting it? Archiving preserves the data but removes it from active maintenance lists." %}')) {
            // Simulate archive action
            showNotification('{% trans "Archiving maintenance record..." %}', 'info');
            
            // In real implementation, this would make an API call to archive
            setTimeout(() => {
                showNotification('{% trans "Maintenance record archived successfully" %}', 'success');
                setTimeout(() => {
                    window.location.href = "{% url 'transport:maintenancerecord_list' %}";
                }, 1000);
            }, 1500);
        }
    }
    
    function createSimilarRecord() {
        if (confirm('{% trans "Would you like to create a new maintenance record with similar details? This will preserve the information while allowing you to make changes." %}')) {
            // In real implementation, this would redirect to create form with pre-filled data
            showNotification('{% trans "Creating similar maintenance record..." %}', 'info');
            
            setTimeout(() => {
                // Redirect to create form with template data
                window.location.href = "{% url 'transport:maintenancerecord_create' %}?template={{ object.pk }}";
            }, 1000);
        }
    }
    
    function showNotification(message, type) {
        // Remove any existing notifications
        const existingNotifications = document.querySelectorAll('.custom-notification');
        existingNotifications.forEach(notification => notification.remove());
        
        const notification = document.createElement('div');
        notification.className = `custom-notification alert alert-${type} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 1060; min-width: 300px;';
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
        `;
        document.body.appendChild(notification);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 5000);
    }
    
    // Export backup functionality
    document.getElementById('exportBackup')?.addEventListener('change', function() {
        if (this.checked) {
            showNotification('{% trans "Backup will be generated before deletion" %}', 'info');
        }
    });
    
    // Vehicle mileage update functionality
    document.getElementById('updateVehicleMileage')?.addEventListener('change', function() {
        if (this.checked) {
            showNotification('{% trans "Vehicle mileage will be adjusted after deletion" %}', 'info');
        }
    });
</script>
{% endblock %}