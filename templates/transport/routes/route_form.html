<!-- templates/transport/routes/route_form.html -->
{% extends 'base/base.html' %}
{% load static %}
{% load i18n %}

{% block title %}
    {% if object %}{% trans "Update Route" %}{% else %}{% trans "Create Route" %}{% endif %}
{% endblock %}

{% block page_title %}
    {% if object %}{% trans "Update Route" %}{% else %}{% trans "Create Route" %}{% endif %}
{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'users:dashboard' %}">{% trans "Home" %}</a></li>
<li class="breadcrumb-item"><a href="{% url 'transport:dashboard' %}">{% trans "Transport" %}</a></li>
<li class="breadcrumb-item"><a href="{% url 'transport:route_list' %}">{% trans "Routes" %}</a></li>
<li class="breadcrumb-item active" aria-current="page">
    {% if object %}{% trans "Update Route" %}{% else %}{% trans "Create Route" %}{% endif %}
</li>
{% endblock %}

{% block extra_css %}
<style>
    /* Route Form Specific Styles */
    .route-form-container {
        max-width: 1000px;
        margin: 0 auto;
    }
    
    .form-section {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .form-section-header {
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 0.75rem;
        margin-bottom: 1.25rem;
    }
    
    .form-section-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #2c3e50;
        margin: 0;
    }
    
    .form-section-subtitle {
        font-size: 0.875rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }
    
    .required-field::after {
        content: " *";
        color: #dc3545;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }
    
    .route-preview {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
        border-left: 4px solid #0d6efd;
    }
    
    .preview-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }
    
    .preview-item {
        display: flex;
        flex-direction: column;
    }
    
    .preview-label {
        font-size: 0.875rem;
        font-weight: 600;
        color: #6c757d;
        margin-bottom: 0.25rem;
    }
    
    .preview-value {
        font-size: 1rem;
        color: #2c3e50;
        font-weight: 500;
    }
    
    .form-actions {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1.25rem;
        margin-top: 1.5rem;
        border-top: 1px solid #dee2e6;
    }
    
    .distance-calculator {
        background: #e7f3ff;
        border: 1px solid #b3d7ff;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 0.5rem;
    }
    
    .duration-estimator {
        background: #f0f9ff;
        border: 1px solid #bae6fd;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 0.5rem;
    }
    
    .map-preview {
        background: #f8f9fa;
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-top: 1rem;
        color: #6c757d;
    }
    
    .route-code-preview {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-weight: 600;
        font-size: 1.1rem;
        text-align: center;
        margin-bottom: 1rem;
    }
    
    .stops-manager {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
    }
    
    .stop-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 0.75rem;
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        margin-bottom: 0.5rem;
    }
    
    .stop-sequence {
        background: #0d6efd;
        color: white;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.875rem;
    }
    
    .stop-details {
        flex: 1;
    }
    
    .stop-name {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 0.25rem;
    }
    
    .stop-address {
        font-size: 0.875rem;
        color: #6c757d;
    }
    
    .stop-actions {
        display: flex;
        gap: 0.5rem;
    }
    
    .efficiency-meter {
        background: #d1fae5;
        border: 1px solid #a7f3d0;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
    }
    
    .meter-reading {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    
    .meter-label {
        font-weight: 600;
        color: #065f46;
    }
    
    .meter-value {
        font-weight: 700;
        color: #065f46;
    }
    
    .meter-bar {
        height: 8px;
        background: #e5e7eb;
        border-radius: 4px;
        overflow: hidden;
    }
    
    .meter-fill {
        height: 100%;
        background: linear-gradient(90deg, #10b981, #34d399);
        border-radius: 4px;
        transition: width 0.5s ease;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .form-section {
            padding: 1rem;
        }
        
        .form-section-title {
            font-size: 1.1rem;
        }
        
        .preview-grid {
            grid-template-columns: 1fr;
        }
        
        .stop-item {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .stop-actions {
            width: 100%;
            justify-content: flex-end;
        }
    }
    
    /* Animation for route preview */
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .slide-in {
        animation: slideIn 0.3s ease-out;
    }
</style>
{% endblock %}

{% block content %}
<div class="route-form-container">
    <form method="post" id="routeForm" novalidate>
        {% csrf_token %}
        
        <!-- Basic Route Information Section -->
        <div class="form-section">
            <div class="form-section-header">
                <h3 class="form-section-title">{% trans "Basic Route Information" %}</h3>
                <p class="form-section-subtitle">{% trans "Enter the fundamental details of the route" %}</p>
            </div>
            
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="{{ form.name.id_for_label }}" class="form-label required-field">
                        {% trans "Route Name" %}
                    </label>
                    {{ form.name }}
                    {% if form.name.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.name.errors }}
                    </div>
                    {% endif %}
                    <div class="form-text">{% trans "Descriptive name for the route (e.g., 'North Campus Route', 'City Center Loop')" %}</div>
                </div>
                
                <div class="col-md-6">
                    <label for="{{ form.code.id_for_label }}" class="form-label required-field">
                        {% trans "Route Code" %}
                    </label>
                    {{ form.code }}
                    {% if form.code.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.code.errors }}
                    </div>
                    {% endif %}
                    <div class="form-text">{% trans "Unique code identifier (e.g., 'R-001', 'NORTH-01')" %}</div>
                    
                    <!-- Route Code Preview -->
                    <div class="route-code-preview" id="routeCodePreview" style="display: none;">
                        <span id="previewCode"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Route Path Section -->
        <div class="form-section">
            <div class="form-section-header">
                <h3 class="form-section-title">{% trans "Route Path" %}</h3>
                <p class="form-section-subtitle">{% trans "Define the start and end points of the route" %}</p>
            </div>
            
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="{{ form.start_point.id_for_label }}" class="form-label required-field">
                        {% trans "Start Point" %}
                    </label>
                    {{ form.start_point }}
                    {% if form.start_point.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.start_point.errors }}
                    </div>
                    {% endif %}
                    <div class="form-text">{% trans "Beginning location of the route" %}</div>
                </div>
                
                <div class="col-md-6">
                    <label for="{{ form.end_point.id_for_label }}" class="form-label required-field">
                        {% trans "End Point" %}
                    </label>
                    {{ form.end_point }}
                    {% if form.end_point.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.end_point.errors }}
                    </div>
                    {% endif %}
                    <div class="form-text">{% trans "Final destination of the route" %}</div>
                </div>
            </div>
            
            <!-- Map Preview Placeholder -->
            <div class="map-preview" id="mapPreview">
                <div class="text-center">
                    <i class="fas fa-map-marked-alt fa-3x mb-3 text-muted"></i>
                    <p class="mb-0">{% trans "Route map preview will appear here" %}</p>
                    <small class="text-muted">{% trans "Based on start and end points" %}</small>
                </div>
            </div>
        </div>

        <!-- Distance and Duration Section -->
        <div class="form-section">
            <div class="form-section-header">
                <h3 class="form-section-title">{% trans "Distance & Duration" %}</h3>
                <p class="form-section-subtitle">{% trans "Specify the route length and estimated travel time" %}</p>
            </div>
            
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="{{ form.total_distance.id_for_label }}" class="form-label required-field">
                        {% trans "Total Distance (km)" %}
                    </label>
                    {{ form.total_distance }}
                    {% if form.total_distance.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.total_distance.errors }}
                    </div>
                    {% endif %}
                    
                    <!-- Distance Calculator -->
                    <div class="distance-calculator">
                        <h6 class="mb-2">{% trans "Distance Calculator" %}</h6>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="autoCalculateDistance">
                            <label class="form-check-label" for="autoCalculateDistance">
                                {% trans "Auto-calculate based on route points" %}
                            </label>
                        </div>
                        <div class="mt-2">
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="calculateDistance()">
                                <i class="fas fa-calculator me-1"></i> {% trans "Calculate Distance" %}
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <label for="{{ form.estimated_duration.id_for_label }}" class="form-label required-field">
                        {% trans "Estimated Duration (minutes)" %}
                    </label>
                    {{ form.estimated_duration }}
                    {% if form.estimated_duration.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.estimated_duration.errors }}
                    </div>
                    {% endif %}
                    
                    <!-- Duration Estimator -->
                    <div class="duration-estimator">
                        <h6 class="mb-2">{% trans "Duration Estimator" %}</h6>
                        <div class="row g-2">
                            <div class="col-6">
                                <small>{% trans "Traffic:" %}</small>
                                <select class="form-select form-select-sm" id="trafficLevel">
                                    <option value="1">{% trans "Light" %}</option>
                                    <option value="1.2" selected>{% trans "Moderate" %}</option>
                                    <option value="1.5">{% trans "Heavy" %}</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <small>{% trans "Speed:" %}</small>
                                <select class="form-select form-select-sm" id="averageSpeed">
                                    <option value="40">{% trans "City (40 km/h)" %}</option>
                                    <option value="60" selected>{% trans "Mixed (60 km/h)" %}</option>
                                    <option value="80">{% trans "Highway (80 km/h)" %}</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-2">
                            <button type="button" class="btn btn-outline-info btn-sm" onclick="estimateDuration()">
                                <i class="fas fa-clock me-1"></i> {% trans "Estimate Duration" %}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Route Efficiency Section -->
        <div class="form-section">
            <div class="form-section-header">
                <h3 class="form-section-title">{% trans "Route Efficiency" %}</h3>
                <p class="form-section-subtitle">{% trans "Analyze route performance and efficiency metrics" %}</p>
            </div>
            
            <div class="efficiency-meter">
                <h6 class="mb-3">{% trans "Route Efficiency Analysis" %}</h6>
                
                <div class="meter-reading">
                    <span class="meter-label">{% trans "Distance Efficiency" %}</span>
                    <span class="meter-value" id="distanceEfficiency">-</span>
                </div>
                <div class="meter-bar">
                    <div class="meter-fill" id="distanceEfficiencyBar" style="width: 0%"></div>
                </div>
                
                <div class="meter-reading mt-3">
                    <span class="meter-label">{% trans "Time Efficiency" %}</span>
                    <span class="meter-value" id="timeEfficiency">-</span>
                </div>
                <div class="meter-bar">
                    <div class="meter-fill" id="timeEfficiencyBar" style="width: 0%"></div>
                </div>
                
                <div class="meter-reading mt-3">
                    <span class="meter-label">{% trans "Overall Score" %}</span>
                    <span class="meter-value" id="overallScore">-</span>
                </div>
                <div class="meter-bar">
                    <div class="meter-fill" id="overallScoreBar" style="width: 0%"></div>
                </div>
                
                <div class="mt-3">
                    <button type="button" class="btn btn-outline-success btn-sm" onclick="analyzeEfficiency()">
                        <i class="fas fa-chart-line me-1"></i> {% trans "Analyze Efficiency" %}
                    </button>
                </div>
            </div>
        </div>

        <!-- Route Stops Management Section -->
        <div class="form-section">
            <div class="form-section-header">
                <h3 class="form-section-title">{% trans "Route Stops Management" %}</h3>
                <p class="form-section-subtitle">{% trans "Manage stops along this route" %}</p>
            </div>
            
            <div class="stops-manager">
                <h6 class="mb-3">{% trans "Route Stops" %}</h6>
                <p class="text-muted mb-3">{% trans "Stops can be added after creating the route. You'll be able to manage stops in the route details page." %}</p>
                
                <!-- Sample Stop Items (for demonstration) -->
                <div class="stop-item">
                    <div class="stop-sequence">1</div>
                    <div class="stop-details">
                        <div class="stop-name">{% trans "Main Campus Gate" %}</div>
                        <div class="stop-address">{% trans "123 University Avenue" %}</div>
                    </div>
                    <div class="stop-actions">
                        <button type="button" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-danger">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                
                <div class="stop-item">
                    <div class="stop-sequence">2</div>
                    <div class="stop-details">
                        <div class="stop-name">{% trans "City Center" %}</div>
                        <div class="stop-address">{% trans "456 Downtown Plaza" %}</div>
                    </div>
                    <div class="stop-actions">
                        <button type="button" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-danger">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                
                <div class="text-center mt-3">
                    <button type="button" class="btn btn-primary btn-sm" disabled>
                        <i class="fas fa-plus me-1"></i> {% trans "Add Stop (Available after saving)" %}
                    </button>
                </div>
            </div>
        </div>

        <!-- Additional Information Section -->
        <div class="form-section">
            <div class="form-section-header">
                <h3 class="form-section-title">{% trans "Additional Information" %}</h3>
                <p class="form-section-subtitle">{% trans "Optional details and route status" %}</p>
            </div>
            
            <div class="row g-3">
                <div class="col-12">
                    <label for="{{ form.description.id_for_label }}" class="form-label">
                        {% trans "Route Description" %}
                    </label>
                    {{ form.description }}
                    {% if form.description.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.description.errors }}
                    </div>
                    {% endif %}
                    <div class="form-text">{% trans "Additional notes, landmarks, or special instructions for this route" %}</div>
                </div>
                
                <div class="col-md-6">
                    <div class="form-check form-switch">
                        {{ form.is_active }}
                        <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                            {% trans "Route is Active" %}
                        </label>
                    </div>
                    {% if form.is_active.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.is_active.errors }}
                    </div>
                    {% endif %}
                    <div class="form-text">{% trans "Active routes can be assigned to vehicles and schedules" %}</div>
                </div>
            </div>
        </div>

        <!-- Route Preview -->
        <div class="form-section" id="routePreview" style="display: none;">
            <div class="form-section-header">
                <h3 class="form-section-title">{% trans "Route Preview" %}</h3>
                <p class="form-section-subtitle">{% trans "Review the route details before submitting" %}</p>
            </div>
            
            <div class="route-preview">
                <div class="preview-grid">
                    <div class="preview-item">
                        <span class="preview-label">{% trans "Route Name" %}</span>
                        <span class="preview-value" id="previewName"></span>
                    </div>
                    <div class="preview-item">
                        <span class="preview-label">{% trans "Route Code" %}</span>
                        <span class="preview-value" id="previewCode"></span>
                    </div>
                    <div class="preview-item">
                        <span class="preview-label">{% trans "Start Point" %}</span>
                        <span class="preview-value" id="previewStart"></span>
                    </div>
                    <div class="preview-item">
                        <span class="preview-label">{% trans "End Point" %}</span>
                        <span class="preview-value" id="previewEnd"></span>
                    </div>
                    <div class="preview-item">
                        <span class="preview-label">{% trans "Distance" %}</span>
                        <span class="preview-value" id="previewDistance"></span>
                    </div>
                    <div class="preview-item">
                        <span class="preview-label">{% trans "Duration" %}</span>
                        <span class="preview-value" id="previewDuration"></span>
                    </div>
                    <div class="preview-item">
                        <span class="preview-label">{% trans "Status" %}</span>
                        <span class="preview-value" id="previewStatus"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <button type="button" class="btn btn-outline-secondary" id="previewBtn">
                        <i class="fas fa-eye me-1"></i> {% trans "Preview" %}
                    </button>
                    <button type="button" class="btn btn-outline-info ms-2" onclick="optimizeRoute()">
                        <i class="fas fa-magic me-1"></i> {% trans "Optimize" %}
                    </button>
                </div>
                <div>
                    <a href="{% url 'transport:route_list' %}" class="btn btn-secondary me-2">
                        <i class="fas fa-times me-1"></i> {% trans "Cancel" %}
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i> 
                        {% if object %}{% trans "Update Route" %}{% else %}{% trans "Create Route" %}{% endif %}
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Form elements
        const form = document.getElementById('routeForm');
        const nameInput = document.getElementById('{{ form.name.id_for_label }}');
        const codeInput = document.getElementById('{{ form.code.id_for_label }}');
        const startPointInput = document.getElementById('{{ form.start_point.id_for_label }}');
        const endPointInput = document.getElementById('{{ form.end_point.id_for_label }}');
        const distanceInput = document.getElementById('{{ form.total_distance.id_for_label }}');
        const durationInput = document.getElementById('{{ form.estimated_duration.id_for_label }}');
        const isActiveInput = document.getElementById('{{ form.is_active.id_for_label }}');
        
        // Preview elements
        const routePreview = document.getElementById('routePreview');
        const routeCodePreview = document.getElementById('routeCodePreview');
        
        // Initialize form
        initializeForm();
        
        // Real-time code preview
        codeInput.addEventListener('input', function() {
            updateCodePreview(this.value);
        });
        
        // Auto-calculate distance when start/end points change
        startPointInput.addEventListener('change', function() {
            if (document.getElementById('autoCalculateDistance')?.checked) {
                calculateDistance();
            }
            updateMapPreview();
        });
        
        endPointInput.addEventListener('change', function() {
            if (document.getElementById('autoCalculateDistance')?.checked) {
                calculateDistance();
            }
            updateMapPreview();
        });
        
        // Preview functionality
        document.getElementById('previewBtn').addEventListener('click', function() {
            updatePreview();
            routePreview.style.display = 'block';
            routePreview.classList.remove('slide-in');
            void routePreview.offsetWidth; // Trigger reflow
            routePreview.classList.add('slide-in');
            routePreview.scrollIntoView({ behavior: 'smooth' });
        });
        
        function initializeForm() {
            // Initialize code preview
            updateCodePreview(codeInput.value);
            
            // Set default values for new routes
            {% if not object %}
            if (!durationInput.value) {
                durationInput.value = '30'; // Default 30 minutes
            }
            if (!isActiveInput.checked) {
                isActiveInput.checked = true; // Default active
            }
            {% endif %}
            
            // Initialize efficiency analysis
            analyzeEfficiency();
        }
        
        function updateCodePreview(code) {
            if (code) {
                document.getElementById('previewCode').textContent = code;
                routeCodePreview.style.display = 'block';
            } else {
                routeCodePreview.style.display = 'none';
            }
        }
        
        function calculateDistance() {
            const start = startPointInput.value;
            const end = endPointInput.value;
            
            if (!start || !end) {
                showNotification('{% trans "Please enter both start and end points" %}', 'warning');
                return;
            }
            
            // Simulate distance calculation
            // In real implementation, this would use a mapping API
            const simulatedDistance = Math.floor(Math.random() * 50) + 5; // 5-55 km
            distanceInput.value = simulatedDistance;
            
            showNotification(`{% trans "Estimated distance calculated:" %} ${simulatedDistance} km`, 'success');
            
            // Re-estimate duration based on new distance
            estimateDuration();
        }
        
        function estimateDuration() {
            const distance = parseFloat(distanceInput.value);
            
            if (!distance || distance <= 0) {
                showNotification('{% trans "Please enter a valid distance first" %}', 'warning');
                return;
            }
            
            const trafficLevel = parseFloat(document.getElementById('trafficLevel').value);
            const averageSpeed = parseFloat(document.getElementById('averageSpeed').value);
            
            // Calculate estimated duration
            const baseTime = (distance / averageSpeed) * 60; // Convert to minutes
            const estimatedTime = Math.round(baseTime * trafficLevel);
            
            durationInput.value = estimatedTime;
            
            showNotification(`{% trans "Estimated duration:" %} ${estimatedTime} {% trans "minutes" %}`, 'info');
            
            // Update efficiency analysis
            analyzeEfficiency();
        }
        
        function analyzeEfficiency() {
            const distance = parseFloat(distanceInput.value) || 0;
            const duration = parseFloat(durationInput.value) || 0;
            
            if (distance > 0 && duration > 0) {
                // Calculate efficiency metrics
                const speedEfficiency = Math.min(100, Math.round((distance / (duration / 60)) * 2)); // km/h * 2 for score
                const timeEfficiency = Math.min(100, Math.round((30 / duration) * 100)); // Based on 30min ideal
                const overallScore = Math.round((speedEfficiency + timeEfficiency) / 2);
                
                // Update efficiency displays
                document.getElementById('distanceEfficiency').textContent = speedEfficiency + '%';
                document.getElementById('timeEfficiency').textContent = timeEfficiency + '%';
                document.getElementById('overallScore').textContent = overallScore + '%';
                
                // Update progress bars
                document.getElementById('distanceEfficiencyBar').style.width = speedEfficiency + '%';
                document.getElementById('timeEfficiencyBar').style.width = timeEfficiency + '%';
                document.getElementById('overallScoreBar').style.width = overallScore + '%';
                
                // Color coding based on score
                const overallBar = document.getElementById('overallScoreBar');
                if (overallScore >= 80) {
                    overallBar.style.background = 'linear-gradient(90deg, #10b981, #34d399)';
                } else if (overallScore >= 60) {
                    overallBar.style.background = 'linear-gradient(90deg, #f59e0b, #fbbf24)';
                } else {
                    overallBar.style.background = 'linear-gradient(90deg, #ef4444, #f87171)';
                }
            }
        }
        
        function updateMapPreview() {
            const start = startPointInput.value;
            const end = endPointInput.value;
            const mapPreview = document.getElementById('mapPreview');
            
            if (start && end) {
                mapPreview.innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-route fa-3x mb-3 text-primary"></i>
                        <p class="mb-1"><strong>${start}</strong></p>
                        <i class="fas fa-arrow-down text-muted mb-1"></i>
                        <p class="mb-1"><strong>${end}</strong></p>
                        <small class="text-muted">{% trans "Interactive map would show the route path" %}</small>
                    </div>
                `;
            }
        }
        
        function updatePreview() {
            // Update preview with current form values
            document.getElementById('previewName').textContent = nameInput.value || 'Not set';
            document.getElementById('previewCode').textContent = codeInput.value || 'Not set';
            document.getElementById('previewStart').textContent = startPointInput.value || 'Not set';
            document.getElementById('previewEnd').textContent = endPointInput.value || 'Not set';
            document.getElementById('previewDistance').textContent = distanceInput.value ? distanceInput.value + ' km' : 'Not set';
            document.getElementById('previewDuration').textContent = durationInput.value ? durationInput.value + ' minutes' : 'Not set';
            document.getElementById('previewStatus').textContent = isActiveInput.checked ? '{% trans "Active" %}' : '{% trans "Inactive" %}';
        }
        
        function optimizeRoute() {
            // Simulate route optimization
            showNotification('{% trans "Analyzing route for optimization..." %}', 'info');
            
            setTimeout(() => {
                // Simulated optimization results
                const currentDistance = parseFloat(distanceInput.value) || 0;
                const optimizedDistance = Math.round(currentDistance * 0.9); // 10% improvement
                
                if (currentDistance > 0) {
                    distanceInput.value = optimizedDistance;
                    estimateDuration(); // Re-estimate duration with new distance
                    
                    showNotification(`{% trans "Route optimized! Distance reduced to" %} ${optimizedDistance} km`, 'success');
                } else {
                    showNotification('{% trans "Please enter route details first" %}', 'warning');
                }
            }, 1500);
        }
        
        // Form validation
        form.addEventListener('submit', function(event) {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            form.classList.add('was-validated');
        });
        
        // Auto-save draft functionality
        let autoSaveTimer;
        const formInputs = form.querySelectorAll('input, select, textarea');
        
        formInputs.forEach(input => {
            input.addEventListener('input', function() {
                clearTimeout(autoSaveTimer);
                autoSaveTimer = setTimeout(saveDraft, 2000);
            });
        });
        
        function saveDraft() {
            // In real implementation, save to localStorage or send to server
            console.log('Auto-saving route draft...');
            showNotification('{% trans "Draft saved automatically" %}', 'info');
        }
        
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 1060; min-width: 300px;';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }
    });
</script>
{% endblock %}