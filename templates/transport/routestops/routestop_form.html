<!-- templates/transport/routestops/routestop_form.html -->
{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}
    {% if object %}{% trans "Update Route Stop" %}{% else %}{% trans "Create Route Stop" %}{% endif %}
{% endblock %}

{% block page_title %}
    {% if object %}{% trans "Update Route Stop" %}{% else %}{% trans "Create Route Stop" %}{% endif %}
{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'users:dashboard' %}">{% trans "Home" %}</a></li>
<li class="breadcrumb-item"><a href="{% url 'transport:route_list' %}">{% trans "Routes" %}</a></li>
{% if object %}
<li class="breadcrumb-item"><a href="{% url 'transport:route_detail' object.route.pk %}">{{ object.route.code }}</a></li>
<li class="breadcrumb-item active" aria-current="page">{% trans "Update Stop" %}</li>
{% else %}
<li class="breadcrumb-item"><a href="{% url 'transport:route_detail' route.pk %}">{{ route.code }}</a></li>
<li class="breadcrumb-item active" aria-current="page">{% trans "Create Stop" %}</li>
{% endif %}
{% endblock %}

{% block extra_css %}
<style>
    .stop-form-card {
        border-radius: 12px;
        border: none;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
    }
    
    .form-section {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border-left: 4px solid #0d6efd;
    }
    
    .form-section h5 {
        color: #0d6efd;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
    }
    
    .form-section h5 i {
        margin-right: 0.5rem;
    }
    
    .stop-preview {
        background-color: #fff;
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        padding: 1.5rem;
        margin-top: 1.5rem;
    }
    
    .preview-header {
        display: flex;
        justify-content: between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #e9ecef;
    }
    
    .preview-item {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        border-bottom: 1px solid #e9ecef;
    }
    
    .preview-item:last-child {
        border-bottom: none;
    }
    
    .preview-label {
        font-weight: 600;
        color: #6c757d;
        min-width: 120px;
    }
    
    .sequence-badge {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: #0d6efd;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1.2rem;
        margin-right: 1rem;
    }
    
    .time-input-group {
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    
    .time-input-group .form-label {
        min-width: 120px;
        margin-bottom: 0;
    }
    
    .map-preview {
        height: 200px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        margin-bottom: 1rem;
        position: relative;
        overflow: hidden;
    }
    
    .map-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
    }
    
    .coordinate-inputs {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }
    
    .stop-sequence-controls {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-top: 0.5rem;
    }
    
    .sequence-btn {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid #e9ecef;
        background: white;
        color: #6c757d;
        transition: all 0.3s ease;
    }
    
    .sequence-btn:hover {
        border-color: #0d6efd;
        color: #0d6efd;
    }
    
    .sequence-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .validation-alert {
        border-left: 4px solid #dc3545;
        background-color: #f8d7da;
    }
    
    .success-alert {
        border-left: 4px solid #198754;
        background-color: #d1e7dd;
    }
    
    .btn-submit {
        padding: 0.75rem 2rem;
        font-weight: 600;
        border-radius: 8px;
        min-width: 150px;
    }
    
    .existing-stops {
        background-color: #fff;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
        max-height: 300px;
        overflow-y: auto;
    }
    
    .existing-stop {
        display: flex;
        align-items: center;
        padding: 0.75rem;
        border-bottom: 1px solid #e9ecef;
        transition: background-color 0.2s ease;
    }
    
    .existing-stop:hover {
        background-color: #f8f9fa;
    }
    
    .existing-stop:last-child {
        border-bottom: none;
    }
    
    .stop-time {
        font-size: 0.875rem;
        color: #6c757d;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .coordinate-inputs {
            grid-template-columns: 1fr;
        }
        
        .time-input-group {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .time-input-group .form-label {
            min-width: auto;
            margin-bottom: 0.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="route-stop-form">
    <div class="row">
        <div class="col-lg-8">
            <div class="card stop-form-card">
                <div class="card-body">
                    <form method="post" id="stopForm">
                        {% csrf_token %}
                        
                        <!-- Basic Information Section -->
                        <div class="form-section">
                            <h5><i class="fas fa-info-circle"></i> {% trans "Basic Information" %}</h5>
                            
                            <!-- Route Selection (for new stops) -->
                            {% if not object %}
                            <div class="mb-3">
                                <label for="{{ form.route.id_for_label }}" class="form-label">
                                    {% trans "Route" %} *
                                </label>
                                {{ form.route }}
                                {% if form.route.errors %}
                                <div class="text-danger small mt-1">
                                    {{ form.route.errors }}
                                </div>
                                {% endif %}
                            </div>
                            {% else %}
                            <input type="hidden" name="route" value="{{ object.route.pk }}">
                            {% endif %}
                            
                            <div class="row">
                                <div class="col-md-8 mb-3">
                                    <label for="{{ form.name.id_for_label }}" class="form-label">
                                        {% trans "Stop Name" %} *
                                    </label>
                                    {{ form.name }}
                                    {% if form.name.errors %}
                                    <div class="text-danger small mt-1">
                                        {{ form.name.errors }}
                                    </div>
                                    {% endif %}
                                    <div class="form-text">{% trans "Descriptive name for the stop location" %}</div>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label for="{{ form.sequence.id_for_label }}" class="form-label">
                                        {% trans "Sequence Number" %} *
                                    </label>
                                    {{ form.sequence }}
                                    {% if form.sequence.errors %}
                                    <div class="text-danger small mt-1">
                                        {{ form.sequence.errors }}
                                    </div>
                                    {% endif %}
                                    <div class="stop-sequence-controls">
                                        <button type="button" class="sequence-btn" id="decrementSequence" {% if not existing_stops %}disabled{% endif %}>
                                            <i class="fas fa-chevron-left"></i>
                                        </button>
                                        <button type="button" class="sequence-btn" id="incrementSequence">
                                            <i class="fas fa-chevron-right"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="{{ form.address.id_for_label }}" class="form-label">
                                    {% trans "Address" %} *
                                </label>
                                {{ form.address }}
                                {% if form.address.errors %}
                                <div class="text-danger small mt-1">
                                    {{ form.address.errors }}
                                </div>
                                {% endif %}
                                <div class="form-text">{% trans "Full address of the stop location" %}</div>
                            </div>
                        </div>
                        
                        <!-- Location Coordinates Section -->
                        <div class="form-section">
                            <h5><i class="fas fa-map-marker-alt"></i> {% trans "Location Coordinates" %}</h5>
                            
                            <div class="map-preview">
                                <div class="map-overlay">
                                    <i class="fas fa-map fa-3x mb-3"></i>
                                    <p class="mb-0">{% trans "Map integration preview" %}</p>
                                    <small class="opacity-75">{% trans "Coordinates will be displayed here" %}</small>
                                </div>
                            </div>
                            
                            <div class="coordinate-inputs">
                                <div class="mb-3">
                                    <label for="{{ form.latitude.id_for_label }}" class="form-label">
                                        {% trans "Latitude" %}
                                    </label>
                                    {{ form.latitude }}
                                    {% if form.latitude.errors %}
                                    <div class="text-danger small mt-1">
                                        {{ form.latitude.errors }}
                                    </div>
                                    {% endif %}
                                    <div class="form-text">{% trans "Decimal coordinates (e.g., 40.7128)" %}</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="{{ form.longitude.id_for_label }}" class="form-label">
                                        {% trans "Longitude" %}
                                    </label>
                                    {{ form.longitude }}
                                    {% if form.longitude.errors %}
                                    <div class="text-danger small mt-1">
                                        {{ form.longitude.errors }}
                                    </div>
                                    {% endif %}
                                    <div class="form-text">{% trans "Decimal coordinates (e.g., -74.0060)" %}</div>
                                </div>
                            </div>
                            
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-outline-secondary btn-sm" id="getCurrentLocation">
                                    <i class="fas fa-location-arrow me-1"></i>{% trans "Use Current Location" %}
                                </button>
                                <button type="button" class="btn btn-outline-info btn-sm" id="geocodeAddress">
                                    <i class="fas fa-search me-1"></i>{% trans "Geocode Address" %}
                                </button>
                            </div>
                        </div>
                        
                        <!-- Timing Information Section -->
                        <div class="form-section">
                            <h5><i class="fas fa-clock"></i> {% trans "Timing Information" %}</h5>
                            
                            <div class="mb-3">
                                <div class="time-input-group">
                                    <label for="{{ form.estimated_arrival_time.id_for_label }}" class="form-label">
                                        {% trans "Estimated Arrival" %} *
                                    </label>
                                    {{ form.estimated_arrival_time }}
                                </div>
                                {% if form.estimated_arrival_time.errors %}
                                <div class="text-danger small mt-1">
                                    {{ form.estimated_arrival_time.errors }}
                                </div>
                                {% endif %}
                                <div class="form-text">{% trans "Expected arrival time at this stop" %}</div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="time-input-group">
                                        <label for="{{ form.pickup_time.id_for_label }}" class="form-label">
                                            {% trans "Pickup Time" %}
                                        </label>
                                        {{ form.pickup_time }}
                                    </div>
                                    {% if form.pickup_time.errors %}
                                    <div class="text-danger small mt-1">
                                        {{ form.pickup_time.errors }}
                                    </div>
                                    {% endif %}
                                    <div class="form-text">{% trans "Morning pickup time" %}</div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <div class="time-input-group">
                                        <label for="{{ form.drop_time.id_for_label }}" class="form-label">
                                            {% trans "Drop Time" %}
                                        </label>
                                        {{ form.drop_time }}
                                    </div>
                                    {% if form.drop_time.errors %}
                                    <div class="text-danger small mt-1">
                                        {{ form.drop_time.errors }}
                                    </div>
                                    {% endif %}
                                    <div class="form-text">{% trans "Evening drop-off time" %}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Status Section -->
                        <div class="form-section">
                            <h5><i class="fas fa-toggle-on"></i> {% trans "Status" %}</h5>
                            
                            <div class="mb-3">
                                <label for="{{ form.status.id_for_label }}" class="form-label">
                                    {% trans "Stop Status" %}
                                </label>
                                {{ form.status }}
                                {% if form.status.errors %}
                                <div class="text-danger small mt-1">
                                    {{ form.status.errors }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Validation and Preview -->
                        <div id="validation-section" style="display: none;">
                            <div class="alert" id="validation-alert">
                                <!-- Validation messages will appear here -->
                            </div>
                            
                            <div class="stop-preview">
                                <div class="preview-header">
                                    <div class="d-flex align-items-center">
                                        <div class="sequence-badge" id="preview-sequence">1</div>
                                        <div>
                                            <h6 class="mb-0" id="preview-name">{% trans "Stop Name" %}</h6>
                                            <small class="text-muted" id="preview-route">{% trans "Route Name" %}</small>
                                        </div>
                                    </div>
                                    <span class="badge bg-success" id="preview-status">{% trans "Active" %}</span>
                                </div>
                                
                                <div class="preview-item">
                                    <span class="preview-label">{% trans "Address:" %}</span>
                                    <span id="preview-address">{% trans "Not specified" %}</span>
                                </div>
                                <div class="preview-item">
                                    <span class="preview-label">{% trans "Coordinates:" %}</span>
                                    <span id="preview-coordinates">{% trans "Not specified" %}</span>
                                </div>
                                <div class="preview-item">
                                    <span class="preview-label">{% trans "Arrival Time:" %}</span>
                                    <span id="preview-arrival">{% trans "Not specified" %}</span>
                                </div>
                                <div class="preview-item">
                                    <span class="preview-label">{% trans "Pickup Time:" %}</span>
                                    <span id="preview-pickup">{% trans "Not specified" %}</span>
                                </div>
                                <div class="preview-item">
                                    <span class="preview-label">{% trans "Drop Time:" %}</span>
                                    <span id="preview-drop">{% trans "Not specified" %}</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="d-flex justify-content-between align-items-center mt-4">
                            {% if object %}
                            <a href="{% url 'transport:route_detail' object.route.pk %}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i>
                                {% trans "Back to Route" %}
                            </a>
                            {% else %}
                            <a href="{% url 'transport:route_detail' route.pk %}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i>
                                {% trans "Back to Route" %}
                            </a>
                            {% endif %}
                            
                            <div class="d-flex gap-2">
                                {% if object %}
                                <a href="{% url 'transport:routestop_delete' object.pk %}" class="btn btn-outline-danger">
                                    <i class="fas fa-trash me-2"></i>
                                    {% trans "Delete Stop" %}
                                </a>
                                {% endif %}
                                
                                <button type="submit" class="btn btn-primary btn-submit">
                                    <i class="fas fa-save me-2"></i>
                                    {% if object %}{% trans "Update Stop" %}{% else %}{% trans "Create Stop" %}{% endif %}
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Right Column - Help and Existing Stops -->
        <div class="col-lg-4">
            <!-- Help Section -->
            <div class="card stop-form-card">
                <div class="card-body">
                    <h5 class="card-title">{% trans "Stop Guidelines" %}</h5>
                    
                    <div class="mb-3">
                        <h6><i class="fas fa-lightbulb text-warning me-2"></i>{% trans "Best Practices" %}</h6>
                        <ul class="small text-muted">
                            <li>{% trans "Use clear, recognizable stop names" %}</li>
                            <li>{% trans "Maintain logical sequence order" %}</li>
                            <li>{% trans "Ensure accurate timing estimates" %}</li>
                            <li>{% trans "Verify coordinates for GPS accuracy" %}</li>
                        </ul>
                    </div>
                    
                    <div class="mb-3">
                        <h6><i class="fas fa-exclamation-triangle text-danger me-2"></i>{% trans "Common Issues" %}</h6>
                        <ul class="small text-muted">
                            <li>{% trans "Sequence conflicts with existing stops" %}</li>
                            <li>{% trans "Inaccurate timing causing delays" %}</li>
                            <li>{% trans "Missing or incorrect coordinates" %}</li>
                            <li>{% trans "Unsafe stop locations" %}</li>
                        </ul>
                    </div>
                    
                    <div class="mb-3">
                        <h6><i class="fas fa-question-circle text-info me-2"></i>{% trans "Timing Tips" %}</h6>
                        <p class="small text-muted mb-2">
                            {% trans "Consider traffic patterns, student wait times, and route efficiency when setting stop timings." %}
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Existing Stops -->
            {% if existing_stops %}
            <div class="card stop-form-card mt-4">
                <div class="card-body">
                    <h5 class="card-title d-flex justify-content-between align-items-center">
                        <span>{% trans "Existing Stops" %}</span>
                        <span class="badge bg-primary">{{ existing_stops|length }}</span>
                    </h5>
                    <p class="text-muted small mb-3">{% trans "Current stops on this route:" %}</p>
                    
                    <div class="existing-stops">
                        {% for stop in existing_stops %}
                        <div class="existing-stop">
                            <div class="sequence-badge" style="background-color: {% if stop.sequence == form.sequence.value %} #dc3545 {% else %} #6c757d {% endif %};">
                                {{ stop.sequence }}
                            </div>
                            <div class="flex-grow-1">
                                <strong class="d-block">{{ stop.name }}</strong>
                                <small class="stop-time">
                                    {{ stop.estimated_arrival_time|time:"H:i" }}
                                    {% if stop.pickup_time %}| Pickup: {{ stop.pickup_time|time:"H:i" }}{% endif %}
                                    {% if stop.drop_time %}| Drop: {{ stop.drop_time|time:"H:i" }}{% endif %}
                                </small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <div class="text-center mt-3">
                        <small class="text-muted">
                            {% trans "Sequence" %} <span class="text-danger">‚óè</span> {% trans "indicates conflict" %}
                        </small>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Quick Actions -->
            <div class="card stop-form-card mt-4">
                <div class="card-body">
                    <h5 class="card-title">{% trans "Quick Actions" %}</h5>
                    <div class="d-grid gap-2">
                        {% if object %}
                        <a href="{% url 'transport:route_detail' object.route.pk %}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-route me-1"></i> {% trans "View Route" %}
                        </a>
                        {% else %}
                        <a href="{% url 'transport:route_detail' route.pk %}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-route me-1"></i> {% trans "View Route" %}
                        </a>
                        {% endif %}
                        <button class="btn btn-outline-info btn-sm" id="autoSequence">
                            <i class="fas fa-magic me-1"></i> {% trans "Auto Sequence" %}
                        </button>
                        <button class="btn btn-outline-success btn-sm" id="copyPrevious">
                            <i class="fas fa-copy me-1"></i> {% trans "Copy Previous Stop" %}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Form elements
        const nameInput = document.getElementById('{{ form.name.id_for_label }}');
        const sequenceInput = document.getElementById('{{ form.sequence.id_for_label }}');
        const addressInput = document.getElementById('{{ form.address.id_for_label }}');
        const latitudeInput = document.getElementById('{{ form.latitude.id_for_label }}');
        const longitudeInput = document.getElementById('{{ form.longitude.id_for_label }}');
        const arrivalTimeInput = document.getElementById('{{ form.estimated_arrival_time.id_for_label }}');
        const pickupTimeInput = document.getElementById('{{ form.pickup_time.id_for_label }}');
        const dropTimeInput = document.getElementById('{{ form.drop_time.id_for_label }}');
        const statusInput = document.getElementById('{{ form.status.id_for_label }}');
        
        // Sequence controls
        const decrementBtn = document.getElementById('decrementSequence');
        const incrementBtn = document.getElementById('incrementSequence');
        
        // Update preview function
        function updatePreview() {
            document.getElementById('preview-sequence').textContent = sequenceInput.value || '1';
            document.getElementById('preview-name').textContent = nameInput.value || '{% trans "Stop Name" %}';
            document.getElementById('preview-address').textContent = addressInput.value || '{% trans "Not specified" %}';
            
            // Coordinates
            const lat = latitudeInput.value;
            const lng = longitudeInput.value;
            if (lat && lng) {
                document.getElementById('preview-coordinates').textContent = `${lat}, ${lng}`;
            } else {
                document.getElementById('preview-coordinates').textContent = '{% trans "Not specified" %}';
            }
            
            // Times
            document.getElementById('preview-arrival').textContent = arrivalTimeInput.value || '{% trans "Not specified" %}';
            document.getElementById('preview-pickup').textContent = pickupTimeInput.value || '{% trans "Not specified" %}';
            document.getElementById('preview-drop').textContent = dropTimeInput.value || '{% trans "Not specified" %}';
            
            // Status
            const statusText = statusInput.options[statusInput.selectedIndex].text;
            document.getElementById('preview-status').textContent = statusText;
            
            // Show validation section
            document.getElementById('validation-section').style.display = 'block';
        }
        
        // Sequence controls
        decrementBtn.addEventListener('click', function() {
            const currentValue = parseInt(sequenceInput.value) || 1;
            if (currentValue > 1) {
                sequenceInput.value = currentValue - 1;
                updatePreview();
                validateSequence();
            }
        });
        
        incrementBtn.addEventListener('click', function() {
            const currentValue = parseInt(sequenceInput.value) || 1;
            sequenceInput.value = currentValue + 1;
            updatePreview();
            validateSequence();
        });
        
        // Sequence validation
        function validateSequence() {
            const currentSequence = parseInt(sequenceInput.value) || 1;
            const validationAlert = document.getElementById('validation-alert');
            
            // Check for conflicts with existing stops
            const conflictingStop = document.querySelector(`.existing-stop .sequence-badge[style*="background-color: #dc3545"]`);
            
            if (conflictingStop) {
                validationAlert.className = 'alert alert-danger validation-alert';
                validationAlert.innerHTML = `
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>{% trans "Sequence Conflict!" %}</strong>
                    <p class="mb-0 mt-1">{% trans "This sequence number is already used by another stop. Please choose a different sequence." %}</p>
                `;
                return false;
            } else {
                validationAlert.className = 'alert alert-success success-alert';
                validationAlert.innerHTML = `
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>{% trans "Sequence Available" %}</strong>
                    <p class="mb-0 mt-1">{% trans "This sequence number is available for use." %}</p>
                `;
                return true;
            }
        }
        
        // Location services
        document.getElementById('getCurrentLocation').addEventListener('click', function() {
            if (navigator.geolocation) {
                this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>{% trans "Getting location..." %}';
                this.disabled = true;
                
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        latitudeInput.value = position.coords.latitude.toFixed(6);
                        longitudeInput.value = position.coords.longitude.toFixed(6);
                        updatePreview();
                        
                        document.getElementById('getCurrentLocation').innerHTML = '<i class="fas fa-location-arrow me-1"></i>{% trans "Use Current Location" %}';
                        document.getElementById('getCurrentLocation').disabled = false;
                    },
                    function(error) {
                        alert('{% trans "Unable to retrieve your location. Please enter coordinates manually." %}');
                        document.getElementById('getCurrentLocation').innerHTML = '<i class="fas fa-location-arrow me-1"></i>{% trans "Use Current Location" %}';
                        document.getElementById('getCurrentLocation').disabled = false;
                    }
                );
            } else {
                alert('{% trans "Geolocation is not supported by your browser." %}');
            }
        });
        
        // Geocode address (simulated)
        document.getElementById('geocodeAddress').addEventListener('click', function() {
            if (!addressInput.value.trim()) {
                alert('{% trans "Please enter an address first." %}');
                return;
            }
            
            this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>{% trans "Geocoding..." %}';
            this.disabled = true;
            
            // Simulate geocoding API call
            setTimeout(() => {
                // In a real implementation, this would call a geocoding service
                // For now, we'll use mock coordinates
                latitudeInput.value = (40 + Math.random()).toFixed(6);
                longitudeInput.value = (-74 + Math.random()).toFixed(6);
                updatePreview();
                
                this.innerHTML = '<i class="fas fa-search me-1"></i>{% trans "Geocode Address" %}';
                this.disabled = false;
            }, 1500);
        });
        
        // Auto sequence
        document.getElementById('autoSequence').addEventListener('click', function() {
            const existingStops = {{ existing_stops|length|default:0 }};
            sequenceInput.value = existingStops + 1;
            updatePreview();
            validateSequence();
        });
        
        // Copy previous stop (simulated)
        document.getElementById('copyPrevious').addEventListener('click', function() {
            if ({{ existing_stops|length|default:0 }} > 0) {
                // In a real implementation, this would copy data from the previous stop
                arrivalTimeInput.value = '07:30';
                pickupTimeInput.value = '07:35';
                dropTimeInput.value = '15:45';
                updatePreview();
                alert('{% trans "Previous stop timings copied. Please adjust as needed." %}');
            } else {
                alert('{% trans "No previous stops available to copy from." %}');
            }
        });
        
        // Real-time preview updates
        const formInputs = [nameInput, sequenceInput, addressInput, latitudeInput, longitudeInput, 
                           arrivalTimeInput, pickupTimeInput, dropTimeInput, statusInput];
        
        formInputs.forEach(input => {
            if (input) {
                input.addEventListener('input', updatePreview);
                input.addEventListener('change', updatePreview);
            }
        });
        
        // Special handling for sequence validation
        if (sequenceInput) {
            sequenceInput.addEventListener('change', validateSequence);
        }
        
        // Form submission validation
        document.getElementById('stopForm').addEventListener('submit', function(e) {
            if (!validateSequence()) {
                e.preventDefault();
                alert('{% trans "Please fix the sequence conflict before submitting." %}');
                return;
            }
            
            // Additional validation can be added here
            if (!nameInput.value.trim()) {
                e.preventDefault();
                alert('{% trans "Please enter a stop name." %}');
                nameInput.focus();
                return;
            }
            
            if (!arrivalTimeInput.value) {
                e.preventDefault();
                alert('{% trans "Please specify an estimated arrival time." %}');
                arrivalTimeInput.focus();
                return;
            }
        });
        
        // Initialize preview
        updatePreview();
        validateSequence();
        
        // Add animation to form sections
        const formSections = document.querySelectorAll('.form-section');
        
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.style.opacity = '1';
                    entry.target.style.transform = 'translateX(0)';
                }
            });
        }, { threshold: 0.1 });
        
        formSections.forEach(section => {
            section.style.opacity = '0';
            section.style.transform = 'translateX(-20px)';
            section.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
            observer.observe(section);
        });
    });
</script>
{% endblock %}