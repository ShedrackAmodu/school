<!-- templates/transport/incidentreports/incidentreport_form.html -->
{% extends 'base/base.html' %}
{% load static %}
{% load i18n %}

{% block title %}
    {% if object %}{% trans "Update Incident Report" %}{% else %}{% trans "Create Incident Report" %}{% endif %}
{% endblock %}

{% block page_title %}
    {% if object %}{% trans "Update Incident Report" %}{% else %}{% trans "Create Incident Report" %}{% endif %}
{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'users:dashboard' %}">{% trans "Home" %}</a></li>
<li class="breadcrumb-item"><a href="{% url 'transport:dashboard' %}">{% trans "Transport" %}</a></li>
<li class="breadcrumb-item"><a href="{% url 'transport:incidentreport_list' %}">{% trans "Incident Reports" %}</a></li>
<li class="breadcrumb-item active" aria-current="page">
    {% if object %}{% trans "Update Report" %}{% else %}{% trans "Create Report" %}{% endif %}
</li>
{% endblock %}

{% block extra_css %}
<style>
    /* Incident Report Form Specific Styles */
    .incident-form-container {
        max-width: 1000px;
        margin: 0 auto;
    }
    
    .form-section {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .form-section-header {
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 0.75rem;
        margin-bottom: 1.25rem;
    }
    
    .form-section-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #2c3e50;
        margin: 0;
    }
    
    .form-section-subtitle {
        font-size: 0.875rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }
    
    .required-field::after {
        content: " *";
        color: #dc3545;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }
    
    .severity-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
    }
    
    .severity-low { background-color: #28a745; }
    .severity-medium { background-color: #ffc107; }
    .severity-high { background-color: #fd7e14; }
    .severity-critical { background-color: #dc3545; }
    
    .students-affected-container {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 0.75rem;
    }
    
    .form-actions {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1.25rem;
        margin-top: 1.5rem;
        border-top: 1px solid #dee2e6;
    }
    
    .incident-preview {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
        border-left: 4px solid #0d6efd;
    }
    
    .preview-field {
        margin-bottom: 0.5rem;
    }
    
    .preview-label {
        font-weight: 600;
        color: #495057;
    }
    
    .preview-value {
        color: #6c757d;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .form-section {
            padding: 1rem;
        }
        
        .form-section-title {
            font-size: 1.1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="incident-form-container">
    <form method="post" id="incidentReportForm" novalidate>
        {% csrf_token %}
        
        <!-- Incident Information Section -->
        <div class="form-section">
            <div class="form-section-header">
                <h3 class="form-section-title">{% trans "Incident Information" %}</h3>
                <p class="form-section-subtitle">{% trans "Basic details about the incident" %}</p>
            </div>
            
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="{{ form.route_schedule.id_for_label }}" class="form-label required-field">
                        {% trans "Route Schedule" %}
                    </label>
                    {{ form.route_schedule }}
                    {% if form.route_schedule.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.route_schedule.errors }}
                    </div>
                    {% endif %}
                </div>
                
                <div class="col-md-6">
                    <label for="{{ form.incident_type.id_for_label }}" class="form-label required-field">
                        {% trans "Incident Type" %}
                    </label>
                    {{ form.incident_type }}
                    {% if form.incident_type.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.incident_type.errors }}
                    </div>
                    {% endif %}
                </div>
                
                <div class="col-md-6">
                    <label for="{{ form.severity.id_for_label }}" class="form-label required-field">
                        {% trans "Severity Level" %}
                    </label>
                    {{ form.severity }}
                    {% if form.severity.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.severity.errors }}
                    </div>
                    {% endif %}
                </div>
                
                <div class="col-md-6">
                    <label for="{{ form.location.id_for_label }}" class="form-label required-field">
                        {% trans "Location" %}
                    </label>
                    {{ form.location }}
                    {% if form.location.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.location.errors }}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Time and Date Section -->
        <div class="form-section">
            <div class="form-section-header">
                <h3 class="form-section-title">{% trans "Time and Date" %}</h3>
                <p class="form-section-subtitle">{% trans "When did the incident occur?" %}</p>
            </div>
            
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="{{ form.date.id_for_label }}" class="form-label required-field">
                        {% trans "Date" %}
                    </label>
                    {{ form.date }}
                    {% if form.date.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.date.errors }}
                    </div>
                    {% endif %}
                </div>
                
                <div class="col-md-6">
                    <label for="{{ form.time.id_for_label }}" class="form-label required-field">
                        {% trans "Time" %}
                    </label>
                    {{ form.time }}
                    {% if form.time.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.time.errors }}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Incident Details Section -->
        <div class="form-section">
            <div class="form-section-header">
                <h3 class="form-section-title">{% trans "Incident Details" %}</h3>
                <p class="form-section-subtitle">{% trans "Describe what happened and actions taken" %}</p>
            </div>
            
            <div class="row g-3">
                <div class="col-12">
                    <label for="{{ form.description.id_for_label }}" class="form-label required-field">
                        {% trans "Description" %}
                    </label>
                    {{ form.description }}
                    {% if form.description.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.description.errors }}
                    </div>
                    {% endif %}
                    <div class="form-text">{% trans "Provide a detailed description of the incident" %}</div>
                </div>
                
                <div class="col-12">
                    <label for="{{ form.action_taken.id_for_label }}" class="form-label required-field">
                        {% trans "Action Taken" %}
                    </label>
                    {{ form.action_taken }}
                    {% if form.action_taken.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.action_taken.errors }}
                    </div>
                    {% endif %}
                    <div class="form-text">{% trans "Describe the immediate actions taken in response to the incident" %}</div>
                </div>
            </div>
        </div>
        
        <!-- Affected Parties Section -->
        <div class="form-section">
            <div class="form-section-header">
                <h3 class="form-section-title">{% trans "Affected Parties" %}</h3>
                <p class="form-section-subtitle">{% trans "Students and personnel involved in the incident" %}</p>
            </div>
            
            <div class="row g-3">
                <div class="col-12">
                    <label for="{{ form.students_affected.id_for_label }}" class="form-label">
                        {% trans "Students Affected" %}
                    </label>
                    <div class="students-affected-container">
                        {{ form.students_affected }}
                    </div>
                    {% if form.students_affected.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.students_affected.errors }}
                    </div>
                    {% endif %}
                    <div class="form-text">{% trans "Select students who were affected by this incident" %}</div>
                </div>
            </div>
        </div>
        
        <!-- Follow-up Section -->
        <div class="form-section">
            <div class="form-section-header">
                <h3 class="form-section-title">{% trans "Follow-up Information" %}</h3>
                <p class="form-section-subtitle">{% trans "Additional actions and notes" %}</p>
            </div>
            
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="form-check form-switch">
                        {{ form.follow_up_required }}
                        <label class="form-check-label" for="{{ form.follow_up_required.id_for_label }}">
                            {% trans "Follow-up Required" %}
                        </label>
                    </div>
                    {% if form.follow_up_required.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.follow_up_required.errors }}
                    </div>
                    {% endif %}
                </div>
                
                <div class="col-12">
                    <label for="{{ form.follow_up_notes.id_for_label }}" class="form-label">
                        {% trans "Follow-up Notes" %}
                    </label>
                    {{ form.follow_up_notes }}
                    {% if form.follow_up_notes.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.follow_up_notes.errors }}
                    </div>
                    {% endif %}
                    <div class="form-text">{% trans "Additional notes for follow-up actions" %}</div>
                </div>
            </div>
        </div>
        
        <!-- Incident Preview -->
        <div class="form-section" id="incidentPreview" style="display: none;">
            <div class="form-section-header">
                <h3 class="form-section-title">{% trans "Incident Preview" %}</h3>
                <p class="form-section-subtitle">{% trans "Review the incident details before submitting" %}</p>
            </div>
            
            <div class="incident-preview">
                <div class="row">
                    <div class="col-md-6 preview-field">
                        <span class="preview-label">{% trans "Route Schedule:" %}</span>
                        <span class="preview-value" id="previewRouteSchedule"></span>
                    </div>
                    <div class="col-md-6 preview-field">
                        <span class="preview-label">{% trans "Incident Type:" %}</span>
                        <span class="preview-value" id="previewIncidentType"></span>
                    </div>
                    <div class="col-md-6 preview-field">
                        <span class="preview-label">{% trans "Severity:" %}</span>
                        <span class="preview-value" id="previewSeverity"></span>
                    </div>
                    <div class="col-md-6 preview-field">
                        <span class="preview-label">{% trans "Location:" %}</span>
                        <span class="preview-value" id="previewLocation"></span>
                    </div>
                    <div class="col-md-6 preview-field">
                        <span class="preview-label">{% trans "Date:" %}</span>
                        <span class="preview-value" id="previewDate"></span>
                    </div>
                    <div class="col-md-6 preview-field">
                        <span class="preview-label">{% trans "Time:" %}</span>
                        <span class="preview-value" id="previewTime"></span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Form Actions -->
        <div class="form-actions">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <button type="button" class="btn btn-outline-secondary" id="previewBtn">
                        <i class="fas fa-eye me-1"></i> {% trans "Preview" %}
                    </button>
                </div>
                <div>
                    <a href="{% url 'transport:incidentreport_list' %}" class="btn btn-secondary me-2">
                        <i class="fas fa-times me-1"></i> {% trans "Cancel" %}
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i> 
                        {% if object %}{% trans "Update Incident Report" %}{% else %}{% trans "Create Incident Report" %}{% endif %}
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Form validation
        const form = document.getElementById('incidentReportForm');
        const requiredFields = form.querySelectorAll('.required-field');
        
        // Add Bootstrap validation classes
        form.addEventListener('submit', function(event) {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            form.classList.add('was-validated');
        });
        
        // Preview functionality
        const previewBtn = document.getElementById('previewBtn');
        const previewSection = document.getElementById('incidentPreview');
        
        previewBtn.addEventListener('click', function() {
            updatePreview();
            previewSection.style.display = 'block';
            
            // Scroll to preview
            previewSection.scrollIntoView({ behavior: 'smooth' });
        });
        
        function updatePreview() {
            // Get form values and update preview
            const routeScheduleSelect = document.getElementById('{{ form.route_schedule.id_for_label }}');
            const incidentTypeSelect = document.getElementById('{{ form.incident_type.id_for_label }}');
            const severitySelect = document.getElementById('{{ form.severity.id_for_label }}');
            const locationInput = document.getElementById('{{ form.location.id_for_label }}');
            const dateInput = document.getElementById('{{ form.date.id_for_label }}');
            const timeInput = document.getElementById('{{ form.time.id_for_label }}');
            
            // Update preview elements
            document.getElementById('previewRouteSchedule').textContent = 
                routeScheduleSelect.options[routeScheduleSelect.selectedIndex].text;
            document.getElementById('previewIncidentType').textContent = 
                incidentTypeSelect.options[incidentTypeSelect.selectedIndex].text;
            document.getElementById('previewSeverity').textContent = 
                severitySelect.options[severitySelect.selectedIndex].text;
            document.getElementById('previewLocation').textContent = locationInput.value;
            document.getElementById('previewDate').textContent = dateInput.value;
            document.getElementById('previewTime').textContent = timeInput.value;
        }
        
        // Auto-save draft functionality
        let autoSaveTimer;
        const formInputs = form.querySelectorAll('input, select, textarea');
        
        formInputs.forEach(input => {
            input.addEventListener('input', function() {
                clearTimeout(autoSaveTimer);
                autoSaveTimer = setTimeout(saveDraft, 2000);
            });
        });
        
        function saveDraft() {
            // In a real implementation, this would save the form data to localStorage or send to server
            console.log('Auto-saving draft...');
            
            // Show saving indicator
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-save me-1"></i> {% trans "Saving..." %}';
            
            setTimeout(() => {
                submitBtn.innerHTML = originalText;
                
                // Show success message
                showNotification('{% trans "Draft saved successfully" %}', 'success');
            }, 500);
        }
        
        // Severity level indicator
        const severitySelect = document.getElementById('{{ form.severity.id_for_label }}');
        const severityIndicator = document.createElement('span');
        severityIndicator.className = 'severity-indicator';
        severitySelect.parentNode.insertBefore(severityIndicator, severitySelect);
        
        function updateSeverityIndicator() {
            const severity = severitySelect.value;
            severityIndicator.className = 'severity-indicator';
            
            if (severity === 'low') {
                severityIndicator.classList.add('severity-low');
            } else if (severity === 'medium') {
                severityIndicator.classList.add('severity-medium');
            } else if (severity === 'high') {
                severityIndicator.classList.add('severity-high');
            } else if (severity === 'critical') {
                severityIndicator.classList.add('severity-critical');
            }
        }
        
        severitySelect.addEventListener('change', updateSeverityIndicator);
        updateSeverityIndicator(); // Initialize on page load
        
        // Date and time validation
        const dateInput = document.getElementById('{{ form.date.id_for_label }}');
        const timeInput = document.getElementById('{{ form.time.id_for_label }}');
        
        function validateDateTime() {
            const selectedDate = new Date(dateInput.value);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            if (selectedDate > today) {
                dateInput.setCustomValidity('{% trans "Incident date cannot be in the future" %}');
            } else {
                dateInput.setCustomValidity('');
            }
        }
        
        dateInput.addEventListener('change', validateDateTime);
        timeInput.addEventListener('change', validateDateTime);
        
        // Initialize form with today's date if creating new incident
        {% if not object %}
        const today = new Date().toISOString().split('T')[0];
        dateInput.value = today;
        
        // Set current time
        const now = new Date();
        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = now.getMinutes().toString().padStart(2, '0');
        timeInput.value = `${hours}:${minutes}`;
        {% endif %}
        
        // Notification function
        function showNotification(message, type) {
            // Create and show a temporary notification
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 1060; min-width: 300px;';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(notification);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }
        
        // Initialize Select2 for students_affected if available
        if (typeof $.fn.select2 !== 'undefined') {
            $('#{{ form.students_affected.id_for_label }}').select2({
                placeholder: '{% trans "Select affected students" %}',
                allowClear: true,
                width: '100%'
            });
        }
    });
</script>
{% endblock %}