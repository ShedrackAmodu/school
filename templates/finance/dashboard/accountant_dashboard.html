{% extends 'base.html' %}
{% load i18n %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="h3 mb-4 text-gray-800">{{ title }}</h1>

    <div class="row">
        <!-- Total Invoiced Card -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                {% translate "Total Invoiced" %} ({{ current_session.name }})
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">${{ total_invoiced|floatformat:2 }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-file-invoice fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Total Paid Card -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                {% translate "Total Paid" %} ({{ current_session.name }})
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">${{ total_paid|floatformat:2 }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-dollar-sign fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Total Outstanding Card -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                {% translate "Total Outstanding" %} ({{ current_session.name }})
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">${{ total_outstanding|floatformat:2 }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Overdue Invoices Card -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-danger shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                                {% translate "Overdue Invoices" %}
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ overdue_invoices_count }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-calendar-times fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Recent Invoices -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">{% translate "Recent Invoices" %}</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered" id="recentInvoicesTable" width="100%" cellspacing="0">
                            <thead>
                                <tr>
                                    <th>{% translate "Invoice #" %}</th>
                                    <th>{% translate "Student" %}</th>
                                    <th>{% translate "Amount" %}</th>
                                    <th>{% translate "Due Date" %}</th>
                                    <th>{% translate "Status" %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for invoice in recent_invoices %}
                                <tr>
                                    <td><a href="{% url 'finance:invoice_detail' pk=invoice.pk %}">{{ invoice.invoice_number }}</a></td>
                                    <td>{{ invoice.student.user.get_full_name }}</td>
                                    <td>${{ invoice.total_amount|floatformat:2 }}</td>
                                    <td>{{ invoice.due_date|date:"M d, Y" }}</td>
                                    <td><span class="badge badge-{{ invoice.get_status_display|lower }}">{{ invoice.get_status_display }}</span></td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5">{% translate "No recent invoices." %}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="text-right">
                        <a href="{% url 'finance:invoice_list' %}" class="btn btn-sm btn-primary">{% translate "View All Invoices" %} &rarr;</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Payments -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">{% translate "Recent Payments" %}</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered" id="recentPaymentsTable" width="100%" cellspacing="0">
                            <thead>
                                <tr>
                                    <th>{% translate "Payment #" %}</th>
                                    <th>{% translate "Student" %}</th>
                                    <th>{% translate "Amount" %}</th>
                                    <th>{% translate "Date" %}</th>
                                    <th>{% translate "Method" %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for payment in recent_payments %}
                                <tr>
                                    <td><a href="{% url 'finance:payment_detail' pk=payment.pk %}">{{ payment.payment_number }}</a></td>
                                    <td>{{ payment.student.user.get_full_name }}</td>
                                    <td>${{ payment.amount|floatformat:2 }}</td>
                                    <td>{{ payment.payment_date|date:"M d, Y" }}</td>
                                    <td>{{ payment.get_payment_method_display }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5">{% translate "No recent payments." %}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="text-right">
                        <a href="{% url 'finance:payment_list' %}" class="btn btn-sm btn-primary">{% translate "View All Payments" %} &rarr;</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Monthly Expense Summary -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">{% translate "Monthly Expense Summary" %}</h6>
                </div>
                <div class="card-body">
                    <p>{% translate "Total expenses this month" %}: <strong>${{ total_expenses|floatformat:2 }}</strong></p>
                    <canvas id="expenseChart"></canvas>
                    <div class="text-right mt-3">
                        <a href="{% url 'finance:expense_list' %}" class="btn btn-sm btn-primary">{% translate "View All Expenses" %} &rarr;</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">{% translate "Quick Actions" %}</h6>
                </div>
                <div class="card-body">
                    <div class="list-group">
                        <a href="{% url 'finance:invoice_create' %}" class="list-group-item list-group-item-action">
                            <i class="fas fa-plus-circle mr-2"></i> {% translate "Create New Invoice" %}
                        </a>
                        <a href="{% url 'finance:payment_create' invoice_pk='00000000-0000-0000-0000-000000000000' %}" class="list-group-item list-group-item-action">
                            <i class="fas fa-money-bill-wave mr-2"></i> {% translate "Record New Payment" %}
                        </a>
                        <a href="{% url 'finance:expense_create' %}" class="list-group-item list-group-item-action">
                            <i class="fas fa-cash-register mr-2"></i> {% translate "Add New Expense" %}
                        </a>
                        <a href="{% url 'finance:feestructure_list' %}" class="list-group-item list-group-item-action">
                            <i class="fas fa-cogs mr-2"></i> {% translate "Manage Fee Structures" %}
                        </a>
                        <a href="{% url 'finance:feediscount_list' %}" class="list-group-item list-group-item-action">
                            <i class="fas fa-tags mr-2"></i> {% translate "Manage Fee Discounts" %}
                        </a>
                        <a href="{% url 'finance:financialreport_list' %}" class="list-group-item list-group-item-action">
                            <i class="fas fa-chart-line mr-2"></i> {% translate "View Financial Reports" %}
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Placeholder for dynamic expense data
        var expenseChart; // Declare chart variable globally or in a scope accessible for updates

        function loadExpenseSummary() {
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth() + 1; // Month is 0-indexed

            // Construct start and end dates for the current month
            const startDate = `${year}-${String(month).padStart(2, '0')}-01`;
            const endDate = `${year}-${String(month).padStart(2, '0')}-${new Date(year, month, 0).getDate()}`;

            fetch(`{% url "finance:api_expense_summary" %}?start_date=${startDate}&end_date=${endDate}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const labels = data.category_summary.map(item => item.category);
                        const values = data.category_summary.map(item => parseFloat(item.total));

                        const backgroundColors = [
                            'rgba(255, 99, 132, 0.8)', 'rgba(54, 162, 235, 0.8)', 'rgba(255, 206, 86, 0.8)',
                            'rgba(75, 192, 192, 0.8)', 'rgba(153, 102, 255, 0.8)', 'rgba(255, 159, 64, 0.8)'
                        ];
                        const borderColors = [
                            'rgba(255, 99, 132, 1)', 'rgba(54, 162, 235, 1)', 'rgba(255, 206, 86, 1)',
                            'rgba(75, 192, 192, 1)', 'rgba(153, 102, 255, 1)', 'rgba(255, 159, 64, 1)'
                        ];

                        const expenseData = {
                            labels: labels,
                            datasets: [{
                                label: '{% translate "Expenses by Category" %}',
                                data: values,
                                backgroundColor: backgroundColors.slice(0, labels.length),
                                borderColor: borderColors.slice(0, labels.length),
                                borderWidth: 1
                            }]
                        };

                        const expenseConfig = {
                            type: 'doughnut',
                            data: expenseData,
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: {
                                        position: 'top',
                                    },
                                    title: {
                                        display: true,
                                        text: '{% translate "Expense Distribution" %}'
                                    }
                                }
                            },
                        };

                        if (expenseChart) {
                            expenseChart.destroy(); // Destroy existing chart before creating a new one
                        }
                        expenseChart = new Chart(
                            document.getElementById('expenseChart'),
                            expenseConfig
                        );
                    } else {
                        console.error('Error fetching expense summary:', data.message);
                    }
                })
                .catch(error => console.error('Error fetching expense summary:', error));
        }

        loadExpenseSummary(); // Load data when the page loads
    });
</script>
{% endblock %}
