{% extends 'base.html' %}
{% load static %}

{% block title %}
    {% if form.instance.pk %}
        Edit Fee Structure - {{ form.instance.name }}
    {% else %}
        Create Fee Structure
    {% endif %}
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        {% if form.instance.pk %}
                            <i class="fas fa-edit"></i> Edit Fee Structure
                        {% else %}
                            <i class="fas fa-plus"></i> Create Fee Structure
                        {% endif %}
                    </h3>
                    <div class="card-tools">
                        <a href="{% url 'finance:feestructure_list' %}" class="btn btn-secondary btn-sm">
                            <i class="fas fa-arrow-left"></i> Back to List
                        </a>
                    </div>
                </div>

                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}

                    <div class="card-body">
                        <div class="row">
                            <!-- Basic Information -->
                            <div class="col-md-6">
                                <h5 class="text-primary"><i class="fas fa-info-circle"></i> Basic Information</h5>

                                <div class="form-group">
                                    <label for="{{ form.name.id_for_label }}">Fee Structure Name *</label>
                                    {{ form.name }}
                                    {% if form.name.errors %}
                                        <div class="text-danger">{{ form.name.errors.0 }}</div>
                                    {% endif %}
                                </div>

                                <div class="form-group">
                                    <label for="{{ form.code.id_for_label }}">Fee Code *</label>
                                    {{ form.code }}
                                    {% if form.code.errors %}
                                        <div class="text-danger">{{ form.code.errors.0 }}</div>
                                    {% endif %}
                                    <small class="form-text text-muted">Unique identifier for this fee structure</small>
                                </div>

                                <div class="form-group">
                                    <label for="{{ form.fee_type.id_for_label }}">Fee Type *</label>
                                    {{ form.fee_type }}
                                    {% if form.fee_type.errors %}
                                        <div class="text-danger">{{ form.fee_type.errors.0 }}</div>
                                    {% endif %}
                                </div>

                                <div class="form-group">
                                    <label for="{{ form.academic_session.id_for_label }}">Academic Session *</label>
                                    {{ form.academic_session }}
                                    {% if form.academic_session.errors %}
                                        <div class="text-danger">{{ form.academic_session.errors.0 }}</div>
                                    {% endif %}
                                </div>

                                <div class="form-group">
                                    <label for="{{ form.applicable_class.id_for_label }}">Applicable Class</label>
                                    {{ form.applicable_class }}
                                    {% if form.applicable_class.errors %}
                                        <div class="text-danger">{{ form.applicable_class.errors.0 }}</div>
                                    {% endif %}
                                    <small class="form-text text-muted">Leave blank if applicable to all classes</small>
                                </div>
                            </div>

                            <!-- Financial Details -->
                            <div class="col-md-6">
                                <h5 class="text-primary"><i class="fas fa-dollar-sign"></i> Financial Details</h5>

                                <div class="form-group">
                                    <label for="{{ form.amount.id_for_label }}">Amount *</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text">₦</span>
                                        </div>
                                        {{ form.amount }}
                                    </div>
                                    {% if form.amount.errors %}
                                        <div class="text-danger">{{ form.amount.errors.0 }}</div>
                                    {% endif %}
                                </div>

                                <div class="form-group">
                                    <label for="{{ form.billing_cycle.id_for_label }}">Billing Cycle *</label>
                                    {{ form.billing_cycle }}
                                    {% if form.billing_cycle.errors %}
                                        <div class="text-danger">{{ form.billing_cycle.errors.0 }}</div>
                                    {% endif %}
                                </div>

                                <div class="form-group">
                                    <label for="{{ form.due_day.id_for_label }}">Due Day of Month *</label>
                                    {{ form.due_day }}
                                    {% if form.due_day.errors %}
                                        <div class="text-danger">{{ form.due_day.errors.0 }}</div>
                                    {% endif %}
                                    <small class="form-text text-muted">Day of the month when payment is due (1-31)</small>
                                </div>

                                <div class="form-group">
                                    <label for="{{ form.tax_rate.id_for_label }}">Tax Rate (%)</label>
                                    <div class="input-group">
                                        {{ form.tax_rate }}
                                        <div class="input-group-append">
                                            <span class="input-group-text">%</span>
                                        </div>
                                    </div>
                                    {% if form.tax_rate.errors %}
                                        <div class="text-danger">{{ form.tax_rate.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <!-- Additional Settings -->
                            <div class="col-md-6">
                                <h5 class="text-primary"><i class="fas fa-cogs"></i> Additional Settings</h5>

                                <div class="form-group">
                                    <div class="custom-control custom-checkbox">
                                        {{ form.is_optional }}
                                        <label class="custom-control-label" for="{{ form.is_optional.id_for_label }}">
                                            Is Optional
                                        </label>
                                    </div>
                                    <small class="form-text text-muted">Students can choose whether to pay this fee</small>
                                </div>

                                <div class="form-group">
                                    <div class="custom-control custom-checkbox">
                                        {{ form.discount_eligible }}
                                        <label class="custom-control-label" for="{{ form.discount_eligible.id_for_label }}">
                                            Discount Eligible
                                        </label>
                                    </div>
                                    <small class="form-text text-muted">This fee can be discounted</small>
                                </div>

                                <div class="form-group">
                                    <label for="{{ form.late_fee_per_day.id_for_label }}">Late Fee Per Day</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text">₦</span>
                                        </div>
                                        {{ form.late_fee_per_day }}
                                    </div>
                                    {% if form.late_fee_per_day.errors %}
                                        <div class="text-danger">{{ form.late_fee_per_day.errors.0 }}</div>
                                    {% endif %}
                                </div>

                                <div class="form-group">
                                    <label for="{{ form.max_late_fee.id_for_label }}">Maximum Late Fee</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text">₦</span>
                                        </div>
                                        {{ form.max_late_fee }}
                                    </div>
                                    {% if form.max_late_fee.errors %}
                                        <div class="text-danger">{{ form.max_late_fee.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Description -->
                            <div class="col-md-6">
                                <h5 class="text-primary"><i class="fas fa-align-left"></i> Description</h5>

                                <div class="form-group">
                                    <label for="{{ form.description.id_for_label }}">Description</label>
                                    {{ form.description }}
                                    {% if form.description.errors %}
                                        <div class="text-danger">{{ form.description.errors.0 }}</div>
                                    {% endif %}
                                    <small class="form-text text-muted">Optional description of this fee structure</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card-footer">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i>
                            {% if form.instance.pk %}Update{% else %}Create{% endif %} Fee Structure
                        </button>
                        <a href="{% url 'finance:feestructure_list' %}" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Initialize form validation
    $('form').validate({
        rules: {
            name: {
                required: true,
                minlength: 2
            },
            code: {
                required: true,
                minlength: 2
            },
            amount: {
                required: true,
                min: 0.01
            },
            due_day: {
                required: true,
                min: 1,
                max: 31
            }
        },
        messages: {
            name: {
                required: "Please enter a fee structure name",
                minlength: "Name must be at least 2 characters"
            },
            code: {
                required: "Please enter a fee code",
                minlength: "Code must be at least 2 characters"
            },
            amount: {
                required: "Please enter an amount",
                min: "Amount must be greater than 0"
            },
            due_day: {
                required: "Please enter a due day",
                min: "Due day must be between 1 and 31",
                max: "Due day must be between 1 and 31"
            }
        }
    });

    // Auto-generate code from name if empty
    $('#{{ form.name.id_for_label }}').on('input', function() {
        var name = $(this).val();
        var codeField = $('#{{ form.code.id_for_label }}');

        if (codeField.val() === '') {
            var code = name.toUpperCase().replace(/[^A-Z0-9]/g, '').substring(0, 10);
            codeField.val(code);
        }
    });
});
</script>
{% endblock %}
