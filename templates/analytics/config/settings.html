{% extends 'base/base.html' %}
{% load static i18n %}

{% block title %}{% trans "Analytics Settings" %}{% endblock %}

{% block page_title %}{% trans "Analytics Settings" %}{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'analytics:dashboard' %}">{% trans "Analytics" %}</a></li>
<li class="breadcrumb-item active" aria-current="page">{% trans "Settings" %}</li>
{% endblock %}

{% block extra_css %}
<style>
    .settings-section {
        background: var(--bs-card-bg);
        border-radius: 0.5rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        margin-bottom: 1.5rem;
        overflow: hidden;
    }
    
    .settings-section-header {
        background: var(--bs-light);
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--bs-border-color);
    }
    
    .settings-section-body {
        padding: 1.5rem;
    }
    
    .settings-group {
        margin-bottom: 1.5rem;
    }
    
    .settings-group:last-child {
        margin-bottom: 0;
    }
    
    .settings-group-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 1rem;
        color: var(--bs-primary);
        border-bottom: 1px solid var(--bs-border-color);
        padding-bottom: 0.5rem;
    }
    
    .cache-stats {
        background: var(--bs-light);
        border-radius: 0.375rem;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .stat-item {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        border-bottom: 1px solid var(--bs-border-color-translucent);
    }
    
    .stat-item:last-child {
        border-bottom: none;
    }
    
    .stat-label {
        font-weight: 500;
    }
    
    .stat-value {
        font-weight: 600;
    }
    
    .danger-zone {
        border: 1px solid var(--bs-danger);
        border-radius: 0.5rem;
        padding: 1.5rem;
        background: rgba(220, 53, 69, 0.05);
    }
    
    .danger-zone-header {
        color: var(--bs-danger);
        margin-bottom: 1rem;
        font-weight: 600;
    }
    
    .form-check-input:checked {
        background-color: var(--bs-primary);
        border-color: var(--bs-primary);
    }
    
    .btn-clear-cache {
        background-color: var(--bs-warning);
        border-color: var(--bs-warning);
        color: var(--bs-dark);
    }
    
    .btn-clear-cache:hover {
        background-color: #e0a800;
        border-color: #d39e00;
    }
    
    .btn-reset-all {
        background-color: var(--bs-danger);
        border-color: var(--bs-danger);
    }
    
    .btn-reset-all:hover {
        background-color: #c82333;
        border-color: #bd2130;
    }
    
    .settings-preview {
        background: var(--bs-light);
        border-radius: 0.375rem;
        padding: 1rem;
        border-left: 4px solid var(--bs-primary);
    }
    
    .preview-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
    }
    
    .preview-item:last-child {
        margin-bottom: 0;
    }
    
    .preview-label {
        font-weight: 500;
    }
    
    .preview-value {
        color: var(--bs-secondary);
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="settings-section">
            <div class="settings-section-header">
                <h4 class="mb-0">{% trans "Analytics Configuration" %}</h4>
                <p class="mb-0 text-muted">{% trans "Configure system-wide analytics settings and preferences" %}</p>
            </div>
            
            <div class="settings-section-body">
                <form method="post" id="analytics-settings-form">
                    {% csrf_token %}
                    
                    <div class="settings-group">
                        <h5 class="settings-group-title">{% trans "Performance & Caching" %}</h5>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.cache_duration.id_for_label }}" class="form-label">
                                        {{ form.cache_duration.label }}
                                    </label>
                                    {{ form.cache_duration }}
                                    {% if form.cache_duration.help_text %}
                                    <div class="form-text">{{ form.cache_duration.help_text }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.auto_refresh_interval.id_for_label }}" class="form-label">
                                        {{ form.auto_refresh_interval.label }}
                                    </label>
                                    {{ form.auto_refresh_interval }}
                                    {% if form.auto_refresh_interval.help_text %}
                                    <div class="form-text">{{ form.auto_refresh_interval.help_text }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.data_retention_months.id_for_label }}" class="form-label">
                                        {{ form.data_retention_months.label }}
                                    </label>
                                    {{ form.data_retention_months }}
                                    {% if form.data_retention_months.help_text %}
                                    <div class="form-text">{{ form.data_retention_months.help_text }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.max_export_records.id_for_label }}" class="form-label">
                                        {{ form.max_export_records.label }}
                                    </label>
                                    {{ form.max_export_records }}
                                    {% if form.max_export_records.help_text %}
                                    <div class="form-text">{{ form.max_export_records.help_text }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="settings-group">
                        <h5 class="settings-group-title">{% trans "Features & Privacy" %}</h5>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check form-switch mb-3">
                                    {{ form.enable_real_time_analytics }}
                                    <label class="form-check-label" for="{{ form.enable_real_time_analytics.id_for_label }}">
                                        {{ form.enable_real_time_analytics.label }}
                                    </label>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="form-check form-switch mb-3">
                                    {{ form.enable_anonymized_data }}
                                    <label class="form-check-label" for="{{ form.enable_anonymized_data.id_for_label }}">
                                        {{ form.enable_anonymized_data.label }}
                                    </label>
                                    {% if form.enable_anonymized_data.help_text %}
                                    <div class="form-text">{{ form.enable_anonymized_data.help_text }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="settings-group">
                        <h5 class="settings-group-title">{% trans "Settings Preview" %}</h5>
                        
                        <div class="settings-preview">
                            <div class="preview-item">
                                <span class="preview-label">{% trans "Cache Duration:" %}</span>
                                <span class="preview-value" id="preview-cache-duration">60 minutes</span>
                            </div>
                            <div class="preview-item">
                                <span class="preview-label">{% trans "Auto-refresh:" %}</span>
                                <span class="preview-value" id="preview-refresh-interval">15 minutes</span>
                            </div>
                            <div class="preview-item">
                                <span class="preview-label">{% trans "Data Retention:" %}</span>
                                <span class="preview-value" id="preview-data-retention">24 months</span>
                            </div>
                            <div class="preview-item">
                                <span class="preview-label">{% trans "Real-time Analytics:" %}</span>
                                <span class="preview-value" id="preview-real-time">Enabled</span>
                            </div>
                            <div class="preview-item">
                                <span class="preview-label">{% trans "Anonymized Data:" %}</span>
                                <span class="preview-value" id="preview-anonymized">Disabled</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between mt-4">
                        <a href="{% url 'analytics:dashboard' %}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left me-1"></i> {% trans "Back to Dashboard" %}
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-lg me-1"></i> {% trans "Save Settings" %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="settings-section">
            <div class="settings-section-header">
                <h4 class="mb-0">{% trans "Cache Management" %}</h4>
                <p class="mb-0 text-muted">{% trans "Monitor and manage analytics cache performance" %}</p>
            </div>
            
            <div class="settings-section-body">
                <div class="cache-stats">
                    <h6 class="mb-3">{% trans "Cache Statistics" %}</h6>
                    
                    <div class="stat-item">
                        <span class="stat-label">{% trans "Total Cache Entries:" %}</span>
                        <span class="stat-value" id="cache-total">{{ cache_stats.total_entries|default:"0" }}</span>
                    </div>
                    
                    <div class="stat-item">
                        <span class="stat-label">{% trans "Active Entries:" %}</span>
                        <span class="stat-value" id="cache-active">{{ cache_stats.active_entries|default:"0" }}</span>
                    </div>
                    
                    <div class="stat-item">
                        <span class="stat-label">{% trans "Expired Entries:" %}</span>
                        <span class="stat-value" id="cache-expired">{{ cache_stats.expired_entries|default:"0" }}</span>
                    </div>
                    
                    <div class="stat-item">
                        <span class="stat-label">{% trans "Total Cache Size:" %}</span>
                        <span class="stat-value" id="cache-size">{{ cache_stats.total_size|default:"0 B" }}</span>
                    </div>
                    
                    <div class="stat-item">
                        <span class="stat-label">{% trans "Average Access Count:" %}</span>
                        <span class="stat-value" id="cache-access">{{ cache_stats.avg_access_count|default:"0" }}</span>
                    </div>
                </div>
                
                <div class="d-flex gap-2">
                    <form method="post" action="{% url 'analytics:clear_cache' %}" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-clear-cache">
                            <i class="bi bi-trash me-1"></i> {% trans "Clear Expired Cache" %}
                        </button>
                    </form>
                    
                    <button type="button" class="btn btn-outline-primary" id="refresh-cache-stats">
                        <i class="bi bi-arrow-clockwise me-1"></i> {% trans "Refresh Stats" %}
                    </button>
                </div>
            </div>
        </div>
        
        <div class="settings-section">
            <div class="settings-section-header">
                <h4 class="mb-0 text-danger">{% trans "Danger Zone" %}</h4>
                <p class="mb-0 text-muted">{% trans "Irreversible actions that affect analytics data" %}</p>
            </div>
            
            <div class="settings-section-body">
                <div class="danger-zone">
                    <h6 class="danger-zone-header">{% trans "Reset All Analytics Data" %}</h6>
                    <p class="mb-3">
                        {% trans "This will permanently delete all analytics data including reports, KPI measurements, and trend analyses. This action cannot be undone." %}
                    </p>
                    
                    <button type="button" class="btn btn-reset-all" data-bs-toggle="modal" data-bs-target="#resetModal">
                        <i class="bi bi-exclamation-triangle me-1"></i> {% trans "Reset All Analytics Data" %}
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Reset Confirmation Modal -->
<div class="modal fade" id="resetModal" tabindex="-1" aria-labelledby="resetModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger" id="resetModalLabel">
                    <i class="bi bi-exclamation-triangle me-2"></i> {% trans "Confirm Reset" %}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>{% trans "You are about to reset all analytics data. This will permanently delete:" %}</p>
                <ul>
                    <li>{% trans "All generated reports" %}</li>
                    <li>{% trans "All KPI measurements" %}</li>
                    <li>{% trans "All trend analyses" %}</li>
                    <li>{% trans "All data exports" %}</li>
                    <li>{% trans "All analytics cache entries" %}</li>
                </ul>
                <p class="text-danger fw-bold">{% trans "This action cannot be undone. Are you sure you want to proceed?" %}</p>
                
                <div class="mb-3">
                    <label for="confirmReset" class="form-label">{% trans "Type 'RESET' to confirm:" %}</label>
                    <input type="text" class="form-control" id="confirmReset" placeholder="RESET">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
                <button type="button" class="btn btn-danger" id="confirmResetBtn" disabled>
                    {% trans "Reset All Data" %}
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Update preview when form values change
        function updatePreview() {
            // Cache duration
            const cacheDuration = document.getElementById('{{ form.cache_duration.id_for_label }}').value;
            document.getElementById('preview-cache-duration').textContent = cacheDuration + ' minutes';
            
            // Refresh interval
            const refreshInterval = document.getElementById('{{ form.auto_refresh_interval.id_for_label }}').value;
            document.getElementById('preview-refresh-interval').textContent = refreshInterval + ' minutes';
            
            // Data retention
            const dataRetention = document.getElementById('{{ form.data_retention_months.id_for_label }}').value;
            document.getElementById('preview-data-retention').textContent = dataRetention + ' months';
            
            // Real-time analytics
            const realTimeEnabled = document.getElementById('{{ form.enable_real_time_analytics.id_for_label }}').checked;
            document.getElementById('preview-real-time').textContent = realTimeEnabled ? 'Enabled' : 'Disabled';
            
            // Anonymized data
            const anonymizedEnabled = document.getElementById('{{ form.enable_anonymized_data.id_for_label }}').checked;
            document.getElementById('preview-anonymized').textContent = anonymizedEnabled ? 'Enabled' : 'Disabled';
        }
        
        // Add event listeners to form fields
        const formFields = document.querySelectorAll('#analytics-settings-form input, #analytics-settings-form select');
        formFields.forEach(field => {
            field.addEventListener('change', updatePreview);
            field.addEventListener('input', updatePreview);
        });
        
        // Initialize preview
        updatePreview();
        
        // Refresh cache stats
        document.getElementById('refresh-cache-stats').addEventListener('click', function() {
            const btn = this;
            const originalText = btn.innerHTML;
            
            btn.disabled = true;
            btn.innerHTML = '<i class="bi bi-arrow-clockwise me-1"></i> {% trans "Refreshing..." %}';
            
            // Simulate API call to refresh cache stats
            setTimeout(function() {
                // In a real implementation, this would fetch updated stats from the server
                document.getElementById('cache-total').textContent = '{{ cache_stats.total_entries|default:"0" }}';
                document.getElementById('cache-active').textContent = '{{ cache_stats.active_entries|default:"0" }}';
                document.getElementById('cache-expired').textContent = '{{ cache_stats.expired_entries|default:"0" }}';
                document.getElementById('cache-size').textContent = '{{ cache_stats.total_size|default:"0 B" }}';
                document.getElementById('cache-access').textContent = '{{ cache_stats.avg_access_count|default:"0" }}';
                
                btn.disabled = false;
                btn.innerHTML = originalText;
                
                // Show success message
                BaseApp.showToast('{% trans "Cache statistics updated successfully" %}', 'success');
            }, 1000);
        });
        
        // Reset confirmation logic
        const confirmResetInput = document.getElementById('confirmReset');
        const confirmResetBtn = document.getElementById('confirmResetBtn');
        
        confirmResetInput.addEventListener('input', function() {
            confirmResetBtn.disabled = this.value.toUpperCase() !== 'RESET';
        });
        
        confirmResetBtn.addEventListener('click', function() {
            // In a real implementation, this would submit a form or make an API call
            // to reset all analytics data
            BaseApp.showToast('{% trans "Analytics data reset initiated" %}', 'info');
            
            // Close the modal
            const resetModal = bootstrap.Modal.getInstance(document.getElementById('resetModal'));
            resetModal.hide();
            
            // Reset the confirmation input
            confirmResetInput.value = '';
            confirmResetBtn.disabled = true;
        });
        
        // Form validation
        const analyticsForm = document.getElementById('analytics-settings-form');
        analyticsForm.addEventListener('submit', function(e) {
            let isValid = true;
            
            // Validate cache duration
            const cacheDuration = document.getElementById('{{ form.cache_duration.id_for_label }}');
            if (cacheDuration.value < 1 || cacheDuration.value > 1440) {
                BaseApp.showToast('{% trans "Cache duration must be between 1 and 1440 minutes" %}', 'error');
                cacheDuration.focus();
                isValid = false;
            }
            
            // Validate refresh interval
            const refreshInterval = document.getElementById('{{ form.auto_refresh_interval.id_for_label }}');
            if (refreshInterval.value < 1 || refreshInterval.value > 120) {
                BaseApp.showToast('{% trans "Auto-refresh interval must be between 1 and 120 minutes" %}', 'error');
                refreshInterval.focus();
                isValid = false;
            }
            
            // Validate data retention
            const dataRetention = document.getElementById('{{ form.data_retention_months.id_for_label }}');
            if (dataRetention.value < 1 || dataRetention.value > 60) {
                BaseApp.showToast('{% trans "Data retention must be between 1 and 60 months" %}', 'error');
                dataRetention.focus();
                isValid = false;
            }
            
            // Validate max export records
            const maxExportRecords = document.getElementById('{{ form.max_export_records.id_for_label }}');
            if (maxExportRecords.value < 100 || maxExportRecords.value > 100000) {
                BaseApp.showToast('{% trans "Maximum export records must be between 100 and 100,000" %}', 'error');
                maxExportRecords.focus();
                isValid = false;
            }
            
            if (!isValid) {
                e.preventDefault();
            }
        });
    });
</script>
{% endblock %}