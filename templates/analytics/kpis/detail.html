{% extends 'base/base.html' %}
{% load static i18n %}

{% block title %}{{ kpi.name }} - {% trans "KPI Details" %}{% endblock %}

{% block page_title %}{{ kpi.name }}{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'analytics:dashboard' %}">{% trans "Analytics" %}</a></li>
<li class="breadcrumb-item"><a href="{% url 'analytics:kpi_list' %}">{% trans "KPIs" %}</a></li>
<li class="breadcrumb-item active" aria-current="page">{{ kpi.name|truncatewords:3 }}</li>
{% endblock %}

{% block page_actions %}
<div class="page-actions">
    <div class="btn-group" role="group">
        <button class="btn btn-success" onclick="refreshKpi('{{ kpi.id }}')">
            <i class="bi bi-arrow-clockwise me-1"></i> {% trans "Refresh" %}
        </button>
        <a href="{% url 'analytics:kpi_trend_data' kpi.id %}" class="btn btn-outline-primary" target="_blank">
            <i class="bi bi-download me-1"></i> {% trans "Export Data" %}
        </a>
        <button type="button" class="btn btn-primary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown">
            <span class="visually-hidden">{% trans "Toggle Dropdown" %}</span>
        </button>
        <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#" onclick="addMeasurement('{{ kpi.id }}')">
                <i class="bi bi-plus-circle me-2"></i> {% trans "Add Measurement" %}
            </a></li>
            <li><a class="dropdown-item" href="#" onclick="editKpi('{{ kpi.id }}')">
                <i class="bi bi-pencil me-2"></i> {% trans "Edit KPI" %}
            </a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="#" onclick="toggleTrending('{{ kpi.id }}')">
                <i class="bi bi-fire me-2"></i> 
                {% if kpi.is_trending %}{% trans "Remove from Trending" %}{% else %}{% trans "Add to Trending" %}{% endif %}
            </a></li>
            <li><a class="dropdown-item text-danger" href="#" onclick="deleteKpi('{{ kpi.id }}')">
                <i class="bi bi-trash me-2"></i> {% trans "Delete KPI" %}
            </a></li>
        </ul>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .kpi-detail-card {
        background: var(--bs-card-bg);
        border-radius: 0.5rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        margin-bottom: 1.5rem;
        border: 1px solid var(--bs-border-color);
    }
    
    .detail-header {
        padding: 1.5rem;
        border-bottom: 1px solid var(--bs-border-color);
        background: var(--bs-light);
        border-radius: 0.5rem 0.5rem 0 0;
    }
    
    .detail-body {
        padding: 1.5rem;
    }
    
    .detail-footer {
        padding: 1rem 1.5rem;
        border-top: 1px solid var(--bs-border-color);
        background: var(--bs-light-bg-subtle);
        border-radius: 0 0 0.5rem 0.5rem;
    }
    
    .kpi-icon-large {
        width: 4rem;
        height: 4rem;
        border-radius: 0.75rem;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 1.5rem;
        flex-shrink: 0;
        font-size: 1.5rem;
    }
    
    .current-value-card {
        text-align: center;
        padding: 2rem;
        background: linear-gradient(135deg, var(--bs-primary), var(--bs-info));
        color: white;
        border-radius: 0.75rem;
        margin-bottom: 1.5rem;
    }
    
    .current-value {
        font-size: 3.5rem;
        font-weight: 700;
        line-height: 1;
        margin-bottom: 0.5rem;
    }
    
    .value-label {
        font-size: 1rem;
        opacity: 0.9;
        margin-bottom: 0.5rem;
    }
    
    .trend-indicator-large {
        display: inline-flex;
        align-items: center;
        font-size: 1.125rem;
        font-weight: 600;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        background: rgba(255, 255, 255, 0.2);
    }
    
    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    .info-card {
        background: var(--bs-light-bg-subtle);
        border-radius: 0.5rem;
        padding: 1.25rem;
        border-left: 4px solid var(--bs-primary);
    }
    
    .info-label {
        font-size: 0.875rem;
        color: var(--bs-secondary);
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
    }
    
    .info-value {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--bs-body-color);
        margin-bottom: 0;
    }
    
    .section-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid var(--bs-primary);
        color: var(--bs-primary);
    }
    
    .chart-container {
        position: relative;
        height: 400px;
        width: 100%;
        margin-bottom: 2rem;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        background: var(--bs-card-bg);
        border: 1px solid var(--bs-border-color);
        border-radius: 0.5rem;
        padding: 1.5rem;
        text-align: center;
    }
    
    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        line-height: 1;
        margin-bottom: 0.5rem;
    }
    
    .stat-label {
        font-size: 0.875rem;
        color: var(--bs-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .measurement-table {
        background: var(--bs-card-bg);
        border-radius: 0.5rem;
        overflow: hidden;
        border: 1px solid var(--bs-border-color);
    }
    
    .table-header {
        background: var(--bs-light);
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--bs-border-color);
    }
    
    .table-body {
        max-height: 400px;
        overflow-y: auto;
    }
    
    .measurement-row {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr 1fr auto;
        gap: 1rem;
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--bs-border-color-translucent);
        align-items: center;
    }
    
    .measurement-row:last-child {
        border-bottom: none;
    }
    
    .measurement-row.header {
        font-weight: 600;
        background: var(--bs-light-bg-subtle);
        position: sticky;
        top: 0;
        z-index: 1;
    }
    
    .value-cell {
        font-weight: 600;
        font-size: 1.125rem;
    }
    
    .change-cell {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .change-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        font-weight: 600;
    }
    
    .change-positive {
        background: rgba(25, 135, 84, 0.1);
        color: var(--bs-success);
    }
    
    .change-negative {
        background: rgba(220, 53, 69, 0.1);
        color: var(--bs-danger);
    }
    
    .change-neutral {
        background: rgba(108, 117, 125, 0.1);
        color: var(--bs-secondary);
    }
    
    .target-progress-container {
        background: var(--bs-light);
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .progress-header {
        display: flex;
        justify-content: between;
        align-items: center;
        margin-bottom: 1rem;
    }
    
    .progress-bar-container {
        height: 8px;
        background: var(--bs-light-bg-subtle);
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 0.5rem;
    }
    
    .progress-bar {
        height: 100%;
        border-radius: 4px;
        transition: width 0.3s ease;
    }
    
    .progress-labels {
        display: flex;
        justify-content: between;
        font-size: 0.875rem;
        color: var(--bs-secondary);
    }
    
    .time-filter {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
    }
    
    .time-filter-btn {
        padding: 0.5rem 1rem;
        border: 1px solid var(--bs-border-color);
        border-radius: 0.375rem;
        background: var(--bs-card-bg);
        color: var(--bs-body-color);
        text-decoration: none;
        font-size: 0.875rem;
        transition: all 0.2s ease;
    }
    
    .time-filter-btn:hover,
    .time-filter-btn.active {
        background: var(--bs-primary);
        color: white;
        border-color: var(--bs-primary);
    }
    
    .empty-state {
        text-align: center;
        padding: 3rem 2rem;
        color: var(--bs-secondary);
    }
    
    .empty-state-icon {
        font-size: 4rem;
        margin-bottom: 1.5rem;
        opacity: 0.5;
    }
    
    .action-buttons {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }
    
    .metadata-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 0.375rem;
        background: var(--bs-light);
        color: var(--bs-secondary);
        font-weight: 500;
    }
    
    .sparkline {
        width: 100px;
        height: 30px;
        background: var(--bs-light);
        border-radius: 0.25rem;
        position: relative;
        overflow: hidden;
    }
    
    .sparkline-line {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: var(--bs-primary);
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Main Content -->
    <div class="col-lg-8">
        <!-- KPI Header -->
        <div class="kpi-detail-card">
            <div class="detail-header">
                <div class="d-flex align-items-start">
                    <div class="kpi-icon-large 
                        {% if kpi.category == 'academic' %}bg-info bg-opacity-10 text-info
                        {% elif kpi.category == 'financial' %}bg-success bg-opacity-10 text-success
                        {% elif kpi.category == 'operational' %}bg-warning bg-opacity-10 text-warning
                        {% else %}bg-secondary bg-opacity-10 text-secondary{% endif %}">
                        <i class="bi 
                            {% if kpi.category == 'academic' %}bi-mortarboard
                            {% elif kpi.category == 'financial' %}bi-currency-dollar
                            {% elif kpi.category == 'operational' %}bi-gear
                            {% else %}bi-graph-up{% endif %}">
                        </i>
                    </div>
                    <div class="flex-grow-1">
                        <h4 class="mb-2">{{ kpi.name }}</h4>
                        <p class="text-muted mb-3">{{ kpi.description }}</p>
                        <div class="d-flex flex-wrap gap-2 align-items-center">
                            <span class="badge 
                                {% if kpi.category == 'academic' %}bg-info
                                {% elif kpi.category == 'financial' %}bg-success
                                {% elif kpi.category == 'operational' %}bg-warning
                                {% else %}bg-secondary{% endif %}">
                                {{ kpi.get_category_display }}
                            </span>
                            <span class="badge bg-light text-dark">
                                <i class="bi bi-graph-up me-1"></i>
                                {{ kpi.get_value_type_display }}
                            </span>
                            <span class="badge bg-light text-dark">
                                <i class="bi bi-clock me-1"></i>
                                {{ kpi.get_refresh_frequency_display }}
                            </span>
                            {% if kpi.is_trending %}
                            <span class="badge bg-warning">
                                <i class="bi bi-fire me-1"></i>
                                {% trans "Trending" %}
                            </span>
                            {% endif %}
                            {% if kpi.status == 'active' %}
                            <span class="badge bg-success">{% trans "Active" %}</span>
                            {% else %}
                            <span class="badge bg-secondary">{% trans "Inactive" %}</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Current Value & Trend -->
        <div class="kpi-detail-card">
            <div class="detail-body">
                {% with latest_measurement=page_obj.0 %}
                <div class="current-value-card">
                    <div class="value-label">{% trans "Current Value" %}</div>
                    <div class="current-value">
                        {% if latest_measurement %}
                            {% if kpi.value_type == 'percentage' %}
                                {{ latest_measurement.value }}%
                            {% elif kpi.value_type == 'currency' %}
                                ${{ latest_measurement.value }}
                            {% else %}
                                {{ latest_measurement.value }}
                            {% endif %}
                        {% else %}
                            --
                        {% endif %}
                    </div>
                    {% if latest_measurement and latest_measurement.change_percentage %}
                    <div class="trend-indicator-large 
                        {% if latest_measurement.change_percentage > 0 %}text-success
                        {% elif latest_measurement.change_percentage < 0 %}text-danger
                        {% else %}text-warning{% endif %}">
                        <i class="bi 
                            {% if latest_measurement.change_percentage > 0 %}bi-arrow-up
                            {% elif latest_measurement.change_percentage < 0 %}bi-arrow-down
                            {% else %}bi-dash{% endif %} me-1">
                        </i>
                        {{ latest_measurement.change_percentage|floatformat:1 }}%
                        {% trans "from previous" %}
                    </div>
                    {% endif %}
                </div>
                {% endwith %}

                <!-- Key Information -->
                <div class="info-grid">
                    <div class="info-card">
                        <div class="info-label">{% trans "Target Value" %}</div>
                        <div class="info-value">
                            {% if kpi.target_value %}
                                {% if kpi.value_type == 'percentage' %}
                                    {{ kpi.target_value }}%
                                {% elif kpi.value_type == 'currency' %}
                                    ${{ kpi.target_value }}
                                {% else %}
                                    {{ kpi.target_value }}
                                {% endif %}
                            {% else %}
                                {% trans "Not Set" %}
                            {% endif %}
                        </div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">{% trans "Value Range" %}</div>
                        <div class="info-value">
                            {% if kpi.min_value and kpi.max_value %}
                                {{ kpi.min_value }} - {{ kpi.max_value }}
                            {% else %}
                                {% trans "Not Set" %}
                            {% endif %}
                        </div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">{% trans "Data Source" %}</div>
                        <div class="info-value">{{ kpi.data_source }}</div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">{% trans "Last Updated" %}</div>
                        <div class="info-value">
                            {% if page_obj.0 %}
                                {{ page_obj.0.measured_at|timesince }} {% trans "ago" %}
                            {% else %}
                                {% trans "Never" %}
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Statistics -->
                {% if stats %}
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value text-primary">{{ stats.avg_value|floatformat:2 }}</div>
                        <div class="stat-label">{% trans "Average" %}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value text-success">{{ stats.max_value|floatformat:2 }}</div>
                        <div class="stat-label">{% trans "Maximum" %}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value text-warning">{{ stats.min_value|floatformat:2 }}</div>
                        <div class="stat-label">{% trans "Minimum" %}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value text-info">{{ stats.total_measurements }}</div>
                        <div class="stat-label">{% trans "Measurements" %}</div>
                    </div>
                </div>
                {% endif %}

                <!-- Target Progress -->
                {% if kpi.target_value and page_obj.0 %}
                <div class="target-progress-container">
                    <div class="progress-header">
                        <h6 class="mb-0">{% trans "Target Progress" %}</h6>
                        <span class="text-muted">
                            {{ page_obj.0.value }} / {{ kpi.target_value }}
                            ({% widthratio page_obj.0.value kpi.target_value 100 %}%)
                        </span>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar 
                            {% if page_obj.0.value >= kpi.target_value %}bg-success
                            {% elif page_obj.0.value >= kpi.target_value|add:"-10" %}bg-warning
                            {% else %}bg-danger{% endif %}" 
                            style="width: {% widthratio page_obj.0.value kpi.target_value 100 %}%">
                        </div>
                    </div>
                    <div class="progress-labels">
                        <span>0</span>
                        <span>{{ kpi.target_value }}</span>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Trend Chart -->
        <div class="kpi-detail-card">
            <div class="detail-header">
                <h5 class="mb-0">{% trans "Performance Trend" %}</h5>
            </div>
            <div class="detail-body">
                <div class="time-filter">
                    <a href="?period=7d" class="time-filter-btn {% if request.GET.period == '7d' %}active{% endif %}">
                        {% trans "7 Days" %}
                    </a>
                    <a href="?period=30d" class="time-filter-btn {% if not request.GET.period or request.GET.period == '30d' %}active{% endif %}">
                        {% trans "30 Days" %}
                    </a>
                    <a href="?period=90d" class="time-filter-btn {% if request.GET.period == '90d' %}active{% endif %}">
                        {% trans "90 Days" %}
                    </a>
                    <a href="?period=1y" class="time-filter-btn {% if request.GET.period == '1y' %}active{% endif %}">
                        {% trans "1 Year" %}
                    </a>
                    <a href="?period=all" class="time-filter-btn {% if request.GET.period == 'all' %}active{% endif %}">
                        {% trans "All Time" %}
                    </a>
                </div>
                
                <div class="chart-container">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Quick Actions -->
        <div class="kpi-detail-card mb-4">
            <div class="detail-header">
                <h6 class="mb-0">{% trans "Quick Actions" %}</h6>
            </div>
            <div class="detail-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" onclick="addMeasurement('{{ kpi.id }}')">
                        <i class="bi bi-plus-circle me-2"></i> {% trans "Add Measurement" %}
                    </button>
                    <button class="btn btn-outline-success" onclick="refreshKpi('{{ kpi.id }}')">
                        <i class="bi bi-arrow-clockwise me-2"></i> {% trans "Refresh KPI" %}
                    </button>
                    <a href="{% url 'analytics:kpi_trend_data' kpi.id %}" class="btn btn-outline-info" target="_blank">
                        <i class="bi bi-download me-2"></i> {% trans "Export Data" %}
                    </a>
                    <button class="btn btn-outline-warning" onclick="toggleTrending('{{ kpi.id }}')">
                        <i class="bi bi-fire me-2"></i>
                        {% if kpi.is_trending %}{% trans "Remove from Trending" %}{% else %}{% trans "Add to Trending" %}{% endif %}
                    </button>
                    <button class="btn btn-outline-danger" onclick="deleteKpi('{{ kpi.id }}')">
                        <i class="bi bi-trash me-2"></i> {% trans "Delete KPI" %}
                    </button>
                </div>
            </div>
        </div>

        <!-- KPI Information -->
        <div class="kpi-detail-card mb-4">
            <div class="detail-header">
                <h6 class="mb-0">{% trans "KPI Information" %}</h6>
            </div>
            <div class="detail-body">
                <div class="mb-3">
                    <strong>{% trans "Calculation Method:" %}</strong>
                    <p class="text-muted mb-2 small">{{ kpi.calculation_query|default:"Automatic calculation"|truncatewords:20 }}</p>
                </div>
                
                <div class="mb-3">
                    <strong>{% trans "Display Format:" %}</strong>
                    <p class="text-muted mb-2 small">{{ kpi.display_format|default:"Default formatting" }}</p>
                </div>
                
                <div class="mb-3">
                    <strong>{% trans "Created:" %}</strong>
                    <p class="text-muted mb-0 small">{{ kpi.created_at|date:"M d, Y" }}</p>
                </div>
                
                <div class="mb-0">
                    <strong>{% trans "Last Modified:" %}</strong>
                    <p class="text-muted mb-0 small">{{ kpi.updated_at|date:"M d, Y" }}</p>
                </div>
            </div>
        </div>

        <!-- Recent Measurements -->
        <div class="kpi-detail-card">
            <div class="detail-header">
                <h6 class="mb-0">{% trans "Recent Measurements" %}</h6>
            </div>
            <div class="detail-body">
                {% if page_obj %}
                <div class="measurement-table">
                    <div class="table-body">
                        <div class="measurement-row header">
                            <div>{% trans "Date" %}</div>
                            <div>{% trans "Value" %}</div>
                            <div>{% trans "Change" %}</div>
                            <div>{% trans "Session" %}</div>
                            <div></div>
                        </div>
                        
                        {% for measurement in page_obj|slice:":5" %}
                        <div class="measurement-row">
                            <div class="text-muted small">
                                {{ measurement.measured_at|date:"M d, H:i" }}
                            </div>
                            <div class="value-cell">
                                {% if kpi.value_type == 'percentage' %}
                                    {{ measurement.value }}%
                                {% elif kpi.value_type == 'currency' %}
                                    ${{ measurement.value }}
                                {% else %}
                                    {{ measurement.value }}
                                {% endif %}
                            </div>
                            <div class="change-cell">
                                {% if measurement.change_percentage %}
                                <span class="change-badge 
                                    {% if measurement.change_percentage > 0 %}change-positive
                                    {% elif measurement.change_percentage < 0 %}change-negative
                                    {% else %}change-neutral{% endif %}">
                                    <i class="bi 
                                        {% if measurement.change_percentage > 0 %}bi-arrow-up
                                        {% elif measurement.change_percentage < 0 %}bi-arrow-down
                                        {% else %}bi-dash{% endif %} me-1">
                                    </i>
                                    {{ measurement.change_percentage|floatformat:1 }}%
                                </span>
                                {% else %}
                                <span class="change-badge change-neutral">--</span>
                                {% endif %}
                            </div>
                            <div class="text-muted small">
                                {{ measurement.academic_session.name|default:"--" }}
                            </div>
                            <div>
                                <button class="btn btn-sm btn-outline-secondary" onclick="viewMeasurement('{{ measurement.id }}')">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                
                <div class="text-center mt-3">
                    <a href="?view=all#measurements" class="btn btn-sm btn-outline-primary">
                        {% trans "View All Measurements" %} ({{ page_obj.paginator.count }})
                    </a>
                </div>
                {% else %}
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="bi bi-graph-up"></i>
                    </div>
                    <p class="mb-0">{% trans "No measurements available" %}</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Measurement History Section -->
{% if page_obj and page_obj.paginator.count > 5 %}
<div class="row mt-4">
    <div class="col-12">
        <div class="kpi-detail-card">
            <div class="detail-header">
                <h5 class="mb-0" id="measurements">{% trans "Measurement History" %}</h5>
            </div>
            <div class="detail-body">
                <div class="measurement-table">
                    <div class="table-body">
                        <div class="measurement-row header">
                            <div>{% trans "Date" %}</div>
                            <div>{% trans "Value" %}</div>
                            <div>{% trans "Previous" %}</div>
                            <div>{% trans "Change" %}</div>
                            <div>{% trans "Session" %}</div>
                            <div>{% trans "Actions" %}</div>
                        </div>
                        
                        {% for measurement in page_obj %}
                        <div class="measurement-row">
                            <div>
                                <div class="fw-medium">{{ measurement.measured_at|date:"M d, Y" }}</div>
                                <div class="text-muted small">{{ measurement.measured_at|date:"H:i" }}</div>
                            </div>
                            <div class="value-cell">
                                {% if kpi.value_type == 'percentage' %}
                                    {{ measurement.value }}%
                                {% elif kpi.value_type == 'currency' %}
                                    ${{ measurement.value }}
                                {% else %}
                                    {{ measurement.value }}
                                {% endif %}
                            </div>
                            <div class="text-muted">
                                {% if measurement.previous_value %}
                                    {% if kpi.value_type == 'percentage' %}
                                        {{ measurement.previous_value }}%
                                    {% elif kpi.value_type == 'currency' %}
                                        ${{ measurement.previous_value }}
                                    {% else %}
                                        {{ measurement.previous_value }}
                                    {% endif %}
                                {% else %}
                                    --
                                {% endif %}
                            </div>
                            <div class="change-cell">
                                {% if measurement.change_percentage %}
                                <span class="change-badge 
                                    {% if measurement.change_percentage > 0 %}change-positive
                                    {% elif measurement.change_percentage < 0 %}change-negative
                                    {% else %}change-neutral{% endif %}">
                                    <i class="bi 
                                        {% if measurement.change_percentage > 0 %}bi-arrow-up
                                        {% elif measurement.change_percentage < 0 %}bi-arrow-down
                                        {% else %}bi-dash{% endif %} me-1">
                                    </i>
                                    {{ measurement.change_percentage|floatformat:1 }}%
                                </span>
                                {% else %}
                                <span class="change-badge change-neutral">--</span>
                                {% endif %}
                            </div>
                            <div>
                                {{ measurement.academic_session.name|default:"--" }}
                            </div>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-outline-secondary" onclick="viewMeasurement('{{ measurement.id }}')" title="{% trans 'View Details' %}">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-warning" onclick="editMeasurement('{{ measurement.id }}')" title="{% trans 'Edit' %}">
                                    <i class="bi bi-pencil"></i>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Pagination -->
                {% if page_obj.has_other_pages %}
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div>
                        <small class="text-muted">
                            {% blocktrans with start=page_obj.start_index end=page_obj.end_index total=page_obj.paginator.count %}
                            Showing {{ start }} to {{ end }} of {{ total }} measurements
                            {% endblocktrans %}
                        </small>
                    </div>
                    
                    <nav aria-label="{% trans 'Measurement pagination' %}">
                        <ul class="pagination mb-0">
                            {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}#measurements">
                                    <i class="bi bi-chevron-left"></i>
                                </a>
                            </li>
                            {% endif %}
                            
                            {% for num in page_obj.paginator.page_range %}
                                {% if page_obj.number == num %}
                                <li class="page-item active">
                                    <span class="page-link">{{ num }}</span>
                                </li>
                                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}#measurements">{{ num }}</a>
                                </li>
                                {% endif %}
                            {% endfor %}
                            
                            {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}#measurements">
                                    <i class="bi bi-chevron-right"></i>
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize trend chart
        initializeTrendChart();
        
        // Set up auto-refresh based on KPI frequency
        setupAutoRefresh();
    });
    
    function initializeTrendChart() {
        const ctx = document.getElementById('trendChart').getContext('2d');
        
        // Sample data - in real implementation, this would come from the API
        const chartData = {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
            datasets: [{
                label: '{{ kpi.name }}',
                data: [65, 59, 80, 81, 56, 55, 70, 75, 82, 78, 85, 90],
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                tension: 0.4,
                fill: true
            }]
        };
        
        const trendChart = new Chart(ctx, {
            type: 'line',
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            }
        });
    }
    
    function setupAutoRefresh() {
        const refreshFrequency = '{{ kpi.refresh_frequency }}';
        let refreshInterval;
        
        if (refreshFrequency === 'realtime') {
            refreshInterval = 30000; // 30 seconds
        } else if (refreshFrequency === 'hourly') {
            refreshInterval = 3600000; // 1 hour
        } else if (refreshFrequency === 'daily') {
            refreshInterval = 86400000; // 24 hours
        }
        
        if (refreshInterval) {
            setInterval(function() {
                refreshKpi('{{ kpi.id }}');
            }, refreshInterval);
        }
    }
    
    function refreshKpi(kpiId) {
        BaseApp.showToast('{% trans "Refreshing KPI data..." %}', 'info');
        
        // In real implementation, this would be an API call
        setTimeout(function() {
            window.location.reload();
        }, 2000);
    }
    
    function addMeasurement(kpiId) {
        BaseApp.showToast('{% trans "Opening measurement form..." %}', 'info');
        // In real implementation, this would open a modal
    }
    
    function editKpi(kpiId) {
        BaseApp.showToast('{% trans "Opening KPI editor..." %}', 'info');
        // In real implementation, this would redirect to edit page
    }
    
    function toggleTrending(kpiId) {
        const isCurrentlyTrending = {{ kpi.is_trending|yesno:"true,false" }};
        const newState = !isCurrentlyTrending;
        
        // In real implementation, this would be an API call
        BaseApp.showToast(
            newState ? '{% trans "Adding to trending..." %}' : '{% trans "Removing from trending..." %}',
            'info'
        );
        
        setTimeout(function() {
            window.location.reload();
        }, 1000);
    }
    
    function deleteKpi(kpiId) {
        if (confirm('{% trans "Are you sure you want to delete this KPI? This action cannot be undone and will delete all associated measurements." %}')) {
            BaseApp.showLoading();
            
            // In real implementation, this would be an API call
            setTimeout(function() {
                BaseApp.hideLoading();
                BaseApp.showToast('{% trans "KPI deleted successfully" %}', 'success');
                
                setTimeout(function() {
                    window.location.href = '{% url "analytics:kpi_list" %}';
                }, 1000);
            }, 1500);
        }
    }
    
    function viewMeasurement(measurementId) {
        BaseApp.showToast('{% trans "Loading measurement details..." %}', 'info');
        // In real implementation, this would open a modal
    }
    
    function editMeasurement(measurementId) {
        BaseApp.showToast('{% trans "Opening measurement editor..." %}', 'info');
        // In real implementation, this would open an edit modal
    }
</script>
{% endblock %}