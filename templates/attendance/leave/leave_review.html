<!-- templates/attendance/leave/leave_review.html -->
{% extends 'base/base.html' %}
{% load static %}

{% block title %}Review Leave Application - School Management System{% endblock %}

{% block extra_css %}
<style>
.leave-detail-card {
    border-left: 4px solid transparent;
    transition: all 0.3s ease;
}
.leave-detail-card.pending {
    border-left-color: #ffc107;
    background: linear-gradient(to right, #fffaf0, #ffffff);
}
.leave-detail-card.approved {
    border-left-color: #28a745;
    background: linear-gradient(to right, #f0fff4, #ffffff);
}
.leave-detail-card.rejected {
    border-left-color: #dc3545;
    background: linear-gradient(to right, #fff0f0, #ffffff);
}
.leave-detail-card.cancelled {
    border-left-color: #6c757d;
    background: linear-gradient(to right, #f8f9fa, #ffffff);
}
.timeline {
    position: relative;
    padding-left: 30px;
}
.timeline::before {
    content: '';
    position: absolute;
    left: 15px;
    top: 0;
    bottom: 0;
    width: 2px;
    background-color: #e9ecef;
}
.timeline-item {
    position: relative;
    margin-bottom: 20px;
}
.timeline-item::before {
    content: '';
    position: absolute;
    left: -23px;
    top: 5px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background-color: #007bff;
    border: 2px solid white;
    box-shadow: 0 0 0 2px #e9ecef;
}
.timeline-item.approved::before {
    background-color: #28a745;
}
.timeline-item.rejected::before {
    background-color: #dc3545;
}
.timeline-item.pending::before {
    background-color: #ffc107;
}
.document-preview {
    max-width: 200px;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 1px solid #e9ecef;
}
.document-preview:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    border-color: #007bff;
}
.approval-actions .btn {
    min-width: 120px;
    font-weight: 500;
}
.status-badge {
    font-size: 0.875rem;
    padding: 0.5rem 1rem;
}
.leave-type-badge {
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-weight: 500;
}
.date-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 10px;
    transition: all 0.3s ease;
}
.date-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
}
.date-card .card-body {
    padding: 1.5rem;
}
.balance-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 10px;
}
.balance-card .balance-number {
    font-size: 2.5rem;
    font-weight: bold;
    line-height: 1;
}
.progress {
    height: 8px;
    background-color: rgba(255,255,255,0.3);
}
.progress-bar {
    background-color: white;
}
.quick-action-btn {
    border-radius: 8px;
    padding: 0.75rem 1rem;
    font-weight: 500;
    transition: all 0.3s ease;
}
.quick-action-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
.rejection-section {
    border-left: 4px solid #dc3545;
    background-color: #fff5f5;
    border-radius: 0 8px 8px 0;
}
.approval-section {
    border-left: 4px solid #28a745;
    background-color: #f0fff4;
    border-radius: 0 8px 8px 0;
}
.review-comment {
    border-radius: 8px;
    border: 1px solid #e9ecef;
    transition: all 0.3s ease;
}
.review-comment:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
}
.attachment-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1rem;
}
@media (max-width: 768px) {
    .attachment-grid {
        grid-template-columns: 1fr;
    }
    .date-card .card-body {
        padding: 1rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Page Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="h3 mb-2 text-gray-800">
                                {% if leaveapplication.status == 'pending' %}
                                <i class="fas fa-clipboard-check text-warning me-2"></i>Review Leave Application
                                {% else %}
                                <i class="fas fa-file-alt text-primary me-2"></i>Leave Application Details
                                {% endif %}
                            </h1>
                            <nav aria-label="breadcrumb">
                                <ol class="breadcrumb">
                                    <li class="breadcrumb-item"><a href="{% url 'attendance:dashboard' %}">Dashboard</a></li>
                                    <li class="breadcrumb-item"><a href="{% url 'attendance:leave_list' %}">Leave Applications</a></li>
                                    <li class="breadcrumb-item active">
                                        {% if leaveapplication.status == 'pending' %}Review{% else %}Details{% endif %}
                                    </li>
                                </ol>
                            </nav>
                        </div>
                        <div class="btn-group">
                            <a href="{% url 'attendance:leave_list' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-1"></i> Back to List
                            </a>
                            {% if perms.attendance.change_leaveapplication %}
                            <button type="button" class="btn btn-outline-primary" onclick="window.print()">
                                <i class="fas fa-print me-1"></i> Print
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Leave Application Details -->
                <div class="col-lg-8">
                    <div class="card leave-detail-card shadow {{ leaveapplication.status }} mb-4">
                        <div class="card-header py-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="m-0 font-weight-bold text-primary">
                                    <i class="fas fa-info-circle me-2"></i>Application Details
                                </h6>
                                <span class="status-badge badge 
                                    {% if leaveapplication.status == 'pending' %}bg-warning
                                    {% elif leaveapplication.status == 'approved' %}bg-success
                                    {% elif leaveapplication.status == 'rejected' %}bg-danger
                                    {% else %}bg-secondary{% endif %}">
                                    <i class="fas fa-{% if leaveapplication.status == 'pending' %}clock{% elif leaveapplication.status == 'approved' %}check{% elif leaveapplication.status == 'rejected' %}times{% else %}ban{% endif %} me-1"></i>
                                    {{ leaveapplication.get_status_display }}
                                </span>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Basic Information -->
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <table class="table table-borderless">
                                        <tr>
                                            <td class="text-muted" style="width: 40%;">
                                                <i class="fas fa-user me-2"></i>Applicant:
                                            </td>
                                            <td><strong>{{ leaveapplication.applicant.get_full_name }}</strong></td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">
                                                <i class="fas fa-id-card me-2"></i>Employee ID:
                                            </td>
                                            <td>{{ leaveapplication.applicant.employee_id|default:"N/A" }}</td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">
                                                <i class="fas fa-building me-2"></i>Department:
                                            </td>
                                            <td>{{ leaveapplication.applicant.department|default:"N/A" }}</td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">
                                                <i class="fas fa-calendar-plus me-2"></i>Applied On:
                                            </td>
                                            <td>{{ leaveapplication.created_at|date:"M d, Y" }}</td>
                                        </tr>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <table class="table table-borderless">
                                        <tr>
                                            <td class="text-muted" style="width: 40%;">
                                                <i class="fas fa-tag me-2"></i>Leave Type:
                                            </td>
                                            <td>
                                                <span class="leave-type-badge" style="background-color: {{ leaveapplication.leave_type.color }}; color: white;">
                                                    {{ leaveapplication.leave_type.name }}
                                                </span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">
                                                <i class="fas fa-clock me-2"></i>Duration:
                                            </td>
                                            <td><strong>{{ leaveapplication.total_days }} day{{ leaveapplication.total_days|pluralize }}</strong></td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">
                                                <i class="fas fa-money-bill-wave me-2"></i>Pay Status:
                                            </td>
                                            <td>
                                                {% if leaveapplication.leave_type.is_paid %}
                                                <span class="badge bg-success">
                                                    <i class="fas fa-check me-1"></i>Paid Leave
                                                </span>
                                                {% else %}
                                                <span class="badge bg-secondary">
                                                    <i class="fas fa-times me-1"></i>Unpaid Leave
                                                </span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">
                                                <i class="fas fa-shield-alt me-2"></i>Approval Required:
                                            </td>
                                            <td>
                                                {% if leaveapplication.leave_type.requires_approval %}
                                                <span class="badge bg-warning">
                                                    <i class="fas fa-exclamation-triangle me-1"></i>Yes
                                                </span>
                                                {% else %}
                                                <span class="badge bg-success">
                                                    <i class="fas fa-check me-1"></i>No
                                                </span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                            </div>

                            <!-- Leave Dates -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <h6 class="border-bottom pb-2 mb-3">
                                        <i class="fas fa-calendar-alt me-2"></i>Leave Period
                                    </h6>
                                    <div class="row text-center">
                                        <div class="col-md-4 mb-3">
                                            <div class="card date-card">
                                                <div class="card-body">
                                                    <small>Start Date</small>
                                                    <div class="h4 mb-0 fw-bold">{{ leaveapplication.start_date|date:"M d, Y" }}</div>
                                                    <small>{{ leaveapplication.start_date|date:"l" }}</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <div class="card date-card">
                                                <div class="card-body">
                                                    <small>End Date</small>
                                                    <div class="h4 mb-0 fw-bold">{{ leaveapplication.end_date|date:"M d, Y" }}</div>
                                                    <small>{{ leaveapplication.end_date|date:"l" }}</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <div class="card date-card">
                                                <div class="card-body">
                                                    <small>Total Days</small>
                                                    <div class="h2 mb-0 fw-bold">{{ leaveapplication.total_days }}</div>
                                                    <small>Day{{ leaveapplication.total_days|pluralize }}</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Reason for Leave -->
                            <div class="mb-4">
                                <h6 class="border-bottom pb-2 mb-3">
                                    <i class="fas fa-comment-alt me-2"></i>Reason for Leave
                                </h6>
                                <div class="bg-light p-4 rounded">
                                    <div class="fst-italic">
                                        {{ leaveapplication.reason|linebreaks }}
                                    </div>
                                </div>
                            </div>

                            <!-- Supporting Documents -->
                            {% if leaveapplication.supporting_documents.exists %}
                            <div class="mb-4">
                                <h6 class="border-bottom pb-2 mb-3">
                                    <i class="fas fa-paperclip me-2"></i>Supporting Documents
                                </h6>
                                <div class="attachment-grid">
                                    {% for document in leaveapplication.supporting_documents.all %}
                                    <div class="card document-preview">
                                        <div class="card-body text-center">
                                            {% if document.file.name|lower|slice:'-4:' == '.pdf' %}
                                            <i class="fas fa-file-pdf fa-2x text-danger mb-2"></i>
                                            {% elif document.file.name|lower|slice:'-4:' in '.doc,.docx' %}
                                            <i class="fas fa-file-word fa-2x text-primary mb-2"></i>
                                            {% elif document.file.name|lower|slice:'-4:' in '.jpg,.jpeg,.png,.gif' %}
                                            <i class="fas fa-file-image fa-2x text-success mb-2"></i>
                                            {% else %}
                                            <i class="fas fa-file fa-2x text-secondary mb-2"></i>
                                            {% endif %}
                                            <div class="small text-truncate mb-2" title="{{ document.filename }}">
                                                {{ document.filename }}
                                            </div>
                                            <div class="btn-group w-100">
                                                <a href="{{ document.file.url }}" target="_blank" 
                                                   class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-eye me-1"></i> View
                                                </a>
                                                <a href="{{ document.file.url }}" download 
                                                   class="btn btn-sm btn-outline-secondary">
                                                    <i class="fas fa-download me-1"></i> Download
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}

                            <!-- Approval History -->
                            {% if leaveapplication.approved_by or leaveapplication.rejection_reason %}
                            <div class="mb-4">
                                <h6 class="border-bottom pb-2 mb-3">
                                    <i class="fas fa-history me-2"></i>
                                    {% if leaveapplication.status == 'approved' %}Approval Details{% else %}Rejection Details{% endif %}
                                </h6>
                                <div class="timeline">
                                    {% if leaveapplication.approved_by %}
                                    <div class="timeline-item {{ leaveapplication.status }}">
                                        <strong>
                                            <i class="fas fa-user-check me-1"></i>
                                            Approved by: {{ leaveapplication.approved_by.get_full_name }}
                                        </strong><br>
                                        <small class="text-muted">
                                            <i class="fas fa-clock me-1"></i>
                                            on {{ leaveapplication.approved_at|date:"M d, Y" }} at {{ leaveapplication.approved_at|time }}
                                        </small>
                                    </div>
                                    {% endif %}
                                    {% if leaveapplication.rejection_reason %}
                                    <div class="timeline-item {{ leaveapplication.status }}">
                                        <strong>
                                            <i class="fas fa-comment-exclamation me-1"></i>
                                            Rejection Reason:
                                        </strong><br>
                                        <div class="alert alert-danger mt-2">
                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                            {{ leaveapplication.rejection_reason }}
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Approval Form (for pending applications) -->
                    {% if leaveapplication.status == 'pending' and perms.attendance.change_leaveapplication %}
                    <div class="card shadow">
                        <div class="card-header py-3 bg-primary text-white">
                            <h6 class="m-0 font-weight-bold">
                                <i class="fas fa-tasks me-2"></i>Review Action
                            </h6>
                        </div>
                        <div class="card-body">
                            <form method="post" id="reviewForm">
                                {% csrf_token %}
                                
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <label for="status" class="form-label fw-bold">
                                            <i class="fas fa-decison me-2"></i>Decision
                                        </label>
                                        <select class="form-select form-select-lg" id="status" name="status" required>
                                            <option value="">Select Decision</option>
                                            <option value="approved">✅ Approve Application</option>
                                            <option value="rejected">❌ Reject Application</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="approved_by" class="form-label fw-bold">
                                            <i class="fas fa-user-tie me-2"></i>Approved By
                                        </label>
                                        <input type="text" class="form-control form-control-lg" id="approved_by" 
                                               value="{{ user.get_full_name }}" readonly>
                                        <input type="hidden" name="approved_by" value="{{ user.id }}">
                                    </div>
                                </div>

                                <!-- Rejection Reason (shown when rejected) -->
                                <div class="mb-4" id="rejectionReasonSection" style="display: none;">
                                    <div class="rejection-section p-3">
                                        <label for="rejection_reason" class="form-label fw-bold text-danger">
                                            <i class="fas fa-exclamation-circle me-2"></i>Rejection Reason
                                        </label>
                                        <textarea class="form-control review-comment" id="rejection_reason" name="rejection_reason" 
                                                  rows="4" placeholder="Please provide a clear and constructive reason for rejection..."></textarea>
                                        <div class="form-text text-danger">
                                            <i class="fas fa-info-circle me-1"></i>
                                            This reason will be shared with the applicant and should be professional and constructive.
                                        </div>
                                    </div>
                                </div>

                                <!-- Additional Comments -->
                                <div class="mb-4">
                                    <div class="approval-section p-3">
                                        <label for="reviewer_notes" class="form-label fw-bold text-success">
                                            <i class="fas fa-sticky-note me-2"></i>Internal Notes (Optional)
                                        </label>
                                        <textarea class="form-control review-comment" id="reviewer_notes" name="reviewer_notes" 
                                                  rows="3" placeholder="Internal notes for record keeping and future reference..."></textarea>
                                        <div class="form-text">
                                            <i class="fas fa-lock me-1"></i>
                                            These notes are for internal administrative use only and won't be shared with the applicant.
                                        </div>
                                    </div>
                                </div>

                                <!-- Action Buttons -->
                                <div class="mt-4 approval-actions">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <a href="{% url 'attendance:leave_list' %}" class="btn btn-outline-secondary btn-lg">
                                            <i class="fas fa-times me-1"></i> Cancel Review
                                        </a>
                                        <div class="btn-group">
                                            <button type="submit" class="btn btn-success btn-lg px-4">
                                                <i class="fas fa-check-circle me-1"></i> Submit Decision
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Sidebar Information -->
                <div class="col-lg-4">
                    <!-- Applicant Leave Balance -->
                    <div class="card shadow mb-4">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">
                                <i class="fas fa-chart-pie me-2"></i>Leave Balance
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="text-center mb-4">
                                <div class="balance-number text-primary">{{ applicant_balance.available|default:"0" }}</div>
                                <small class="text-muted">Available Days</small>
                            </div>
                            <div class="row text-center mb-3">
                                <div class="col-6">
                                    <div class="h5">{{ applicant_balance.used|default:"0" }}</div>
                                    <small class="text-muted">Used</small>
                                </div>
                                <div class="col-6">
                                    <div class="h5">{{ applicant_balance.pending|default:"0" }}</div>
                                    <small class="text-muted">Pending</small>
                                </div>
                            </div>
                            <div class="progress mt-3">
                                <div class="progress-bar" role="progressbar" 
                                     style="width: {{ applicant_balance.percentage|default:'0' }}%"
                                     aria-valuenow="{{ applicant_balance.percentage|default:'0' }}" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100">
                                </div>
                            </div>
                            <div class="text-center mt-2 small text-muted">
                                {{ applicant_balance.percentage|default:"0" }}% of annual leave used
                            </div>
                        </div>
                    </div>

                    <!-- Application Timeline -->
                    <div class="card shadow mb-4">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">
                                <i class="fas fa-stream me-2"></i>Application Timeline
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="timeline">
                                <div class="timeline-item">
                                    <strong>
                                        <i class="fas fa-paper-plane me-1 text-primary"></i>
                                        Application Submitted
                                    </strong><br>
                                    <small class="text-muted">{{ leaveapplication.created_at|date:"M d, Y" }} at {{ leaveapplication.created_at|time }}</small>
                                </div>
                                {% if leaveapplication.status != 'pending' %}
                                <div class="timeline-item {{ leaveapplication.status }}">
                                    <strong>
                                        <i class="fas fa-{% if leaveapplication.status == 'approved' %}check{% else %}times{% endif %} me-1 text-{% if leaveapplication.status == 'approved' %}success{% else %}danger{% endif %}"></i>
                                        {% if leaveapplication.status == 'approved' %}Approved{% else %}Rejected{% endif %}
                                    </strong><br>
                                    <small class="text-muted">
                                        {{ leaveapplication.approved_at|date:"M d, Y"|default:"" }} at {{ leaveapplication.approved_at|time|default:"" }}
                                    </small>
                                </div>
                                {% else %}
                                <div class="timeline-item pending">
                                    <strong>
                                        <i class="fas fa-clock me-1 text-warning"></i>
                                        Under Review
                                    </strong><br>
                                    <small class="text-muted">Awaiting decision</small>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="card shadow">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">
                                <i class="fas fa-bolt me-2"></i>Quick Actions
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <a href="mailto:{{ leaveapplication.applicant.email }}?subject=Leave Application: {{ leaveapplication.leave_type.name }}&body=Regarding your leave application from {{ leaveapplication.start_date }} to {{ leaveapplication.end_date }}" 
                                   class="btn quick-action-btn btn-outline-primary">
                                    <i class="fas fa-envelope me-1"></i> Email Applicant
                                </a>
                                <button type="button" class="btn quick-action-btn btn-outline-info" onclick="window.print()">
                                    <i class="fas fa-print me-1"></i> Print Details
                                </button>
                                {% if perms.attendance.change_leaveapplication and leaveapplication.status == 'pending' %}
                                <button type="button" class="btn quick-action-btn btn-outline-warning" onclick="document.getElementById('reviewForm').scrollIntoView({behavior: 'smooth'})">
                                    <i class="fas fa-edit me-1"></i> Quick Review
                                </button>
                                {% endif %}
                                {% if perms.attendance.delete_leaveapplication %}
                                <button type="button" class="btn quick-action-btn btn-outline-danger" data-bs-toggle="modal" 
                                        data-bs-target="#deleteModal">
                                    <i class="fas fa-trash me-1"></i> Delete Application
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Contact Information -->
                    <div class="card shadow mt-4">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">
                                <i class="fas fa-address-card me-2"></i>Contact Information
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="small">
                                <p class="mb-2">
                                    <strong><i class="fas fa-user me-2"></i></strong>
                                    {{ leaveapplication.applicant.get_full_name }}
                                </p>
                                <p class="mb-2">
                                    <strong><i class="fas fa-envelope me-2"></i></strong>
                                    <a href="mailto:{{ leaveapplication.applicant.email }}">{{ leaveapplication.applicant.email }}</a>
                                </p>
                                {% if leaveapplication.applicant.phone %}
                                <p class="mb-0">
                                    <strong><i class="fas fa-phone me-2"></i></strong>
                                    <a href="tel:{{ leaveapplication.applicant.phone }}">{{ leaveapplication.applicant.phone }}</a>
                                </p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>Delete Leave Application
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this leave application?</p>
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <strong>Warning:</strong> This action cannot be undone and will permanently remove the application from the system. All associated data will be lost.
                </div>
                <p><strong>Application Details:</strong></p>
                <ul>
                    <li>Applicant: {{ leaveapplication.applicant.get_full_name }}</li>
                    <li>Leave Type: {{ leaveapplication.leave_type.name }}</li>
                    <li>Period: {{ leaveapplication.start_date }} to {{ leaveapplication.end_date }}</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i> Cancel
                </button>
                <form method="post" action="{% url 'attendance:leave_delete' leaveapplication.pk %}" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash me-1"></i> Delete Application
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Show/hide rejection reason based on decision
    const statusSelect = document.getElementById('status');
    const rejectionSection = document.getElementById('rejectionReasonSection');
    
    if (statusSelect && rejectionSection) {
        statusSelect.addEventListener('change', function() {
            if (this.value === 'rejected') {
                rejectionSection.style.display = 'block';
                document.getElementById('rejection_reason').required = true;
            } else {
                rejectionSection.style.display = 'none';
                document.getElementById('rejection_reason').required = false;
            }
        });

        // Initialize on page load if there's a value
        if (statusSelect.value === 'rejected') {
            rejectionSection.style.display = 'block';
            document.getElementById('rejection_reason').required = true;
        }
    }

    // Form validation
    const reviewForm = document.getElementById('reviewForm');
    if (reviewForm) {
        reviewForm.addEventListener('submit', function(e) {
            const status = document.getElementById('status').value;
            const rejectionReason = document.getElementById('rejection_reason');
            
            if (!status) {
                e.preventDefault();
                showAlert('Please select a decision (Approve or Reject).', 'warning');
                statusSelect.focus();
                return;
            }
            
            if (status === 'rejected' && !rejectionReason.value.trim()) {
                e.preventDefault();
                showAlert('Please provide a rejection reason.', 'warning');
                rejectionReason.focus();
                return;
            }

            // Confirm submission
            if (!confirm('Are you sure you want to submit this decision? This action cannot be undone.')) {
                e.preventDefault();
                return;
            }
        });
    }

    // Add smooth scrolling for timeline items
    const timelineItems = document.querySelectorAll('.timeline-item');
    timelineItems.forEach(item => {
        item.style.opacity = '0';
        item.style.transform = 'translateX(-20px)';
        item.style.transition = 'all 0.5s ease';
    });

    // Animate timeline items on load
    setTimeout(() => {
        timelineItems.forEach((item, index) => {
            setTimeout(() => {
                item.style.opacity = '1';
                item.style.transform = 'translateX(0)';
            }, index * 200);
        });
    }, 500);
});

function showAlert(message, type) {
    // Remove any existing alerts
    const existingAlert = document.querySelector('.custom-alert');
    if (existingAlert) {
        existingAlert.remove();
    }

    const alertClass = type === 'warning' ? 'alert-warning' : 'alert-danger';
    const alertHtml = `
        <div class="custom-alert alert ${alertClass} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3" style="z-index: 9999;">
            <i class="fas fa-exclamation-triangle me-2"></i>${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', alertHtml);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        const alert = document.querySelector('.custom-alert');
        if (alert) {
            alert.remove();
        }
    }, 5000);
}

// Add keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl + Enter to submit form (when review form is visible)
    if (e.ctrlKey && e.key === 'Enter') {
        const reviewForm = document.getElementById('reviewForm');
        if (reviewForm && reviewForm.offsetParent !== null) {
            e.preventDefault();
            reviewForm.dispatchEvent(new Event('submit'));
        }
    }
    
    // Escape key to go back
    if (e.key === 'Escape') {
        const backButton = document.querySelector('a[href*="leave_list"]');
        if (backButton) {
            e.preventDefault();
            backButton.click();
        }
    }
});

// Print optimization
function beforePrint() {
    document.querySelectorAll('.btn, .card-header').forEach(el => {
        el.classList.add('print-hidden');
    });
}

function afterPrint() {
    document.querySelectorAll('.btn, .card-header').forEach(el => {
        el.classList.remove('print-hidden');
    });
}

// Add print event listeners
if (window.matchMedia) {
    const mediaQueryList = window.matchMedia('print');
    mediaQueryList.addListener(mql => {
        if (mql.matches) {
            beforePrint();
        } else {
            afterPrint();
        }
    });
}

window.onbeforeprint = beforePrint;
window.onafterprint = afterPrint;
</script>

<style>
@media print {
    .btn, .card-header, .breadcrumb, .modal, .quick-action-btn {
        display: none !important;
    }
    .card {
        border: 1px solid #000 !important;
        box-shadow: none !important;
    }
    .leave-detail-card {
        border-left: 4px solid #000 !important;
    }
    .text-primary {
        color: #000 !important;
    }
}
</style>
{% endblock %}