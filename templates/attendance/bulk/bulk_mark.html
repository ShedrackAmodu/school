<!-- templates/attendance/bulk/bulk_mark.html -->
{% extends 'base/base.html' %}
{% load static %}

{% block title %}Bulk Attendance - {{ class_obj.name }} - School Management System{% endblock %}

{% block extra_css %}
<style>
.student-card {
    transition: all 0.3s ease;
    border: 2px solid transparent;
}
.student-card:hover {
    border-color: #007bff;
}
.student-card.selected {
    border-color: #28a745;
    background-color: #f8fff9;
}
.attendance-status-btn {
    transition: all 0.3s ease;
}
.status-present {
    background-color: #28a745;
    border-color: #28a745;
    color: white;
}
.status-absent {
    background-color: #dc3545;
    border-color: #dc3545;
    color: white;
}
.status-late {
    background-color: #ffc107;
    border-color: #ffc107;
    color: #212529;
}
.status-half_day {
    background-color: #fd7e14;
    border-color: #fd7e14;
    color: white;
}
.status-leave {
    background-color: #17a2b8;
    border-color: #17a2b8;
    color: white;
}
.bulk-action-bar {
    position: sticky;
    bottom: 0;
    background: white;
    border-top: 2px solid #dee2e6;
    padding: 1rem 0;
    margin-top: 2rem;
}
.progress-bar-animated {
    animation: progress-bar-stripes 1s linear infinite;
}
.student-avatar {
    width: 50px;
    height: 50px;
    object-fit: cover;
}
.quick-select-buttons .btn {
    margin: 2px;
}
.marking-progress {
    font-size: 0.9rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-2">Bulk Attendance - {{ class_obj.name }}</h1>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="{% url 'attendance:dashboard' %}">Dashboard</a></li>
                            <li class="breadcrumb-item"><a href="{% url 'attendance:bulk_class_select' %}">Bulk Marking</a></li>
                            <li class="breadcrumb-item active">{{ class_obj.name }}</li>
                        </ol>
                    </nav>
                </div>
                <div class="d-flex gap-2">
                    <a href="{% url 'attendance:bulk_class_select' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i> Back to Classes
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Session Configuration -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Attendance Session Configuration</h6>
        </div>
        <div class="card-body">
            <form method="post" id="bulkAttendanceForm">
                {% csrf_token %}
                <div class="row g-3">
                    <div class="col-md-3">
                        <label for="date" class="form-label">Attendance Date</label>
                        <input type="date" class="form-control" id="date" name="date" 
                               value="{{ today|date:'Y-m-d' }}" required>
                    </div>
                    <div class="col-md-3">
                        <label for="attendance_session" class="form-label">Session</label>
                        <select class="form-select" id="attendance_session" name="attendance_session" required>
                            <option value="">Select Session</option>
                            {% for session in attendance_sessions %}
                            <option value="{{ session.id }}">{{ session.name }} ({{ session.start_time|time }} - {{ session.end_time|time }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="default_status" class="form-label">Default Status</label>
                        <select class="form-select" id="default_status" name="default_status">
                            <option value="present">Present</option>
                            <option value="absent">Absent</option>
                            <option value="late">Late</option>
                            <option value="half_day">Half Day</option>
                            <option value="leave">Leave</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-grid">
                            <button type="button" id="applyDefaultBtn" class="btn btn-warning">
                                <i class="fas fa-bolt me-1"></i> Apply Default
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Quick Actions Bar -->
    <div class="card shadow mb-4">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h6 class="mb-0">Quick Selection</h6>
                    <div class="quick-select-buttons mt-2">
                        <button type="button" class="btn btn-sm btn-outline-success mark-all-btn" data-status="present">
                            <i class="fas fa-check me-1"></i> Mark All Present
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-danger mark-all-btn" data-status="absent">
                            <i class="fas fa-times me-1"></i> Mark All Absent
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-warning mark-all-btn" data-status="late">
                            <i class="fas fa-clock me-1"></i> Mark All Late
                        </button>
                    </div>
                </div>
                <div class="col-md-6 text-end">
                    <div class="marking-progress">
                        <strong id="markedCount">0</strong> of <strong>{{ students.count }}</strong> students marked
                        <div class="progress mt-1" style="height: 8px;">
                            <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Students Grid -->
    <div class="row" id="studentsGrid">
        {% for student in students %}
        <div class="col-xl-3 col-lg-4 col-md-6 mb-4">
            <div class="card student-card h-100" data-student-id="{{ student.id }}">
                <div class="card-body">
                    <!-- Student Info -->
                    <div class="d-flex align-items-center mb-3">
                        <img src="{% if student.user.profile_picture %}{{ student.user.profile_picture.url }}{% else %}{% static 'img/default-avatar.png' %}{% endif %}" 
                             alt="{{ student.user.get_full_name }}" 
                             class="student-avatar rounded-circle me-3">
                        <div class="flex-grow-1">
                            <h6 class="mb-1">{{ student.user.get_full_name }}</h6>
                            <small class="text-muted">{{ student.admission_number }}</small>
                        </div>
                    </div>

                    <!-- Attendance Status -->
                    <div class="mb-3">
                        <label class="form-label small text-muted mb-2">Attendance Status</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="status_{{ student.id }}" 
                                   id="present_{{ student.id }}" value="present" autocomplete="off">
                            <label class="btn btn-outline-success btn-sm attendance-status-btn" for="present_{{ student.id }}">
                                <i class="fas fa-check"></i>
                            </label>

                            <input type="radio" class="btn-check" name="status_{{ student.id }}" 
                                   id="absent_{{ student.id }}" value="absent" autocomplete="off">
                            <label class="btn btn-outline-danger btn-sm attendance-status-btn" for="absent_{{ student.id }}">
                                <i class="fas fa-times"></i>
                            </label>

                            <input type="radio" class="btn-check" name="status_{{ student.id }}" 
                                   id="late_{{ student.id }}" value="late" autocomplete="off">
                            <label class="btn btn-outline-warning btn-sm attendance-status-btn" for="late_{{ student.id }}">
                                <i class="fas fa-clock"></i>
                            </label>

                            <input type="radio" class="btn-check" name="status_{{ student.id }}" 
                                   id="half_day_{{ student.id }}" value="half_day" autocomplete="off">
                            <label class="btn btn-outline-orange btn-sm attendance-status-btn" for="half_day_{{ student.id }}">
                                Â½
                            </label>

                            <input type="radio" class="btn-check" name="status_{{ student.id }}" 
                                   id="leave_{{ student.id }}" value="leave" autocomplete="off">
                            <label class="btn btn-outline-info btn-sm attendance-status-btn" for="leave_{{ student.id }}">
                                <i class="fas fa-calendar-minus"></i>
                            </label>
                        </div>
                    </div>

                    <!-- Remarks -->
                    <div class="mb-3">
                        <label for="remarks_{{ student.id }}" class="form-label small text-muted">Remarks</label>
                        <textarea class="form-control form-control-sm" id="remarks_{{ student.id }}" 
                                  name="remarks_{{ student.id }}" rows="2" 
                                  placeholder="Optional remarks..."></textarea>
                    </div>

                    <!-- Today's Previous Attendance -->
                    <div class="previous-attendance">
                        <small class="text-muted">
                            {% with prev_attendance=student.get_today_attendance %}
                            {% if prev_attendance %}
                            <i class="fas fa-history me-1"></i>
                            Previously: <span class="badge bg-secondary">{{ prev_attendance.get_status_display }}</span>
                            {% else %}
                            <i class="fas fa-info-circle me-1"></i>
                            Not marked today
                            {% endif %}
                            {% endwith %}
                        </small>
                    </div>
                </div>
                <div class="card-footer bg-transparent py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">Click status to mark</small>
                        <div class="form-check form-switch">
                            <input class="form-check-input student-toggle" type="checkbox" 
                                   id="toggle_{{ student.id }}" checked>
                            <label class="form-check-label" for="toggle_{{ student.id }}"></label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <div class="text-center py-5">
                <i class="fas fa-users fa-4x text-muted mb-3"></i>
                <h4 class="text-muted">No Students Found</h4>
                <p class="text-muted">There are no active students in this class.</p>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Bulk Action Bar -->
    <div class="bulk-action-bar">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="d-flex align-items-center">
                        <div class="form-check me-3">
                            <input class="form-check-input" type="checkbox" id="selectAllStudents">
                            <label class="form-check-label" for="selectAllStudents">
                                Select All
                            </label>
                        </div>
                        <div class="marking-stats">
                            <span id="selectedCount" class="badge bg-primary">0 selected</span>
                            <span id="completedCount" class="badge bg-success ms-2">0 completed</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 text-end">
                    <div class="btn-group">
                        <button type="button" id="saveDraftBtn" class="btn btn-outline-warning">
                            <i class="fas fa-save me-1"></i> Save Draft
                        </button>
                        <button type="button" id="submitAttendanceBtn" class="btn btn-success">
                            <i class="fas fa-paper-plane me-1"></i> Submit Attendance
                        </button>
                        <button type="button" id="submitAndNextBtn" class="btn btn-primary">
                            <i class="fas fa-forward me-1"></i> Submit & Next Class
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmationModalLabel">Confirm Submission</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>You are about to submit attendance for <strong id="confirmCount">0</strong> students.</p>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    This action cannot be undone. Please review all entries before submitting.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="confirmSubmitBtn" class="btn btn-success">Confirm Submission</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('bulkAttendanceForm');
    const studentsGrid = document.getElementById('studentsGrid');
    const progressBar = document.getElementById('progressBar');
    const markedCount = document.getElementById('markedCount');
    const selectedCount = document.getElementById('selectedCount');
    const completedCount = document.getElementById('completedCount');
    const selectAllCheckbox = document.getElementById('selectAllStudents');
    
    let markedStudents = new Set();
    let selectedStudents = new Set();

    // Initialize date to today if not set
    const dateField = document.getElementById('date');
    if (!dateField.value) {
        dateField.value = new Date().toISOString().split('T')[0];
    }

    // Apply default status to all students
    document.getElementById('applyDefaultBtn').addEventListener('click', function() {
        const defaultStatus = document.getElementById('default_status').value;
        const statusRadios = document.querySelectorAll('input[type="radio"][name^="status_"]');
        
        statusRadios.forEach(radio => {
            if (radio.value === defaultStatus) {
                radio.checked = true;
                radio.dispatchEvent(new Event('change'));
            }
        });
        
        updateProgress();
    });

    // Mark all buttons
    document.querySelectorAll('.mark-all-btn').forEach(button => {
        button.addEventListener('click', function() {
            const status = this.getAttribute('data-status');
            const statusRadios = document.querySelectorAll(`input[type="radio"][name^="status_"][value="${status}"]`);
            
            statusRadios.forEach(radio => {
                radio.checked = true;
                radio.dispatchEvent(new Event('change'));
            });
            
            updateProgress();
        });
    });

    // Attendance status change handler
    studentsGrid.addEventListener('change', function(e) {
        if (e.target.type === 'radio' && e.target.name.startsWith('status_')) {
            const studentId = e.target.name.split('_')[1];
            const studentCard = document.querySelector(`[data-student-id="${studentId}"]`);
            
            if (e.target.checked) {
                markedStudents.add(studentId);
                studentCard.classList.add('selected');
                
                // Update button appearance
                const statusButtons = studentCard.querySelectorAll('.attendance-status-btn');
                statusButtons.forEach(btn => btn.classList.remove('status-present', 'status-absent', 'status-late', 'status-half_day', 'status-leave'));
                
                const activeLabel = studentCard.querySelector(`label[for="${e.target.id}"]`);
                activeLabel.classList.add(`status-${e.target.value}`);
            }
            
            updateProgress();
        }
    });

    // Student toggle handler
    studentsGrid.addEventListener('change', function(e) {
        if (e.target.classList.contains('student-toggle')) {
            const studentId = e.target.id.split('_')[1];
            const studentCard = document.querySelector(`[data-student-id="${studentId}"]`);
            
            if (e.target.checked) {
                selectedStudents.add(studentId);
                studentCard.style.opacity = '1';
            } else {
                selectedStudents.delete(studentId);
                studentCard.style.opacity = '0.6';
            }
            
            updateSelectedCount();
        }
    });

    // Select all students
    selectAllCheckbox.addEventListener('change', function() {
        const toggles = document.querySelectorAll('.student-toggle');
        toggles.forEach(toggle => {
            toggle.checked = this.checked;
            toggle.dispatchEvent(new Event('change'));
        });
    });

    // Update progress indicators
    function updateProgress() {
        const totalStudents = {{ students.count }};
        const marked = markedStudents.size;
        const percentage = totalStudents > 0 ? (marked / totalStudents) * 100 : 0;
        
        progressBar.style.width = `${percentage}%`;
        markedCount.textContent = marked;
        completedCount.textContent = `${marked} completed`;
        
        // Update progress bar color
        if (percentage === 100) {
            progressBar.className = 'progress-bar bg-success';
        } else if (percentage > 0) {
            progressBar.className = 'progress-bar bg-warning progress-bar-animated';
        } else {
            progressBar.className = 'progress-bar';
        }
    }

    function updateSelectedCount() {
        selectedCount.textContent = `${selectedStudents.size} selected`;
    }

    // Form submission
    document.getElementById('submitAttendanceBtn').addEventListener('click', function() {
        if (markedStudents.size === 0) {
            alert('Please mark attendance for at least one student before submitting.');
            return;
        }
        
        document.getElementById('confirmCount').textContent = markedStudents.size;
        const modal = new bootstrap.Modal(document.getElementById('confirmationModal'));
        modal.show();
    });

    document.getElementById('confirmSubmitBtn').addEventListener('click', function() {
        // Show loading state
        const submitBtn = document.getElementById('submitAttendanceBtn');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Submitting...';
        submitBtn.disabled = true;

        // Submit form
        form.submit();
    });

    // Save draft functionality
    document.getElementById('saveDraftBtn').addEventListener('click', function() {
        // Implement draft saving logic here
        console.log('Saving draft...');
        alert('Draft saved successfully!');
    });

    // Initialize
    updateProgress();
    updateSelectedCount();
});
</script>
{% endblock %}