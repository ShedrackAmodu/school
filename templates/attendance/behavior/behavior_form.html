{% extends 'base.html' %}
{% load static %}

{% block title %}{% if object %}Edit{% else %}Create{% endif %} Behavior Record{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        {% if object %}Edit{% else %}Create{% endif %} Behavior Record
                    </h3>
                    <div class="card-tools">
                        <a href="{% url 'attendance:behavior_list' %}" class="btn btn-secondary btn-sm">
                            <i class="fas fa-arrow-left"></i> Back to List
                        </a>
                    </div>
                </div>

                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}

                    <div class="card-body">
                        <!-- Incident Information -->
                        <div class="row">
                            <div class="col-12">
                                <h5 class="text-primary mb-3">
                                    <i class="fas fa-exclamation-triangle"></i> Incident Information
                                </h5>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.student.id_for_label }}" class="form-label">Student <span class="text-danger">*</span></label>
                                    {{ form.student }}
                                    {% if form.student.errors %}
                                        <div class="text-danger small">{{ form.student.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.incident_date.id_for_label }}" class="form-label">Incident Date <span class="text-danger">*</span></label>
                                    {{ form.incident_date }}
                                    {% if form.incident_date.errors %}
                                        <div class="text-danger small">{{ form.incident_date.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.incident_time.id_for_label }}" class="form-label">Incident Time</label>
                                    {{ form.incident_time }}
                                    {% if form.incident_time.errors %}
                                        <div class="text-danger small">{{ form.incident_time.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.location.id_for_label }}" class="form-label">Location</label>
                                    {{ form.location }}
                                    {% if form.location.errors %}
                                        <div class="text-danger small">{{ form.location.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12">
                                <div class="mb-3">
                                    <label for="{{ form.title.id_for_label }}" class="form-label">Incident Title <span class="text-danger">*</span></label>
                                    {{ form.title }}
                                    {% if form.title.errors %}
                                        <div class="text-danger small">{{ form.title.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12">
                                <div class="mb-3">
                                    <label for="{{ form.description.id_for_label }}" class="form-label">Detailed Description <span class="text-danger">*</span></label>
                                    {{ form.description }}
                                    {% if form.description.errors %}
                                        <div class="text-danger small">{{ form.description.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Classification -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <h5 class="text-primary mb-3">
                                    <i class="fas fa-tags"></i> Classification
                                </h5>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.behavior_type.id_for_label }}" class="form-label">Behavior Type <span class="text-danger">*</span></label>
                                    {{ form.behavior_type }}
                                    {% if form.behavior_type.errors %}
                                        <div class="text-danger small">{{ form.behavior_type.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.severity.id_for_label }}" class="form-label">Severity <span class="text-danger">*</span></label>
                                    {{ form.severity }}
                                    {% if form.severity.errors %}
                                        <div class="text-danger small">{{ form.severity.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.incident_category.id_for_label }}" class="form-label">Incident Category <span class="text-danger">*</span></label>
                                    {{ form.incident_category }}
                                    {% if form.incident_category.errors %}
                                        <div class="text-danger small">{{ form.incident_category.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Evidence & Witnesses -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <h5 class="text-primary mb-3">
                                    <i class="fas fa-search"></i> Evidence & Witnesses
                                </h5>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.evidence_description.id_for_label }}" class="form-label">Evidence Description</label>
                                    {{ form.evidence_description }}
                                    {% if form.evidence_description.errors %}
                                        <div class="text-danger small">{{ form.evidence_description.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.evidence_files.id_for_label }}" class="form-label">Evidence Files</label>
                                    {{ form.evidence_files }}
                                    {% if form.evidence_files.errors %}
                                        <div class="text-danger small">{{ form.evidence_files.errors.0 }}</div>
                                    {% endif %}
                                    <div class="form-text">Supported formats: PDF, JPG, PNG, MP4, DOC, DOCX</div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <div class="form-check">
                                        {{ form.has_witnesses }}
                                        <label for="{{ form.has_witnesses.id_for_label }}" class="form-check-label">
                                            Has Witnesses
                                        </label>
                                    </div>
                                    {% if form.has_witnesses.errors %}
                                        <div class="text-danger small">{{ form.has_witnesses.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.witnesses.id_for_label }}" class="form-label">Witnesses</label>
                                    {{ form.witnesses }}
                                    {% if form.witnesses.errors %}
                                        <div class="text-danger small">{{ form.witnesses.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.witness_statements.id_for_label }}" class="form-label">Witness Statements</label>
                                    {{ form.witness_statements }}
                                    {% if form.witness_statements.errors %}
                                        <div class="text-danger small">{{ form.witness_statements.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Action & Consequences -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <h5 class="text-primary mb-3">
                                    <i class="fas fa-gavel"></i> Action & Consequences
                                </h5>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12">
                                <div class="mb-3">
                                    <label for="{{ form.action_taken.id_for_label }}" class="form-label">Action Taken</label>
                                    {{ form.action_taken }}
                                    {% if form.action_taken.errors %}
                                        <div class="text-danger small">{{ form.action_taken.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.consequence_type.id_for_label }}" class="form-label">Consequence Type</label>
                                    {{ form.consequence_type }}
                                    {% if form.consequence_type.errors %}
                                        <div class="text-danger small">{{ form.consequence_type.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.consequence_duration.id_for_label }}" class="form-label">Consequence Duration</label>
                                    {{ form.consequence_duration }}
                                    {% if form.consequence_duration.errors %}
                                        <div class="text-danger small">{{ form.consequence_duration.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.action_deadline.id_for_label }}" class="form-label">Action Deadline</label>
                                    {{ form.action_deadline }}
                                    {% if form.action_deadline.errors %}
                                        <div class="text-danger small">{{ form.action_deadline.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="mb-3">
                                    <div class="form-check mt-4">
                                        {{ form.action_completed }}
                                        <label for="{{ form.action_completed.id_for_label }}" class="form-check-label">
                                            Action Completed
                                        </label>
                                    </div>
                                    {% if form.action_completed.errors %}
                                        <div class="text-danger small">{{ form.action_completed.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Follow-up & Resolution -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <h5 class="text-primary mb-3">
                                    <i class="fas fa-calendar-check"></i> Follow-up & Resolution
                                </h5>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <div class="form-check">
                                        {{ form.follow_up_required }}
                                        <label for="{{ form.follow_up_required.id_for_label }}" class="form-check-label">
                                            Follow-up Required
                                        </label>
                                    </div>
                                    {% if form.follow_up_required.errors %}
                                        <div class="text-danger small">{{ form.follow_up_required.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.follow_up_date.id_for_label }}" class="form-label">Follow-up Date</label>
                                    {{ form.follow_up_date }}
                                    {% if form.follow_up_date.errors %}
                                        <div class="text-danger small">{{ form.follow_up_date.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.next_follow_up_date.id_for_label }}" class="form-label">Next Follow-up Date</label>
                                    {{ form.next_follow_up_date }}
                                    {% if form.next_follow_up_date.errors %}
                                        <div class="text-danger small">{{ form.next_follow_up_date.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.follow_up_notes.id_for_label }}" class="form-label">Follow-up Notes</label>
                                    {{ form.follow_up_notes }}
                                    {% if form.follow_up_notes.errors %}
                                        <div class="text-danger small">{{ form.follow_up_notes.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <div class="form-check">
                                        {{ form.is_resolved }}
                                        <label for="{{ form.is_resolved.id_for_label }}" class="form-check-label">
                                            Is Resolved
                                        </label>
                                    </div>
                                    {% if form.is_resolved.errors %}
                                        <div class="text-danger small">{{ form.is_resolved.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.resolution_date.id_for_label }}" class="form-label">Resolution Date</label>
                                    {{ form.resolution_date }}
                                    {% if form.resolution_date.errors %}
                                        <div class="text-danger small">{{ form.resolution_date.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12">
                                <div class="mb-3">
                                    <label for="{{ form.resolution.id_for_label }}" class="form-label">Resolution Details</label>
                                    {{ form.resolution }}
                                    {% if form.resolution.errors %}
                                        <div class="text-danger small">{{ form.resolution.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Parent Communication -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <h5 class="text-primary mb-3">
                                    <i class="fas fa-users"></i> Parent Communication
                                </h5>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <div class="form-check">
                                        {{ form.parent_notified }}
                                        <label for="{{ form.parent_notified.id_for_label }}" class="form-check-label">
                                            Parent Notified
                                        </label>
                                    </div>
                                    {% if form.parent_notified.errors %}
                                        <div class="text-danger small">{{ form.parent_notified.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.parent_notification_date.id_for_label }}" class="form-label">Parent Notification Date</label>
                                    {{ form.parent_notification_date }}
                                    {% if form.parent_notification_date.errors %}
                                        <div class="text-danger small">{{ form.parent_notification_date.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.parent_response.id_for_label }}" class="form-label">Parent Response</label>
                                    {{ form.parent_response }}
                                    {% if form.parent_response.errors %}
                                        <div class="text-danger small">{{ form.parent_response.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="mb-3">
                                    <div class="form-check mt-4">
                                        {{ form.parent_meeting_scheduled }}
                                        <label for="{{ form.parent_meeting_scheduled.id_for_label }}" class="form-check-label">
                                            Parent Meeting Scheduled
                                        </label>
                                    </div>
                                    {% if form.parent_meeting_scheduled.errors %}
                                        <div class="text-danger small">{{ form.parent_meeting_scheduled.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.parent_meeting_date.id_for_label }}" class="form-label">Parent Meeting Date</label>
                                    {{ form.parent_meeting_date }}
                                    {% if form.parent_meeting_date.errors %}
                                        <div class="text-danger small">{{ form.parent_meeting_date.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Escalation -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <h5 class="text-primary mb-3">
                                    <i class="fas fa-arrow-up"></i> Escalation
                                </h5>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.escalated_to.id_for_label }}" class="form-label">Escalated To</label>
                                    {{ form.escalated_to }}
                                    {% if form.escalated_to.errors %}
                                        <div class="text-danger small">{{ form.escalated_to.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.escalation_date.id_for_label }}" class="form-label">Escalation Date</label>
                                    {{ form.escalation_date }}
                                    {% if form.escalation_date.errors %}
                                        <div class="text-danger small">{{ form.escalation_date.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12">
                                <div class="mb-3">
                                    <label for="{{ form.escalation_reason.id_for_label }}" class="form-label">Escalation Reason</label>
                                    {{ form.escalation_reason }}
                                    {% if form.escalation_reason.errors %}
                                        <div class="text-danger small">{{ form.escalation_reason.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Additional Fields -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <h5 class="text-primary mb-3">
                                    <i class="fas fa-plus"></i> Additional Information
                                </h5>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12">
                                <div class="mb-3">
                                    <label for="{{ form.tags.id_for_label }}" class="form-label">Tags</label>
                                    {{ form.tags }}
                                    {% if form.tags.errors %}
                                        <div class="text-danger small">{{ form.tags.errors.0 }}</div>
                                    {% endif %}
                                    <div class="form-text">Comma-separated tags for categorization</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card-footer">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> {% if object %}Update{% else %}Create{% endif %} Record
                        </button>
                        <a href="{% url 'attendance:behavior_list' %}" class="btn btn-secondary ms-2">
                            <i class="fas fa-times"></i> Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Auto-populate resolution date when resolved checkbox is checked
document.getElementById('{{ form.is_resolved.id_for_label }}').addEventListener('change', function() {
    const resolutionDateField = document.getElementById('{{ form.resolution_date.id_for_label }}');
    if (this.checked) {
        const today = new Date().toISOString().split('T')[0];
        resolutionDateField.value = today;
    } else {
        resolutionDateField.value = '';
    }
});

// Auto-populate parent notification date when notified checkbox is checked
document.getElementById('{{ form.parent_notified.id_for_label }}').addEventListener('change', function() {
    const notificationDateField = document.getElementById('{{ form.parent_notification_date.id_for_label }}');
    if (this.checked) {
        const today = new Date().toISOString().split('T')[0];
        notificationDateField.value = today;
    } else {
        notificationDateField.value = '';
    }
});

// Show/hide witness fields based on has_witnesses checkbox
document.getElementById('{{ form.has_witnesses.id_for_label }}').addEventListener('change', function() {
    const witnessFields = document.querySelectorAll('[id*="witness"]');
    witnessFields.forEach(field => {
        field.closest('.mb-3').style.display = this.checked ? 'block' : 'none';
    });
});

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    const hasWitnessesCheckbox = document.getElementById('{{ form.has_witnesses.id_for_label }}');
    if (hasWitnessesCheckbox) {
        const witnessFields = document.querySelectorAll('[id*="witness"]');
        witnessFields.forEach(field => {
            field.closest('.mb-3').style.display = hasWitnessesCheckbox.checked ? 'block' : 'none';
        });
    }
});
</script>
{% endblock %}
