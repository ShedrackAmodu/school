<!-- templates/academics/reports/class_report.html -->
{% extends 'academics/base/base.html' %}
{% load static i18n %}

{% block title %}
    {% trans "Class Report" %} - {{ class_obj.name }}
{% endblock %}

{% block page_title %}
    {% trans "Class Report" %} - {{ class_obj.name }}
{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'academics:dashboard' %}">{% trans "Academics" %}</a></li>
<li class="breadcrumb-item"><a href="{% url 'academics:class_list' %}">{% trans "Classes" %}</a></li>
<li class="breadcrumb-item"><a href="{% url 'academics:class_detail' class_obj.pk %}">{{ class_obj.name }}</a></li>
<li class="breadcrumb-item active" aria-current="page">{% trans "Class Report" %}</li>
{% endblock %}

{% block page_actions %}
<div class="page-actions">
    <div class="btn-group" role="group">
        <button type="button" class="btn btn-outline-primary" onclick="window.print()">
            <i class="bi bi-printer me-1"></i> {% trans "Print Report" %}
        </button>
        <button type="button" class="btn btn-outline-success" id="export-pdf-btn">
            <i class="bi bi-file-pdf me-1"></i> {% trans "Export PDF" %}
        </button>
        <button type="button" class="btn btn-outline-info" id="export-excel-btn">
            <i class="bi bi-file-spreadsheet me-1"></i> {% trans "Export Excel" %}
        </button>
        <a href="{% url 'academics:class_detail' class_obj.pk %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i> {% trans "Back to Class" %}
        </a>
    </div>
</div>
{% endblock %}

{% block content %}
<style>
.class-report-container {
    font-family: 'Inter', sans-serif;
}

.report-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 0.75rem;
    padding: 2rem;
    margin-bottom: 2rem;
    text-align: center;
}

.report-title {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.report-subtitle {
    font-size: 1.1rem;
    opacity: 0.9;
    margin-bottom: 0;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: #fff;
    border: 1px solid #e9ecef;
    border-radius: 0.75rem;
    padding: 1.5rem;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    transition: transform 0.2s ease;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.stat-number {
    font-size: 2.5rem;
    font-weight: 700;
    display: block;
    line-height: 1;
}

.stat-label {
    font-size: 0.875rem;
    color: #6c757d;
    margin-top: 0.5rem;
    font-weight: 500;
}

.stat-trend {
    font-size: 0.75rem;
    margin-top: 0.25rem;
}

.trend-up {
    color: #28a745;
}

.trend-down {
    color: #dc3545;
}

.trend-neutral {
    color: #6c757d;
}

.info-card {
    background: #fff;
    border: 1px solid #e9ecef;
    border-radius: 0.75rem;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.info-card .card-header {
    background: none;
    border-bottom: 2px solid #e9ecef;
    padding: 0 0 1rem 0;
    margin-bottom: 1rem;
}

.info-card .card-title {
    color: #495057;
    font-weight: 600;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.students-table {
    width: 100%;
    border-collapse: collapse;
}

.students-table th {
    background: #f8f9fa;
    padding: 0.75rem;
    text-align: left;
    font-weight: 600;
    color: #495057;
    border-bottom: 2px solid #e9ecef;
}

.students-table td {
    padding: 0.75rem;
    border-bottom: 1px solid #e9ecef;
    vertical-align: middle;
}

.students-table tr:hover {
    background: #f8f9fa;
}

.student-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
}

.student-info {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.student-name {
    font-weight: 600;
    color: #212529;
}

.student-id {
    font-size: 0.875rem;
    color: #6c757d;
}

.performance-badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    border-radius: 0.375rem;
}

.performance-excellent { background: #d4edda; color: #155724; }
.performance-good { background: #d1ecf1; color: #0c5460; }
.performance-average { background: #fff3cd; color: #856404; }
.performance-poor { background: #f8d7da; color: #721c24; }

.attendance-chart-container {
    height: 300px;
    margin: 1.5rem 0;
}

.grade-distribution {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    margin: 1.5rem 0;
}

.grade-item {
    text-align: center;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 0.5rem;
}

.grade-letter {
    font-size: 1.5rem;
    font-weight: 700;
    display: block;
    margin-bottom: 0.5rem;
}

.grade-count {
    font-size: 1.25rem;
    font-weight: 600;
    color: #495057;
    display: block;
}

.grade-percentage {
    font-size: 0.875rem;
    color: #6c757d;
}

.subject-performance {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
    margin: 1.5rem 0;
}

.subject-card {
    background: #fff;
    border: 1px solid #e9ecef;
    border-radius: 0.5rem;
    padding: 1rem;
    text-align: center;
}

.subject-name {
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: #495057;
}

.subject-average {
    font-size: 1.5rem;
    font-weight: 700;
    color: #0d6efd;
    margin-bottom: 0.5rem;
}

.subject-teacher {
    font-size: 0.875rem;
    color: #6c757d;
}

.progress-bar-container {
    background: #e9ecef;
    border-radius: 0.375rem;
    height: 8px;
    overflow: hidden;
    margin: 0.5rem 0;
}

.progress-bar {
    height: 100%;
    background: #0d6efd;
    border-radius: 0.375rem;
    transition: width 0.3s ease;
}

.teacher-contact {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 0.5rem;
    margin: 1rem 0;
}

.teacher-avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    object-fit: cover;
}

.teacher-info h6 {
    margin-bottom: 0.25rem;
    color: #212529;
}

.teacher-info p {
    margin-bottom: 0.25rem;
    color: #6c757d;
    font-size: 0.875rem;
}

.timeline {
    position: relative;
    padding-left: 2rem;
    margin: 1.5rem 0;
}

.timeline::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #e9ecef;
}

.timeline-item {
    position: relative;
    margin-bottom: 1.5rem;
    padding-left: 1.5rem;
}

.timeline-item::before {
    content: '';
    position: absolute;
    left: -0.5rem;
    top: 0.5rem;
    width: 1rem;
    height: 1rem;
    border-radius: 50%;
    background: #0d6efd;
    border: 3px solid #fff;
    box-shadow: 0 0 0 2px #0d6efd;
}

.timeline-date {
    font-size: 0.875rem;
    color: #6c757d;
    margin-bottom: 0.25rem;
}

.timeline-content {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 0.5rem;
    border-left: 3px solid #0d6efd;
}

.report-section {
    page-break-inside: avoid;
}

@media print {
    .page-actions,
    .sidebar,
    .navigation {
        display: none !important;
    }
    
    .report-header {
        background: #fff !important;
        color: #000 !important;
        border: 2px solid #000;
    }
    
    .stat-card {
        border: 1px solid #000;
        box-shadow: none;
    }
    
    .info-card {
        border: 1px solid #000;
        box-shadow: none;
        page-break-inside: avoid;
    }
    
    body {
        font-size: 12pt;
        line-height: 1.4;
    }
}

@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
    }
    
    .students-table {
        font-size: 0.875rem;
    }
    
    .student-info {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }
    
    .page-actions .btn-group {
        flex-direction: column;
        width: 100%;
    }
    
    .page-actions .btn {
        margin-bottom: 0.5rem;
    }
}

.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    display: none;
}

.export-options {
    background: #f8f9fa;
    border-radius: 0.5rem;
    padding: 1rem;
    margin: 1rem 0;
}

.chart-container {
    position: relative;
    height: 300px;
    margin: 1.5rem 0;
}

.legend {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin: 1rem 0;
    justify-content: center;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
}

.legend-color {
    width: 12px;
    height: 12px;
    border-radius: 2px;
}

.comparison-card {
    background: #fff;
    border: 1px solid #e9ecef;
    border-radius: 0.5rem;
    padding: 1rem;
    margin: 0.5rem 0;
}

.comparison-item {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.comparison-label {
    flex: 1;
    font-weight: 500;
}

.comparison-value {
    font-weight: 600;
    color: #495057;
}

.comparison-bar {
    flex: 2;
    height: 8px;
    background: #e9ecef;
    border-radius: 4px;
    overflow: hidden;
    margin: 0 1rem;
}

.comparison-fill {
    height: 100%;
    background: #0d6efd;
    border-radius: 4px;
}
</style>

<div class="class-report-container">
    <!-- Report Header -->
    <div class="report-header">
        <h1 class="report-title">{% trans "Class Academic Report" %}</h1>
        <p class="report-subtitle">{{ class_obj.name }} - {{ class_obj.academic_session.name }}</p>
        <p class="report-subtitle mb-0">{% trans "Generated on" %} {% now "F d, Y" %}</p>
    </div>

    <!-- Quick Statistics -->
    <div class="stats-grid">
        <div class="stat-card">
            <span class="stat-number">{{ total_students }}</span>
            <span class="stat-label">{% trans "Total Students" %}</span>
            <div class="stat-trend trend-neutral">
                <i class="bi bi-dash-circle me-1"></i> {% trans "Full capacity" %}
            </div>
        </div>
        
        <div class="stat-card">
            <span class="stat-number">{{ average_grade|default:"-" }}</span>
            <span class="stat-label">{% trans "Average Grade" %}</span>
            <div class="stat-trend {% if grade_trend == 'up' %}trend-up{% elif grade_trend == 'down' %}trend-down{% else %}trend-neutral{% endif %}">
                {% if grade_trend == 'up' %}
                <i class="bi bi-arrow-up-circle me-1"></i> {% trans "Improving" %}
                {% elif grade_trend == 'down' %}
                <i class="bi bi-arrow-down-circle me-1"></i> {% trans "Declining" %}
                {% else %}
                <i class="bi bi-dash-circle me-1"></i> {% trans "Stable" %}
                {% endif %}
            </div>
        </div>
        
        <div class="stat-card">
            <span class="stat-number">{{ attendance_rate }}%</span>
            <span class="stat-label">{% trans "Attendance Rate" %}</span>
            <div class="stat-trend {% if attendance_trend == 'up' %}trend-up{% elif attendance_trend == 'down' %}trend-down{% else %}trend-neutral{% endif %}">
                {% if attendance_trend == 'up' %}
                <i class="bi bi-arrow-up-circle me-1"></i> +{{ attendance_change }}%
                {% elif attendance_trend == 'down' %}
                <i class="bi bi-arrow-down-circle me-1"></i> {{ attendance_change }}%
                {% else %}
                <i class="bi bi-dash-circle me-1"></i> {% trans "No change" %}
                {% endif %}
            </div>
        </div>
        
        <div class="stat-card">
            <span class="stat-number">{{ top_performer_count }}</span>
            <span class="stat-label">{% trans "Top Performers" %}</span>
            <div class="stat-trend trend-up">
                <i class="bi bi-star me-1"></i> {{ top_performer_percentage }}%
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Main Content Column -->
        <div class="col-lg-8">
            <!-- Students List -->
            <div class="info-card report-section">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="bi bi-people"></i> {% trans "Students Overview" %}
                    </h5>
                </div>
                
                <div class="table-responsive">
                    <table class="students-table">
                        <thead>
                            <tr>
                                <th>{% trans "Student" %}</th>
                                <th>{% trans "Roll No" %}</th>
                                <th>{% trans "Overall Grade" %}</th>
                                <th>{% trans "Attendance" %}</th>
                                <th>{% trans "Performance" %}</th>
                                <th>{% trans "Status" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for enrollment in enrollments %}
                            <tr>
                                <td>
                                    <div class="student-info">
                                        {% if enrollment.student.photo %}
                                        <img src="{{ enrollment.student.photo.url }}" alt="{{ enrollment.student.user.get_full_name }}" class="student-avatar">
                                        {% else %}
                                        <div class="student-avatar bg-primary text-white d-flex align-items-center justify-content-center">
                                            {{ enrollment.student.user.get_initials }}
                                        </div>
                                        {% endif %}
                                        <div>
                                            <div class="student-name">{{ enrollment.student.user.get_full_name }}</div>
                                            <div class="student-id">{{ enrollment.student.student_id }}</div>
                                        </div>
                                    </div>
                                </td>
                                <td>{{ enrollment.roll_number }}</td>
                                <td>
                                    {% with academic_record=enrollment.student.academic_records.filter|first %}
                                    {% if academic_record.overall_grade %}
                                    <strong>{{ academic_record.overall_grade }}</strong>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                    {% endwith %}
                                </td>
                                <td>
                                    {% with attendance=enrollment.student.attendance_stats %}
                                    {% if attendance.rate %}
                                    <div>
                                        <strong>{{ attendance.rate }}%</strong>
                                        <small class="text-muted d-block">({{ attendance.present }}/{{ attendance.total }})</small>
                                    </div>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                    {% endwith %}
                                </td>
                                <td>
                                    {% with performance=enrollment.student.performance_level %}
                                    <span class="performance-badge performance-{{ performance }}">
                                        {{ performance|title }}
                                    </span>
                                    {% endwith %}
                                </td>
                                <td>
                                    <span class="badge bg-{% if enrollment.enrollment_status == 'active' %}success{% else %}warning{% endif %}">
                                        {{ enrollment.get_enrollment_status_display }}
                                    </span>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center py-4">
                                    <i class="bi bi-people display-4 text-muted"></i>
                                    <p class="mt-2 mb-0">{% trans "No students enrolled in this class" %}</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Academic Performance -->
            <div class="info-card report-section">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="bi bi-graph-up"></i> {% trans "Academic Performance" %}
                    </h5>
                </div>
                
                <!-- Grade Distribution -->
                <h6>{% trans "Grade Distribution" %}</h6>
                <div class="grade-distribution">
                    {% for grade in grade_distribution %}
                    <div class="grade-item">
                        <span class="grade-letter">{{ grade.grade }}</span>
                        <span class="grade-count">{{ grade.count }}</span>
                        <span class="grade-percentage">{{ grade.percentage }}%</span>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Subject Performance -->
                <h6 class="mt-4">{% trans "Subject-wise Performance" %}</h6>
                <div class="subject-performance">
                    {% for subject in subject_performance %}
                    <div class="subject-card">
                        <div class="subject-name">{{ subject.name }}</div>
                        <div class="subject-average">{{ subject.average_grade|default:"-" }}</div>
                        <div class="subject-teacher">{{ subject.teacher_name }}</div>
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: {{ subject.average_percentage }}%"></div>
                        </div>
                        <small class="text-muted">{{ subject.average_percentage }}% {% trans "average" %}</small>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Attendance Analysis -->
            <div class="info-card report-section">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="bi bi-calendar-check"></i> {% trans "Attendance Analysis" %}
                    </h5>
                </div>
                
                <div class="chart-container">
                    <canvas id="attendanceChart"></canvas>
                </div>
                
                <div class="legend">
                    {% for item in attendance_legend %}
                    <div class="legend-item">
                        <div class="legend-color" style="background: {{ item.color }}"></div>
                        <span>{{ item.label }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Sidebar Column -->
        <div class="col-lg-4">
            <!-- Class Information -->
            <div class="info-card report-section">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="bi bi-info-circle"></i> {% trans "Class Information" %}
                    </h5>
                </div>
                
                <div class="mb-3">
                    <strong>{% trans "Class Teacher:" %}</strong>
                    {% if class_obj.class_teacher %}
                    <div class="teacher-contact">
                        {% if class_obj.class_teacher.photo %}
                        <img src="{{ class_obj.class_teacher.photo.url }}" alt="{{ class_obj.class_teacher.user.get_full_name }}" class="teacher-avatar">
                        {% else %}
                        <div class="teacher-avatar bg-primary text-white d-flex align-items-center justify-content-center">
                            {{ class_obj.class_teacher.user.get_initials }}
                        </div>
                        {% endif %}
                        <div class="teacher-info">
                            <h6>{{ class_obj.class_teacher.user.get_full_name }}</h6>
                            <p>{{ class_obj.class_teacher.teacher_id }}</p>
                            <p class="mb-0">
                                <i class="bi bi-envelope me-1"></i>
                                {{ class_obj.class_teacher.user.email }}
                            </p>
                        </div>
                    </div>
                    {% else %}
                    <p class="text-muted">{% trans "Not assigned" %}</p>
                    {% endif %}
                </div>
                
                <div class="row">
                    <div class="col-6">
                        <strong>{% trans "Grade Level:" %}</strong>
                        <p class="mb-2">{{ class_obj.grade_level.name }}</p>
                    </div>
                    <div class="col-6">
                        <strong>{% trans "Class Type:" %}</strong>
                        <p class="mb-2">{{ class_obj.get_class_type_display }}</p>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-6">
                        <strong>{% trans "Room:" %}</strong>
                        <p class="mb-2">{{ class_obj.room_number|default:"Not assigned" }}</p>
                    </div>
                    <div class="col-6">
                        <strong>{% trans "Capacity:" %}</strong>
                        <p class="mb-2">{{ class_obj.current_student_count }}/{{ class_obj.capacity }}</p>
                    </div>
                </div>
                
                <div>
                    <strong>{% trans "Academic Session:" %}</strong>
                    <p class="mb-0">{{ class_obj.academic_session.name }}</p>
                </div>
            </div>

            <!-- Key Metrics -->
            <div class="info-card report-section">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="bi bi-speedometer2"></i> {% trans "Key Metrics" %}
                    </h5>
                </div>
                
                <div class="comparison-card">
                    <div class="comparison-item">
                        <span class="comparison-label">{% trans "Class Average" %}</span>
                        <span class="comparison-value">{{ average_grade|default:"-" }}</span>
                        <div class="comparison-bar">
                            <div class="comparison-fill" style="width: {{ average_percentage }}%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="comparison-card">
                    <div class="comparison-item">
                        <span class="comparison-label">{% trans "Attendance Rate" %}</span>
                        <span class="comparison-value">{{ attendance_rate }}%</span>
                        <div class="comparison-bar">
                            <div class="comparison-fill" style="width: {{ attendance_rate }}%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="comparison-card">
                    <div class="comparison-item">
                        <span class="comparison-label">{% trans "Completion Rate" %}</span>
                        <span class="comparison-value">{{ completion_rate }}%</span>
                        <div class="comparison-bar">
                            <div class="comparison-fill" style="width: {{ completion_rate }}%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Activities -->
            <div class="info-card report-section">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="bi bi-clock-history"></i> {% trans "Recent Activities" %}
                    </h5>
                </div>
                
                <div class="timeline">
                    {% for activity in recent_activities %}
                    <div class="timeline-item">
                        <div class="timeline-date">{{ activity.date|date:"M d, Y" }}</div>
                        <div class="timeline-content">
                            <strong>{{ activity.title }}</strong>
                            <p class="mb-0 small">{{ activity.description }}</p>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-muted text-center">{% trans "No recent activities" %}</p>
                    {% endfor %}
                </div>
            </div>

            <!-- Recommendations -->
            <div class="info-card report-section">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="bi bi-lightbulb"></i> {% trans "Recommendations" %}
                    </h5>
                </div>
                
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>{% trans "Based on current performance:" %}</strong>
                </div>
                
                <ul class="list-unstyled">
                    {% for recommendation in recommendations %}
                    <li class="mb-2">
                        <i class="bi bi-check-circle text-success me-2"></i>
                        {{ recommendation }}
                    </li>
                    {% empty %}
                    <li class="text-muted">{% trans "No specific recommendations at this time" %}</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="text-center">
        <div class="spinner-border text-primary mb-3" role="status">
            <span class="visually-hidden">{% trans "Generating report..." %}</span>
        </div>
        <p class="mb-0">{% trans "Generating report, please wait..." %}</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
class ClassReportView {
    constructor() {
        this.classId = {{ class_obj.pk }};
        this.init();
    }

    init() {
        this.setupEventListeners();
        this.renderCharts();
        this.setupExportHandlers();
    }

    setupEventListeners() {
        // Print button
        document.querySelector('[onclick="window.print()"]').addEventListener('click', () => {
            this.trackAction('print');
        });
    }

    setupExportHandlers() {
        // PDF Export
        document.getElementById('export-pdf-btn').addEventListener('click', () => {
            this.exportReport('pdf');
        });

        // Excel Export
        document.getElementById('export-excel-btn').addEventListener('click', () => {
            this.exportReport('excel');
        });
    }

    renderCharts() {
        this.renderAttendanceChart();
    }

    renderAttendanceChart() {
        const ctx = document.getElementById('attendanceChart').getContext('2d');
        
        // Sample data - replace with actual data from context
        const attendanceData = {
            labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4', 'Week 5'],
            datasets: [
                {
                    label: '{% trans "Present" %}',
                    data: [85, 88, 92, 87, 90],
                    backgroundColor: '#28a745',
                    borderColor: '#28a745',
                    borderWidth: 2
                },
                {
                    label: '{% trans "Absent" %}',
                    data: [10, 8, 5, 9, 7],
                    backgroundColor: '#dc3545',
                    borderColor: '#dc3545',
                    borderWidth: 2
                },
                {
                    label: '{% trans "Late" %}',
                    data: [5, 4, 3, 4, 3],
                    backgroundColor: '#ffc107',
                    borderColor: '#ffc107',
                    borderWidth: 2
                }
            ]
        };

        new Chart(ctx, {
            type: 'bar',
            data: attendanceData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        stacked: true,
                        grid: {
                            display: false
                        }
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.raw + '%';
                            }
                        }
                    }
                }
            }
        });
    }

    async exportReport(format) {
        const loadingOverlay = document.getElementById('loadingOverlay');
        loadingOverlay.style.display = 'flex';

        try {
            const response = await fetch(`/academics/api/classes/${this.classId}/export-report/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': window.CSRF_TOKEN,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    format: format,
                    include_charts: true
                })
            });

            if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `class_report_${this.classId}_${new Date().toISOString().split('T')[0]}.${format}`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                
                this.trackAction(`export_${format}`);
            } else {
                throw new Error('Export failed');
            }
        } catch (error) {
            console.error('Export error:', error);
            alert('{% trans "Error exporting report. Please try again." %}');
        } finally {
            loadingOverlay.style.display = 'none';
        }
    }

    trackAction(action) {
        // Track user actions for analytics
        fetch(`/academics/api/classes/${this.classId}/track-action/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': window.CSRF_TOKEN,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: action,
                timestamp: new Date().toISOString()
            })
        }).catch(error => {
            console.error('Tracking error:', error);
        });
    }
}

// Initialize when document is ready
document.addEventListener('DOMContentLoaded', function() {
    window.classReportView = new ClassReportView();
});
</script>
{% endblock %}