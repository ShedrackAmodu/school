<!-- templates/academics/subjects/subject_detail.html -->
{% extends 'academics/base/base.html' %}
{% load static i18n %}

{% block title %}
    {{ subject.name }} - {% trans "Subject Details" %}
{% endblock %}

{% block page_title %}
    {{ subject.name }}
{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'academics:dashboard' %}">{% trans "Academics" %}</a></li>
<li class="breadcrumb-item"><a href="{% url 'academics:subject_list' %}">{% trans "Subjects" %}</a></li>
<li class="breadcrumb-item active" aria-current="page">{{ subject.name }}</li>
{% endblock %}

{% block page_actions %}
<div class="page-actions">
    <div class="btn-group" role="group">
        {% if user.is_staff or user.teacher_profile %}
        <a href="{% url 'academics:subject_update' subject.pk %}" class="btn btn-outline-warning">
            <i class="bi bi-pencil me-1"></i> {% trans "Edit Subject" %}
        </a>
        {% endif %}
        <button type="button" class="btn btn-outline-primary" onclick="window.print()">
            <i class="bi bi-printer me-1"></i> {% trans "Print" %}
        </button>
        <a href="{% url 'academics:material_create' %}?subject={{ subject.pk }}" class="btn btn-outline-success">
            <i class="bi bi-plus-circle me-1"></i> {% trans "Add Material" %}
        </a>
        <a href="{% url 'academics:subject_list' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i> {% trans "Back to Subjects" %}
        </a>
    </div>
</div>


{% endblock %}

{% block content %}
<style>
.subject-detail-container {
    font-family: 'Inter', sans-serif;
}

.subject-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 0.75rem;
    padding: 2rem;
    margin-bottom: 2rem;
    position: relative;
    overflow: hidden;
}

.subject-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.1);
}

.subject-basic-info {
    position: relative;
    z-index: 2;
}

.subject-name {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.subject-code {
    font-size: 1.5rem;
    opacity: 0.9;
    margin-bottom: 1rem;
    font-family: 'Courier New', monospace;
}

.subject-meta {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-top: 1.5rem;
}

.meta-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.meta-label {
    font-size: 0.875rem;
    opacity: 0.8;
}

.meta-value {
    font-size: 1.1rem;
    font-weight: 600;
}

.subject-status-badge {
    position: absolute;
    top: 1rem;
    right: 1rem;
    z-index: 3;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: #fff;
    border: 1px solid #e9ecef;
    border-radius: 0.75rem;
    padding: 1.5rem;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    transition: transform 0.2s ease;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.stat-number {
    font-size: 2.5rem;
    font-weight: 700;
    display: block;
    line-height: 1;
    margin-bottom: 0.5rem;
}

.stat-label {
    font-size: 0.875rem;
    color: #6c757d;
    font-weight: 500;
}

.stat-trend {
    font-size: 0.75rem;
    margin-top: 0.5rem;
}

.trend-up { color: #28a745; }
.trend-down { color: #dc3545; }
.trend-neutral { color: #6c757d; }

.info-card {
    background: #fff;
    border: 1px solid #e9ecef;
    border-radius: 0.75rem;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.info-card .card-header {
    background: none;
    border-bottom: 2px solid #e9ecef;
    padding: 0 0 1rem 0;
    margin-bottom: 1rem;
}

.info-card .card-title {
    color: #495057;
    font-weight: 600;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.teachers-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
    margin: 1.5rem 0;
}

.teacher-card {
    background: #fff;
    border: 1px solid #e9ecef;
    border-radius: 0.75rem;
    padding: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1.5rem;
    transition: transform 0.2s ease;
}

.teacher-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.teacher-avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    object-fit: cover;
    flex-shrink: 0;
}

.teacher-details {
    flex-grow: 1;
}

.teacher-name {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: #212529;
}

.teacher-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-bottom: 0.75rem;
}

.teacher-info {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: #6c757d;
}

.teacher-classes {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.class-badge {
    background: #e7f1ff;
    color: #0d6efd;
    padding: 0.25rem 0.5rem;
    border-radius: 0.375rem;
    font-size: 0.75rem;
    font-weight: 500;
}

.classes-table {
    width: 100%;
    border-collapse: collapse;
    margin: 1rem 0;
}

.classes-table th {
    background: #f8f9fa;
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    color: #495057;
    border-bottom: 2px solid #e9ecef;
}

.classes-table td {
    padding: 1rem;
    border-bottom: 1px solid #e9ecef;
    vertical-align: middle;
}

.classes-table tr:hover {
    background: #f8f9fa;
}

.class-info {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.class-icon {
    width: 40px;
    height: 40px;
    border-radius: 0.5rem;
    background: #e9ecef;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    color: #495057;
    flex-shrink: 0;
}

.class-details {
    flex-grow: 1;
}

.class-name {
    font-weight: 600;
    color: #212529;
    margin-bottom: 0.25rem;
}

.class-meta {
    font-size: 0.875rem;
    color: #6c757d;
}

.teacher-assignment {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.teacher-avatar-sm {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    object-fit: cover;
}

.materials-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1.5rem;
    margin: 1.5rem 0;
}

.material-card {
    background: #fff;
    border: 1px solid #e9ecef;
    border-radius: 0.75rem;
    padding: 1.5rem;
    transition: transform 0.2s ease;
}

.material-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.material-header {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    margin-bottom: 1rem;
}

.material-type-icon {
    width: 50px;
    height: 50px;
    border-radius: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    flex-shrink: 0;
}

.type-textbook { background: #e3f2fd; color: #1976d2; }
.type-worksheet { background: #f3e5f5; color: #7b1fa2; }
.type-presentation { background: #e8f5e8; color: #388e3c; }
.type-video { background: #fff3e0; color: #f57c00; }
.type-document { background: #e0f2f1; color: #00796b; }
.type-quiz { background: #e8eaf6; color: #303f9f; }
.type-assignment { background: #fbe9e7; color: #d84315; }

.material-title {
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: #212529;
    line-height: 1.3;
}

.material-description {
    color: #6c757d;
    font-size: 0.875rem;
    line-height: 1.4;
    margin-bottom: 1rem;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.material-meta {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 1rem;
}

.material-teacher {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: #6c757d;
}

.material-stats {
    display: flex;
    gap: 1rem;
    font-size: 0.75rem;
    color: #6c757d;
}

.material-actions {
    display: flex;
    gap: 0.5rem;
}

.prerequisites-list {
    list-style: none;
    padding: 0;
    margin: 1rem 0;
}

.prerequisites-list li {
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    background: #f8f9fa;
    border-radius: 0.5rem;
    border-left: 4px solid #0d6efd;
    display: flex;
    justify-content: between;
    align-items: center;
}

.prerequisites-list li:last-child {
    margin-bottom: 0;
}

.prerequisite-status {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    border-radius: 0.375rem;
}

.status-completed { background: #d4edda; color: #155724; }
.status-pending { background: #fff3cd; color: #856404; }

.performance-chart-container {
    height: 300px;
    margin: 1.5rem 0;
}

.quick-actions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin: 1.5rem 0;
}

.action-card {
    background: #fff;
    border: 1px solid #e9ecef;
    border-radius: 0.5rem;
    padding: 1.5rem;
    text-align: center;
    text-decoration: none;
    color: inherit;
    transition: all 0.3s ease;
}

.action-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    text-decoration: none;
    color: inherit;
    border-color: #0d6efd;
}

.action-icon {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: #e7f1ff;
    color: #0d6efd;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    margin: 0 auto 1rem auto;
}

.action-title {
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: #212529;
}

.action-description {
    font-size: 0.875rem;
    color: #6c757d;
    margin: 0;
}

@media print {
    .page-actions,
    .sidebar,
    .navigation {
        display: none !important;
    }
    
    .subject-header {
        background: #fff !important;
        color: #000 !important;
        border: 2px solid #000;
    }
    
    .stat-card,
    .info-card {
        border: 1px solid #000;
        box-shadow: none;
    }
    
    body {
        font-size: 12pt;
        line-height: 1.4;
    }
}

@media (max-width: 768px) {
    .subject-header {
        padding: 1.5rem;
    }
    
    .subject-name {
        font-size: 2rem;
    }
    
    .subject-meta {
        grid-template-columns: 1fr;
    }
    
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
    }
    
    .teachers-grid {
        grid-template-columns: 1fr;
    }
    
    .teacher-card {
        flex-direction: column;
        text-align: center;
        gap: 1rem;
    }
    
    .teacher-meta {
        justify-content: center;
    }
    
    .materials-grid {
        grid-template-columns: 1fr;
    }
    
    .classes-table {
        font-size: 0.875rem;
    }
    
    .page-actions .btn-group {
        flex-direction: column;
        width: 100%;
    }
    
    .page-actions .btn {
        margin-bottom: 0.5rem;
    }
}

.empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: #6c757d;
}

.empty-state-icon {
    font-size: 4rem;
    color: #dee2e6;
    margin-bottom: 1rem;
}

.subject-description {
    line-height: 1.6;
    color: #495057;
    margin: 1rem 0;
}

.department-info {
    background: #e7f3ff;
    border: 1px solid #b3d9ff;
    border-radius: 0.5rem;
    padding: 1rem;
    margin: 1rem 0;
    display: flex;
    align-items: center;
    gap: 1rem;
}

.department-icon {
    width: 50px;
    height: 50px;
    border-radius: 0.5rem;
    background: #0d6efd;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    flex-shrink: 0;
}

.department-details h6 {
    margin-bottom: 0.25rem;
    color: #212529;
}

.department-details p {
    margin-bottom: 0;
    color: #6c757d;
    font-size: 0.875rem;
}

.tab-content {
    margin-top: 1rem;
}

.nav-tabs .nav-link {
    color: #495057;
    font-weight: 500;
    padding: 0.75rem 1.5rem;
    border: none;
    border-bottom: 2px solid transparent;
}

.nav-tabs .nav-link.active {
    color: #0d6efd;
    background: none;
    border-color: #0d6efd;
}

.nav-tabs .nav-link:hover {
    border-color: #dee2e6;
}

.credit-badge {
    font-size: 1rem;
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
}

.type-badge {
    font-size: 0.875rem;
    padding: 0.375rem 0.75rem;
    border-radius: 0.375rem;
}

.badge-core { background: #0d6efd; color: white; }
.badge-elective { background: #6c757d; color: white; }
</style>

<div class="subject-detail-container">
    <!-- Subject Header -->
    <div class="subject-header">
        <div class="subject-basic-info">
            <h1 class="subject-name">{{ subject.name }}</h1>
            <div class="subject-code">{{ subject.code }}</div>
            
            <div class="subject-status-badge">
                {% if subject.is_active %}
                <span class="badge bg-success" style="font-size: 1rem; padding: 0.5rem 1rem;">
                    <i class="bi bi-check-circle me-1"></i> {% trans "Active" %}
                </span>
                {% else %}
                <span class="badge bg-secondary" style="font-size: 1rem; padding: 0.5rem 1rem;">
                    <i class="bi bi-pause-circle me-1"></i> {% trans "Inactive" %}
                </span>
                {% endif %}
            </div>

            <div class="subject-meta">
                <div class="meta-item">
                    <span class="meta-label">{% trans "Credits" %}</span>
                    <span class="meta-value">
                        <span class="badge bg-primary credit-badge">
                            {{ subject.credits }} {% trans "credit(s)" %}
                        </span>
                    </span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">{% trans "Type" %}</span>
                    <span class="meta-value">
                        <span class="badge type-badge badge-{{ subject.subject_type }}">
                            {{ subject.get_subject_type_display }}
                        </span>
                    </span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">{% trans "Department" %}</span>
                    <span class="meta-value">{{ subject.department.name }}</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">{% trans "Prerequisites" %}</span>
                    <span class="meta-value">{{ subject.prerequisites.count }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Statistics -->
    <div class="stats-grid">
        <div class="stat-card">
            <span class="stat-number">{{ teacher_count }}</span>
            <span class="stat-label">{% trans "Teachers" %}</span>
            <div class="stat-trend trend-up">
                <i class="bi bi-person-check me-1"></i> {% trans "Assigned" %}
            </div>
        </div>
        
        <div class="stat-card">
            <span class="stat-number">{{ class_count }}</span>
            <span class="stat-label">{% trans "Classes" %}</span>
            <div class="stat-trend trend-neutral">
                <i class="bi bi-people me-1"></i> {% trans "Offered" %}
            </div>
        </div>
        
        <div class="stat-card">
            <span class="stat-number">{{ student_count }}</span>
            <span class="stat-label">{% trans "Students" %}</span>
            <div class="stat-trend trend-up">
                <i class="bi bi-person me-1"></i> {% trans "Enrolled" %}
            </div>
        </div>
        
        <div class="stat-card">
            <span class="stat-number">{{ material_count }}</span>
            <span class="stat-label">{% trans "Materials" %}</span>
            <div class="stat-trend trend-up">
                <i class="bi bi-file-earmark me-1"></i> {% trans "Available" %}
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
        <a href="{% url 'academics:material_create' %}?subject={{ subject.pk }}" class="action-card">
            <div class="action-icon">
                <i class="bi bi-plus-circle"></i>
            </div>
            <div class="action-title">{% trans "Add Material" %}</div>
            <p class="action-description">{% trans "Create learning resources" %}</p>
        </a>
        
        <a href="{% url 'academics:timetable_create' %}?subject={{ subject.pk }}" class="action-card">
            <div class="action-icon">
                <i class="bi bi-calendar-plus"></i>
            </div>
            <div class="action-title">{% trans "Schedule Class" %}</div>
            <p class="action-description">{% trans "Add to timetable" %}</p>
        </a>
        
        <!-- <a href="{% url 'academics:subject_assignment' %}?subject={{ subject.pk }}" class="action-card">
            <div class="action-icon">
                <i class="bi bi-person-plus"></i>
            </div>
            <div class="action-title">{% trans "Assign Teacher" %}</div>
            <p class="action-description">{% trans "Assign to classes" %}</p>
        </a> -->
        
        <a href="{% url 'academics:material_list' %}?subject={{ subject.pk }}" class="action-card">
            <div class="action-icon">
                <i class="bi bi-collection"></i>
            </div>
            <div class="action-title">{% trans "View Materials" %}</div>
            <p class="action-description">{% trans "Browse resources" %}</p>
        </a>
    </div>

    <!-- Navigation Tabs -->
    <ul class="nav nav-tabs" id="subjectTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
                <i class="bi bi-info-circle me-1"></i> {% trans "Overview" %}
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="teachers-tab" data-bs-toggle="tab" data-bs-target="#teachers" type="button" role="tab">
                <i class="bi bi-people me-1"></i> {% trans "Teachers" %}
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="classes-tab" data-bs-toggle="tab" data-bs-target="#classes" type="button" role="tab">
                <i class="bi bi-building me-1"></i> {% trans "Classes" %}
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="materials-tab" data-bs-toggle="tab" data-bs-target="#materials" type="button" role="tab">
                <i class="bi bi-journal me-1"></i> {% trans "Materials" %}
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="prerequisites-tab" data-bs-toggle="tab" data-bs-target="#prerequisites" type="button" role="tab">
                <i class="bi bi-diagram-3 me-1"></i> {% trans "Prerequisites" %}
            </button>
        </li>
    </ul>

    <div class="tab-content" id="subjectTabsContent">
        <!-- Overview Tab -->
        <div class="tab-pane fade show active" id="overview" role="tabpanel">
            <div class="info-card">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="bi bi-info-circle"></i> {% trans "Subject Information" %}
                    </h5>
                </div>
                
                <div class="department-info">
                    <div class="department-icon">
                        <i class="bi bi-building"></i>
                    </div>
                    <div class="department-details">
                        <h6>{{ subject.department.name }}</h6>
                        <p>{{ subject.department.code }} â€¢ {{ subject.department.teachers.count }} teachers</p>
                    </div>
                </div>

                {% if subject.description %}
                <div class="subject-description">
                    {{ subject.description|linebreaks }}
                </div>
                {% else %}
                <p class="text-muted">{% trans "No description provided for this subject." %}</p>
                {% endif %}

                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-label">{% trans "Subject Code" %}</span>
                        <span class="info-value">{{ subject.code }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">{% trans "Credits" %}</span>
                        <span class="info-value">{{ subject.credits }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">{% trans "Subject Type" %}</span>
                        <span class="info-value">
                            <span class="badge type-badge badge-{{ subject.subject_type }}">
                                {{ subject.get_subject_type_display }}
                            </span>
                        </span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">{% trans "Status" %}</span>
                        <span class="info-value">
                            <span class="badge bg-{% if subject.is_active %}success{% else %}secondary{% endif %}">
                                {% if subject.is_active %}{% trans "Active" %}{% else %}{% trans "Inactive" %}{% endif %}
                            </span>
                        </span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">{% trans "Department" %}</span>
                        <span class="info-value">{{ subject.department.name }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">{% trans "Department Code" %}</span>
                        <span class="info-value">{{ subject.department.code }}</span>
                    </div>
                </div>
            </div>

            <!-- Performance Overview -->
            <div class="info-card">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="bi bi-graph-up"></i> {% trans "Performance Overview" %}
                    </h5>
                </div>
                
                <div class="performance-chart-container">
                    <canvas id="performanceChart"></canvas>
                </div>
                
                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-label">{% trans "Average Grade" %}</span>
                        <span class="info-value">{{ average_grade|default:"-" }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">{% trans "Pass Rate" %}</span>
                        <span class="info-value">{{ pass_rate }}%</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">{% trans "Top Performing Class" %}</span>
                        <span class="info-value">{{ top_class|default:"-" }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">{% trans "Performance Trend" %}</span>
                        <span class="info-value">
                            <span class="badge bg-{% if performance_trend == 'up' %}success{% elif performance_trend == 'down' %}danger{% else %}warning{% endif %}">
                                {% if performance_trend == 'up' %}{% trans "Improving" %}
                                {% elif performance_trend == 'down' %}{% trans "Declining" %}
                                {% else %}{% trans "Stable" %}{% endif %}
                            </span>
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Teachers Tab -->
        <div class="tab-pane fade" id="teachers" role="tabpanel">
            <div class="info-card">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="bi bi-people"></i> {% trans "Assigned Teachers" %}
                    </h5>
                </div>
                
                {% if current_assignments %}
                <div class="teachers-grid">
                    {% for assignment in current_assignments %}
                    <div class="teacher-card">
                        {% if assignment.teacher.photo %}
                        <img src="{{ assignment.teacher.photo.url }}" alt="{{ assignment.teacher.user.get_full_name }}" class="teacher-avatar">
                        {% else %}
                        <div class="teacher-avatar bg-primary text-white d-flex align-items-center justify-content-center">
                            {{ assignment.teacher.user.get_initials }}
                        </div>
                        {% endif %}
                        <div class="teacher-details">
                            <div class="teacher-name">{{ assignment.teacher.user.get_full_name }}</div>
                            <div class="teacher-meta">
                                <div class="teacher-info">
                                    <i class="bi bi-person-badge"></i>
                                    {{ assignment.teacher.teacher_id }}
                                </div>
                                <div class="teacher-info">
                                    <i class="bi bi-building"></i>
                                    {{ assignment.teacher.department.name }}
                                </div>
                                <div class="teacher-info">
                                    <i class="bi bi-clock"></i>
                                    {{ assignment.periods_per_week }} {% trans "periods/week" %}
                                </div>
                            </div>
                            <div class="teacher-classes">
                                {% for class in assignment.class_assigned.all %}
                                <span class="class-badge">{{ class.name }}</span>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="teacher-actions">
                            <a href="{% url 'academics:teacher_detail' assignment.teacher.pk %}" class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-eye"></i>
                            </a>
                            <button class="btn btn-outline-success btn-sm" onclick="contactTeacher('{{ assignment.teacher.user.email }}')">
                                <i class="bi bi-envelope"></i>
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="bi bi-people"></i>
                    </div>
                    <h5>{% trans "No Teachers Assigned" %}</h5>
                    <p class="mb-4">{% trans "There are no teachers currently assigned to this subject." %}</p>
                    {% if user.is_staff %}
                    <!-- <a href="{% url 'academics:subject_assignment' %}?subject={{ subject.pk }}" class="btn btn-primary">
                        <i class="bi bi-plus-circle me-1"></i> {% trans "Assign to Class" %}
                    </a> -->
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Classes Tab -->
        <div class="tab-pane fade" id="classes" role="tabpanel">
            <div class="info-card">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="bi bi-building"></i> {% trans "Classes Offering This Subject" %}
                    </h5>
                </div>
                
                {% if class_assignments %}
                <div class="table-responsive">
                    <table class="classes-table">
                        <thead>
                            <tr>
                                <th>{% trans "Class" %}</th>
                                <th>{% trans "Grade Level" %}</th>
                                <th>{% trans "Teacher" %}</th>
                                <th>{% trans "Periods/Week" %}</th>
                                <th>{% trans "Students" %}</th>
                                <th>{% trans "Academic Session" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for assignment in class_assignments %}
                            <tr>
                                <td>
                                    <div class="class-info">
                                        <div class="class-icon">
                                            <i class="bi bi-people"></i>
                                        </div>
                                        <div class="class-details">
                                            <div class="class-name">{{ assignment.class_assigned.name }}</div>
                                            <div class="class-meta">{{ assignment.class_assigned.code }}</div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <strong>{{ assignment.class_assigned.grade_level.name }}</strong>
                                    <br>
                                    <small class="text-muted">{{ assignment.class_assigned.grade_level.code }}</small>
                                </td>
                                <td>
                                    {% if assignment.teacher %}
                                    <div class="teacher-assignment">
                                        {% if assignment.teacher.photo %}
                                        <img src="{{ assignment.teacher.photo.url }}" alt="{{ assignment.teacher.user.get_full_name }}" class="teacher-avatar-sm">
                                        {% else %}
                                        <div class="teacher-avatar-sm bg-primary text-white d-flex align-items-center justify-content-center" style="font-size: 0.75rem;">
                                            {{ assignment.teacher.user.get_initials }}
                                        </div>
                                        {% endif %}
                                        <span>{{ assignment.teacher.user.get_full_name }}</span>
                                    </div>
                                    {% else %}
                                    <span class="text-muted">{% trans "Not assigned" %}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-info">{{ assignment.periods_per_week }}</span>
                                </td>
                                <td>
                                    {{ assignment.class_assigned.current_student_count }}
                                </td>
                                <td>
                                    {{ assignment.academic_session.name }}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="bi bi-building"></i>
                    </div>
                    <h5>{% trans "No Class Assignments" %}</h5>
                    <p class="mb-4">{% trans "This subject is not currently assigned to any classes." %}</p>
                    {% if user.is_staff %}
                    {% comment %} <a href="{% url 'academics:subject_assignment' %}?subject={{ subject.pk }}" class="btn btn-primary">
                        <i class="bi bi-plus-circle me-1"></i> {% trans "Assign to Class" %}
                    </a> {% endcomment %}
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Materials Tab -->
        <div class="tab-pane fade" id="materials" role="tabpanel">
            <div class="info-card">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="bi bi-journal"></i> {% trans "Learning Materials" %}
                    </h5>
                </div>
                
                {% if materials %}
                <div class="materials-grid">
                    {% for material in materials %}
                    <div class="material-card">
                        <div class="material-header">
                            <div class="material-type-icon type-{{ material.material_type }}">
                                <i class="bi {{ material.get_icon_class }}"></i>
                            </div>
                            <div class="flex-grow-1">
                                <div class="material-title">{{ material.title }}</div>
                                <div class="material-description">{{ material.description|truncatewords:20 }}</div>
                            </div>
                        </div>
                        
                        <div class="material-meta">
                            <div class="material-teacher">
                                <i class="bi bi-person"></i>
                                {{ material.teacher.user.get_full_name }}
                            </div>
                            <div class="material-stats">
                                <span><i class="bi bi-eye"></i> {{ material.view_count }}</span>
                                <span><i class="bi bi-download"></i> {{ material.download_count }}</span>
                            </div>
                        </div>
                        
                        <div class="material-actions">
                            <a href="{% url 'academics:material_detail' material.pk %}" class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-eye me-1"></i> {% trans "View" %}
                            </a>
                            {% if material.file %}
                            <a href="{{ material.file.url }}" class="btn btn-outline-success btn-sm" download>
                                <i class="bi bi-download me-1"></i> {% trans "Download" %}
                            </a>
                            {% endif %}
                            {% if material.external_url %}
                            <a href="{{ material.external_url }}" target="_blank" class="btn btn-outline-info btn-sm">
                                <i class="bi bi-box-arrow-up-right me-1"></i> {% trans "Visit" %}
                            </a>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="bi bi-journal"></i>
                    </div>
                    <h5>{% trans "No Learning Materials" %}</h5>
                    <p class="mb-4">{% trans "There are no learning materials available for this subject yet." %}</p>
                    {% if user.teacher_profile or user.is_staff %}
                    <a href="{% url 'academics:material_create' %}?subject={{ subject.pk }}" class="btn btn-primary">
                        <i class="bi bi-plus-circle me-1"></i> {% trans "Create First Material" %}
                    </a>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Prerequisites Tab -->
        <div class="tab-pane fade" id="prerequisites" role="tabpanel">
            <div class="info-card">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="bi bi-diagram-3"></i> {% trans "Prerequisites" %}
                    </h5>
                </div>
                
                {% if subject.prerequisites.all %}
                <p>{% trans "Students must complete the following subjects before enrolling in this course:" %}</p>
                
                <ul class="prerequisites-list">
                    {% for prerequisite in subject.prerequisites.all %}
                    <li>
                        <div>
                            <strong>{{ prerequisite.name }}</strong>
                            <br>
                            <small class="text-muted">{{ prerequisite.code }}</small>
                        </div>
                        <span class="prerequisite-status status-completed">
                            <i class="bi bi-check-circle me-1"></i> {% trans "Required" %}
                        </span>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="bi bi-check-circle"></i>
                    </div>
                    <h5>{% trans "No Prerequisites" %}</h5>
                    <p class="mb-0">{% trans "This subject has no prerequisites. Students can enroll directly." %}</p>
                </div>
                {% endif %}

                {% if subject.is_prerequisite_for.count > 0 %}
                <div class="mt-4">
                    <h6>{% trans "Required For:" %}</h6>
                    <p>{% trans "This subject is a prerequisite for the following courses:" %}</p>
                    <ul class="prerequisites-list">
                        {% for course in subject.is_prerequisite_for.all %}
                        <li>
                            <div>
                                <strong>{{ course.name }}</strong>
                                <br>
                                <small class="text-muted">{{ course.code }}</small>
                            </div>
                            <span class="prerequisite-status status-pending">
                                <i class="bi bi-arrow-right me-1"></i> {% trans "Leads to" %}
                            </span>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
class SubjectDetailView {
    constructor() {
        this.subjectId = {{ subject.pk }};
        this.init();
    }

    init() {
        this.setupEventListeners();
        this.setupTabPersistence();
        this.renderPerformanceChart();
    }

    setupEventListeners() {
        // Print button handler is already set via onclick
    }

    setupTabPersistence() {
        // Tab persistence
        const activeTab = localStorage.getItem('subjectDetailActiveTab');
        if (activeTab) {
            const tab = new bootstrap.Tab(document.getElementById(activeTab));
            tab.show();
        }

        // Save active tab on change
        document.getElementById('subjectTabs').addEventListener('shown.bs.tab', (event) => {
            localStorage.setItem('subjectDetailActiveTab', event.target.id);
        });
    }

    renderPerformanceChart() {
        const ctx = document.getElementById('performanceChart').getContext('2d');
        
        // Sample data - replace with actual data from context
        const performanceData = {
            labels: ['A', 'B', 'C', 'D', 'F'],
            datasets: [{
                label: '{% trans "Grade Distribution" %}',
                data: [25, 35, 20, 15, 5],
                backgroundColor: [
                    '#28a745',
                    '#20c997',
                    '#ffc107',
                    '#fd7e14',
                    '#dc3545'
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        };

        new Chart(ctx, {
            type: 'doughnut',
            data: performanceData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '60%',
                plugins: {
                    legend: {
                        position: 'bottom',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((context.raw / total) * 100);
                                return `${context.label}: ${context.raw} students (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }
}

// Global functions
function contactTeacher(email) {
    if (email) {
        window.location.href = `mailto:${email}?subject=Regarding {{ subject.name }}`;
    } else {
        alert('{% trans "Teacher email not available" %}');
    }
}

// Initialize when document is ready
document.addEventListener('DOMContentLoaded', function() {
    window.subjectDetailView = new SubjectDetailView();
});
</script>
{% endblock %}
