<!-- templates/hostels/maintenance/maintenance_form.html -->
{% extends 'base/base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% if form.instance.pk %}Edit Maintenance Request{% else %}Create Maintenance Request{% endif %} - Hostel Management{% endblock %}

{% block extra_css %}
<style>
    .form-card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .form-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }
    
    .form-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px 12px 0 0;
        padding: 1.5rem;
    }
    
    .form-section {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        background: #f8f9fa;
    }
    
    .form-section-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #495057;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #007bff;
    }
    
    .required-field::after {
        content: " *";
        color: #dc3545;
    }
    
    .form-actions {
        background: #f8f9fa;
        border-top: 1px solid #e9ecef;
        padding: 1.5rem;
        border-radius: 0 0 12px 12px;
    }
    
    .info-badge {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-size: 0.9rem;
    }
    
    .priority-badge {
        font-size: 0.75rem;
        padding: 0.35rem 0.75rem;
        border-radius: 20px;
        font-weight: 500;
    }
    
    .priority-low { background: linear-gradient(135deg, #28a745, #20c997); color: white; }
    .priority-medium { background: linear-gradient(135deg, #ffc107, #fd7e14); color: white; }
    .priority-high { background: linear-gradient(135deg, #dc3545, #e83e8c); color: white; }
    .priority-urgent { background: linear-gradient(135deg, #6f42c1, #e83e8c); color: white; }
    
    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 0.5rem;
    }
    
    .status-pending { background-color: #6c757d; }
    .status-in_progress { background-color: #007bff; }
    .status-completed { background-color: #28a745; }
    .status-cancelled { background-color: #dc3545; }
    
    .location-card {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        border-radius: 8px;
        padding: 1rem;
        margin: 1rem 0;
    }
    
    .cost-estimator {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        color: white;
        border-radius: 8px;
        padding: 1rem;
        margin: 1rem 0;
    }
    
    .timeline-preview {
        background: #e9ecef;
        border-radius: 8px;
        padding: 1rem;
        margin: 1rem 0;
    }
    
    .dynamic-field {
        transition: all 0.3s ease;
    }
    
    .dynamic-field:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    
    .help-text {
        font-size: 0.875rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }
    
    .image-upload-area {
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        padding: 2rem;
        text-align: center;
        background: #f8f9fa;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .image-upload-area:hover {
        border-color: #007bff;
        background: #e7f3ff;
    }
    
    .image-upload-icon {
        font-size: 3rem;
        color: #6c757d;
        margin-bottom: 1rem;
    }
    
    .urgency-indicator {
        height: 6px;
        border-radius: 3px;
        margin-top: 0.5rem;
        background: #e9ecef;
    }
    
    .urgency-fill {
        height: 100%;
        border-radius: 3px;
        transition: all 0.3s ease;
    }
    
    .assigned-staff {
        background: #e7f3ff;
        border: 1px solid #b3d9ff;
        border-radius: 8px;
        padding: 1rem;
        margin: 1rem 0;
    }
</style>
{% endblock %}

{% block page_title %}
{% if form.instance.pk %}
    <i class="bi bi-tools me-2"></i>Edit Maintenance Request
{% else %}
    <i class="bi bi-plus-circle me-2"></i>Create Maintenance Request
{% endif %}
{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'users:dashboard' %}">{% trans "Home" %}</a></li>
<li class="breadcrumb-item"><a href="{% url 'hostels:dashboard' %}">Hostel Dashboard</a></li>
<li class="breadcrumb-item"><a href="{% url 'hostels:maintenance_list' %}">Maintenance</a></li>
<li class="breadcrumb-item active" aria-current="page">
    {% if form.instance.pk %}Edit Request{% else %}Create Request{% endif %}
</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card form-card">
                <div class="form-header">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h4 class="mb-0">
                                {% if form.instance.pk %}
                                    <i class="bi bi-tools me-2"></i>Edit Maintenance Request
                                {% else %}
                                    <i class="bi bi-plus-circle me-2"></i>Create Maintenance Request
                                {% endif %}
                            </h4>
                            <p class="mb-0 opacity-75">
                                {% if form.instance.pk %}
                                    Update maintenance request details and progress
                                {% else %}
                                    Report a new maintenance issue for quick resolution
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-4 text-end">
                            <span class="info-badge">
                                <i class="bi bi-wrench me-1"></i>
                                {% if form.instance.pk %}Editing{% else %}Creating{% endif %} Request
                            </span>
                        </div>
                    </div>
                </div>

                <div class="card-body">
                    <form method="post" id="maintenanceForm" novalidate>
                        {% csrf_token %}
                        
                        <!-- Location Information Section -->
                        <div class="form-section">
                            <h5 class="form-section-title">
                                <i class="bi bi-geo-alt me-2"></i>Location Information
                            </h5>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.hostel.id_for_label }}" class="form-label required-field">
                                        <i class="bi bi-building me-1"></i>Hostel
                                    </label>
                                    {{ form.hostel }}
                                    {% if form.hostel.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.hostel.errors }}
                                        </div>
                                    {% endif %}
                                    <div class="help-text">
                                        Select the hostel where maintenance is needed
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.room.id_for_label }}" class="form-label">
                                        <i class="bi bi-door-closed me-1"></i>Room (Optional)
                                    </label>
                                    {{ form.room }}
                                    {% if form.room.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.room.errors }}
                                        </div>
                                    {% endif %}
                                    <div class="help-text">
                                        Specific room location (if applicable)
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.bed.id_for_label }}" class="form-label">
                                        <i class="bi bi-layout-text-sidebar me-1"></i>Bed (Optional)
                                    </label>
                                    {{ form.bed }}
                                    {% if form.bed.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.bed.errors }}
                                        </div>
                                    {% endif %}
                                    <div class="help-text">
                                        Specific bed location (if applicable)
                                    </div>
                                </div>
                            </div>

                            <!-- Location Preview -->
                            <div class="location-card" id="locationPreview">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <h6 class="mb-1">Location Preview</h6>
                                        <p class="mb-0 opacity-75" id="locationText">
                                            {% if form.instance.hostel %}
                                                {{ form.instance.hostel.name }}
                                                {% if form.instance.room %} - Room {{ form.instance.room.room_number }}{% endif %}
                                                {% if form.instance.bed %} - Bed {{ form.instance.bed.bed_number }}{% endif %}
                                            {% else %}
                                                Select a hostel to see location details
                                            {% endif %}
                                        </p>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <i class="bi bi-pin-map fs-1 opacity-50"></i>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Issue Details Section -->
                        <div class="form-section">
                            <h5 class="form-section-title">
                                <i class="bi bi-exclamation-triangle me-2"></i>Issue Details
                            </h5>
                            <div class="mb-3">
                                <label for="{{ form.title.id_for_label }}" class="form-label required-field">
                                    <i class="bi bi-card-heading me-1"></i>Issue Title
                                </label>
                                {{ form.title }}
                                {% if form.title.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.title.errors }}
                                    </div>
                                {% endif %}
                                <div class="help-text">
                                    Brief, descriptive title of the maintenance issue
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="{{ form.description.id_for_label }}" class="form-label required-field">
                                    <i class="bi bi-card-text me-1"></i>Detailed Description
                                </label>
                                {{ form.description }}
                                {% if form.description.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.description.errors }}
                                    </div>
                                {% endif %}
                                <div class="help-text">
                                    Provide detailed information about the issue, including when it started and specific symptoms
                                </div>
                            </div>

                            <!-- Priority Selection -->
                            <div class="mb-3">
                                <label for="{{ form.priority.id_for_label }}" class="form-label required-field">
                                    <i class="bi bi-flag me-1"></i>Priority Level
                                </label>
                                {{ form.priority }}
                                {% if form.priority.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.priority.errors }}
                                    </div>
                                {% endif %}
                                <div class="urgency-indicator">
                                    <div class="urgency-fill" id="urgencyFill" style="width: 25%; background: #28a745;"></div>
                                </div>
                                <div class="help-text">
                                    How urgent is this repair? This affects response time.
                                </div>
                            </div>
                        </div>

                        <!-- Assignment & Scheduling Section -->
                        <div class="form-section">
                            <h5 class="form-section-title">
                                <i class="bi bi-person-check me-2"></i>Assignment & Scheduling
                            </h5>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.assigned_to.id_for_label }}" class="form-label">
                                        <i class="bi bi-person-gear me-1"></i>Assign To
                                    </label>
                                    {{ form.assigned_to }}
                                    {% if form.assigned_to.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.assigned_to.errors }}
                                        </div>
                                    {% endif %}
                                    <div class="help-text">
                                        Staff member responsible for this repair
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.scheduled_date.id_for_label }}" class="form-label">
                                        <i class="bi bi-calendar-event me-1"></i>Scheduled Date
                                    </label>
                                    {{ form.scheduled_date }}
                                    {% if form.scheduled_date.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.scheduled_date.errors }}
                                        </div>
                                    {% endif %}
                                    <div class="help-text">
                                        Planned date for maintenance work
                                    </div>
                                </div>
                            </div>

                            <!-- Assigned Staff Preview -->
                            <div class="assigned-staff" id="staffPreview" style="display: none;">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <h6 class="mb-1" id="staffName">Staff Member</h6>
                                        <p class="mb-0 text-muted" id="staffDetails">Position & Contact</p>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="clearAssignment()">
                                            <i class="bi bi-x-circle me-1"></i>Clear
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Cost Estimation Section -->
                        <div class="form-section">
                            <h5 class="form-section-title">
                                <i class="bi bi-calculator me-2"></i>Cost Estimation
                            </h5>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.estimated_cost.id_for_label }}" class="form-label">
                                        <i class="bi bi-currency-rupee me-1"></i>Estimated Cost
                                    </label>
                                    {{ form.estimated_cost }}
                                    {% if form.estimated_cost.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.estimated_cost.errors }}
                                        </div>
                                    {% endif %}
                                    <div class="help-text">
                                        Expected cost for parts and labor
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">
                                        <i class="bi bi-cash-stack me-1"></i>Actual Cost
                                    </label>
                                    {% if form.instance.actual_cost %}
                                        <div class="form-control bg-light">
                                            ₹{{ form.instance.actual_cost }} (Recorded on completion)
                                        </div>
                                    {% else %}
                                        <div class="form-control bg-light text-muted">
                                            Will be recorded when work is completed
                                        </div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Cost Estimator -->
                            <div class="cost-estimator" id="costEstimator" style="display: none;">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <i class="bi bi-graph-up me-2"></i>
                                        <strong>Cost Estimate:</strong> 
                                        <span id="estimatedCostDisplay">₹0.00</span>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <small>Based on priority and issue type</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Status & Progress Section -->
                        <div class="form-section">
                            <h5 class="form-section-title">
                                <i class="bi bi-clipboard-check me-2"></i>Status & Progress
                            </h5>
                            {% if form.instance.pk %}
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.status.id_for_label }}" class="form-label">
                                        <i class="bi bi-circle-fill me-1"></i>Current Status
                                    </label>
                                    {{ form.status }}
                                    {% if form.status.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.status.errors }}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">
                                        <i class="bi bi-clock me-1"></i>Request Date
                                    </label>
                                    <div class="form-control bg-light">
                                        {{ form.instance.requested_date|date:"M d, Y g:i A" }}
                                    </div>
                                </div>
                            </div>

                            <!-- Completion Date -->
                            {% if form.instance.status == 'completed' %}
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="bi bi-check-circle me-1"></i>Completion Date
                                </label>
                                <div class="form-control bg-light">
                                    {{ form.instance.completed_date|date:"M d, Y g:i A" }}
                                </div>
                            </div>
                            {% endif %}

                            <!-- Timeline Preview -->
                            <div class="timeline-preview">
                                <h6 class="mb-3">Progress Timeline</h6>
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="text-center">
                                        <div class="status-indicator status-pending"></div>
                                        <div class="small">Requested</div>
                                        <div class="small text-muted">{{ form.instance.requested_date|date:"M d" }}</div>
                                    </div>
                                    <div class="flex-grow-1 border-top mx-2"></div>
                                    <div class="text-center">
                                        <div class="status-indicator {% if form.instance.status != 'pending' %}status-in_progress{% else %}status-pending{% endif %}"></div>
                                        <div class="small">In Progress</div>
                                        <div class="small text-muted">
                                            {% if form.instance.status != 'pending' %}{{ form.instance.updated_at|date:"M d" }}{% endif %}
                                        </div>
                                    </div>
                                    <div class="flex-grow-1 border-top mx-2"></div>
                                    <div class="text-center">
                                        <div class="status-indicator {% if form.instance.status == 'completed' %}status-completed{% else %}status-pending{% endif %}"></div>
                                        <div class="small">Completed</div>
                                        <div class="small text-muted">
                                            {% if form.instance.status == 'completed' %}{{ form.instance.completed_date|date:"M d" }}{% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% else %}
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                Status will be automatically set to "Pending" when this request is created.
                            </div>
                            {% endif %}
                        </div>

                        <!-- Additional Information Section -->
                        <div class="form-section">
                            <h5 class="form-section-title">
                                <i class="bi bi-journal-text me-2"></i>Additional Information
                            </h5>
                            <div class="mb-3">
                                <label for="{{ form.notes.id_for_label }}" class="form-label">
                                    <i class="bi bi-sticky me-1"></i>Internal Notes
                                </label>
                                {{ form.notes }}
                                {% if form.notes.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.notes.errors }}
                                    </div>
                                {% endif %}
                                <div class="help-text">
                                    Additional notes, instructions, or follow-up information for maintenance staff
                                </div>
                            </div>

                            <!-- Image Upload -->
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="bi bi-image me-1"></i>Issue Photos (Optional)
                                </label>
                                <div class="image-upload-area" onclick="document.getElementById('imageUpload').click()">
                                    <i class="bi bi-cloud-arrow-up image-upload-icon"></i>
                                    <h6>Click to Upload Photos</h6>
                                    <p class="text-muted mb-0">Upload images to help describe the issue. Supports JPG, PNG - Max 5MB per image</p>
                                    <input type="file" id="imageUpload" accept="image/*" multiple style="display: none;">
                                </div>
                                <div id="imagePreview" class="mt-3"></div>
                            </div>
                        </div>

                        <!-- Request Summary -->
                        <div class="form-section">
                            <h5 class="form-section-title">
                                <i class="bi bi-eye me-2"></i>Request Summary
                            </h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <h6 class="card-title">Quick Overview</h6>
                                            <div class="mb-2">
                                                <strong>Priority:</strong>
                                                <span id="summaryPriority" class="ms-2">
                                                    {% if form.instance.priority %}
                                                        <span class="priority-badge priority-{{ form.instance.priority }}">
                                                            {{ form.instance.get_priority_display }}
                                                        </span>
                                                    {% else %}
                                                        Not set
                                                    {% endif %}
                                                </span>
                                            </div>
                                            <div class="mb-2">
                                                <strong>Status:</strong>
                                                <span id="summaryStatus" class="ms-2">
                                                    {% if form.instance.status %}
                                                        <span class="status-indicator status-{{ form.instance.status }}"></span>
                                                        {{ form.instance.get_status_display }}
                                                    {% else %}
                                                        Pending
                                                    {% endif %}
                                                </span>
                                            </div>
                                            <div class="mb-2">
                                                <strong>Assigned To:</strong>
                                                <span id="summaryAssigned" class="ms-2">
                                                    {% if form.instance.assigned_to %}
                                                        {{ form.instance.assigned_to.get_full_name }}
                                                    {% else %}
                                                        Unassigned
                                                    {% endif %}
                                                </span>
                                            </div>
                                            <div>
                                                <strong>Estimated Cost:</strong>
                                                <span id="summaryCost" class="ms-2">
                                                    {% if form.instance.estimated_cost %}
                                                        ₹{{ form.instance.estimated_cost }}
                                                    {% else %}
                                                        Not estimated
                                                    {% endif %}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <h6 class="card-title">Expected Timeline</h6>
                                            <div id="timelineEstimate">
                                                {% if form.instance.priority == 'urgent' %}
                                                <p class="text-danger mb-1"><strong>Urgent:</strong> 24-48 hours</p>
                                                {% elif form.instance.priority == 'high' %}
                                                <p class="text-warning mb-1"><strong>High:</strong> 3-5 days</p>
                                                {% elif form.instance.priority == 'medium' %}
                                                <p class="text-info mb-1"><strong>Medium:</strong> 1-2 weeks</p>
                                                {% elif form.instance.priority == 'low' %}
                                                <p class="text-success mb-1"><strong>Low:</strong> 2-4 weeks</p>
                                                {% else %}
                                                <p class="text-muted">Set priority to see estimated timeline</p>
                                                {% endif %}
                                            </div>
                                            <div class="mt-2">
                                                <small class="text-muted">
                                                    <i class="bi bi-info-circle me-1"></i>
                                                    Timeline may vary based on part availability and workload
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="form-actions">
                            <div class="row">
                                <div class="col-md-6">
                                    <a href="{% url 'hostels:maintenance_list' %}" class="btn btn-outline-secondary">
                                        <i class="bi bi-arrow-left me-2"></i>
                                        Back to Maintenance
                                    </a>
                                </div>
                                <div class="col-md-6 text-end">
                                    {% if form.instance.pk and form.instance.status != 'completed' and form.instance.status != 'cancelled' %}
                                    <a href="{% url 'hostels:maintenance_complete' pk=form.instance.pk %}" class="btn btn-success me-2">
                                        <i class="bi bi-check-circle me-2"></i>
                                        Mark Complete
                                    </a>
                                    {% endif %}
                                    <button type="reset" class="btn btn-outline-danger me-2">
                                        <i class="bi bi-arrow-clockwise me-2"></i>
                                        Reset
                                    </button>
                                    <button type="submit" class="btn btn-primary" id="submitBtn">
                                        <i class="bi bi-check-circle me-2"></i>
                                        {% if form.instance.pk %}Update Request{% else %}Create Request{% endif %}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const maintenanceForm = document.getElementById('maintenanceForm');
        const submitBtn = document.getElementById('submitBtn');
        const hostelSelect = document.getElementById('{{ form.hostel.id_for_label }}');
        const roomSelect = document.getElementById('{{ form.room.id_for_label }}');
        const bedSelect = document.getElementById('{{ form.bed.id_for_label }}');
        const titleInput = document.getElementById('{{ form.title.id_for_label }}');
        const descriptionTextarea = document.getElementById('{{ form.description.id_for_label }}');
        const prioritySelect = document.getElementById('{{ form.priority.id_for_label }}');
        const assignedToSelect = document.getElementById('{{ form.assigned_to.id_for_label }}');
        const scheduledDateInput = document.getElementById('{{ form.scheduled_date.id_for_label }}');
        const estimatedCostInput = document.getElementById('{{ form.estimated_cost.id_for_label }}');
        const statusSelect = document.getElementById('{{ form.status.id_for_label }}');

        // Dynamic room and bed filtering
        function updateLocationOptions() {
            const hostelId = hostelSelect.value;
            
            if (hostelId) {
                // Enable room select and fetch rooms
                roomSelect.disabled = false;
                bedSelect.disabled = true;
                bedSelect.innerHTML = '<option value="">Select a room first</option>';
                
                // In real implementation, this would be an AJAX call to fetch rooms
                console.log('Fetching rooms for hostel:', hostelId);
            } else {
                roomSelect.disabled = true;
                bedSelect.disabled = true;
                roomSelect.innerHTML = '<option value="">Select a hostel first</option>';
                bedSelect.innerHTML = '<option value="">Select a room first</option>';
            }
            
            updateLocationPreview();
        }

        function updateBedOptions() {
            const roomId = roomSelect.value;
            
            if (roomId) {
                bedSelect.disabled = false;
                // In real implementation, this would be an AJAX call to fetch beds
                console.log('Fetching beds for room:', roomId);
            } else {
                bedSelect.disabled = true;
                bedSelect.innerHTML = '<option value="">Select a room first</option>';
            }
            
            updateLocationPreview();
        }

        // Update location preview
        function updateLocationPreview() {
            const locationText = document.getElementById('locationText');
            const hostelText = hostelSelect.options[hostelSelect.selectedIndex]?.text;
            const roomText = roomSelect.options[roomSelect.selectedIndex]?.text;
            const bedText = bedSelect.options[bedSelect.selectedIndex]?.text;
            
            let location = 'Select a hostel to see location details';
            if (hostelText) {
                location = hostelText;
                if (roomText && roomText !== 'Select a room') {
                    location += ` - ${roomText}`;
                    if (bedText && bedText !== 'Select a bed') {
                        location += ` - ${bedText}`;
                    }
                }
            }
            
            locationText.textContent = location;
        }

        // Update priority visual indicator
        function updatePriorityIndicator() {
            const priority = prioritySelect.value;
            const urgencyFill = document.getElementById('urgencyFill');
            let width, color;
            
            switch(priority) {
                case 'low':
                    width = '25%'; color = '#28a745';
                    break;
                case 'medium':
                    width = '50%'; color = '#ffc107';
                    break;
                case 'high':
                    width = '75%'; color = '#fd7e14';
                    break;
                case 'urgent':
                    width = '100%'; color = '#dc3545';
                    break;
                default:
                    width = '25%'; color = '#28a745';
            }
            
            urgencyFill.style.width = width;
            urgencyFill.style.background = color;
            
            updateSummary();
            updateTimelineEstimate();
        }

        // Update assigned staff preview
        function updateStaffPreview() {
            const staffPreview = document.getElementById('staffPreview');
            const staffName = document.getElementById('staffName');
            const staffDetails = document.getElementById('staffDetails');
            
            if (assignedToSelect.value) {
                const staffText = assignedToSelect.options[assignedToSelect.selectedIndex].text;
                staffName.textContent = staffText;
                staffDetails.textContent = 'Maintenance Staff';
                staffPreview.style.display = 'block';
            } else {
                staffPreview.style.display = 'none';
            }
            
            updateSummary();
        }

        // Clear assignment
        window.clearAssignment = function() {
            assignedToSelect.value = '';
            updateStaffPreview();
        };

        // Update cost estimator
        function updateCostEstimator() {
            const costEstimator = document.getElementById('costEstimator');
            const estimatedCostDisplay = document.getElementById('estimatedCostDisplay');
            const priority = prioritySelect.value;
            
            let baseCost = 0;
            switch(priority) {
                case 'low': baseCost = 500; break;
                case 'medium': baseCost = 1500; break;
                case 'high': baseCost = 3500; break;
                case 'urgent': baseCost = 7500; break;
            }
            
            if (baseCost > 0) {
                costEstimator.style.display = 'block';
                estimatedCostDisplay.textContent = `₹${baseCost.toFixed(2)}`;
                
                // Auto-fill estimated cost if empty
                if (!estimatedCostInput.value) {
                    estimatedCostInput.value = baseCost;
                }
            } else {
                costEstimator.style.display = 'none';
            }
            
            updateSummary();
        }

        // Update summary section
        function updateSummary() {
            const summaryPriority = document.getElementById('summaryPriority');
            const summaryStatus = document.getElementById('summaryStatus');
            const summaryAssigned = document.getElementById('summaryAssigned');
            const summaryCost = document.getElementById('summaryCost');
            
            // Update priority
            if (prioritySelect.value) {
                const priorityText = prioritySelect.options[prioritySelect.selectedIndex].text;
                summaryPriority.innerHTML = `<span class="priority-badge priority-${prioritySelect.value}">${priorityText}</span>`;
            } else {
                summaryPriority.textContent = 'Not set';
            }
            
            // Update status
            if (statusSelect && statusSelect.value) {
                const statusText = statusSelect.options[statusSelect.selectedIndex].text;
                summaryStatus.innerHTML = `<span class="status-indicator status-${statusSelect.value}"></span>${statusText}`;
            } else {
                summaryStatus.innerHTML = '<span class="status-indicator status-pending"></span>Pending';
            }
            
            // Update assigned staff
            if (assignedToSelect.value) {
                summaryAssigned.textContent = assignedToSelect.options[assignedToSelect.selectedIndex].text;
            } else {
                summaryAssigned.textContent = 'Unassigned';
            }
            
            // Update cost
            if (estimatedCostInput.value) {
                summaryCost.textContent = `₹${estimatedCostInput.value}`;
            } else {
                summaryCost.textContent = 'Not estimated';
            }
        }

        // Update timeline estimate
        function updateTimelineEstimate() {
            const timelineEstimate = document.getElementById('timelineEstimate');
            const priority = prioritySelect.value;
            let timelineHtml = '';
            
            switch(priority) {
                case 'urgent':
                    timelineHtml = '<p class="text-danger mb-1"><strong>Urgent:</strong> 24-48 hours</p>';
                    break;
                case 'high':
                    timelineHtml = '<p class="text-warning mb-1"><strong>High:</strong> 3-5 days</p>';
                    break;
                case 'medium':
                    timelineHtml = '<p class="text-info mb-1"><strong>Medium:</strong> 1-2 weeks</p>';
                    break;
                case 'low':
                    timelineHtml = '<p class="text-success mb-1"><strong>Low:</strong> 2-4 weeks</p>';
                    break;
                default:
                    timelineHtml = '<p class="text-muted">Set priority to see estimated timeline</p>';
            }
            
            timelineEstimate.innerHTML = timelineHtml;
        }

        // Image upload handling
        function handleImageUpload(event) {
            const files = event.target.files;
            const preview = document.getElementById('imagePreview');
            preview.innerHTML = '';

            for (let file of files) {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'img-thumbnail me-2 mb-2';
                        img.style.maxWidth = '100px';
                        img.style.maxHeight = '100px';
                        preview.appendChild(img);
                    };
                    reader.readAsDataURL(file);
                }
            }
        }

        // Form validation
        function validateForm() {
            let isValid = true;
            const requiredFields = [hostelSelect, titleInput, descriptionTextarea, prioritySelect];

            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    field.classList.add('is-invalid');
                    isValid = false;
                } else {
                    field.classList.remove('is-invalid');
                }
            });

            // Description length validation
            if (descriptionTextarea.value.trim().length < 10) {
                descriptionTextarea.classList.add('is-invalid');
                isValid = false;
            } else {
                descriptionTextarea.classList.remove('is-invalid');
            }

            return isValid;
        }

        // Event listeners
        hostelSelect.addEventListener('change', updateLocationOptions);
        roomSelect.addEventListener('change', updateBedOptions);
        bedSelect.addEventListener('change', updateLocationPreview);
        prioritySelect.addEventListener('change', updatePriorityIndicator);
        assignedToSelect.addEventListener('change', updateStaffPreview);
        estimatedCostInput.addEventListener('input', updateSummary);
        if (statusSelect) statusSelect.addEventListener('change', updateSummary);
        document.getElementById('imageUpload').addEventListener('change', handleImageUpload);

        // Form submission
        maintenanceForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!validateForm()) {
                alert('Please fill in all required fields correctly. Description should be at least 10 characters.');
                return;
            }

            // Show loading state
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>Saving...';
            submitBtn.disabled = true;

            // Submit the form
            this.submit();
        });

        // Reset form handler
        maintenanceForm.addEventListener('reset', function() {
            setTimeout(updateLocationOptions, 100);
            setTimeout(updatePriorityIndicator, 100);
            setTimeout(updateStaffPreview, 100);
            setTimeout(updateSummary, 100);
        });

        // Initialize on page load
        updateLocationOptions();
        updatePriorityIndicator();
        updateStaffPreview();
        updateSummary();
        updateTimelineEstimate();

        // Auto-focus on title input
        titleInput.focus();

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                submitBtn.click();
            }
        });

        // Auto-schedule based on priority
        prioritySelect.addEventListener('change', function() {
            if (!scheduledDateInput.value) {
                const today = new Date();
                let daysToAdd = 7; // Default medium priority
                
                switch(this.value) {
                    case 'urgent': daysToAdd = 1; break;
                    case 'high': daysToAdd = 2; break;
                    case 'low': daysToAdd = 14; break;
                }
                
                const scheduledDate = new Date(today);
                scheduledDate.setDate(today.getDate() + daysToAdd);
                scheduledDateInput.value = scheduledDate.toISOString().split('T')[0];
            }
        });

        // Show character count for description
        descriptionTextarea.addEventListener('input', function() {
            const currentLength = this.value.length;
            let helpText = this.parentNode.querySelector('.help-text');
            
            if (!helpText.querySelector('.char-count')) {
                const charCount = document.createElement('span');
                charCount.className = 'char-count float-end';
                helpText.appendChild(charCount);
            }
            
            const charCount = helpText.querySelector('.char-count');
            charCount.textContent = `${currentLength} characters`;
            
            if (currentLength < 10) {
                charCount.className = 'char-count float-end text-danger';
            } else if (currentLength < 50) {
                charCount.className = 'char-count float-end text-warning';
            } else {
                charCount.className = 'char-count float-end text-success';
            }
        });

        // Trigger input event to show initial character count
        descriptionTextarea.dispatchEvent(new Event('input'));
    });
</script>
{% endblock %}