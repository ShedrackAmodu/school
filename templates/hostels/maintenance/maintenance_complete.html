<!-- templates/hostels/maintenance/maintenance_complete.html -->
{% extends 'base/base.html' %}
{% load static %}
{% load i18n %}


{% block title %}Complete Maintenance Request - Hostel Management{% endblock %}

{% block extra_css %}
<style>
    .completion-card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        max-width: 800px;
        margin: 0 auto;
    }
    
    .completion-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }
    
    .completion-header {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border-radius: 12px 12px 0 0;
        padding: 2rem;
    }
    
    .completion-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
    }
    
    .request-info-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 8px;
        padding: 1.5rem;
    }
    
    .info-item {
        display: flex;
        justify-content: space-between;
        padding: 0.75rem 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .info-item:last-child {
        border-bottom: none;
    }
    
    .info-label {
        font-weight: 500;
        opacity: 0.9;
    }
    
    .info-value {
        font-weight: 600;
    }
    
    .completion-form-section {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 1.5rem;
        background: #f8f9fa;
    }
    
    .form-section-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #495057;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #28a745;
    }
    
    .required-field::after {
        content: " *";
        color: #dc3545;
    }
    
    .action-buttons {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        margin-top: 2rem;
    }
    
    .cost-comparison {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        color: white;
        border-radius: 8px;
        padding: 1rem;
        margin: 1rem 0;
    }
    
    .time-tracking {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        border-radius: 8px;
        padding: 1rem;
        margin: 1rem 0;
    }
    
    .resolution-summary {
        border: 2px solid #28a745;
        border-radius: 8px;
        padding: 1.5rem;
        background: #d4edda;
        color: #155724;
    }
    
    .material-list {
        background: #e7f3ff;
        border: 1px solid #b3d9ff;
        border-radius: 8px;
        padding: 1rem;
        margin: 1rem 0;
    }
    
    .material-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid rgba(179, 217, 255, 0.5);
    }
    
    .material-item:last-child {
        border-bottom: none;
    }
    
    .signature-area {
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        padding: 2rem;
        text-align: center;
        background: #f8f9fa;
        margin: 1rem 0;
        cursor: pointer;
    }
    
    .signature-area:hover {
        border-color: #28a745;
        background: #e8f5e8;
    }
    
    .signature-preview {
        min-height: 100px;
        border: 1px solid #28a745;
        border-radius: 4px;
        background: white;
        margin-top: 1rem;
    }
    
    .completion-badge {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 600;
    }
    
    .time-display {
        font-size: 2rem;
        font-weight: 700;
        text-align: center;
        margin: 1rem 0;
    }
    
    .auto-calculate-btn {
        background: #6c757d;
        border: none;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 4px;
        font-size: 0.875rem;
        cursor: pointer;
    }
    
    .auto-calculate-btn:hover {
        background: #5a6268;
    }
</style>
{% endblock %}

{% block page_title %}
<i class="bi bi-check-circle me-2"></i>Complete Maintenance Request
{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'users:dashboard' %}">{% trans "Home" %}</a></li>
<li class="breadcrumb-item"><a href="{% url 'hostels:dashboard' %}">Hostel Dashboard</a></li>
<li class="breadcrumb-item"><a href="{% url 'hostels:maintenance_list' %}">Maintenance</a></li>
<li class="breadcrumb-item active" aria-current="page">Complete Request</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card completion-card">
                <!-- Completion Header -->
                <div class="completion-header text-center">
                    <i class="bi bi-check-circle completion-icon"></i>
                    <h2 class="mb-3">Complete Maintenance Request</h2>
                    <p class="lead mb-0 opacity-90">Mark this maintenance request as completed and record final details</p>
                </div>

                <div class="card-body">
                    <!-- Request Information -->
                    <div class="request-info-card mb-4">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h3 class="text-white mb-2">{{ maintenance.title }}</h3>
                                <p class="text-white-50 mb-0">
                                    {{ maintenance.hostel.name }}
                                    {% if maintenance.room %} - Room {{ maintenance.room.room_number }}{% endif %}
                                    {% if maintenance.bed %} - Bed {{ maintenance.bed.bed_number }}{% endif %}
                                </p>
                            </div>
                            <div class="col-md-4 text-end">
                                <span class="completion-badge">
                                    <i class="bi bi-wrench me-1"></i>Ready to Complete
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Request Details -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header bg-light">
                                    <h6 class="card-title mb-0">Request Details</h6>
                                </div>
                                <div class="card-body">
                                    <div class="info-item">
                                        <span class="info-label">Priority:</span>
                                        <span class="info-value">
                                            <span class="badge {% if maintenance.priority == 'urgent' %}bg-danger{% elif maintenance.priority == 'high' %}bg-warning{% elif maintenance.priority == 'medium' %}bg-info{% else %}bg-success{% endif %}">
                                                {{ maintenance.get_priority_display }}
                                            </span>
                                        </span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Requested By:</span>
                                        <span class="info-value">{{ maintenance.requested_by.get_full_name }}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Request Date:</span>
                                        <span class="info-value">{{ maintenance.requested_date|date:"M d, Y" }}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Assigned To:</span>
                                        <span class="info-value">
                                            {% if maintenance.assigned_to %}
                                                {{ maintenance.assigned_to.get_full_name }}
                                            {% else %}
                                                Unassigned
                                            {% endif %}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header bg-light">
                                    <h6 class="card-title mb-0">Cost & Timeline</h6>
                                </div>
                                <div class="card-body">
                                    <div class="info-item">
                                        <span class="info-label">Estimated Cost:</span>
                                        <span class="info-value">
                                            {% if maintenance.estimated_cost %}
                                                ₹{{ maintenance.estimated_cost }}
                                            {% else %}
                                                Not estimated
                                            {% endif %}
                                        </span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Scheduled Date:</span>
                                        <span class="info-value">
                                            {% if maintenance.scheduled_date %}
                                                {{ maintenance.scheduled_date|date:"M d, Y" }}
                                            {% else %}
                                                Not scheduled
                                            {% endif %}
                                        </span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Days Open:</span>
                                        <span class="info-value">{{ days_open }} days</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Current Status:</span>
                                        <span class="info-value">
                                            <span class="badge {% if maintenance.status == 'pending' %}bg-secondary{% elif maintenance.status == 'in_progress' %}bg-primary{% else %}bg-success{% endif %}">
                                                {{ maintenance.get_status_display }}
                                            </span>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Resolution Time Tracking -->
                    <div class="time-tracking">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <i class="bi bi-clock-history me-2"></i>
                                <strong>Resolution Time:</strong> 
                                <span class="time-display">{{ days_open }} days</span>
                            </div>
                            <div class="col-md-4 text-end">
                                <small>Request opened {{ maintenance.requested_date|date:"M d, Y" }}</small>
                            </div>
                        </div>
                    </div>

                    <!-- Completion Form -->
                    <div class="completion-form-section">
                        <h5 class="form-section-title">
                            <i class="bi bi-clipboard-check me-2"></i>Completion Details
                        </h5>
                        
                        <form method="post" id="completionForm">
                            {% csrf_token %}
                            
                            <!-- Actual Cost -->
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <label for="actual_cost" class="form-label">
                                        <i class="bi bi-currency-rupee me-1"></i>Actual Cost
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text">₹</span>
                                        <input type="number" class="form-control" 
                                               id="actual_cost" name="actual_cost" 
                                               value="{{ maintenance.estimated_cost|default:0 }}" 
                                               min="0" step="0.01">
                                        <button type="button" class="btn btn-outline-secondary auto-calculate-btn" 
                                                onclick="useEstimatedCost()">
                                            Use Estimated
                                        </button>
                                    </div>
                                    <div class="form-text">
                                        Final cost including parts and labor
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex align-items-center h-100">
                                        <div class="text-center w-100">
                                            {% if maintenance.estimated_cost %}
                                            <div class="fs-4 fw-bold {% if maintenance.estimated_cost %}text-info{% else %}text-muted{% endif %}" id="estimatedDisplay">
                                                ₹{{ maintenance.estimated_cost }}
                                            </div>
                                            <div class="text-muted">Estimated Cost</div>
                                            {% else %}
                                            <div class="text-muted">No estimate provided</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Cost Comparison -->
                            {% if maintenance.estimated_cost %}
                            <div class="cost-comparison" id="costComparison">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <i class="bi bi-graph-up-arrow me-2"></i>
                                        <strong>Cost Comparison:</strong> 
                                        <span id="costDifference">Calculating...</span>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <small>Estimated vs Actual</small>
                                    </div>
                                </div>
                            </div>
                            {% endif %}

                            <!-- Work Details -->
                            <div class="mb-4">
                                <label for="work_performed" class="form-label required-field">
                                    <i class="bi bi-tools me-1"></i>Work Performed
                                </label>
                                <textarea class="form-control" id="work_performed" name="work_performed" 
                                          rows="4" placeholder="Describe the work that was performed, including any repairs, replacements, or adjustments..." 
                                          required></textarea>
                                <div class="form-text">
                                    Detailed description of the work completed
                                </div>
                            </div>

                            <!-- Materials Used -->
                            <div class="mb-4">
                                <label class="form-label">
                                    <i class="bi bi-box-seam me-1"></i>Materials Used
                                </label>
                                <div class="material-list">
                                    <div id="materialsContainer">
                                        <div class="material-item">
                                            <input type="text" class="form-control form-control-sm" name="material_name[]" placeholder="Material name">
                                            <input type="number" class="form-control form-control-sm mx-2" style="width: 100px;" name="material_quantity[]" placeholder="Qty" min="1">
                                            <input type="number" class="form-control form-control-sm" style="width: 120px;" name="material_cost[]" placeholder="Cost" min="0" step="0.01">
                                            <button type="button" class="btn btn-sm btn-outline-danger ms-2" onclick="removeMaterial(this)">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="addMaterial()">
                                        <i class="bi bi-plus-circle me-1"></i>Add Material
                                    </button>
                                </div>
                            </div>

                            <!-- Completion Notes -->
                            <div class="mb-4">
                                <label for="completion_notes" class="form-label">
                                    <i class="bi bi-sticky me-1"></i>Completion Notes
                                </label>
                                <textarea class="form-control" id="completion_notes" name="completion_notes" 
                                          rows="3" placeholder="Any additional notes, recommendations, or follow-up requirements..."></textarea>
                                <div class="form-text">
                                    Notes for future reference or follow-up actions
                                </div>
                            </div>

                            <!-- Quality Check -->
                            <div class="mb-4">
                                <label class="form-label required-field">
                                    <i class="bi bi-shield-check me-1"></i>Quality Assurance
                                </label>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="quality_check" name="quality_check" required>
                                    <label class="form-check-label" for="quality_check">
                                        Work has been quality checked and meets standards
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="safety_check" name="safety_check" required>
                                    <label class="form-check-label" for="safety_check">
                                        Area is safe and clean after work completion
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="client_notified" name="client_notified">
                                    <label class="form-check-label" for="client_notified">
                                        Student/Staff has been notified of completion
                                    </label>
                                </div>
                            </div>

                            <!-- Technician Signature -->
                            <div class="mb-4">
                                <label class="form-label">
                                    <i class="bi bi-pen me-1"></i>Technician Signature
                                </label>
                                <div class="signature-area" onclick="showSignaturePad()">
                                    <i class="bi bi-pen-fill" style="font-size: 2rem;"></i>
                                    <h6>Click to Add Signature</h6>
                                    <p class="text-muted mb-0">Technician completing the work</p>
                                    <div class="signature-preview" id="signaturePreview">
                                        <!-- Signature will appear here -->
                                    </div>
                                </div>
                                <input type="hidden" id="technician_signature" name="technician_signature">
                            </div>

                            <!-- Resolution Summary -->
                            <div class="resolution-summary">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <h6 class="mb-2">
                                            <i class="bi bi-check-circle me-2"></i>
                                            Ready to Complete
                                        </h6>
                                        <p class="mb-0">Completing this request will:</p>
                                        <ul class="mb-0">
                                            <li>Mark the request as completed</li>
                                            <li>Record the completion date and time</li>
                                            <li>Update maintenance history</li>
                                            <li>Notify relevant stakeholders</li>
                                            <li>Update inventory if materials were used</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <div class="completion-badge">
                                            <i class="bi bi-check-lg me-1"></i>
                                            Complete
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="action-buttons">
                                <a href="{% url 'hostels:maintenance_list' %}" class="btn btn-outline-secondary">
                                    <i class="bi bi-arrow-left me-2"></i>
                                    Cancel
                                </a>
                                <button type="button" class="btn btn-warning" onclick="saveAsInProgress()">
                                    <i class="bi bi-pause-circle me-2"></i>
                                    Save as In Progress
                                </button>
                                <button type="submit" class="btn btn-success" id="completeBtn">
                                    <i class="bi bi-check-circle me-2"></i>
                                    Mark as Completed
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const completionForm = document.getElementById('completionForm');
        const completeBtn = document.getElementById('completeBtn');
        const actualCostInput = document.getElementById('actual_cost');
        const workPerformedTextarea = document.getElementById('work_performed');
        const estimatedCost = {{ maintenance.estimated_cost|default:0 }};
        const estimatedDisplay = document.getElementById('estimatedDisplay');
        const costComparison = document.getElementById('costComparison');
        const costDifference = document.getElementById('costDifference');

        // Use estimated cost
        window.useEstimatedCost = function() {
            if (estimatedCost > 0) {
                actualCostInput.value = estimatedCost;
                updateCostComparison();
            }
        };

        // Update cost comparison
        function updateCostComparison() {
            if (estimatedCost > 0 && costComparison) {
                const actualCost = parseFloat(actualCostInput.value) || 0;
                const difference = actualCost - estimatedCost;
                const percentage = ((difference / estimatedCost) * 100).toFixed(1);
                
                if (difference === 0) {
                    costDifference.innerHTML = '<span class="text-success">On budget</span>';
                } else if (difference > 0) {
                    costDifference.innerHTML = `<span class="text-danger">Over budget by ₹${Math.abs(difference).toFixed(2)} (${percentage}%)</span>`;
                } else {
                    costDifference.innerHTML = `<span class="text-success">Under budget by ₹${Math.abs(difference).toFixed(2)} (${percentage}%)</span>`;
                }
            }
        }

        // Add material row
        window.addMaterial = function() {
            const container = document.getElementById('materialsContainer');
            const newRow = document.createElement('div');
            newRow.className = 'material-item';
            newRow.innerHTML = `
                <input type="text" class="form-control form-control-sm" name="material_name[]" placeholder="Material name" required>
                <input type="number" class="form-control form-control-sm mx-2" style="width: 100px;" name="material_quantity[]" placeholder="Qty" min="1" required>
                <input type="number" class="form-control form-control-sm" style="width: 120px;" name="material_cost[]" placeholder="Cost" min="0" step="0.01" required>
                <button type="button" class="btn btn-sm btn-outline-danger ms-2" onclick="removeMaterial(this)">
                    <i class="bi bi-trash"></i>
                </button>
            `;
            container.appendChild(newRow);
        };

        // Remove material row
        window.removeMaterial = function(button) {
            const container = document.getElementById('materialsContainer');
            if (container.children.length > 1) {
                button.parentElement.remove();
            }
        };

        // Show signature pad (simplified version)
        window.showSignaturePad = function() {
            const signature = prompt('Please enter your name for signature:');
            if (signature) {
                document.getElementById('signaturePreview').innerHTML = `
                    <div class="text-center p-3">
                        <div style="font-family: 'Brush Script MT', cursive; font-size: 1.5rem;">${signature}</div>
                        <div class="small text-muted">Signed digitally</div>
                    </div>
                `;
                document.getElementById('technician_signature').value = signature;
            }
        };

        // Save as in progress
        window.saveAsInProgress = function() {
            if (confirm('Save work progress and keep request as "In Progress"? You can complete it later.')) {
                // In real implementation, this would submit with a different status
                console.log('Saving as in progress...');
                // For now, we'll just show a message
                showNotification('Work progress saved successfully. Request remains in progress.', 'info');
            }
        };

        // Form validation
        function validateForm() {
            let isValid = true;
            const requiredFields = [workPerformedTextarea];
            const requiredCheckboxes = ['quality_check', 'safety_check'];

            // Validate text fields
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    field.classList.add('is-invalid');
                    isValid = false;
                } else {
                    field.classList.remove('is-invalid');
                }
            });

            // Validate checkboxes
            requiredCheckboxes.forEach(checkboxName => {
                const checkbox = document.querySelector(`[name="${checkboxName}"]`);
                if (!checkbox.checked) {
                    checkbox.classList.add('is-invalid');
                    isValid = false;
                } else {
                    checkbox.classList.remove('is-invalid');
                }
            });

            // Validate work performed length
            if (workPerformedTextarea.value.trim().length < 10) {
                workPerformedTextarea.classList.add('is-invalid');
                isValid = false;
            }

            return isValid;
        }

        // Form submission
        completionForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!validateForm()) {
                alert('Please fill in all required fields correctly. Work performed should be at least 10 characters.');
                return;
            }

            // Final confirmation
            const confirmationMessage = `
You are about to mark this maintenance request as COMPLETED:

Request: {{ maintenance.title }}
Location: {{ maintenance.hostel.name }}{% if maintenance.room %} - Room {{ maintenance.room.room_number }}{% endif %}

This action will:
• Mark the request as completed
• Record final costs and work details
• Update maintenance history
• Notify relevant staff

Are you sure you want to proceed?`;

            if (!confirm(confirmationMessage)) {
                return;
            }

            // Show loading state
            const originalText = completeBtn.innerHTML;
            completeBtn.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>Completing...';
            completeBtn.disabled = true;

            // Submit the form
            this.submit();
        });

        // Real-time updates
        actualCostInput.addEventListener('input', updateCostComparison);

        // Auto-focus on work performed
        workPerformedTextarea.focus();

        // Initialize cost comparison
        updateCostComparison();

        // Show character count for work performed
        workPerformedTextarea.addEventListener('input', function() {
            const currentLength = this.value.length;
            let helpText = this.parentNode.querySelector('.form-text');
            
            if (!helpText.querySelector('.char-count')) {
                const charCount = document.createElement('span');
                charCount.className = 'char-count float-end';
                helpText.appendChild(charCount);
            }
            
            const charCount = helpText.querySelector('.char-count');
            charCount.textContent = `${currentLength} characters`;
            
            if (currentLength < 10) {
                charCount.className = 'char-count float-end text-danger';
            } else if (currentLength < 50) {
                charCount.className = 'char-count float-end text-warning';
            } else {
                charCount.className = 'char-count float-end text-success';
            }
        });

        // Trigger input event to show initial character count
        workPerformedTextarea.dispatchEvent(new Event('input'));

        // Utility function for notifications
        function showNotification(message, type) {
            const alertClass = type === 'success' ? 'alert-success' : 'alert-info';
            const notification = document.createElement('div');
            notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                completeBtn.click();
            }
            
            if (e.key === 'Escape') {
                window.location.href = "{% url 'hostels:maintenance_list' %}";
            }
        });

        // Auto-calculate total materials cost
        function calculateMaterialsTotal() {
            const materialCosts = document.querySelectorAll('input[name="material_cost[]"]');
            let total = 0;
            
            materialCosts.forEach(input => {
                total += parseFloat(input.value) || 0;
            });
            
            // Auto-update actual cost if it's close to estimated
            if (total > 0 && (!actualCostInput.value || Math.abs(actualCostInput.value - estimatedCost) < 100)) {
                actualCostInput.value = total;
                updateCostComparison();
            }
        }

        // Add event listeners to material cost inputs
        document.addEventListener('input', function(e) {
            if (e.target.name === 'material_cost[]') {
                calculateMaterialsTotal();
            }
        });
    });
</script>
{% endblock %}