<!-- templates/hostels/hostels/hostel_confirm_delete.html -->
{% extends 'base/base.html' %}
{% load static %}

{% block title %}Delete Hostel - Hostel Management{% endblock %}

{% block extra_css %}
<style>
    .delete-card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        max-width: 800px;
        margin: 0 auto;
    }
    
    .delete-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }
    
    .warning-header {
        background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
        color: white;
        border-radius: 12px 12px 0 0;
        padding: 2rem;
    }
    
    .warning-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
    }
    
    .hostel-info-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 8px;
        padding: 1.5rem;
    }
    
    .info-item {
        display: flex;
        justify-content: space-between;
        padding: 0.75rem 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .info-item:last-child {
        border-bottom: none;
    }
    
    .info-label {
        font-weight: 500;
        opacity: 0.9;
    }
    
    .info-value {
        font-weight: 600;
    }
    
    .impact-section {
        border: 2px solid #ffc107;
        border-radius: 8px;
        padding: 1.5rem;
        background: #fff3cd;
        color: #856404;
    }
    
    .impact-item {
        display: flex;
        align-items: center;
        padding: 0.75rem 0;
        border-bottom: 1px solid rgba(255, 193, 7, 0.3);
    }
    
    .impact-item:last-child {
        border-bottom: none;
    }
    
    .impact-icon {
        font-size: 1.5rem;
        margin-right: 1rem;
        width: 30px;
        text-align: center;
    }
    
    .danger-zone {
        border: 2px solid #dc3545;
        border-radius: 8px;
        padding: 1.5rem;
        background: #f8d7da;
        color: #721c24;
    }
    
    .confirmation-input {
        border: 2px solid #dc3545;
        border-radius: 6px;
        padding: 0.75rem;
        font-weight: 600;
        text-align: center;
        letter-spacing: 0.1em;
    }
    
    .confirmation-input:focus {
        border-color: #dc3545;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
    }
    
    .action-buttons {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 2rem;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin: 1.5rem 0;
    }
    
    .stat-card {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 1rem;
        text-align: center;
    }
    
    .stat-number {
        font-size: 1.5rem;
        font-weight: 700;
        line-height: 1;
    }
    
    .stat-label {
        font-size: 0.8rem;
        opacity: 0.9;
        margin-top: 0.25rem;
    }
    
    .backup-section {
        background: #e7f3ff;
        border: 1px solid #b3d9ff;
        border-radius: 8px;
        padding: 1rem;
        margin: 1rem 0;
    }
    
    .typewriter {
        border-right: 2px solid;
        animation: blink 1s infinite;
        display: inline-block;
    }
    
    @keyframes blink {
        0%, 50% { border-color: transparent; }
        51%, 100% { border-color: #dc3545; }
    }
    
    .security-notice {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        color: white;
        border-radius: 8px;
        padding: 1rem;
        text-align: center;
        margin: 1rem 0;
    }
</style>
{% endblock %}

{% block page_title %}
<i class="bi bi-exclamation-triangle me-2"></i>Delete Hostel
{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'users:dashboard' %}">{% trans "Home" %}</a></li>
<li class="breadcrumb-item"><a href="{% url 'hostels:dashboard' %}">Hostel Dashboard</a></li>
<li class="breadcrumb-item"><a href="{% url 'hostels:hostel_list' %}">Hostels</a></li>
<li class="breadcrumb-item active" aria-current="page">Delete Hostel</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card delete-card">
                <!-- Warning Header -->
                <div class="warning-header text-center">
                    <i class="bi bi-exclamation-triangle warning-icon"></i>
                    <h2 class="mb-3">Delete Hostel Confirmation</h2>
                    <p class="lead mb-0 opacity-90">You are about to permanently delete a hostel and all its associated data</p>
                </div>

                <div class="card-body">
                    <!-- Hostel Information -->
                    <div class="hostel-info-card mb-4">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h3 class="text-white mb-2">{{ hostel.name }}</h3>
                                <p class="text-white-50 mb-0">
                                    {{ hostel.code }} • {{ hostel.get_hostel_type_display }} • {{ hostel.get_category_display }}
                                </p>
                            </div>
                            <div class="col-md-4 text-end">
                                <span class="badge bg-{% if hostel.is_active %}success{% else %}secondary{% endif %} fs-6">
                                    {{ hostel.is_active|yesno:"Active,Inactive" }}
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Statistics Grid -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number">{{ hostel.total_rooms }}</div>
                            <div class="stat-label">Total Rooms</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">{{ hostel.capacity }}</div>
                            <div class="stat-label">Total Capacity</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">{{ hostel.current_occupancy }}</div>
                            <div class="stat-label">Current Occupancy</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">{{ hostel.available_beds }}</div>
                            <div class="stat-label">Available Beds</div>
                        </div>
                    </div>

                    <!-- Security Notice -->
                    <div class="security-notice">
                        <i class="bi bi-shield-exclamation me-2"></i>
                        <strong>SECURITY NOTICE:</strong> This action requires elevated permissions and cannot be undone.
                    </div>

                    <!-- Impact Assessment -->
                    <div class="impact-section mb-4">
                        <h5 class="mb-3">
                            <i class="bi bi-graph-down me-2"></i>
                            What will be deleted permanently:
                        </h5>
                        
                        <div class="impact-item">
                            <i class="bi bi-door-closed impact-icon text-danger"></i>
                            <div>
                                <strong>{{ hostel.rooms.count }} Rooms</strong> and all associated data
                            </div>
                        </div>
                        
                        <div class="impact-item">
                            <i class="bi bi-layout-text-sidebar impact-icon text-danger"></i>
                            <div>
                                <strong>{{ total_beds }} Beds</strong> and their allocation history
                            </div>
                        </div>
                        
                        <div class="impact-item">
                            <i class="bi bi-people impact-icon text-danger"></i>
                            <div>
                                <strong>{{ active_allocations }} Active Student Allocations</strong> will be terminated
                            </div>
                        </div>
                        
                        <div class="impact-item">
                            <i class="bi bi-cash-coin impact-icon text-danger"></i>
                            <div>
                                <strong>{{ fee_records }} Fee Records</strong> and payment history
                            </div>
                        </div>
                        
                        <div class="impact-item">
                            <i class="bi bi-tools impact-icon text-danger"></i>
                            <div>
                                <strong>{{ maintenance_requests }} Maintenance Requests</strong> and their history
                            </div>
                        </div>
                        
                        <div class="impact-item">
                            <i class="bi bi-box-seam impact-icon text-danger"></i>
                            <div>
                                <strong>{{ inventory_items }} Inventory Items</strong> and asset records
                            </div>
                        </div>
                        
                        <div class="impact-item">
                            <i class="bi bi-person-badge impact-icon text-danger"></i>
                            <div>
                                <strong>{{ visitor_logs }} Visitor Logs</strong> and security records
                            </div>
                        </div>
                    </div>

                    <!-- Backup Recommendation -->
                    <div class="backup-section">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h6 class="text-primary mb-2">
                                    <i class="bi bi-cloud-arrow-down me-2"></i>
                                    Recommended: Export Data Before Deletion
                                </h6>
                                <p class="text-muted mb-0">
                                    Consider exporting hostel data for archival purposes before proceeding with deletion.
                                </p>
                            </div>
                            <div class="col-md-4 text-end">
                                <button class="btn btn-outline-primary btn-sm" onclick="exportHostelData()">
                                    <i class="bi bi-download me-2"></i>Export Data
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Danger Zone -->
                    <div class="danger-zone">
                        <h5 class="mb-3 text-danger">
                            <i class="bi bi-exclamation-octagon me-2"></i>
                            Danger Zone - Permanent Deletion
                        </h5>
                        
                        <p class="mb-3">
                            <strong>This action cannot be undone.</strong> All data associated with this hostel will be permanently removed from the system. This may affect:
                        </p>
                        
                        <ul class="mb-3">
                            <li>Student accommodation records</li>
                            <li>Financial transactions and fee history</li>
                            <li>Maintenance and inventory records</li>
                            <li>Visitor logs and security data</li>
                            <li>Reporting and analytics data</li>
                        </ul>

                        <!-- Confirmation Input -->
                        <div class="mb-3">
                            <label for="confirmationText" class="form-label fw-semibold">
                                Type <span class="text-danger">"DELETE {{ hostel.name|upper }}"</span> to confirm:
                            </label>
                            <input type="text" class="form-control confirmation-input" 
                                   id="confirmationText" 
                                   placeholder="Type the hostel name in uppercase"
                                   oninput="validateConfirmation()">
                            <div class="form-text text-danger">
                                <i class="bi bi-key me-1"></i>
                                This is a security measure to prevent accidental deletion.
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="action-buttons">
                            <a href="{% url 'hostels:hostel_list' %}" class="btn btn-success btn-lg">
                                <i class="bi bi-arrow-left me-2"></i>
                                Cancel & Go Back
                            </a>
                            <form method="post" id="deleteForm" class="d-inline">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-danger btn-lg" id="deleteBtn" disabled>
                                    <i class="bi bi-trash3 me-2"></i>
                                    Permanently Delete Hostel
                                </button>
                            </form>
                        </div>

                        <!-- Additional Warning -->
                        <div class="text-center mt-3">
                            <small class="text-muted">
                                <i class="bi bi-info-circle me-1"></i>
                                This action will be logged for security audit purposes.
                            </small>
                        </div>
                    </div>

                    <!-- Alternative Options -->
                    <div class="text-center mt-4">
                        <p class="text-muted mb-2">Consider these alternatives instead:</p>
                        <div class="btn-group">
                            <a href="{% url 'hostels:hostel_update' pk=hostel.pk %}" class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-pencil me-2"></i>Edit Hostel
                            </a>
                            <button class="btn btn-outline-warning btn-sm" onclick="deactivateHostel()">
                                <i class="bi bi-pause-circle me-2"></i>Deactivate Instead
                            </button>
                            <a href="{% url 'hostels:hostel_detail' pk=hostel.pk %}" class="btn btn-outline-info btn-sm">
                                <i class="bi bi-eye me-2"></i>View Details
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const confirmationInput = document.getElementById('confirmationText');
        const deleteBtn = document.getElementById('deleteBtn');
        const deleteForm = document.getElementById('deleteForm');
        const requiredText = "DELETE {{ hostel.name|upper }}";

        // Typewriter effect for the required text
        function typeWriterEffect() {
            const element = document.querySelector('.typewriter');
            if (element) {
                let text = requiredText;
                let i = 0;
                element.innerHTML = '';
                
                function type() {
                    if (i < text.length) {
                        element.innerHTML += text.charAt(i);
                        i++;
                        setTimeout(type, 100);
                    }
                }
                type();
            }
        }

        // Validate confirmation text
        window.validateConfirmation = function() {
            const inputText = confirmationInput.value.trim();
            const isValid = inputText === requiredText;
            
            deleteBtn.disabled = !isValid;
            
            if (isValid) {
                confirmationInput.classList.remove('is-invalid');
                confirmationInput.classList.add('is-valid');
            } else {
                confirmationInput.classList.remove('is-valid');
                if (inputText.length > 0) {
                    confirmationInput.classList.add('is-invalid');
                } else {
                    confirmationInput.classList.remove('is-invalid');
                }
            }
        };

        // Enhanced form submission
        deleteForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!deleteBtn.disabled) {
                // Show final confirmation
                const confirmationMessage = `
FINAL WARNING: You are about to PERMANENTLY DELETE:

Hostel: {{ hostel.name }}
Code: {{ hostel.name }}
Type: {{ hostel.get_hostel_type_display }}

This will affect:
• {{ hostel.rooms.count }} rooms and {{ total_beds }} beds
• {{ active_allocations }} active student allocations
• {{ fee_records }} fee records
• {{ maintenance_requests }} maintenance requests
• {{ inventory_items }} inventory items
• {{ visitor_logs }} visitor logs

THIS ACTION CANNOT BE UNDONE!

Are you absolutely sure you want to proceed?`;
                
                if (confirm(confirmationMessage)) {
                    // Show loading state
                    const originalText = deleteBtn.innerHTML;
                    deleteBtn.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>Deleting...';
                    deleteBtn.disabled = true;
                    
                    // Add security delay
                    setTimeout(() => {
                        this.submit();
                    }, 2000);
                }
            }
        });

        // Export hostel data
        window.exportHostelData = function() {
            // In real implementation, this would trigger data export
            alert('This would export all hostel data for backup purposes.\n\nExport would include:\n- Hostel information\n- Room and bed data\n- Student allocations\n- Fee records\n- Maintenance history\n- Inventory data\n- Visitor logs');
        };

        // Deactivate instead of delete
        window.deactivateHostel = function() {
            if (confirm('Deactivate this hostel instead? This will:\n\n• Mark the hostel as inactive\n• Prevent new allocations\n• Preserve all historical data\n• Allow reactivation later\n\nThis is a safer alternative to deletion.')) {
                // In real implementation, this would redirect to deactivation view
                window.location.href = "{% url 'hostels:hostel_update' pk=hostel.pk %}";
            }
        };

        // Initialize typewriter effect
        typeWriterEffect();

        // Auto-focus on confirmation input
        confirmationInput.focus();

        // Add keyboard event listeners
        document.addEventListener('keydown', function(e) {
            // Escape key to cancel
            if (e.key === 'Escape') {
                window.location.href = "{% url 'hostels:hostel_list' %}";
            }
            
            // Ctrl+Enter to submit if enabled
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter' && !deleteBtn.disabled) {
                e.preventDefault();
                deleteBtn.click();
            }
        });

        // Prevent accidental navigation
        window.addEventListener('beforeunload', function(e) {
            if (confirmationInput.value.length > 0) {
                e.preventDefault();
                e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
                return e.returnValue;
            }
        });

        // Show character count for confirmation
        confirmationInput.addEventListener('input', function() {
            const currentLength = this.value.length;
            const requiredLength = requiredText.length;
            
            let helpText = this.parentNode.querySelector('.form-text');
            if (!helpText.querySelector('.char-count')) {
                const charCount = document.createElement('span');
                charCount.className = 'char-count';
                helpText.appendChild(charCount);
            }
            
            const charCount = helpText.querySelector('.char-count');
            charCount.textContent = ` ${currentLength}/${requiredLength} characters`;
            
            if (currentLength === requiredLength) {
                charCount.className = 'char-count text-success';
            } else {
                charCount.className = 'char-count text-danger';
            }
        });

        // Trigger input event to show initial character count
        confirmationInput.dispatchEvent(new Event('input'));
    });
</script>
{% endblock %}