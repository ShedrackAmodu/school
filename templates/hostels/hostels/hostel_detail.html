<!-- templates/hostels/hostels/hostel_detail.html -->
{% extends 'base/base.html' %}
{% load static %}

{% block title %}{{ hostel.name }} - Hostel Details{% endblock %}

{% block extra_css %}
<style>
    .hostel-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 2rem;
        position: relative;
        overflow: hidden;
    }
    
    .hostel-header::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 200px;
        height: 200px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        transform: translate(50px, -50px);
    }
    
    .hostel-avatar-large {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 2rem;
        font-weight: bold;
        border: 3px solid rgba(255, 255, 255, 0.3);
    }
    
    .stat-card {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s ease;
        height: 100%;
    }
    
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }
    
    .stat-number {
        font-size: 2rem;
        font-weight: 700;
        color: #333;
        margin-bottom: 0.5rem;
    }
    
    .stat-label {
        color: #6c757d;
        font-size: 0.9rem;
        font-weight: 500;
    }
    
    .info-card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 1.5rem;
    }
    
    .info-card .card-header {
        background: white;
        border-bottom: 1px solid #e9ecef;
        font-weight: 600;
        padding: 1rem 1.5rem;
    }
    
    .info-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .info-list li {
        padding: 0.75rem 1.5rem;
        border-bottom: 1px solid #f8f9fa;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .info-list li:last-child {
        border-bottom: none;
    }
    
    .info-label {
        font-weight: 500;
        color: #495057;
    }
    
    .info-value {
        color: #6c757d;
        text-align: right;
    }
    
    .amenity-tag {
        background: #e3f2fd;
        color: #1976d2;
        padding: 0.4rem 0.8rem;
        border-radius: 20px;
        font-size: 0.875rem;
        margin: 0.25rem;
        display: inline-block;
    }
    
    .progress-container {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .progress-label {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
        font-weight: 500;
    }
    
    .occupancy-progress {
        height: 12px;
        border-radius: 6px;
        background-color: #e9ecef;
        overflow: hidden;
    }
    
    .progress-bar-custom {
        height: 100%;
        border-radius: 6px;
        transition: width 0.3s ease;
    }
    
    .room-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }
    
    .room-card {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 1rem;
        transition: all 0.3s ease;
    }
    
    .room-card:hover {
        border-color: #007bff;
        box-shadow: 0 2px 8px rgba(0, 123, 255, 0.1);
    }
    
    .room-status {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 0.5rem;
    }
    
    .status-available { background-color: #28a745; }
    .status-occupied { background-color: #dc3545; }
    .status-maintenance { background-color: #ffc107; }
    
    .tab-content {
        padding: 1.5rem 0;
    }
    
    .staff-card {
        text-align: center;
        padding: 1.5rem;
    }
    
    .staff-avatar {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.2rem;
        margin: 0 auto 1rem;
    }
    
    .action-buttons {
        position: absolute;
        top: 2rem;
        right: 2rem;
    }
    
    .map-placeholder {
        background: #f8f9fa;
        border-radius: 8px;
        height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block page_title %}{{ hostel.name }}{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'users:dashboard' %}">{% trans "Home" %}</a></li>
<li class="breadcrumb-item"><a href="{% url 'hostels:dashboard' %}">Hostels</a></li>
<li class="breadcrumb-item"><a href="{% url 'hostels:hostel_list' %}">All Hostels</a></li>
<li class="breadcrumb-item active" aria-current="page">{{ hostel.name }}</li>
{% endblock %}

{% block page_actions %}
<div class="action-buttons">
    <div class="btn-group" role="group">
        <a href="{% url 'hostels:hostel_update' pk=hostel.pk %}" class="btn btn-light">
            <i class="bi bi-pencil me-1"></i>Edit
        </a>
        <button type="button" class="btn btn-light dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
            <span class="visually-hidden">Toggle Dropdown</span>
        </button>
        <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="{% url 'hostels:room_create' %}?hostel={{ hostel.pk }}"><i class="bi bi-plus-circle me-2"></i>Add Room</a></li>
            <li><a class="dropdown-item" href="#"><i class="bi bi-printer me-2"></i>Print Details</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item text-danger" href="{% url 'hostels:hostel_delete' pk=hostel.pk %}"><i class="bi bi-trash me-2"></i>Delete Hostel</a></li>
        </ul>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Hostel Header -->
    <div class="hostel-header">
        <div class="row align-items-center">
            <div class="col-auto">
                <div class="hostel-avatar-large">
                    {{ hostel.name|slice:":2"|upper }}
                </div>
            </div>
            <div class="col">
                <h1 class="h2 mb-2">{{ hostel.name }}</h1>
                <p class="mb-3 opacity-75">{{ hostel.code }} • {{ hostel.get_hostel_type_display }} • {{ hostel.get_category_display }}</p>
                <div class="d-flex flex-wrap gap-2">
                    <span class="badge bg-light text-dark">
                        <i class="bi bi-people me-1"></i>{{ hostel.current_occupancy }}/{{ hostel.capacity }} Residents
                    </span>
                    <span class="badge bg-light text-dark">
                        <i class="bi bi-door-closed me-1"></i>{{ hostel.total_rooms }} Rooms
                    </span>
                    <span class="badge bg-light text-dark">
                        <i class="bi bi-cash-coin me-1"></i>₹{{ hostel.monthly_rent }}/month
                    </span>
                    <span class="badge {% if hostel.is_active %}bg-success{% else %}bg-danger{% endif %}">
                        {{ hostel.is_active|yesno:"Active,Inactive" }}
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="stat-card">
                <div class="stat-number text-primary">{{ total_rooms }}</div>
                <div class="stat-label">Total Rooms</div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="stat-card">
                <div class="stat-number text-success">{{ available_rooms }}</div>
                <div class="stat-label">Available Rooms</div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="stat-card">
                <div class="stat-number text-info">{{ current_allocations }}</div>
                <div class="stat-label">Current Residents</div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="stat-card">
                <div class="stat-number text-warning">{{ pending_maintenance }}</div>
                <div class="stat-label">Pending Maintenance</div>
            </div>
        </div>
    </div>

    <!-- Main Content Tabs -->
    <ul class="nav nav-tabs" id="hostelTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
                <i class="bi bi-info-circle me-1"></i>Overview
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="rooms-tab" data-bs-toggle="tab" data-bs-target="#rooms" type="button" role="tab">
                <i class="bi bi-door-closed me-1"></i>Rooms
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="staff-tab" data-bs-toggle="tab" data-bs-target="#staff" type="button" role="tab">
                <i class="bi bi-person-badge me-1"></i>Staff
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="facilities-tab" data-bs-toggle="tab" data-bs-target="#facilities" type="button" role="tab">
                <i class="bi bi-building me-1"></i>Facilities
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="activity-tab" data-bs-toggle="tab" data-bs-target="#activity" type="button" role="tab">
                <i class="bi bi-clock-history me-1"></i>Recent Activity
            </button>
        </li>
    </ul>

    <div class="tab-content" id="hostelTabsContent">
        <!-- Overview Tab -->
        <div class="tab-pane fade show active" id="overview" role="tabpanel">
            <div class="row">
                <!-- Left Column -->
                <div class="col-lg-8">
                    <!-- Occupancy Progress -->
                    <div class="progress-container">
                        <div class="progress-label">
                            <span>Hostel Occupancy</span>
                            <span>{{ hostel.occupancy_percentage }}% ({{ hostel.current_occupancy }}/{{ hostel.capacity }})</span>
                        </div>
                        <div class="occupancy-progress">
                            <div class="progress-bar-custom bg-success" style="width: {{ hostel.occupancy_percentage }}%"></div>
                        </div>
                        <div class="mt-2 text-center">
                            <small class="text-muted">
                                {% if hostel.is_full %}
                                    <i class="bi bi-exclamation-triangle text-danger me-1"></i>Hostel is fully occupied
                                {% else %}
                                    {{ hostel.available_beds }} beds available
                                {% endif %}
                            </small>
                        </div>
                    </div>

                    <!-- Basic Information -->
                    <div class="card info-card">
                        <div class="card-header">
                            <i class="bi bi-info-circle me-2"></i>Basic Information
                        </div>
                        <div class="card-body">
                            <ul class="info-list">
                                <li>
                                    <span class="info-label">Hostel Code</span>
                                    <span class="info-value">{{ hostel.code }}</span>
                                </li>
                                <li>
                                    <span class="info-label">Type</span>
                                    <span class="info-value">{{ hostel.get_hostel_type_display }}</span>
                                </li>
                                <li>
                                    <span class="info-label">Category</span>
                                    <span class="info-value">{{ hostel.get_category_display }}</span>
                                </li>
                                <li>
                                    <span class="info-label">Total Floors</span>
                                    <span class="info-value">{{ hostel.total_floors }}</span>
                                </li>
                                <li>
                                    <span class="info-label">Total Rooms</span>
                                    <span class="info-value">{{ hostel.total_rooms }}</span>
                                </li>
                                <li>
                                    <span class="info-label">Capacity</span>
                                    <span class="info-value">{{ hostel.capacity }} students</span>
                                </li>
                                <li>
                                    <span class="info-label">Monthly Rent</span>
                                    <span class="info-value">₹{{ hostel.monthly_rent }}</span>
                                </li>
                                <li>
                                    <span class="info-label">Security Deposit</span>
                                    <span class="info-value">₹{{ hostel.security_deposit }}</span>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <!-- Description -->
                    {% if hostel.description %}
                    <div class="card info-card">
                        <div class="card-header">
                            <i class="bi bi-card-text me-2"></i>Description
                        </div>
                        <div class="card-body">
                            <p class="mb-0">{{ hostel.description|linebreaks }}</p>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Right Column -->
                <div class="col-lg-4">
                    <!-- Contact Information -->
                    <div class="card info-card">
                        <div class="card-header">
                            <i class="bi bi-telephone me-2"></i>Contact Information
                        </div>
                        <div class="card-body">
                            <ul class="info-list">
                                {% if hostel.phone %}
                                <li>
                                    <span class="info-label">Phone</span>
                                    <span class="info-value">{{ hostel.phone }}</span>
                                </li>
                                {% endif %}
                                {% if hostel.mobile %}
                                <li>
                                    <span class="info-label">Mobile</span>
                                    <span class="info-value">{{ hostel.mobile }}</span>
                                </li>
                                {% endif %}
                                {% if hostel.email %}
                                <li>
                                    <span class="info-label">Email</span>
                                    <span class="info-value">{{ hostel.email }}</span>
                                </li>
                                {% endif %}
                                {% if hostel.emergency_contact %}
                                <li>
                                    <span class="info-label">Emergency Contact</span>
                                    <span class="info-value">{{ hostel.emergency_contact }}</span>
                                </li>
                                {% endif %}
                                {% if hostel.emergency_phone %}
                                <li>
                                    <span class="info-label">Emergency Phone</span>
                                    <span class="info-value">{{ hostel.emergency_phone }}</span>
                                </li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>

                    <!-- Address -->
                    <div class="card info-card">
                        <div class="card-header">
                            <i class="bi bi-geo-alt me-2"></i>Address
                        </div>
                        <div class="card-body">
                            <p class="mb-2">
                                {% if hostel.address_line_1 %}{{ hostel.address_line_1 }}<br>{% endif %}
                                {% if hostel.address_line_2 %}{{ hostel.address_line_2 }}<br>{% endif %}
                                {% if hostel.city %}{{ hostel.city }}{% endif %}
                                {% if hostel.state %}, {{ hostel.state }}{% endif %}
                                {% if hostel.postal_code %}<br>{{ hostel.postal_code }}{% endif %}
                                {% if hostel.country %}<br>{{ hostel.country }}{% endif %}
                            </p>
                            <div class="map-placeholder">
                                <i class="bi bi-map me-2"></i>Map View
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Rooms Tab -->
        <div class="tab-pane fade" id="rooms" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5>Rooms in {{ hostel.name }}</h5>
                <a href="{% url 'hostels:room_create' %}?hostel={{ hostel.pk }}" class="btn btn-primary">
                    <i class="bi bi-plus-circle me-1"></i>Add Room
                </a>
            </div>
            
            <div class="room-grid">
                {% for room in hostel.rooms.all %}
                <div class="room-card">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="mb-0">Room {{ room.room_number }}</h6>
                        <span class="badge {% if room.is_available %}bg-success{% else %}bg-secondary{% endif %}">
                            <span class="room-status status-{% if room.is_available %}available{% else %}occupied{% endif %}"></span>
                            {{ room.is_available|yesno:"Available,Occupied" }}
                        </span>
                    </div>
                    
                    <div class="small text-muted mb-2">
                        Floor {{ room.floor }} • {{ room.get_room_type_display }}
                    </div>
                    
                    <div class="mb-2">
                        <div class="d-flex justify-content-between small mb-1">
                            <span>Occupancy</span>
                            <span>{{ room.current_occupancy }}/{{ room.capacity }}</span>
                        </div>
                        <div class="progress" style="height: 4px;">
                            <div class="progress-bar {% if room.is_full %}bg-danger{% else %}bg-success{% endif %}" 
                                 style="width: {% widthratio room.current_occupancy room.capacity 100 %}%">
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between small text-muted mb-2">
                        <span>Rent: ₹{{ room.effective_rent }}</span>
                        {% if room.maintenance_required %}
                        <span class="text-warning"><i class="bi bi-tools me-1"></i>Maintenance</span>
                        {% endif %}
                    </div>
                    
                    <div class="d-flex gap-1">
                        <a href="{% url 'hostels:room_detail' pk=room.pk %}" class="btn btn-sm btn-outline-primary flex-fill">View</a>
                        <a href="{% url 'hostels:room_update' pk=room.pk %}" class="btn btn-sm btn-outline-secondary">Edit</a>
                    </div>
                </div>
                {% empty %}
                <div class="col-12 text-center py-5">
                    <i class="bi bi-door-closed text-muted mb-3" style="font-size: 3rem;"></i>
                    <h5 class="text-muted">No Rooms Added</h5>
                    <p class="text-muted">Start by adding rooms to this hostel.</p>
                    <a href="{% url 'hostels:room_create' %}?hostel={{ hostel.pk }}" class="btn btn-primary">
                        <i class="bi bi-plus-circle me-2"></i>Add First Room
                    </a>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Staff Tab -->
        <div class="tab-pane fade" id="staff" role="tabpanel">
            <div class="row">
                {% if hostel.warden %}
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card info-card staff-card">
                        <div class="staff-avatar">
                            {{ hostel.warden.get_full_name|slice:":2"|upper|default:"WD" }}
                        </div>
                        <h6>Warden</h6>
                        <p class="text-muted mb-2">{{ hostel.warden.get_full_name|default:hostel.warden.username }}</p>
                        <p class="small text-muted mb-3">{{ hostel.warden.email }}</p>
                        <button class="btn btn-sm btn-outline-primary">Contact</button>
                    </div>
                </div>
                {% endif %}
                
                {% if hostel.assistant_warden %}
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card info-card staff-card">
                        <div class="staff-avatar">
                            {{ hostel.assistant_warden.get_full_name|slice:":2"|upper|default:"AW" }}
                        </div>
                        <h6>Assistant Warden</h6>
                        <p class="text-muted mb-2">{{ hostel.assistant_warden.get_full_name|default:hostel.assistant_warden.username }}</p>
                        <p class="small text-muted mb-3">{{ hostel.assistant_warden.email }}</p>
                        <button class="btn btn-sm btn-outline-primary">Contact</button>
                    </div>
                </div>
                {% endif %}
                
                {% if not hostel.warden and not hostel.assistant_warden %}
                <div class="col-12 text-center py-5">
                    <i class="bi bi-person-x text-muted mb-3" style="font-size: 3rem;"></i>
                    <h5 class="text-muted">No Staff Assigned</h5>
                    <p class="text-muted">Assign staff members to manage this hostel.</p>
                    <a href="{% url 'hostels:hostel_update' pk=hostel.pk %}" class="btn btn-primary">
                        <i class="bi bi-person-plus me-2"></i>Assign Staff
                    </a>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Facilities Tab -->
        <div class="tab-pane fade" id="facilities" role="tabpanel">
            {% if hostel.amenities %}
            <div class="card info-card mb-4">
                <div class="card-header">
                    <i class="bi bi-star me-2"></i>Amenities & Facilities
                </div>
                <div class="card-body">
                    <div class="amenities-list">
                        {% for amenity in hostel.amenities %}
                        <span class="amenity-tag">{{ amenity }}</span>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
            
            {% if hostel.rules %}
            <div class="card info-card">
                <div class="card-header">
                    <i class="bi bi-journal-text me-2"></i>Hostel Rules
                </div>
                <div class="card-body">
                    <div class="rules-content">
                        {{ hostel.rules|linebreaks }}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Activity Tab -->
        <div class="tab-pane fade" id="activity" role="tabpanel">
            {% if recent_visitors %}
            <div class="card info-card mb-4">
                <div class="card-header">
                    <i class="bi bi-person-badge me-2"></i>Recent Visitors
                </div>
                <div class="card-body">
                    {% for visitor in recent_visitors %}
                    <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                        <div>
                            <strong>{{ visitor.visitor_name }}</strong>
                            <div class="small text-muted">
                                Visiting {{ visitor.visiting_student.user.get_full_name|default:visitor.visiting_student.user.username }}
                                {% if visitor.is_parent_guardian %}
                                <span class="badge bg-info ms-2">Parent</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="text-end">
                            <div class="small text-muted">{{ visitor.check_in_time|date:"M d, g:i A" }}</div>
                            <div class="small">
                                {% if visitor.is_checked_out %}
                                <span class="text-success">Checked out</span>
                                {% else %}
                                <span class="text-warning">Currently visiting</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <div class="text-center">
                <a href="{% url 'hostels:visitor_list' %}?hostel={{ hostel.pk }}" class="btn btn-outline-primary">
                    View All Activity
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Tab persistence
        const hostelTabs = document.getElementById('hostelTabs');
        const storedTab = localStorage.getItem('hostelDetailActiveTab');
        
        if (storedTab) {
            const tab = new bootstrap.Tab(document.querySelector(`[data-bs-target="${storedTab}"]`));
            tab.show();
        }
        
        hostelTabs.addEventListener('show.bs.tab', function(event) {
            localStorage.setItem('hostelDetailActiveTab', event.target.getAttribute('data-bs-target'));
        });

        // Print functionality
        document.querySelector('[href="#"]').addEventListener('click', function(e) {
            e.preventDefault();
            window.print();
        });

        // Smooth scrolling for page actions
        document.querySelectorAll('.action-buttons a').forEach(link => {
            link.addEventListener('click', function(e) {
                if (this.getAttribute('href').startsWith('#')) {
                    e.preventDefault();
                    const target = document.querySelector(this.getAttribute('href'));
                    if (target) {
                        target.scrollIntoView({ behavior: 'smooth' });
                    }
                }
            });
        });

        // Room status updates
        document.querySelectorAll('.room-card').forEach(card => {
            card.addEventListener('click', function(e) {
                if (!e.target.closest('a')) {
                    const roomLink = this.querySelector('a[href*="room_detail"]');
                    if (roomLink) {
                        window.location.href = roomLink.href;
                    }
                }
            });
        });
    });
</script>
{% endblock %}