{% extends 'base.html' %}
{% load static %}

{% block title %}
    {% if form.instance.pk %}Edit{% else %}Create{% endif %} SMS Template - Communications
{% endblock %}

{% block extra_css %}
<style>
.sms-form-container {
    max-width: 800px;
    margin: 0 auto;
}

.form-section {
    background: white;
    border-radius: 12px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    border: 1px solid #e9ecef;
}

.section-header {
    border-bottom: 2px solid #f8f9fa;
    padding-bottom: 1rem;
    margin-bottom: 1.5rem;
}

.section-title {
    color: #2c3e50;
    font-weight: 600;
    font-size: 1.25rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin: 0;
}

.section-title i {
    color: #3498db;
}

.form-group-enhanced {
    margin-bottom: 1.5rem;
}

.form-label {
    font-weight: 500;
    color: #2c3e50;
    margin-bottom: 0.5rem;
}

.required-field::after {
    content: " *";
    color: #e74c3c;
}

.help-text {
    font-size: 0.875rem;
    color: #6c757d;
    margin-top: 0.25rem;
}

.character-counter {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.875rem;
    margin-top: 0.5rem;
}

.character-count {
    color: #6c757d;
}

.character-count.warning {
    color: #e67e22;
}

.character-count.error {
    color: #e74c3c;
}

.sms-preview {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
    margin-top: 1rem;
    border-left: 4px solid #17a2b8;
}

.preview-title {
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: #2c3e50;
}

.variables-help {
    background: #e7f3ff;
    border: 1px solid #b3d9ff;
    border-radius: 6px;
    padding: 1rem;
    margin-top: 1rem;
}

.variables-help h6 {
    color: #0066cc;
    margin-bottom: 0.5rem;
}

.variable-examples {
    font-family: monospace;
    font-size: 0.875rem;
    color: #495057;
}

.form-actions {
    background: white;
    border-radius: 12px;
    padding: 1.5rem 2rem;
    margin-top: 2rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    border: 1px solid #e9ecef;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
}

.action-buttons {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

@media (max-width: 768px) {
    .form-section {
        padding: 1.5rem;
    }

    .form-actions {
        flex-direction: column;
        align-items: stretch;
    }

    .action-buttons {
        order: 2;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid sms-form-container">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'users:dashboard' %}">Home</a></li>
            <li class="breadcrumb-item"><a href="{% url 'communication:smstemplate_list' %}">SMS Templates</a></li>
            <li class="breadcrumb-item active" aria-current="page">
                {% if form.instance.pk %}Edit{% else %}Create{% endif %} Template
            </li>
        </ol>
    </nav>

    <!-- Page Header -->
    <div class="page-header bg-light py-4 mb-4">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col">
                    <h1 class="page-title h2 mb-2">
                        {% if form.instance.pk %}
                            <i class="bi bi-pencil-square text-primary me-2"></i>
                            Edit SMS Template
                        {% else %}
                            <i class="bi bi-plus-circle text-primary me-2"></i>
                            Create New SMS Template
                        {% endif %}
                    </h1>
                    <p class="text-muted mb-0">
                        {% if form.instance.pk %}
                            Update the SMS template details below
                        {% else %}
                            Create a new SMS template for messaging
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
    </div>

    <form method="post" class="sms-form-container" id="smsTemplateForm">
        {% csrf_token %}

        <!-- Basic Information Section -->
        <div class="form-section">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="bi bi-info-circle"></i>
                    Template Information
                </h2>
            </div>

            <!-- Name Field -->
            <div class="form-group-enhanced">
                <label for="{{ form.name.id_for_label }}" class="form-label required-field">
                    {{ form.name.label }}
                </label>
                {{ form.name }}
                {% if form.name.help_text %}
                <div class="help-text">{{ form.name.help_text }}</div>
                {% endif %}
                {% if form.name.errors %}
                <div class="invalid-feedback d-block">
                    {{ form.name.errors }}
                </div>
                {% endif %}
            </div>

            <!-- Is Active Field -->
            <div class="form-group-enhanced">
                <div class="form-check">
                    {{ form.is_active }}
                    <label for="{{ form.is_active.id_for_label }}" class="form-check-label">
                        {{ form.is_active.label }}
                    </label>
                </div>
                {% if form.is_active.help_text %}
                <div class="help-text">{{ form.is_active.help_text }}</div>
                {% endif %}
                {% if form.is_active.errors %}
                <div class="invalid-feedback d-block">
                    {{ form.is_active.errors }}
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Content Section -->
        <div class="form-section">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="bi bi-chat-text"></i>
                    SMS Content
                </h2>
            </div>

            <!-- Content Field -->
            <div class="form-group-enhanced">
                <label for="{{ form.content.id_for_label }}" class="form-label required-field">
                    {{ form.content.label }}
                </label>
                {{ form.content }}
                {% if form.content.help_text %}
                <div class="help-text">{{ form.content.help_text }}</div>
                {% endif %}
                {% if form.content.errors %}
                <div class="invalid-feedback d-block">
                    {{ form.content.errors }}
                </div>
                {% endif %}

                <!-- Character Counter -->
                <div class="character-counter">
                    <div class="character-count" id="characterCount">
                        0/160 characters
                    </div>
                    <div class="text-muted small">
                        SMS messages are limited to 160 characters
                    </div>
                </div>
            </div>

            <!-- SMS Preview -->
            <div class="sms-preview">
                <div class="preview-title">SMS Preview</div>
                <div id="smsPreview" class="text-muted">
                    Your SMS content will appear here...
                </div>
            </div>
        </div>

        <!-- Variables Section -->
        <div class="form-section">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="bi bi-code-slash"></i>
                    Template Variables
                </h2>
            </div>

            <!-- Variables Field -->
            <div class="form-group-enhanced">
                <label for="{{ form.variables.id_for_label }}" class="form-label">
                    {{ form.variables.label }}
                </label>
                {{ form.variables }}
                {% if form.variables.help_text %}
                <div class="help-text">{{ form.variables.help_text }}</div>
                {% endif %}
                {% if form.variables.errors %}
                <div class="invalid-feedback d-block">
                    {{ form.variables.errors }}
                </div>
                {% endif %}
            </div>

            <!-- Variables Help -->
            <div class="variables-help">
                <h6><i class="bi bi-lightbulb me-2"></i>Using Variables</h6>
                <p class="mb-2">Use variables in your SMS content to personalize messages. Variables will be replaced with actual values when sending.</p>
                <div class="variable-examples">
                    Example: "Hello {{ name }}, your appointment is on {{ date }} at {{ time }}."<br>
                    Variables: <code>{"name": "John", "date": "2024-01-15", "time": "10:00 AM"}</code>
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
            <div class="action-buttons">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check-lg me-2"></i>
                    {% if form.instance.pk %}Update{% else %}Create{% endif %} SMS Template
                </button>

                <a href="{% url 'communication:smstemplate_list' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-x-lg me-2"></i>
                    Cancel
                </a>
            </div>

            {% if form.instance.pk %}
            <div class="form-text text-muted">
                Last updated: {{ form.instance.updated_at|date:"M d, Y H:i" }}
            </div>
            {% endif %}
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const contentTextarea = document.getElementById('{{ form.content.id_for_label }}');
    const characterCount = document.getElementById('characterCount');
    const smsPreview = document.getElementById('smsPreview');
    const variablesTextarea = document.getElementById('{{ form.variables.id_for_label }}');
    const smsTemplateForm = document.getElementById('smsTemplateForm');

    // Character count and preview update with debouncing
    let updateTimeout;
    function updateCharacterCount() {
        clearTimeout(updateTimeout);
        updateTimeout = setTimeout(() => {
            const content = contentTextarea.value;
            const length = content.length;

            characterCount.textContent = `${length}/160 characters`;

            // Update styling based on length
            characterCount.classList.remove('warning', 'error');
            if (length > 140) {
                characterCount.classList.add('warning');
            }
            if (length > 160) {
                characterCount.classList.add('error');
            }

            // Update preview with variable replacement simulation
            let previewContent = content || 'Your SMS content will appear here...';

            // Simple variable replacement preview
            if (variablesTextarea && variablesTextarea.value.trim()) {
                try {
                    const variables = JSON.parse(variablesTextarea.value);
                    for (const [key, value] of Object.entries(variables)) {
                        const placeholder = `{{${key}}}`;
                        previewContent = previewContent.replace(new RegExp(placeholder, 'g'), String(value));
                    }
                } catch (e) {
                    // Invalid JSON, show original content
                }
            }

            smsPreview.textContent = previewContent;
        }, 150);
    }

    // Real-time character count update
    function updateCharacterCountImmediate() {
        const content = contentTextarea.value;
        const length = content.length;

        characterCount.textContent = `${length}/160 characters`;

        // Update styling based on length
        characterCount.classList.remove('warning', 'error');
        if (length > 140) {
            characterCount.classList.add('warning');
        }
        if (length > 160) {
            characterCount.classList.add('error');
        }

        // Update preview
        smsPreview.textContent = content || 'Your SMS content will appear here...';
    }

    // Initial update
    updateCharacterCountImmediate();

    // Update on input with debouncing for preview
    contentTextarea.addEventListener('input', function() {
        updateCharacterCountImmediate();
        updateCharacterCount(); // Debounced preview update
    });

    // Variables field change should trigger preview update
    if (variablesTextarea) {
        variablesTextarea.addEventListener('input', updateCharacterCount);
    }

    // Enhanced form validation
    if (smsTemplateForm) {
        smsTemplateForm.addEventListener('submit', function(e) {
            let isValid = true;
            let errorMessages = [];

            // Check character limit
            const content = contentTextarea.value;
            if (content.length > 160) {
                isValid = false;
                errorMessages.push('SMS content cannot exceed 160 characters.');
                contentTextarea.classList.add('is-invalid');
            } else {
                contentTextarea.classList.remove('is-invalid');
            }

            // Check required fields
            const requiredFields = smsTemplateForm.querySelectorAll('.required-field');
            requiredFields.forEach(field => {
                const input = field.closest('.form-group-enhanced').querySelector('input, textarea');
                if (input && !input.value.trim()) {
                    isValid = false;
                    errorMessages.push('Please fill in all required fields.');
                    input.classList.add('is-invalid');
                } else {
                    input.classList.remove('is-invalid');
                }
            });

            // Validate JSON variables
            if (variablesTextarea && variablesTextarea.value.trim()) {
                try {
                    JSON.parse(variablesTextarea.value);
                    variablesTextarea.classList.remove('is-invalid');
                } catch (jsonError) {
                    isValid = false;
                    errorMessages.push('Variables must be valid JSON format.');
                    variablesTextarea.classList.add('is-invalid');
                }
            }

            if (!isValid) {
                e.preventDefault();
                // Show first error message
                if (errorMessages.length > 0) {
                    alert(errorMessages[0]);
                }
                return false;
            }

            // Show loading state
            const submitBtn = smsTemplateForm.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Saving...';
            }
        });
    }

    // Variables field validation with better UX
    if (variablesTextarea) {
        variablesTextarea.addEventListener('blur', function() {
            if (this.value.trim()) {
                try {
                    JSON.parse(this.value);
                    this.classList.remove('is-invalid');
                    // Show success indicator
                    this.style.borderColor = '#28a745';
                    setTimeout(() => {
                        this.style.borderColor = '';
                    }, 1000);
                } catch (e) {
                    this.classList.add('is-invalid');
                    this.style.borderColor = '#dc3545';
                    alert('Variables must be valid JSON format. Example: {"name": "John", "amount": "100"}');
                }
            } else {
                this.classList.remove('is-invalid');
                this.style.borderColor = '';
            }
        });

        // Auto-format JSON on blur
        variablesTextarea.addEventListener('blur', function() {
            if (this.value.trim()) {
                try {
                    const parsed = JSON.parse(this.value);
                    this.value = JSON.stringify(parsed, null, 2);
                } catch (e) {
                    // Invalid JSON, leave as is
                }
            }
        });
    }

    // Add keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Ctrl/Cmd + Enter to submit form
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
            e.preventDefault();
            const submitBtn = smsTemplateForm.querySelector('button[type="submit"]');
            if (submitBtn && !submitBtn.disabled) {
                submitBtn.click();
            }
        }
    });

    // Add template variable insertion helper
    const variableExamples = document.querySelector('.variable-examples');
    if (variableExamples && contentTextarea) {
        // Make variable examples clickable
        const codeElements = variableExamples.querySelectorAll('code');
        codeElements.forEach(code => {
            code.style.cursor = 'pointer';
            code.title = 'Click to insert into SMS content';
            code.addEventListener('click', function() {
                const text = this.textContent;
                if (text.includes('{{') && text.includes('}}')) {
                    // Insert variable placeholder
                    const start = contentTextarea.selectionStart;
                    const end = contentTextarea.selectionEnd;
                    const before = contentTextarea.value.substring(0, start);
                    const after = contentTextarea.value.substring(end);
                    contentTextarea.value = before + text + after;
                    contentTextarea.focus();
                    contentTextarea.setSelectionRange(start + text.length, start + text.length);
                    updateCharacterCountImmediate();
                    updateCharacterCount();
                }
            });
        });
    }

    // Auto-save draft functionality (optional enhancement)
    let autoSaveTimeout;
    function autoSave() {
        clearTimeout(autoSaveTimeout);
        autoSaveTimeout = setTimeout(() => {
            // In a real implementation, this would save to localStorage or server
            console.log('Auto-saving draft...');
        }, 30000); // Auto-save every 30 seconds
    }

    // Trigger auto-save on content changes
    contentTextarea.addEventListener('input', autoSave);
    if (variablesTextarea) {
        variablesTextarea.addEventListener('input', autoSave);
    }
});
</script>
{% endblock %}
