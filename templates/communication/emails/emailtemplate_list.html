{% extends 'base.html' %}
{% load static %}
{% load permission_filters %}

{% block title %}Email Templates - Communications{% endblock %}

{% block extra_css %}
<style>
.email-templates-container {
    max-width: 1400px;
    margin: 0 auto;
}

/* Filter Section */
.filter-section {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    border: 1px solid #e9ecef;
}

.filter-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.filter-toggle {
    background: none;
    border: none;
    color: #6c757d;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem;
}

.filter-toggle:hover {
    color: #495057;
}

.filter-form {
    display: none;
    animation: slideDown 0.3s ease-out;
}

.filter-form.show {
    display: block;
}

@keyframes slideDown {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

.filter-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
}

.filter-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    border-top: 1px solid #e9ecef;
    padding-top: 1rem;
}

/* Template Cards */
.template-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    border: 1px solid #e9ecef;
    transition: all 0.3s ease;
    position: relative;
}

.template-card:hover {
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}

.template-card.inactive {
    opacity: 0.7;
    background: #f8f9fa;
}

.template-card.inactive::before {
    content: 'INACTIVE';
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: #6c757d;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
}

.template-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
    gap: 1rem;
}

.template-title {
    flex: 1;
    margin-bottom: 0.5rem;
}

.template-title h3 {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
    color: #2c3e50;
}

.template-title a {
    color: inherit;
    text-decoration: none;
}

.template-title a:hover {
    color: #3498db;
}

.template-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    align-items: center;
    margin-bottom: 1rem;
}

.template-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.375rem 0.75rem;
    border-radius: 20px;
    font-size: 0.875rem;
    font-weight: 500;
}

.badge-type {
    background: #e8f4fd;
    color: #3498db;
    border: 1px solid #b3d9ff;
}

.badge-language {
    background: #f0fff4;
    color: #38a169;
    border: 1px solid #c6f6d5;
}

.badge-status {
    background: #d1ecf1;
    color: #0c5460;
    border: 1px solid #bee5eb;
}

.badge-status.inactive {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f1b0b7;
}

.template-content {
    color: #555;
    line-height: 1.6;
    margin-bottom: 1rem;
}

.template-subject {
    font-weight: 500;
    color: #2c3e50;
    margin-bottom: 0.5rem;
    padding: 0.75rem;
    background: #f8f9fa;
    border-radius: 6px;
    border-left: 3px solid #3498db;
}

.template-preview {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
    color: #6c757d;
    font-size: 0.875rem;
}

.template-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 1rem;
    border-top: 1px solid #e9ecef;
    flex-wrap: wrap;
    gap: 1rem;
}

.template-info {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    color: #6c757d;
    font-size: 0.875rem;
}

.template-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

/* Bulk Actions */
.bulk-actions {
    background: white;
    border-radius: 12px;
    padding: 1rem 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    border: 1px solid #e9ecef;
    display: none;
}

.bulk-actions.show {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
}

.bulk-selection-info {
    color: #6c757d;
    font-size: 0.875rem;
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 3rem 2rem;
    color: #6c757d;
}

.empty-state-icon {
    font-size: 4rem;
    color: #dee2e6;
    margin-bottom: 1rem;
}

.empty-state h3 {
    color: #6c757d;
    margin-bottom: 0.5rem;
}

/* Statistics Cards */
.stats-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    text-align: center;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    border: 1px solid #e9ecef;
}

.stat-number {
    font-size: 2rem;
    font-weight: 700;
    color: #2c3e50;
    line-height: 1;
    margin-bottom: 0.5rem;
}

.stat-label {
    color: #6c757d;
    font-size: 0.875rem;
}

/* View Toggle */
.view-toggle {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.view-option {
    padding: 0.5rem 1rem;
    border: 1px solid #dee2e6;
    background: white;
    color: #6c757d;
    cursor: pointer;
    border-radius: 6px;
    transition: all 0.2s;
}

.view-option.active {
    background: #3498db;
    color: white;
    border-color: #3498db;
}

.view-option:hover:not(.active) {
    background: #f8f9fa;
}

/* Grid View */
.templates-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 1.5rem;
}

.templates-grid .template-card {
    margin-bottom: 0;
    height: fit-content;
}

/* Quick Actions */
.quick-actions {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
}

/* Template Usage */
.usage-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.5rem;
    background: #e9ecef;
    color: #6c757d;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
}

/* Responsive Design */
@media (max-width: 768px) {
    .template-header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .template-actions {
        align-self: flex-end;
    }
    
    .template-footer {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .filter-grid {
        grid-template-columns: 1fr;
    }
    
    .templates-grid {
        grid-template-columns: 1fr;
    }
    
    .bulk-actions {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .stats-cards {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 576px) {
    .stats-cards {
        grid-template-columns: 1fr;
    }
}

/* Loading States */
.loading-skeleton {
    animation: pulse 1.5s ease-in-out infinite;
}

.skeleton-card {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    height: 200px;
}

/* Print Styles */
@media print {
    .filter-section,
    .bulk-actions,
    .template-actions,
    .view-toggle,
    .quick-actions {
        display: none !important;
    }
    
    .template-card {
        break-inside: avoid;
        box-shadow: none;
        border: 1px solid #ddd;
    }
}

/* Dark mode support */
[data-bs-theme="dark"] .template-card,
[data-bs-theme="dark"] .filter-section,
[data-bs-theme="dark"] .bulk-actions,
[data-bs-theme="dark"] .stat-card {
    background: #2d3748;
    border-color: #4a5568;
    color: #e2e8f0;
}

[data-bs-theme="dark"] .template-title h3,
[data-bs-theme="dark"] .template-subject {
    color: #e2e8f0;
}

[data-bs-theme="dark"] .template-preview,
[data-bs-theme="dark"] .template-info,
[data-bs-theme="dark"] .bulk-selection-info,
[data-bs-theme="dark"] .stat-label {
    color: #a0aec0;
}

[data-bs-theme="dark"] .template-card.inactive {
    background: #4a5568;
}

[data-bs-theme="dark"] .template-subject {
    background: #4a5568;
    border-left-color: #3498db;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid email-templates-container">
    <!-- Page Header -->
    <div class="page-header bg-light py-4 mb-4">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col">
                    <h1 class="page-title h2 mb-2">
                        <i class="bi bi-envelope text-primary me-2"></i>
                        Email Templates
                    </h1>
                    <p class="text-muted mb-0">
                        Manage and create email templates for your communications
                    </p>
                </div>
                <div class="col-auto">
                    {% if user.is_authenticated and user|has_perm:'apps.communication.add_emailtemplate' %}
                    <a href="{% url 'communication:emailtemplate_create' %}" class="btn btn-primary">
                        <i class="bi bi-plus-circle me-2"></i>
                        Create Template
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="stats-cards">
        <div class="stat-card">
            <div class="stat-number">{{ email_templates.count }}</div>
            <div class="stat-label">Total Templates</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ active_templates_count }}</div>
            <div class="stat-label">Active Templates</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ system_templates_count }}</div>
            <div class="stat-label">System Templates</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ multi_language_count }}</div>
            <div class="stat-label">Multi-language</div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
        <div class="view-toggle">
            <button class="view-option active" data-view="list">
                <i class="bi bi-list"></i>
                List View
            </button>
            <button class="view-option" data-view="grid">
                <i class="bi bi-grid-3x3-gap"></i>
                Grid View
            </button>
        </div>
        
        <div class="ms-auto d-flex gap-2">
            {% if user.is_authenticated and user|has_perm:'apps.communication.change_emailtemplate' %}
            <button class="btn btn-outline-primary btn-sm" id="bulkActionsToggle">
                <i class="bi bi-check2-square me-2"></i>
                Bulk Actions
            </button>
            {% endif %}
            
            <button class="btn btn-outline-secondary btn-sm" onclick="window.print()">
                <i class="bi bi-printer me-2"></i>
                Print
            </button>
            
            <button class="btn btn-outline-success btn-sm" id="exportTemplates">
                <i class="bi bi-download me-2"></i>
                Export
            </button>
        </div>
    </div>

    <!-- Bulk Actions -->
    {% if user.is_authenticated and user|has_perm:'apps.communication.change_emailtemplate' %}
    <div class="bulk-actions" id="bulkActions">
        <div class="bulk-selection-info">
            <i class="bi bi-info-circle me-2"></i>
            <span id="selectedCount">0 templates selected</span>
        </div>
        
        <div class="d-flex gap-2">
            <button class="btn btn-success btn-sm" id="bulkActivateBtn" disabled>
                <i class="bi bi-check-circle me-2"></i>
                Activate Selected
            </button>
            
            <button class="btn btn-warning btn-sm" id="bulkDeactivateBtn" disabled>
                <i class="bi bi-pause-circle me-2"></i>
                Deactivate Selected
            </button>
            
            <button class="btn btn-outline-danger btn-sm" id="bulkDeleteBtn" disabled data-bs-toggle="modal" data-bs-target="#bulkDeleteModal">
                <i class="bi bi-trash me-2"></i>
                Delete Selected
            </button>
            
            <button class="btn btn-outline-secondary btn-sm" id="clearSelectionBtn">
                <i class="bi bi-x-circle me-2"></i>
                Clear Selection
            </button>
        </div>
    </div>
    {% endif %}

    <!-- Filter Section -->
    <div class="filter-section">
        <div class="filter-header">
            <h5 class="mb-0">
                <i class="bi bi-funnel me-2"></i>
                Filters
            </h5>
            <button class="filter-toggle" id="filterToggle">
                <i class="bi bi-chevron-down"></i>
                <span>Show Filters</span>
            </button>
        </div>
        
        <form method="get" class="filter-form" id="filterForm">
            <div class="filter-grid">
                <!-- Type Filter -->
                <div class="mb-3">
                    <label for="template_type" class="form-label small fw-bold">Template Type</label>
                    <select name="type" id="template_type" class="form-select form-select-sm">
                        <option value="">All Types</option>
                        <option value="system" {% if request.GET.type == 'system' %}selected{% endif %}>System</option>
                        <option value="notification" {% if request.GET.type == 'notification' %}selected{% endif %}>Notification</option>
                        <option value="marketing" {% if request.GET.type == 'marketing' %}selected{% endif %}>Marketing</option>
                        <option value="alert" {% if request.GET.type == 'alert' %}selected{% endif %}>Alert</option>
                    </select>
                </div>

                <!-- Status Filter -->
                <div class="mb-3">
                    <label for="status" class="form-label small fw-bold">Status</label>
                    <select name="status" id="status" class="form-select form-select-sm">
                        <option value="">All Status</option>
                        <option value="active" {% if request.GET.status == 'active' %}selected{% endif %}>Active</option>
                        <option value="inactive" {% if request.GET.status == 'inactive' %}selected{% endif %}>Inactive</option>
                    </select>
                </div>

                <!-- Language Filter -->
                <div class="mb-3">
                    <label for="language" class="form-label small fw-bold">Language</label>
                    <select name="language" id="language" class="form-select form-select-sm">
                        <option value="">All Languages</option>
                        <option value="en" {% if request.GET.language == 'en' %}selected{% endif %}>English</option>
                        <option value="es" {% if request.GET.language == 'es' %}selected{% endif %}>Spanish</option>
                        <option value="fr" {% if request.GET.language == 'fr' %}selected{% endif %}>French</option>
                        <option value="ar" {% if request.GET.language == 'ar' %}selected{% endif %}>Arabic</option>
                    </select>
                </div>

                <!-- Search -->
                <div class="mb-3">
                    <label for="search" class="form-label small fw-bold">Search</label>
                    <input type="text" name="search" id="search" class="form-control form-control-sm" 
                           placeholder="Search templates..." value="{{ request.GET.search }}">
                </div>
            </div>

            <div class="filter-actions">
                <button type="submit" class="btn btn-primary btn-sm">
                    <i class="bi bi-filter me-2"></i>
                    Apply Filters
                </button>
                <a href="{% url 'communication:emailtemplate_list' %}" class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-arrow-clockwise me-2"></i>
                    Reset
                </a>
            </div>
        </form>
    </div>

    <!-- Templates List -->
    <div class="templates-list" id="templatesList">
        {% if email_templates %}
            <div class="templates-view" id="listView">
                {% for template in email_templates %}
                <div class="template-card {% if not template.is_active %}inactive{% endif %}" 
                     data-template-id="{{ template.id }}">
                    
                    <!-- Bulk Selection Checkbox -->
                    {% if user.is_authenticated and user|has_perm:'apps.communication.change_emailtemplate' %}
                    <div class="form-check bulk-select-checkbox" style="position: absolute; top: 1rem; right: 1rem;">
                        <input type="checkbox" class="form-check-input template-checkbox"
                               value="{{ template.id }}" id="template_{{ template.id }}">
                    </div>
                    {% endif %}

                    <div class="template-header">
                        <div class="template-title">
                            <h3>
                                <a href="{% url 'communication:emailtemplate_edit' template.pk %}">
                                    {{ template.name }}
                                </a>
                            </h3>
                        </div>
                        <div class="template-usage">
                            <span class="usage-badge">
                                <i class="bi bi-send"></i>
                                {{ template.sent_emails.count }} sent
                            </span>
                        </div>
                    </div>

                    <div class="template-meta">
                        <span class="template-badge badge-type">
                            <i class="bi bi-tag"></i>
                            {{ template.get_template_type_display }}
                        </span>
                        
                        <span class="template-badge badge-language">
                            <i class="bi bi-translate"></i>
                            {{ template.get_language_display }}
                        </span>
                        
                        <span class="template-badge badge-status {% if not template.is_active %}inactive{% endif %}">
                            <i class="bi bi-circle-fill"></i>
                            {% if template.is_active %}Active{% else %}Inactive{% endif %}
                        </span>
                    </div>

                    <div class="template-content">
                        <div class="template-subject">
                            {{ template.subject }}
                        </div>
                        <div class="template-preview">
                            {{ template.body_text|default:template.body_html|striptags|truncatewords:30 }}
                        </div>
                    </div>

                    <div class="template-footer">
                        <div class="template-info">
                            <div>
                                <div class="fw-medium">Created {{ template.created_at|date:"M d, Y" }}</div>
                                {% if template.updated_at != template.created_at %}
                                <div class="small">Updated {{ template.updated_at|date:"M d, Y" }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="template-actions">
                            <a href="{% url 'communication:emailtemplate_edit' template.pk %}" 
                               class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-pencil me-1"></i>
                                Edit
                            </a>
                            
                            <a href="{% url 'communication:send_test_email' template.pk %}" 
                               class="btn btn-outline-success btn-sm">
                                <i class="bi bi-envelope-check me-1"></i>
                                Test
                            </a>
                            
                            {% if user.is_authenticated and user|has_perm:'apps.communication.delete_emailtemplate' %}
                            <button class="btn btn-outline-danger btn-sm" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#deleteModal"
                                    data-template-id="{{ template.id }}"
                                    data-template-name="{{ template.name }}">
                                <i class="bi bi-trash me-1"></i>
                                Delete
                            </button>
                            {% endif %}
                            
                            <button class="btn btn-outline-info btn-sm dropdown-toggle" 
                                    type="button" 
                                    data-bs-toggle="dropdown"
                                    aria-expanded="false">
                                <i class="bi bi-three-dots"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li>
                                    <a class="dropdown-item" href="#" onclick="duplicateTemplate('{{ template.id }}')">
                                        <i class="bi bi-copy me-2"></i>
                                        Duplicate
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="#" onclick="exportTemplate('{{ template.id }}')">
                                        <i class="bi bi-download me-2"></i>
                                        Export
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a class="dropdown-item {% if template.is_active %}text-warning{% else %}text-success{% endif %}" 
                                       href="#" 
                                       onclick="toggleTemplateStatus('{{ template.id }}', {{ template.is_active|lower }})">
                                        <i class="bi bi-{% if template.is_active %}pause{% else %}play{% endif %}-circle me-2"></i>
                                        {% if template.is_active %}Deactivate{% else %}Activate{% endif %}
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Grid View (Hidden by Default) -->
            <div class="templates-grid" id="gridView" style="display: none;">
                {% for template in email_templates %}
                <div class="template-card {% if not template.is_active %}inactive{% endif %}" 
                     data-template-id="{{ template.id }}">
                    
                    {% if user.is_authenticated and user|has_perm:'apps.communication.change_emailtemplate' %}
                    <div class="form-check bulk-select-checkbox" style="position: absolute; top: 1rem; right: 1rem;">
                        <input type="checkbox" class="form-check-input template-checkbox"
                               value="{{ template.id }}" id="template_grid_{{ template.id }}">
                    </div>
                    {% endif %}

                    <div class="template-header">
                        <div class="template-title">
                            <h4>
                                <a href="{% url 'communication:emailtemplate_edit' template.pk %}">
                                    {{ template.name|truncatewords:4 }}
                                </a>
                            </h4>
                        </div>
                    </div>

                    <div class="template-meta">
                        <span class="template-badge badge-type">
                            {{ template.get_template_type_display }}
                        </span>
                        <span class="template-badge badge-language">
                            {{ template.language|upper }}
                        </span>
                    </div>

                    <div class="template-content">
                        <div class="template-subject" style="font-size: 0.875rem;">
                            {{ template.subject|truncatewords:8 }}
                        </div>
                        <div class="template-preview">
                            {{ template.body_text|default:template.body_html|striptags|truncatewords:20 }}
                        </div>
                    </div>

                    <div class="template-footer">
                        <div class="small text-muted">
                            {% if template.is_active %}
                            <span class="text-success">● Active</span>
                            {% else %}
                            <span class="text-danger">● Inactive</span>
                            {% endif %}
                            <br>
                            {{ template.sent_emails.count }} sent
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Pagination -->
            {% if is_paginated %}
            <div class="pagination-container mt-4">
                <nav aria-label="Email templates pagination">
                    <ul class="pagination justify-content-center">
                        {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                <i class="bi bi-chevron-double-left"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                <i class="bi bi-chevron-left"></i>
                            </a>
                        </li>
                        {% endif %}

                        {% for num in page_obj.paginator.page_range %}
                            {% if page_obj.number == num %}
                            <li class="page-item active">
                                <span class="page-link">{{ num }}</span>
                            </li>
                            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ num }}</a>
                            </li>
                            {% endif %}
                        {% endfor %}

                        {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                <i class="bi bi-chevron-right"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                <i class="bi bi-chevron-double-right"></i>
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
            {% endif %}

        {% else %}
            <!-- Empty State -->
            <div class="empty-state">
                <div class="empty-state-icon">
                    <i class="bi bi-envelope"></i>
                </div>
                <h3>No Email Templates Found</h3>
                <p class="mb-4">There are no email templates matching your current filters.</p>
                {% if user.is_authenticated and user|has_perm:'apps.communication.add_emailtemplate' %}
                <a href="{% url 'communication:emailtemplate_create' %}" class="btn btn-primary">
                    <i class="bi bi-plus-circle me-2"></i>
                    Create Your First Template
                </a>
                {% endif %}
                <div class="mt-3">
                    <a href="{% url 'communication:emailtemplate_list' %}" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-arrow-clockwise me-2"></i>
                        Clear Filters
                    </a>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<!-- Delete Confirmation Modal -->
{% if user.is_authenticated and user|has_perm:'apps.communication.delete_emailtemplate' %}
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Delete Email Template</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the template "<strong id="deleteTemplateName"></strong>"?</p>
                <p class="text-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    This action cannot be undone. Any emails sent using this template will remain, but the template will be permanently deleted.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="post" action="" id="deleteTemplateForm">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Delete Template</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Delete Modal -->
<div class="modal fade" id="bulkDeleteModal" tabindex="-1" aria-labelledby="bulkDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bulkDeleteModalLabel">Delete Multiple Templates</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete <strong id="bulkDeleteCount">0</strong> selected templates?</p>
                <p class="text-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    This action cannot be undone. Any emails sent using these templates will remain, but the templates will be permanently deleted.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="post" action="{% url 'communication:bulk_delete_templates' %}" id="bulkDeleteForm">
                    {% csrf_token %}
                    <input type="hidden" name="template_ids" id="bulkDeleteIds">
                    <button type="submit" class="btn btn-danger">Delete Selected</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Filter Toggle
    const filterToggle = document.getElementById('filterToggle');
    const filterForm = document.getElementById('filterForm');
    
    if (filterToggle && filterForm) {
        filterToggle.addEventListener('click', function() {
            filterForm.classList.toggle('show');
            const icon = this.querySelector('i');
            const text = this.querySelector('span');
            
            if (filterForm.classList.contains('show')) {
                icon.className = 'bi bi-chevron-up';
                text.textContent = 'Hide Filters';
            } else {
                icon.className = 'bi bi-chevron-down';
                text.textContent = 'Show Filters';
            }
        });
    }

    // View Toggle
    const viewOptions = document.querySelectorAll('.view-option');
    const listView = document.getElementById('listView');
    const gridView = document.getElementById('gridView');
    
    viewOptions.forEach(option => {
        option.addEventListener('click', function() {
            // Update active state
            viewOptions.forEach(opt => opt.classList.remove('active'));
            this.classList.add('active');
            
            // Show/hide views
            const viewType = this.dataset.view;
            if (viewType === 'list') {
                listView.style.display = 'block';
                gridView.style.display = 'none';
            } else {
                listView.style.display = 'none';
                gridView.style.display = 'grid';
            }
            
            // Save preference to localStorage
            localStorage.setItem('emailTemplateViewPreference', viewType);
        });
    });
    
    // Load saved view preference
    const savedView = localStorage.getItem('emailTemplateViewPreference') || 'list';
    const savedViewOption = document.querySelector(`[data-view="${savedView}"]`);
    if (savedViewOption) {
        savedViewOption.click();
    }

    // Bulk Actions
    const bulkActionsToggle = document.getElementById('bulkActionsToggle');
    const bulkActions = document.getElementById('bulkActions');
    const templateCheckboxes = document.querySelectorAll('.template-checkbox');
    const selectedCount = document.getElementById('selectedCount');
    const bulkActivateBtn = document.getElementById('bulkActivateBtn');
    const bulkDeactivateBtn = document.getElementById('bulkDeactivateBtn');
    const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
    const clearSelectionBtn = document.getElementById('clearSelectionBtn');
    const bulkDeleteIds = document.getElementById('bulkDeleteIds');
    const bulkDeleteCount = document.getElementById('bulkDeleteCount');
    
    if (bulkActionsToggle) {
        bulkActionsToggle.addEventListener('click', function() {
            bulkActions.classList.toggle('show');
        });
    }
    
    // Checkbox selection handling
    templateCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateBulkActions);
    });
    
    function updateBulkActions() {
        const selectedCheckboxes = document.querySelectorAll('.template-checkbox:checked');
        const count = selectedCheckboxes.length;
        
        selectedCount.textContent = `${count} template${count !== 1 ? 's' : ''} selected`;
        
        // Enable/disable bulk action buttons
        bulkActivateBtn.disabled = count === 0;
        bulkDeactivateBtn.disabled = count === 0;
        bulkDeleteBtn.disabled = count === 0;
        
        // Update form hidden fields
        const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.value).join(',');
        bulkDeleteIds.value = selectedIds;
        bulkDeleteCount.textContent = count;
    }
    
    if (clearSelectionBtn) {
        clearSelectionBtn.addEventListener('click', function() {
            templateCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            updateBulkActions();
        });
    }
    
    // Bulk activate/deactivate
    if (bulkActivateBtn) {
        bulkActivateBtn.addEventListener('click', function() {
            const selectedIds = Array.from(document.querySelectorAll('.template-checkbox:checked')).map(cb => cb.value);
            bulkUpdateTemplateStatus(selectedIds, true);
        });
    }
    
    if (bulkDeactivateBtn) {
        bulkDeactivateBtn.addEventListener('click', function() {
            const selectedIds = Array.from(document.querySelectorAll('.template-checkbox:checked')).map(cb => cb.value);
            bulkUpdateTemplateStatus(selectedIds, false);
        });
    }
    
    // Delete Modal Handling
    const deleteModal = document.getElementById('deleteModal');
    if (deleteModal) {
        deleteModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            const templateId = button.getAttribute('data-template-id');
            const templateName = button.getAttribute('data-template-name');
            
            document.getElementById('deleteTemplateName').textContent = templateName;
            document.getElementById('deleteTemplateForm').action = 
                `{% url 'communication:emailtemplate_delete' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', templateId);
        });
    }
    
    // Export functionality
    const exportBtn = document.getElementById('exportTemplates');
    if (exportBtn) {
        exportBtn.addEventListener('click', function() {
            // This would typically export all visible templates
            showToast('Export functionality would be implemented here', 'info');
        });
    }
    
    // Search functionality
    const searchInput = document.getElementById('search');
    if (searchInput) {
        let searchTimeout;
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                // Trigger search - this would typically submit the form or make AJAX call
                if (this.value.length >= 3 || this.value.length === 0) {
                    document.getElementById('filterForm').submit();
                }
            }, 500);
        });
    }
    
    // Initialize
    updateBulkActions();
});

function toggleTemplateStatus(templateId, isActive) {
    const url = `{% url 'communication:emailtemplate_toggle_status' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', templateId);
    
    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            is_active: !isActive
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(`Template ${!isActive ? 'activated' : 'deactivated'} successfully`, 'success');
            // Reload the page to reflect changes
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('Failed to update template status', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Failed to update template status', 'error');
    });
}

function bulkUpdateTemplateStatus(templateIds, activate) {
    const url = '{% url "communication:bulk_update_template_status" %}';
    
    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            template_ids: templateIds,
            is_active: activate
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(`${templateIds.length} templates ${activate ? 'activated' : 'deactivated'} successfully`, 'success');
            // Reload the page to reflect changes
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('Failed to update templates status', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Failed to update templates status', 'error');
    });
}

function duplicateTemplate(templateId) {
    const url = `{% url 'communication:emailtemplate_duplicate' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', templateId);
    
    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Template duplicated successfully', 'success');
            // Redirect to edit the new template or reload the list
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('Failed to duplicate template', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Failed to duplicate template', 'error');
    });
}

function exportTemplate(templateId) {
    const url = `{% url 'communication:emailtemplate_export' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', templateId);
    
    // Create a temporary link to trigger download
    const link = document.createElement('a');
    link.href = url;
    link.download = 'email_template.json';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showToast('Template exported successfully', 'success');
}

function showToast(message, type = 'info') {
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-bg-${type} border-0`;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');
    
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    `;
    
    // Add to container
    const container = document.getElementById('toastContainer') || createToastContainer();
    container.appendChild(toast);
    
    // Initialize and show
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    // Remove after hide
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}

function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toastContainer';
    container.className = 'toast-container position-fixed top-0 end-0 p-3';
    container.style.zIndex = '9999';
    document.body.appendChild(container);
    return container;
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl/Cmd + F to focus search
    if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
        e.preventDefault();
        const searchInput = document.getElementById('search');
        if (searchInput) {
            searchInput.focus();
        }
    }
    
    // Escape to clear selection
    if (e.key === 'Escape') {
        const clearSelectionBtn = document.getElementById('clearSelectionBtn');
        if (clearSelectionBtn) {
            clearSelectionBtn.click();
        }
    }
    
    // Ctrl/Cmd + A to select all (when in list view)
    if ((e.ctrlKey || e.metaKey) && e.key === 'a') {
        e.preventDefault();
        const checkboxes = document.querySelectorAll('.template-checkbox');
        const allChecked = Array.from(checkboxes).every(cb => cb.checked);
        
        checkboxes.forEach(checkbox => {
            checkbox.checked = !allChecked;
        });
        updateBulkActions();
    }
});
</script>
{% endblock %}
