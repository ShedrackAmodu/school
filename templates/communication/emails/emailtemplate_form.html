{% extends 'base.html' %}
{% load static %}

{% block title %}
    {% if form.instance.pk %}Edit{% else %}Create{% endif %} Email Template - Communications
{% endblock %}

{% block extra_css %}
<style>
.email-template-form-container {
    max-width: 1200px;
    margin: 0 auto;
}

.form-section {
    background: white;
    border-radius: 12px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    border: 1px solid #e9ecef;
}

.section-header {
    border-bottom: 2px solid #f8f9fa;
    padding-bottom: 1rem;
    margin-bottom: 1.5rem;
}

.section-title {
    color: #2c3e50;
    font-weight: 600;
    font-size: 1.25rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.section-title i {
    color: #3498db;
}

.form-group-enhanced {
    margin-bottom: 1.5rem;
}

.form-label {
    font-weight: 500;
    color: #2c3e50;
    margin-bottom: 0.5rem;
}

.required-field::after {
    content: " *";
    color: #e74c3c;
}

.help-text {
    font-size: 0.875rem;
    color: #6c757d;
    margin-top: 0.25rem;
}

.character-count {
    font-size: 0.875rem;
    color: #6c757d;
    text-align: right;
    margin-top: 0.25rem;
}

.character-count.warning {
    color: #e67e22;
}

.character-count.error {
    color: #e74c3c;
}

/* Template Preview */
.template-preview {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1.5rem;
    margin-top: 1rem;
    border-left: 4px solid #3498db;
    display: none;
}

.template-preview.show {
    display: block;
}

.preview-header {
    border-bottom: 1px solid #dee2e6;
    padding-bottom: 1rem;
    margin-bottom: 1rem;
}

.preview-subject {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 0.5rem;
}

.preview-meta {
    color: #6c757d;
    font-size: 0.875rem;
}

.preview-content {
    line-height: 1.6;
}

.preview-content.html {
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 1rem;
    background: white;
    min-height: 200px;
}

.preview-content.text {
    white-space: pre-wrap;
    font-family: monospace;
    font-size: 0.875rem;
}

/* Tab Navigation */
.template-tabs {
    border-bottom: 1px solid #dee2e6;
    margin-bottom: 1.5rem;
}

.nav-tabs {
    border-bottom: none;
}

.nav-tabs .nav-link {
    border: none;
    color: #6c757d;
    font-weight: 500;
    padding: 0.75rem 1.5rem;
    border-bottom: 3px solid transparent;
}

.nav-tabs .nav-link.active {
    color: #3498db;
    background: none;
    border-bottom: 3px solid #3498db;
}

.nav-tabs .nav-link:hover {
    color: #3498db;
    border-bottom: 3px solid #3498db;
}

.tab-pane {
    display: none;
}

.tab-pane.active {
    display: block;
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

/* Code Editor Styles */
.code-editor {
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.875rem;
    line-height: 1.5;
}

.variable-highlight {
    background: #fff3cd;
    color: #856404;
    padding: 0.125rem 0.25rem;
    border-radius: 3px;
    font-family: monospace;
    font-size: 0.8rem;
}

/* Variables Panel */
.variables-panel {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1.5rem;
    margin-top: 1rem;
}

.variable-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem;
    border-bottom: 1px solid #e9ecef;
}

.variable-item:last-child {
    border-bottom: none;
}

.variable-name {
    font-family: monospace;
    font-weight: 500;
    color: #2c3e50;
}

.variable-description {
    color: #6c757d;
    font-size: 0.875rem;
}

.variable-preview {
    background: #e9ecef;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.8rem;
}

/* Template Type Indicators */
.template-type-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.875rem;
    font-weight: 500;
    margin-left: 1rem;
}

.template-type-system { background: #e8f4fd; color: #3498db; border: 1px solid #b3d9ff; }
.template-type-notification { background: #f0fff4; color: #38a169; border: 1px solid #c6f6d5; }
.template-type-marketing { background: #fffaf0; color: #dd6b20; border: 1px solid #feebc8; }
.template-type-alert { background: #fed7d7; color: #e53e3e; border: 1px solid #feb2b2; }

/* Test Email Section */
.test-email-section {
    background: #e8f5e8;
    border-radius: 8px;
    padding: 1.5rem;
    margin-top: 1rem;
    border-left: 4px solid #38a169;
}

.test-form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr auto;
    gap: 1rem;
    align-items: end;
}

@media (max-width: 768px) {
    .test-form-grid {
        grid-template-columns: 1fr;
    }
}

/* Language Selector */
.language-selector {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.language-option {
    padding: 0.5rem 1rem;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    background: white;
    cursor: pointer;
    transition: all 0.2s;
}

.language-option.active {
    background: #3498db;
    color: white;
    border-color: #3498db;
}

.language-option:hover:not(.active) {
    background: #f8f9fa;
}

/* Action Buttons */
.form-actions {
    background: white;
    border-radius: 12px;
    padding: 1.5rem 2rem;
    margin-top: 2rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    border: 1px solid #e9ecef;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
}

.action-buttons {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.preview-toggle {
    background: none;
    border: 1px solid #3498db;
    color: #3498db;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
}

.preview-toggle:hover {
    background: #3498db;
    color: white;
}

/* Responsive Design */
@media (max-width: 768px) {
    .form-section {
        padding: 1.5rem;
    }
    
    .form-actions {
        flex-direction: column;
        align-items: stretch;
    }
    
    .action-buttons {
        order: 2;
    }
    
    .preview-toggle {
        order: 1;
        align-self: flex-start;
    }
    
    .nav-tabs .nav-link {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
    }
}

/* Template Examples */
.template-examples {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
    margin-top: 1rem;
}

.example-item {
    padding: 0.5rem;
    border-bottom: 1px solid #e9ecef;
    cursor: pointer;
    transition: background-color 0.2s;
}

.example-item:hover {
    background: #e9ecef;
}

.example-item:last-child {
    border-bottom: none;
}

.example-name {
    font-weight: 500;
    color: #2c3e50;
}

.example-description {
    color: #6c757d;
    font-size: 0.875rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'users:dashboard' %}">Home</a></li>
            <li class="breadcrumb-item"><a href="{% url 'communication:emailtemplate_list' %}">Email Templates</a></li>
            <li class="breadcrumb-item active" aria-current="page">
                {% if form.instance.pk %}Edit{% else %}Create{% endif %} Email Template
            </li>
        </ol>
    </nav>

    <!-- Page Header -->
    <div class="page-header bg-light py-4 mb-4">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col">
                    <h1 class="page-title h2 mb-2">
                        {% if form.instance.pk %}
                            <i class="bi bi-pencil-square text-primary me-2"></i>
                            Edit Email Template
                        {% else %}
                            <i class="bi bi-plus-circle text-primary me-2"></i>
                            Create New Email Template
                        {% endif %}
                    </h1>
                    <p class="text-muted mb-0">
                        {% if form.instance.pk %}
                            Update the email template details below
                        {% else %}
                            Create a new email template for your communications
                        {% endif %}
                    </p>
                </div>
                <div class="col-auto">
                    <button type="button" class="btn btn-outline-primary preview-toggle" id="previewToggle">
                        <i class="bi bi-eye me-2"></i>
                        Preview Template
                    </button>
                </div>
            </div>
        </div>
    </div>

    <form method="post" class="email-template-form-container" id="emailTemplateForm">
        {% csrf_token %}
        
        <!-- Basic Information Section -->
        <div class="form-section">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="bi bi-info-circle"></i>
                    Basic Information
                </h2>
            </div>
            
            <div class="row">
                <!-- Template Name -->
                <div class="col-md-6">
                    <div class="form-group-enhanced">
                        <label for="{{ form.name.id_for_label }}" class="form-label required-field">
                            {{ form.name.label }}
                        </label>
                        {{ form.name }}
                        {% if form.name.help_text %}
                        <div class="help-text">{{ form.name.help_text }}</div>
                        {% endif %}
                        {% if form.name.errors %}
                        <div class="invalid-feedback d-block">
                            {{ form.name.errors }}
                        </div>
                        {% endif %}
                        <div class="character-count" id="nameCharacterCount">
                            {{ form.instance.name|length|default:0 }}/100 characters
                        </div>
                    </div>
                </div>

                <!-- Template Type -->
                <div class="col-md-6">
                    <div class="form-group-enhanced">
                        <label for="{{ form.template_type.id_for_label }}" class="form-label required-field">
                            {{ form.template_type.label }}
                        </label>
                        {{ form.template_type }}
                        {% if form.template_type.errors %}
                        <div class="invalid-feedback d-block">
                            {{ form.template_type.errors }}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Language -->
            <div class="form-group-enhanced">
                <label class="form-label required-field">Language</label>
                <div class="language-selector">
                    {% for value, label in form.language.field.choices %}
                    <label class="language-option {% if form.language.value == value %}active{% endif %}">
                        <input type="radio" name="{{ form.language.name }}" value="{{ value }}" 
                               {% if form.language.value == value %}checked{% endif %} style="display: none;">
                        {{ label }}
                    </label>
                    {% endfor %}
                </div>
                {% if form.language.errors %}
                <div class="invalid-feedback d-block">
                    {{ form.language.errors }}
                </div>
                {% endif %}
            </div>

            <!-- Active Status -->
            <div class="form-group-enhanced">
                <div class="form-check form-switch">
                    {{ form.is_active }}
                    <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                        {{ form.is_active.label }}
                    </label>
                </div>
                {% if form.is_active.help_text %}
                <div class="help-text">{{ form.is_active.help_text }}</div>
                {% endif %}
                {% if form.is_active.errors %}
                <div class="invalid-feedback d-block">
                    {{ form.is_active.errors }}
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Content Section -->
        <div class="form-section">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="bi bi-file-text"></i>
                    Template Content
                </h2>
            </div>

            <!-- Subject -->
            <div class="form-group-enhanced">
                <label for="{{ form.subject.id_for_label }}" class="form-label required-field">
                    {{ form.subject.label }}
                </label>
                {{ form.subject }}
                {% if form.subject.help_text %}
                <div class="help-text">{{ form.subject.help_text }}</div>
                {% endif %}
                {% if form.subject.errors %}
                <div class="invalid-feedback d-block">
                    {{ form.subject.errors }}
                </div>
                {% endif %}
                <div class="character-count" id="subjectCharacterCount">
                    {{ form.instance.subject|length|default:0 }}/200 characters
                </div>
            </div>

            <!-- Content Tabs -->
            <div class="template-tabs">
                <ul class="nav nav-tabs" id="contentTabs">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#htmlTab">
                            <i class="bi bi-code-slash me-2"></i>
                            HTML Content
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#textTab">
                            <i class="bi bi-text-paragraph me-2"></i>
                            Plain Text
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#variablesTab">
                            <i class="bi bi-tags me-2"></i>
                            Variables
                        </a>
                    </li>
                </ul>
            </div>

            <div class="tab-content">
                <!-- HTML Content Tab -->
                <div class="tab-pane active" id="htmlTab">
                    <div class="form-group-enhanced">
                        <label for="{{ form.body_html.id_for_label }}" class="form-label required-field">
                            HTML Body Content
                        </label>
                        {{ form.body_html }}
                        {% if form.body_html.help_text %}
                        <div class="help-text">{{ form.body_html.help_text }}</div>
                        {% endif %}
                        {% if form.body_html.errors %}
                        <div class="invalid-feedback d-block">
                            {{ form.body_html.errors }}
                        </div>
                        {% endif %}
                        <div class="character-count" id="htmlCharacterCount">
                            {{ form.instance.body_html|length|default:0 }} characters
                        </div>
                    </div>
                </div>

                <!-- Plain Text Tab -->
                <div class="tab-pane" id="textTab">
                    <div class="form-group-enhanced">
                        <label for="{{ form.body_text.id_for_label }}" class="form-label">
                            Plain Text Content
                        </label>
                        {{ form.body_text }}
                        {% if form.body_text.help_text %}
                        <div class="help-text">{{ form.body_text.help_text }}</div>
                        {% endif %}
                        {% if form.body_text.errors %}
                        <div class="invalid-feedback d-block">
                            {{ form.body_text.errors }}
                        </div>
                        {% endif %}
                        <div class="character-count" id="textCharacterCount">
                            {{ form.instance.body_text|length|default:0 }} characters
                        </div>
                    </div>
                </div>

                <!-- Variables Tab -->
                <div class="tab-pane" id="variablesTab">
                    <div class="form-group-enhanced">
                        <label for="{{ form.variables.id_for_label }}" class="form-label">
                            Template Variables
                        </label>
                        {{ form.variables }}
                        {% if form.variables.help_text %}
                        <div class="help-text">{{ form.variables.help_text }}</div>
                        {% endif %}
                        {% if form.variables.errors %}
                        <div class="invalid-feedback d-block">
                            {{ form.variables.errors }}
                        </div>
                        {% endif %}
                    </div>

                    <!-- Available Variables -->
                    <div class="variables-panel">
                        <h6 class="mb-3">Available Variables</h6>
                        <div class="variable-item">
                            <div>
                                <span class="variable-name">{{ user_name }}</span>
                                <div class="variable-description">Full name of the recipient</div>
                            </div>
                            <span class="variable-preview">John Doe</span>
                        </div>
                        <div class="variable-item">
                            <div>
                                <span class="variable-name">{{ user_email }}</span>
                                <div class="variable-description">Email address of the recipient</div>
                            </div>
                            <span class="variable-preview">john@example.com</span>
                        </div>
                        <div class="variable-item">
                            <div>
                                <span class="variable-name">{{ school_name }}</span>
                                <div class="variable-description">Name of your school</div>
                            </div>
                            <span class="variable-preview">Nexus Intelligence School</span>
                        </div>
                        <div class="variable-item">
                            <div>
                                <span class="variable-name">{{ current_date }}</span>
                                <div class="variable-description">Current date</div>
                            </div>
                            <span class="variable-preview">{% now "F d, Y" %}</span>
                        </div>
                        <div class="variable-item">
                            <div>
                                <span class="variable-name">{{ announcement_title }}</span>
                                <div class="variable-description">Title of related announcement</div>
                            </div>
                            <span class="variable-preview">School Holiday Schedule</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Template Preview -->
        <div class="template-preview" id="templatePreview">
            <div class="preview-header">
                <div class="preview-subject" id="previewSubject">Email Subject Will Appear Here</div>
                <div class="preview-meta">
                    Type: <span id="previewType">System</span> â€¢ 
                    Language: <span id="previewLanguage">English</span>
                </div>
            </div>
            <div class="preview-content html" id="previewHtml">
                HTML content preview will appear here...
            </div>
            <div class="preview-content text" id="previewText" style="display: none;">
                Plain text content preview will appear here...
            </div>
        </div>

        <!-- Test Email Section -->
        {% if form.instance.pk %}
        <div class="test-email-section">
            <h5 class="mb-3">
                <i class="bi bi-envelope-check me-2"></i>
                Test Email
            </h5>
            <div class="test-form-grid">
                <div>
                    <label for="testRecipient" class="form-label">Test Recipient Email</label>
                    <input type="email" class="form-control" id="testRecipient" 
                           placeholder="Enter email address to send test">
                </div>
                <div>
                    <label for="testData" class="form-label">Test Data (JSON)</label>
                    <input type="text" class="form-control" id="testData" 
                           placeholder='{"user_name": "Test User"}'>
                </div>
                <div>
                    <button type="button" class="btn btn-success" id="sendTestEmail">
                        <i class="bi bi-send me-2"></i>
                        Send Test
                    </button>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Template Examples -->
        <div class="template-examples">
            <h6 class="mb-3">Quick Templates</h6>
            <div class="example-item" data-template="welcome">
                <div class="example-name">Welcome Email</div>
                <div class="example-description">Template for new user welcome emails</div>
            </div>
            <div class="example-item" data-template="notification">
                <div class="example-name">Notification Email</div>
                <div class="example-description">Standard notification template</div>
            </div>
            <div class="example-item" data-template="announcement">
                <div class="example-name">Announcement Email</div>
                <div class="example-description">Template for announcement notifications</div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
            <div class="action-buttons">
                <button type="submit" name="save" value="save" class="btn btn-primary">
                    <i class="bi bi-check-lg me-2"></i>
                    {% if form.instance.pk %}Update{% else %}Create{% endif %} Template
                </button>
                
                <button type="submit" name="save_and_add" value="true" class="btn btn-outline-primary">
                    <i class="bi bi-plus-circle me-2"></i>
                    Save & Add Another
                </button>
                
                <a href="{% url 'communication:emailtemplate_list' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-x-lg me-2"></i>
                    Cancel
                </a>
                
                {% if form.instance.pk %}
                <a href="{% url 'communication:send_test_email' form.instance.pk %}" 
                   class="btn btn-outline-success">
                    <i class="bi bi-envelope-check me-2"></i>
                    Send Test
                </a>
                {% endif %}
            </div>
            
            {% if form.instance.pk %}
            <div class="form-text text-muted">
                Last updated: {{ form.instance.updated_at|date:"M d, Y H:i" }}
                {% if form.instance.created_by %}
                by {{ form.instance.created_by.get_full_name|default:form.instance.created_by.username }}
                {% endif %}
            </div>
            {% endif %}
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tab functionality
    const tabLinks = document.querySelectorAll('#contentTabs .nav-link');
    tabLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const target = this.getAttribute('href');
            
            // Update active tab
            tabLinks.forEach(tab => tab.classList.remove('active'));
            this.classList.add('active');
            
            // Show target pane
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            document.querySelector(target).classList.add('active');
        });
    });

    // Character count for name
    const nameInput = document.getElementById('{{ form.name.id_for_label }}');
    const nameCount = document.getElementById('nameCharacterCount');
    
    if (nameInput) {
        nameInput.addEventListener('input', function() {
            const length = this.value.length;
            nameCount.textContent = `${length}/100 characters`;
            
            if (length > 80) {
                nameCount.classList.add('warning');
                nameCount.classList.remove('error');
            } else if (length >= 100) {
                nameCount.classList.add('error');
                nameCount.classList.remove('warning');
            } else {
                nameCount.classList.remove('warning', 'error');
            }
        });
    }

    // Character count for subject
    const subjectInput = document.getElementById('{{ form.subject.id_for_label }}');
    const subjectCount = document.getElementById('subjectCharacterCount');
    
    if (subjectInput) {
        subjectInput.addEventListener('input', function() {
            const length = this.value.length;
            subjectCount.textContent = `${length}/200 characters`;
            
            if (length > 180) {
                subjectCount.classList.add('warning');
                subjectCount.classList.remove('error');
            } else if (length >= 200) {
                subjectCount.classList.add('error');
                subjectCount.classList.remove('warning');
            } else {
                subjectCount.classList.remove('warning', 'error');
            }
            
            updatePreview();
        });
    }

    // Character count for HTML content
    const htmlInput = document.getElementById('{{ form.body_html.id_for_label }}');
    const htmlCount = document.getElementById('htmlCharacterCount');
    
    if (htmlInput) {
        htmlInput.addEventListener('input', function() {
            const length = this.value.length;
            htmlCount.textContent = `${length} characters`;
            updatePreview();
        });
    }

    // Character count for text content
    const textInput = document.getElementById('{{ form.body_text.id_for_label }}');
    const textCount = document.getElementById('textCharacterCount');
    
    if (textInput) {
        textInput.addEventListener('input', function() {
            const length = this.value.length;
            textCount.textContent = `${length} characters`;
            updatePreview();
        });
    }

    // Language selector
    const languageOptions = document.querySelectorAll('.language-option');
    languageOptions.forEach(option => {
        option.addEventListener('click', function() {
            languageOptions.forEach(opt => opt.classList.remove('active'));
            this.classList.add('active');
            const radio = this.querySelector('input[type="radio"]');
            radio.checked = true;
            updatePreview();
        });
    });

    // Template type change
    const templateTypeSelect = document.getElementById('{{ form.template_type.id_for_label }}');
    if (templateTypeSelect) {
        templateTypeSelect.addEventListener('change', updatePreview);
    }

    // Preview toggle
    const previewToggle = document.getElementById('previewToggle');
    const templatePreview = document.getElementById('templatePreview');
    
    if (previewToggle) {
        previewToggle.addEventListener('click', function() {
            if (templatePreview.classList.contains('show')) {
                templatePreview.classList.remove('show');
                this.innerHTML = '<i class="bi bi-eye me-2"></i>Preview Template';
            } else {
                templatePreview.classList.add('show');
                this.innerHTML = '<i class="bi bi-eye-slash me-2"></i>Hide Preview';
                updatePreview();
            }
        });
    }

    // Test email functionality
    const sendTestBtn = document.getElementById('sendTestEmail');
    if (sendTestBtn) {
        sendTestBtn.addEventListener('click', function() {
            const recipient = document.getElementById('testRecipient').value;
            const testData = document.getElementById('testData').value;
            
            if (!recipient) {
                alert('Please enter a test recipient email address.');
                return;
            }
            
            // Validate JSON if provided
            if (testData) {
                try {
                    JSON.parse(testData);
                } catch (e) {
                    alert('Test data must be valid JSON format.');
                    return;
                }
            }
            
            // Send test email (this would typically be an AJAX call)
            sendTestEmail(recipient, testData);
        });
    }

    // Template examples
    const exampleItems = document.querySelectorAll('.example-item');
    exampleItems.forEach(item => {
        item.addEventListener('click', function() {
            const templateType = this.dataset.template;
            loadTemplateExample(templateType);
        });
    });

    // Form validation
    const emailTemplateForm = document.getElementById('emailTemplateForm');
    if (emailTemplateForm) {
        emailTemplateForm.addEventListener('submit', function(e) {
            let isValid = true;
            const requiredFields = emailTemplateForm.querySelectorAll('.required-field');
            
            requiredFields.forEach(field => {
                const input = field.closest('.form-group-enhanced').querySelector('input, select, textarea');
                if (input && !input.value.trim()) {
                    isValid = false;
                    input.classList.add('is-invalid');
                } else {
                    input.classList.remove('is-invalid');
                }
            });
            
            // Validate variables JSON
            const variablesInput = document.getElementById('{{ form.variables.id_for_label }}');
            if (variablesInput && variablesInput.value.trim()) {
                try {
                    JSON.parse(variablesInput.value);
                } catch (e) {
                    isValid = false;
                    variablesInput.classList.add('is-invalid');
                    alert('Variables must be valid JSON format.');
                }
            }
            
            if (!isValid) {
                e.preventDefault();
                alert('Please fill in all required fields and ensure variables are valid JSON.');
            }
        });
    }

    // Initialize preview
    updatePreview();
});

function updatePreview() {
    const subjectInput = document.getElementById('{{ form.subject.id_for_label }}');
    const htmlInput = document.getElementById('{{ form.body_html.id_for_label }}');
    const textInput = document.getElementById('{{ form.body_text.id_for_label }}');
    const templateTypeSelect = document.getElementById('{{ form.template_type.id_for_label }}');
    const languageInput = document.querySelector('input[name="{{ form.language.name }}"]:checked');
    
    const previewSubject = document.getElementById('previewSubject');
    const previewHtml = document.getElementById('previewHtml');
    const previewText = document.getElementById('previewText');
    const previewType = document.getElementById('previewType');
    const previewLanguage = document.getElementById('previewLanguage');
    
    if (previewSubject && subjectInput) {
        previewSubject.textContent = subjectInput.value || 'Email Subject Will Appear Here';
    }
    
    if (previewHtml && htmlInput) {
        previewHtml.innerHTML = htmlInput.value || 'HTML content preview will appear here...';
    }
    
    if (previewText && textInput) {
        previewText.textContent = textInput.value || 'Plain text content preview will appear here...';
    }
    
    if (previewType && templateTypeSelect) {
        previewType.textContent = templateTypeSelect.options[templateTypeSelect.selectedIndex]?.text || 'System';
    }
    
    if (previewLanguage && languageInput) {
        previewLanguage.textContent = languageInput.value.toUpperCase() || 'English';
    }
}

function sendTestEmail(recipient, testData) {
    const sendTestBtn = document.getElementById('sendTestEmail');
    const originalText = sendTestBtn.innerHTML;
    
    // Show loading state
    sendTestBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Sending...';
    sendTestBtn.disabled = true;
    
    // Simulate API call (replace with actual AJAX call)
    setTimeout(() => {
        // This would typically be an AJAX call to your backend
        // For now, we'll simulate success
        showToast('Test email sent successfully to ' + recipient, 'success');
        
        // Reset button
        sendTestBtn.innerHTML = originalText;
        sendTestBtn.disabled = false;
    }, 2000);
}

function loadTemplateExample(templateType) {
    const examples = {
        welcome: {
            subject: 'Welcome to {{ school_name }}',
            html: `<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
    <h2 style="color: #2c3e50;">Welcome to {{ school_name }}, {{ user_name }}!</h2>
    <p>We're excited to have you join our school community.</p>
    <p>Your account has been successfully created and you can now access all our services.</p>
    <div style="background: #f8f9fa; padding: 1rem; border-radius: 6px; margin: 1rem 0;">
        <strong>Next Steps:</strong>
        <ul>
            <li>Complete your profile information</li>
            <li>Explore the parent portal features</li>
            <li>Set up notification preferences</li>
        </ul>
    </div>
    <p>If you have any questions, please don't hesitate to contact us.</p>
    <p>Best regards,<br>The {{ school_name }} Team</p>
</div>`,
            text: `Welcome to {{ school_name }}, {{ user_name }}!

We're excited to have you join our school community.

Your account has been successfully created and you can now access all our services.

Next Steps:
- Complete your profile information
- Explore the parent portal features  
- Set up notification preferences

If you have any questions, please don't hesitate to contact us.

Best regards,
The {{ school_name }} Team`
        },
        notification: {
            subject: 'Notification: {{ announcement_title }}',
            html: `<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
    <h3 style="color: #2c3e50;">{{ announcement_title }}</h3>
    <p>Dear {{ user_name }},</p>
    <p>This is an important notification from {{ school_name }}.</p>
    <div style="background: #e8f4fd; padding: 1rem; border-radius: 6px; margin: 1rem 0;">
        <p style="margin: 0;">Please check the announcement for detailed information and take any necessary actions.</p>
    </div>
    <p>Sent on: {{ current_date }}</p>
    <p>Thank you,<br>{{ school_name }} Administration</p>
</div>`,
            text: `Notification: {{ announcement_title }}

Dear {{ user_name }},

This is an important notification from {{ school_name }}.

Please check the announcement for detailed information and take any necessary actions.

Sent on: {{ current_date }}

Thank you,
{{ school_name }} Administration`
        },
        announcement: {
            subject: 'Announcement: {{ announcement_title }}',
            html: `<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem; text-align: center; border-radius: 8px 8px 0 0;">
        <h2 style="margin: 0; font-size: 1.5rem;">{{ school_name }}</h2>
        <p style="margin: 0.5rem 0 0; opacity: 0.9;">Official Announcement</p>
    </div>
    <div style="padding: 2rem;">
        <h3 style="color: #2c3e50; margin-bottom: 1rem;">{{ announcement_title }}</h3>
        <p>Dear {{ user_name }},</p>
        <p>We would like to bring to your attention an important announcement.</p>
        <div style="background: #f8f9fa; padding: 1rem; border-radius: 6px; margin: 1rem 0;">
            <p style="margin: 0;"><strong>Please note:</strong> This announcement contains important information that requires your attention.</p>
        </div>
        <p>For more details, please log in to your account or contact the school administration.</p>
        <p style="color: #6c757d; font-size: 0.875rem; margin-top: 2rem;">
            This announcement was sent on {{ current_date }}.<br>
            Please do not reply to this automated message.
        </p>
    </div>
</div>`,
            text: `ANNOUNCEMENT: {{ announcement_title }}

Dear {{ user_name }},

We would like to bring to your attention an important announcement.

Please note: This announcement contains important information that requires your attention.

For more details, please log in to your account or contact the school administration.

This announcement was sent on {{ current_date }}.
Please do not reply to this automated message.`
        }
    };

    const example = examples[templateType];
    if (example) {
        document.getElementById('{{ form.subject.id_for_label }}').value = example.subject;
        document.getElementById('{{ form.body_html.id_for_label }}').value = example.html;
        document.getElementById('{{ form.body_text.id_for_label }}').value = example.text;
        
        updatePreview();
        showToast(`Loaded ${templateType} template example`, 'info');
    }
}

function showToast(message, type = 'info') {
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-bg-${type} border-0`;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');
    
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    `;
    
    // Add to container
    const container = document.getElementById('toastContainer') || createToastContainer();
    container.appendChild(toast);
    
    // Initialize and show
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    // Remove after hide
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}

function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toastContainer';
    container.className = 'toast-container position-fixed top-0 end-0 p-3';
    container.style.zIndex = '9999';
    document.body.appendChild(container);
    return container;
}
</script>
{% endblock %}