{% extends 'base.html' %}
{% load static %}

{% block title %}
    {% if form.instance.pk %}Edit{% else %}Create{% endif %} Notice Board - Communications
{% endblock %}

{% block extra_css %}
<style>
.noticeboard-form-container {
    max-width: 800px;
    margin: 0 auto;
}

.form-section {
    background: white;
    border-radius: 12px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    border: 1px solid #e9ecef;
}

.section-header {
    border-bottom: 2px solid #f8f9fa;
    padding-bottom: 1rem;
    margin-bottom: 1.5rem;
}

.section-title {
    color: #2c3e50;
    font-weight: 600;
    font-size: 1.25rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.section-title i {
    color: #3498db;
}

.form-group-enhanced {
    margin-bottom: 1.5rem;
}

.form-label {
    font-weight: 500;
    color: #2c3e50;
    margin-bottom: 0.5rem;
}

.required-field::after {
    content: " *";
    color: #e74c3c;
}

.help-text {
    font-size: 0.875rem;
    color: #6c757d;
    margin-top: 0.25rem;
}

.form-actions {
    background: white;
    border-radius: 12px;
    padding: 1.5rem 2rem;
    margin-top: 2rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    border: 1px solid #e9ecef;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
}

.action-buttons {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

@media (max-width: 768px) {
    .form-section {
        padding: 1.5rem;
    }

    .form-actions {
        flex-direction: column;
        align-items: stretch;
    }

    .action-buttons {
        order: 2;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'users:dashboard' %}">Home</a></li>
            <li class="breadcrumb-item"><a href="{% url 'communication:noticeboard_list' %}">Notice Boards</a></li>
            <li class="breadcrumb-item active" aria-current="page">
                {% if form.instance.pk %}Edit{% else %}Create{% endif %} Notice Board
            </li>
        </ol>
    </nav>

    <!-- Page Header -->
    <div class="page-header bg-light py-4 mb-4">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col">
                    <h1 class="page-title h2 mb-2">
                        {% if form.instance.pk %}
                            <i class="bi bi-pencil-square text-primary me-2"></i>
                            Edit Notice Board
                        {% else %}
                            <i class="bi bi-plus-circle text-primary me-2"></i>
                            Create New Notice Board
                        {% endif %}
                    </h1>
                    <p class="text-muted mb-0">
                        {% if form.instance.pk %}
                            Update the notice board details below
                        {% else %}
                            Create a new notice board for displaying announcements
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
    </div>

    <form method="post" class="noticeboard-form-container" id="noticeboardForm">
        {% csrf_token %}

        <!-- Basic Information Section -->
        <div class="form-section">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="bi bi-info-circle"></i>
                    Basic Information
                </h2>
            </div>

            <!-- Name Field -->
            <div class="form-group-enhanced">
                <label for="{{ form.name.id_for_label }}" class="form-label required-field">
                    {{ form.name.label }}
                </label>
                {{ form.name }}
                {% if form.name.help_text %}
                <div class="help-text">{{ form.name.help_text }}</div>
                {% endif %}
                {% if form.name.errors %}
                <div class="invalid-feedback d-block">
                    {{ form.name.errors }}
                </div>
                {% endif %}
            </div>

            <!-- Board Type Field -->
            <div class="form-group-enhanced">
                <label for="{{ form.board_type.id_for_label }}" class="form-label required-field">
                    {{ form.board_type.label }}
                </label>
                {{ form.board_type }}
                {% if form.board_type.help_text %}
                <div class="help-text">{{ form.board_type.help_text }}</div>
                {% endif %}
                {% if form.board_type.errors %}
                <div class="invalid-feedback d-block">
                    {{ form.board_type.errors }}
                </div>
                {% endif %}
            </div>

            <!-- Description Field -->
            <div class="form-group-enhanced">
                <label for="{{ form.description.id_for_label }}" class="form-label">
                    {{ form.description.label }}
                </label>
                {{ form.description }}
                {% if form.description.help_text %}
                <div class="help-text">{{ form.description.help_text }}</div>
                {% endif %}
                {% if form.description.errors %}
                <div class="invalid-feedback d-block">
                    {{ form.description.errors }}
                </div>
                {% endif %}
            </div>

            <!-- Location Field -->
            <div class="form-group-enhanced">
                <label for="{{ form.location.id_for_label }}" class="form-label">
                    {{ form.location.label }}
                </label>
                {{ form.location }}
                {% if form.location.help_text %}
                <div class="help-text">{{ form.location.help_text }}</div>
                {% endif %}
                {% if form.location.errors %}
                <div class="invalid-feedback d-block">
                    {{ form.location.errors }}
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Settings Section -->
        <div class="form-section">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="bi bi-gear"></i>
                    Display Settings
                </h2>
            </div>

            <div class="row">
                <!-- Is Active Field -->
                <div class="col-md-6">
                    <div class="form-group-enhanced">
                        <div class="form-check">
                            {{ form.is_active }}
                            <label for="{{ form.is_active.id_for_label }}" class="form-check-label">
                                {{ form.is_active.label }}
                            </label>
                        </div>
                        {% if form.is_active.help_text %}
                        <div class="help-text">{{ form.is_active.help_text }}</div>
                        {% endif %}
                        {% if form.is_active.errors %}
                        <div class="invalid-feedback d-block">
                            {{ form.is_active.errors }}
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Refresh Interval Field -->
                <div class="col-md-6">
                    <div class="form-group-enhanced">
                        <label for="{{ form.refresh_interval.id_for_label }}" class="form-label required-field">
                            {{ form.refresh_interval.label }}
                        </label>
                        {{ form.refresh_interval }}
                        {% if form.refresh_interval.help_text %}
                        <div class="help-text">{{ form.refresh_interval.help_text }}</div>
                        {% endif %}
                        {% if form.refresh_interval.errors %}
                        <div class="invalid-feedback d-block">
                            {{ form.refresh_interval.errors }}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Access Control Section -->
        <div class="form-section">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="bi bi-shield-lock"></i>
                    Access Control
                </h2>
            </div>

            <!-- Allowed Users Field -->
            <div class="form-group-enhanced">
                <label for="{{ form.allowed_users.id_for_label }}" class="form-label">
                    {{ form.allowed_users.label }}
                </label>
                {{ form.allowed_users }}
                {% if form.allowed_users.help_text %}
                <div class="help-text">{{ form.allowed_users.help_text }}</div>
                {% endif %}
                {% if form.allowed_users.errors %}
                <div class="invalid-feedback d-block">
                    {{ form.allowed_users.errors }}
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
            <div class="action-buttons">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check-lg me-2"></i>
                    {% if form.instance.pk %}Update{% else %}Create{% endif %} Notice Board
                </button>

                <a href="{% url 'communication:noticeboard_list' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-x-lg me-2"></i>
                    Cancel
                </a>
            </div>

            {% if form.instance.pk %}
            <div class="form-text text-muted">
                Last updated: {{ form.instance.updated_at|date:"M d, Y H:i" }}
            </div>
            {% endif %}
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const noticeboardForm = document.getElementById('noticeboardForm');

    // Initialize Select2 for multiple select fields with enhanced options
    $('.select2-multiple').select2({
        placeholder: function() {
            return $(this).data('placeholder') || 'Select options...';
        },
        width: '100%',
        theme: 'bootstrap-5',
        allowClear: true,
        closeOnSelect: false,
        tags: false,
        tokenSeparators: [',', ' '],
        maximumSelectionLength: 50, // Reasonable limit
        language: {
            maximumSelected: function (e) {
                return "You can only select " + e.maximum + " items";
            }
        }
    });

    // Enhanced form validation with better error handling
    if (noticeboardForm) {
        // Real-time validation
        const requiredFields = noticeboardForm.querySelectorAll('.required-field');
        requiredFields.forEach(field => {
            const input = field.closest('.form-group-enhanced').querySelector('input, select, textarea');
            if (input) {
                input.addEventListener('blur', function() {
                    validateField(this);
                });

                input.addEventListener('input', function() {
                    if (this.classList.contains('is-invalid')) {
                        validateField(this);
                    }
                });
            }
        });

        // Field validation function
        function validateField(input) {
            const isRequired = input.closest('.form-group-enhanced').querySelector('.required-field');
            let isValid = true;

            if (isRequired) {
                if (input.tagName === 'SELECT' && input.multiple) {
                    // For multiple select, check if any options are selected
                    const selectedOptions = Array.from(input.selectedOptions);
                    isValid = selectedOptions.length > 0;
                } else {
                    isValid = input.value.trim() !== '';
                }
            }

            if (isValid) {
                input.classList.remove('is-invalid');
                input.classList.add('is-valid');
            } else {
                input.classList.remove('is-valid');
                input.classList.add('is-invalid');
            }

            return isValid;
        }

        // Form submission validation
        noticeboardForm.addEventListener('submit', function(e) {
            let isValid = true;
            let firstInvalidField = null;
            const errorMessages = [];

            requiredFields.forEach(field => {
                const input = field.closest('.form-group-enhanced').querySelector('input, select, textarea');
                if (input) {
                    const fieldValid = validateField(input);
                    if (!fieldValid) {
                        isValid = false;
                        if (!firstInvalidField) {
                            firstInvalidField = input;
                        }
                        const fieldName = field.textContent.replace('*', '').trim();
                        errorMessages.push(`${fieldName} is required.`);
                    }
                }
            });

            // Additional validation for specific fields
            const refreshInterval = document.getElementById('{{ form.refresh_interval.id_for_label }}');
            if (refreshInterval && refreshInterval.value) {
                const interval = parseInt(refreshInterval.value);
                if (interval < 5 || interval > 300) {
                    isValid = false;
                    errorMessages.push('Refresh interval must be between 5 and 300 seconds.');
                    refreshInterval.classList.add('is-invalid');
                } else {
                    refreshInterval.classList.remove('is-invalid');
                }
            }

            if (!isValid) {
                e.preventDefault();

                // Focus on first invalid field
                if (firstInvalidField) {
                    firstInvalidField.focus();
                    firstInvalidField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }

                // Show error message
                if (errorMessages.length > 0) {
                    alert('Please correct the following errors:\n\n' + errorMessages.join('\n'));
                }
                return false;
            }

            // Show loading state
            const submitBtn = noticeboardForm.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>{% if form.instance.pk %}Updating{% else %}Creating{% endif %}...';
            }
        });
    }

    // Dynamic help text for refresh interval
    const refreshIntervalInput = document.getElementById('{{ form.refresh_interval.id_for_label }}');
    if (refreshIntervalInput) {
        const helpText = refreshIntervalInput.closest('.form-group-enhanced').querySelector('.help-text');

        refreshIntervalInput.addEventListener('input', function() {
            const value = parseInt(this.value) || 0;
            let recommendation = '';

            if (value < 5) {
                recommendation = ' (Too low - minimum 5 seconds recommended)';
                this.classList.add('is-warning');
            } else if (value > 300) {
                recommendation = ' (Too high - maximum 300 seconds recommended)';
                this.classList.add('is-warning');
            } else if (value >= 5 && value <= 30) {
                recommendation = ' (Good for frequently updated content)';
                this.classList.remove('is-warning');
            } else if (value > 30 && value <= 120) {
                recommendation = ' (Suitable for most notice boards)';
                this.classList.remove('is-warning');
            } else {
                recommendation = ' (Good for static content)';
                this.classList.remove('is-warning');
            }

            if (helpText) {
                const originalText = helpText.textContent.split(' (')[0];
                helpText.textContent = originalText + recommendation;
            }
        });
    }

    // Board type change handler
    const boardTypeSelect = document.getElementById('{{ form.board_type.id_for_label }}');
    if (boardTypeSelect) {
        boardTypeSelect.addEventListener('change', function() {
            const selectedType = this.value;
            const descriptionTextarea = document.getElementById('{{ form.description.id_for_label }}');

            // Provide helpful description based on board type
            const suggestions = {
                'main': 'Main notice board for general announcements and important information.',
                'staff': 'Staff-only notice board for internal communications and policies.',
                'student': 'Student notice board for academic announcements and events.',
                'parent': 'Parent notice board for school updates and family communications.',
                'event': 'Event-specific notice board for temporary displays and promotions.'
            };

            if (descriptionTextarea && !descriptionTextarea.value.trim()) {
                descriptionTextarea.placeholder = suggestions[selectedType] || 'Enter notice board description...';
            }

            // Update location suggestions
            const locationInput = document.getElementById('{{ form.location.id_for_label }}');
            if (locationInput && !locationInput.value.trim()) {
                const locationSuggestions = {
                    'main': 'Main Entrance, School Hall',
                    'staff': 'Staff Room, Administration Office',
                    'student': 'Classroom Corridors, Library',
                    'parent': 'Parent Waiting Area, School Entrance',
                    'event': 'Event Hall, Gymnasium'
                };
                locationInput.placeholder = locationSuggestions[selectedType] || 'Enter physical location...';
            }
        });

        // Trigger initial change to set placeholders
        boardTypeSelect.dispatchEvent(new Event('change'));
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Ctrl/Cmd + Enter to submit form
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
            e.preventDefault();
            const submitBtn = noticeboardForm.querySelector('button[type="submit"]');
            if (submitBtn && !submitBtn.disabled) {
                submitBtn.click();
            }
        }

        // Ctrl/Cmd + Shift + C to clear form (for new boards)
        if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'C') {
            e.preventDefault();
            if (!noticeboardForm.dataset.instancePk) { // Only for new boards
                if (confirm('Clear all form fields?')) {
                    const inputs = noticeboardForm.querySelectorAll('input, textarea, select');
                    inputs.forEach(input => {
                        if (input.type === 'checkbox') {
                            input.checked = false;
                        } else {
                            input.value = '';
                        }
                        input.classList.remove('is-valid', 'is-invalid');
                    });

                    // Reset Select2
                    $('.select2-multiple').val(null).trigger('change');
                }
            }
        }
    });

    // Auto-save functionality for drafts
    let autoSaveTimeout;
    function autoSave() {
        clearTimeout(autoSaveTimeout);
        autoSaveTimeout = setTimeout(() => {
            // In a real implementation, this would save to localStorage or server
            const formData = new FormData(noticeboardForm);
            const data = {};
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }
            localStorage.setItem('noticeboard_draft', JSON.stringify(data));
            console.log('Draft auto-saved');
        }, 30000); // Auto-save every 30 seconds
    }

    // Trigger auto-save on form changes
    noticeboardForm.addEventListener('input', autoSave);
    noticeboardForm.addEventListener('change', autoSave);

    // Load draft on page load (for new boards)
    if (!noticeboardForm.dataset.instancePk) {
        const draft = localStorage.getItem('noticeboard_draft');
        if (draft) {
            try {
                const data = JSON.parse(draft);
                // Populate form with draft data
                Object.keys(data).forEach(key => {
                    const input = noticeboardForm.querySelector(`[name="${key}"]`);
                    if (input) {
                        if (input.type === 'checkbox') {
                            input.checked = data[key] === 'on';
                        } else {
                            input.value = data[key];
                        }
                    }
                });
                console.log('Draft loaded');
            } catch (e) {
                console.error('Failed to load draft:', e);
            }
        }
    }

    // Add visual feedback for form completion
    function updateFormProgress() {
        const totalFields = requiredFields.length;
        let completedFields = 0;

        requiredFields.forEach(field => {
            const input = field.closest('.form-group-enhanced').querySelector('input, select, textarea');
            if (input && input.value.trim()) {
                completedFields++;
            }
        });

        const progress = Math.round((completedFields / totalFields) * 100);

        // Update progress indicator if it exists
        const progressBar = document.querySelector('.form-progress-bar');
        if (progressBar) {
            progressBar.style.width = `${progress}%`;
            progressBar.textContent = `${progress}% Complete`;
        }
    }

    // Update progress on field changes
    requiredFields.forEach(field => {
        const input = field.closest('.form-group-enhanced').querySelector('input, select, textarea');
        if (input) {
            input.addEventListener('input', updateFormProgress);
            input.addEventListener('change', updateFormProgress);
        }
    });

    // Initial progress update
    updateFormProgress();
});
</script>
{% endblock %}
