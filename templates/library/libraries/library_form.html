{% extends 'base/base.html' %}
{% load static i18n %}

{% block title %}
    {% if object %}{% trans "Edit Library" %}{% else %}{% trans "Add New Library" %}{% endif %}
{% endblock %}

{% block page_title %}
    {% if object %}
        {% trans "Edit Library" %}
    {% else %}
        {% trans "Add New Library" %}
    {% endif %}
{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'users:dashboard' %}">{% trans "Home" %}</a></li>
<li class="breadcrumb-item"><a href="{% url 'library:dashboard' %}">{% trans "Library" %}</a></li>
<li class="breadcrumb-item"><a href="{% url 'library:library_list' %}">{% trans "Libraries" %}</a></li>
<li class="breadcrumb-item active" aria-current="page">
    {% if object %}{% trans "Edit Library" %}{% else %}{% trans "Add Library" %}{% endif %}
</li>
{% endblock %}

{% block extra_css %}
<style>
    .form-card {
        border-left: 4px solid #65a0f9;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .form-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .section-card {
        border-left: 3px solid #e9ecef;
        margin-bottom: 1.5rem;
    }
    
    .section-card .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
    }
    
    .time-input-group {
        max-width: 200px;
    }
    
    .policy-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }
    
    .preview-card {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: 2px dashed #dee2e6;
    }
    
    .required-field::after {
        content: " *";
        color: #dc3545;
    }
    
    .help-text {
        font-size: 0.875rem;
        color: #6c757d;
    }
    
    .form-section {
        border-left: 4px solid transparent;
        padding-left: 1rem;
        margin-bottom: 2rem;
    }
    
    .form-section.basic { border-left-color: #65a0f9; }
    .form-section.hours { border-left-color: #28a745; }
    .form-section.policies { border-left-color: #ffc107; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card form-card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-building me-2"></i>
                        {% if object %}
                            {% trans "Edit Library Information" %}
                        {% else %}
                            {% trans "Create New Library" %}
                        {% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" novalidate>
                        {% csrf_token %}
                        
                        {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            <h6 class="alert-heading">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                {% trans "Please correct the following errors:" %}
                            </h6>
                            <ul class="mb-0">
                                {% for error in form.non_field_errors %}
                                    <li>{{ error }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}

                        <!-- Basic Information Section -->
                        <div class="form-section basic">
                            <h5 class="text-primary mb-3">
                                <i class="bi bi-info-circle me-2"></i>
                                {% trans "Basic Information" %}
                            </h5>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <!-- Library Name -->
                                    <div class="mb-3">
                                        <label for="{{ form.name.id_for_label }}" class="form-label required-field">
                                            {{ form.name.label }}
                                        </label>
                                        {{ form.name }}
                                        {% if form.name.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.name.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                        <div class="help-text">{{ form.name.help_text }}</div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <!-- Library Code -->
                                    <div class="mb-3">
                                        <label for="{{ form.code.id_for_label }}" class="form-label required-field">
                                            {{ form.code.label }}
                                        </label>
                                        {{ form.code }}
                                        {% if form.code.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.code.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                        <div class="help-text">{{ form.code.help_text }}</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Description -->
                            <div class="mb-4">
                                <label for="{{ form.description.id_for_label }}" class="form-label">
                                    {{ form.description.label }}
                                </label>
                                {{ form.description }}
                                {% if form.description.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.description.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                                <div class="help-text">{{ form.description.help_text }}</div>
                            </div>
                        </div>

                        <!-- Operating Hours Section -->
                        <div class="form-section hours">
                            <h5 class="text-success mb-3">
                                <i class="bi bi-clock me-2"></i>
                                {% trans "Operating Hours" %}
                            </h5>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <!-- Opening Time -->
                                    <div class="mb-3">
                                        <label for="{{ form.opening_time.id_for_label }}" class="form-label required-field">
                                            {{ form.opening_time.label }}
                                        </label>
                                        <div class="time-input-group">
                                            {{ form.opening_time }}
                                        </div>
                                        {% if form.opening_time.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.opening_time.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <!-- Closing Time -->
                                    <div class="mb-3">
                                        <label for="{{ form.closing_time.id_for_label }}" class="form-label required-field">
                                            {{ form.closing_time.label }}
                                        </label>
                                        <div class="time-input-group">
                                            {{ form.closing_time }}
                                        </div>
                                        {% if form.closing_time.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.closing_time.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Operating Hours Preview -->
                            <div class="card preview-card mb-4">
                                <div class="card-body text-center">
                                    <h6 class="card-title">{% trans "Operating Hours Preview" %}</h6>
                                    <div id="hoursPreview" class="text-muted">
                                        {% if object %}
                                            {{ object.operating_hours }}
                                        {% else %}
                                            {% trans "Set opening and closing times to see preview" %}
                                        {% endif %}
                                    </div>
                                    <div id="currentStatus" class="mt-2">
                                        {% if object and object.is_open_now %}
                                        <span class="badge bg-success policy-badge">
                                            <i class="bi bi-check-circle me-1"></i>{% trans "Currently Open" %}
                                        </span>
                                        {% elif object %}
                                        <span class="badge bg-danger policy-badge">
                                            <i class="bi bi-x-circle me-1"></i>{% trans "Currently Closed" %}
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Borrowing Policies Section -->
                        <div class="form-section policies">
                            <h5 class="text-warning mb-3">
                                <i class="bi bi-journal-bookmark me-2"></i>
                                {% trans "Borrowing Policies" %}
                            </h5>
                            
                            <div class="row">
                                <div class="col-md-4">
                                    <!-- Max Borrow Days -->
                                    <div class="mb-3">
                                        <label for="{{ form.max_borrow_days.id_for_label }}" class="form-label required-field">
                                            {{ form.max_borrow_days.label }}
                                        </label>
                                        <div class="input-group">
                                            {{ form.max_borrow_days }}
                                            <span class="input-group-text">{% trans "days" %}</span>
                                        </div>
                                        {% if form.max_borrow_days.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.max_borrow_days.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                        <div class="help-text">{{ form.max_borrow_days.help_text }}</div>
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <!-- Max Books Per User -->
                                    <div class="mb-3">
                                        <label for="{{ form.max_books_per_user.id_for_label }}" class="form-label required-field">
                                            {{ form.max_books_per_user.label }}
                                        </label>
                                        <div class="input-group">
                                            {{ form.max_books_per_user }}
                                            <span class="input-group-text">{% trans "books" %}</span>
                                        </div>
                                        {% if form.max_books_per_user.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.max_books_per_user.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                        <div class="help-text">{{ form.max_books_per_user.help_text }}</div>
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <!-- Fine Per Day -->
                                    <div class="mb-3">
                                        <label for="{{ form.fine_per_day.id_for_label }}" class="form-label required-field">
                                            {{ form.fine_per_day.label }}
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            {{ form.fine_per_day }}
                                        </div>
                                        {% if form.fine_per_day.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.fine_per_day.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                        <div class="help-text">{{ form.fine_per_day.help_text }}</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Policy Summary -->
                            <div class="card preview-card">
                                <div class="card-body">
                                    <h6 class="card-title">{% trans "Policy Summary" %}</h6>
                                    <div class="row text-center">
                                        <div class="col-md-4">
                                            <div class="border rounded p-3">
                                                <div class="text-primary fs-4 fw-bold" id="borrowDaysPreview">
                                                    {{ form.max_borrow_days.value|default:"14" }}
                                                </div>
                                                <small class="text-muted">{% trans "Borrow Days" %}</small>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="border rounded p-3">
                                                <div class="text-success fs-4 fw-bold" id="maxBooksPreview">
                                                    {{ form.max_books_per_user.value|default:"5" }}
                                                </div>
                                                <small class="text-muted">{% trans "Books Per User" %}</small>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="border rounded p-3">
                                                <div class="text-danger fs-4 fw-bold" id="finePreview">
                                                    ${{ form.fine_per_day.value|default:"5.00" }}
                                                </div>
                                                <small class="text-muted">{% trans "Daily Fine" %}</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Status Section -->
                        <div class="mb-4">
                            <h6 class="text-secondary mb-3">
                                <i class="bi bi-toggle-on me-2"></i>
                                {% trans "Library Status" %}
                            </h6>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="{{ form.status.id_for_label }}" class="form-label">
                                            {{ form.status.label }}
                                        </label>
                                        {{ form.status }}
                                        {% if form.status.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.status.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                        <div class="help-text">
                                            {% trans "Set to inactive to temporarily disable this library" %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="d-flex justify-content-between align-items-center border-top pt-4">
                            <div>
                                <a href="{% url 'library:library_list' %}" class="btn btn-outline-secondary">
                                    <i class="bi bi-arrow-left me-2"></i>{% trans "Back to Libraries" %}
                                </a>
                                {% if object %}
                                <a href="{% url 'library:library_detail' object.pk %}" class="btn btn-outline-info ms-2">
                                    <i class="bi bi-eye me-2"></i>{% trans "View Details" %}
                                </a>
                                {% endif %}
                            </div>
                            <div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-check-circle me-2"></i>
                                    {% if object %}
                                        {% trans "Update Library" %}
                                    {% else %}
                                        {% trans "Create Library" %}
                                    {% endif %}
                                </button>
                                {% if object %}
                                <button type="button" class="btn btn-danger ms-2" data-bs-toggle="modal" data-bs-target="#deleteModal">
                                    <i class="bi bi-trash me-2"></i>{% trans "Delete" %}
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
{% if object %}
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">
                    <i class="bi bi-exclamation-triangle text-danger me-2"></i>
                    {% trans "Confirm Library Deletion" %}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <h6 class="alert-heading">{% trans "Warning!" %}</h6>
                    {% trans "You are about to delete the library:" %} <strong>{{ object.name }}</strong>
                </div>
                <p class="mb-2">{% trans "This action will:" %}</p>
                <ul>
                    <li>{% trans "Set the library status to inactive" %}</li>
                    <li>{% trans "Prevent new book additions to this library" %}</li>
                    <li>{% trans "Preserve existing books and records" %}</li>
                </ul>
                <p class="text-danger mb-0">
                    <strong>{% trans "This action cannot be undone!" %}</strong>
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-2"></i>{% trans "Cancel" %}
                </button>
                <form method="post" action="{% url 'library:library_delete' object.pk %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash me-2"></i>{% trans "Delete Library" %}
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Update operating hours preview in real-time
        const openingTimeField = document.getElementById('{{ form.opening_time.id_for_label }}');
        const closingTimeField = document.getElementById('{{ form.closing_time.id_for_label }}');
        const hoursPreview = document.getElementById('hoursPreview');
        
        function updateHoursPreview() {
            const openingTime = openingTimeField.value;
            const closingTime = closingTimeField.value;
            
            if (openingTime && closingTime) {
                // Format times for display
                const opening = formatTimeForDisplay(openingTime);
                const closing = formatTimeForDisplay(closingTime);
                hoursPreview.innerHTML = `<strong>${opening} - ${closing}</strong>`;
                
                // Update current status
                updateCurrentStatus(openingTime, closingTime);
            } else {
                hoursPreview.textContent = '{% trans "Set opening and closing times to see preview" %}';
            }
        }
        
        function formatTimeForDisplay(timeString) {
            const [hours, minutes] = timeString.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const displayHour = hour % 12 || 12;
            return `${displayHour}:${minutes} ${ampm}`;
        }
        
        function updateCurrentStatus(openingTime, closingTime) {
            const now = new Date();
            const currentTime = now.toTimeString().slice(0, 5); // HH:MM format
            
            if (currentTime >= openingTime && currentTime <= closingTime) {
                document.getElementById('currentStatus').innerHTML = `
                    <span class="badge bg-success policy-badge">
                        <i class="bi bi-check-circle me-1"></i>{% trans "Currently Open" %}
                    </span>
                `;
            } else {
                document.getElementById('currentStatus').innerHTML = `
                    <span class="badge bg-danger policy-badge">
                        <i class="bi bi-x-circle me-1"></i>{% trans "Currently Closed" %}
                    </span>
                `;
            }
        }
        
        if (openingTimeField && closingTimeField) {
            openingTimeField.addEventListener('change', updateHoursPreview);
            closingTimeField.addEventListener('change', updateHoursPreview);
            // Initial update
            updateHoursPreview();
        }
        
        // Update policy previews in real-time
        const maxBorrowDaysField = document.getElementById('{{ form.max_borrow_days.id_for_label }}');
        const maxBooksField = document.getElementById('{{ form.max_books_per_user.id_for_label }}');
        const fineField = document.getElementById('{{ form.fine_per_day.id_for_label }}');
        
        if (maxBorrowDaysField) {
            maxBorrowDaysField.addEventListener('input', function() {
                document.getElementById('borrowDaysPreview').textContent = this.value;
            });
        }
        
        if (maxBooksField) {
            maxBooksField.addEventListener('input', function() {
                document.getElementById('maxBooksPreview').textContent = this.value;
            });
        }
        
        if (fineField) {
            fineField.addEventListener('input', function() {
                document.getElementById('finePreview').textContent = '$' + this.value;
            });
        }
        
        // Auto-generate library code from name
        const nameField = document.getElementById('{{ form.name.id_for_label }}');
        const codeField = document.getElementById('{{ form.code.id_for_label }}');
        
        if (nameField && codeField && !codeField.value) {
            nameField.addEventListener('blur', function() {
                if (!codeField.value) {
                    // Generate code from name (first 3 letters of each word, uppercase)
                    const code = this.value
                        .split(' ')
                        .map(word => word.substring(0, 3).toUpperCase())
                        .join('')
                        .substring(0, 10);
                    codeField.value = code;
                }
            });
        }
        
        // Form validation for time fields
        const form = document.querySelector('form');
        form.addEventListener('submit', function(e) {
            if (openingTimeField.value && closingTimeField.value && openingTimeField.value >= closingTimeField.value) {
                e.preventDefault();
                alert('{% trans "Closing time must be after opening time." %}');
                closingTimeField.focus();
            }
        });
        
        // Set default values if not provided
        if (!maxBorrowDaysField.value) maxBorrowDaysField.value = 14;
        if (!maxBooksField.value) maxBooksField.value = 5;
        if (!fineField.value) fineField.value = '5.00';
        
        // Initialize tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    });
    
    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Ctrl + S to save
        if (e.ctrlKey && e.key === 's') {
            e.preventDefault();
            document.querySelector('button[type="submit"]').click();
        }
        
        // Escape key to cancel
        if (e.key === 'Escape') {
            window.location.href = '{% url "library:library_list" %}';
        }
    });
</script>
{% endblock %}