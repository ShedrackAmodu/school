<!-- templates/library/authors/author_form.html -->
{% extends 'base/base.html' %}
{% load static i18n %}

{% block title %}
    {% if form.instance.pk %}
        {% trans "Edit Author" %} - {{ form.instance.full_name }}
    {% else %}
        {% trans "Add New Author" %}
    {% endif %}
{% endblock %}

{% block page_title %}
    {% if form.instance.pk %}
        {% trans "Edit Author" %}
    {% else %}
        {% trans "Add New Author" %}
    {% endif %}
{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'users:dashboard' %}">{% trans "Home" %}</a></li>
<li class="breadcrumb-item"><a href="{% url 'library:dashboard' %}">{% trans "Library" %}</a></li>
<li class="breadcrumb-item"><a href="{% url 'library:author_list' %}">{% trans "Authors" %}</a></li>
<li class="breadcrumb-item active" aria-current="page">
    {% if form.instance.pk %}
        {% trans "Edit" %} {{ form.instance.full_name }}
    {% else %}
        {% trans "Add New Author" %}
    {% endif %}
</li>
{% endblock %}

{% block extra_css %}
<style>
    /* Author Form Specific Styles */
    .form-card {
        border-left: 4px solid #65a0f9;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .form-card:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .preview-card {
        border-left: 4px solid #28a745;
        background-color: #f8f9fa;
    }
    
    .author-avatar-preview {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        background: linear-gradient(135deg, #65a0f9, #6f42c1);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 3rem;
        margin: 0 auto;
        border: 4px solid white;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .form-section {
        border-bottom: 1px solid #e9ecef;
        padding-bottom: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .form-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }
    
    .section-title {
        color: #495057;
        font-weight: 600;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #65a0f9;
        display: inline-block;
    }
    
    .required-field::after {
        content: " *";
        color: #dc3545;
    }
    
    .help-text {
        font-size: 0.875rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }
    
    .character-count {
        font-size: 0.75rem;
        color: #6c757d;
        text-align: right;
        margin-top: 0.25rem;
    }
    
    .bio-preview {
        max-height: 200px;
        overflow-y: auto;
        background-color: white;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 1rem;
        font-size: 0.9rem;
        line-height: 1.5;
    }
    
    .timeline-preview {
        font-size: 0.9rem;
    }
    
    .timeline-item {
        border-left: 2px solid #65a0f9;
        padding-left: 1rem;
        margin-bottom: 1rem;
        position: relative;
    }
    
    .timeline-item::before {
        content: '';
        position: absolute;
        left: -6px;
        top: 0;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background-color: #65a0f9;
    }
    
    .action-buttons {
        position: sticky;
        bottom: 0;
        background: white;
        padding: 1rem 0;
        border-top: 1px solid #dee2e6;
        margin-top: 2rem;
    }
    
    @media (max-width: 768px) {
        .author-avatar-preview {
            width: 80px;
            height: 80px;
            font-size: 2rem;
        }
        
        .action-buttons .btn {
            margin-bottom: 0.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <form method="post" novalidate>
        {% csrf_token %}
        
        <div class="row">
            <!-- Left Column: Form Fields -->
            <div class="col-lg-8">
                <div class="card form-card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-person-badge text-primary me-2"></i>
                            {% if form.instance.pk %}
                                {% trans "Edit Author Information" %}
                            {% else %}
                                {% trans "Author Information" %}
                            {% endif %}
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Personal Information Section -->
                        <div class="form-section">
                            <h6 class="section-title">
                                <i class="bi bi-person me-2"></i>{% trans "Personal Information" %}
                            </h6>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.first_name.id_for_label }}" class="form-label required-field">
                                        {{ form.first_name.label }}
                                    </label>
                                    {{ form.first_name }}
                                    {% if form.first_name.help_text %}
                                    <div class="help-text">{{ form.first_name.help_text }}</div>
                                    {% endif %}
                                    {% if form.first_name.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.first_name.errors }}
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.last_name.id_for_label }}" class="form-label required-field">
                                        {{ form.last_name.label }}
                                    </label>
                                    {{ form.last_name }}
                                    {% if form.last_name.help_text %}
                                    <div class="help-text">{{ form.last_name.help_text }}</div>
                                    {% endif %}
                                    {% if form.last_name.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.last_name.errors }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.nationality.id_for_label }}" class="form-label">
                                        {{ form.nationality.label }}
                                    </label>
                                    {{ form.nationality }}
                                    {% if form.nationality.help_text %}
                                    <div class="help-text">{{ form.nationality.help_text }}</div>
                                    {% endif %}
                                    {% if form.nationality.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.nationality.errors }}
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.status.id_for_label }}" class="form-label required-field">
                                        {{ form.status.label }}
                                    </label>
                                    {{ form.status }}
                                    {% if form.status.help_text %}
                                    <div class="help-text">{{ form.status.help_text }}</div>
                                    {% endif %}
                                    {% if form.status.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.status.errors }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Biographical Information Section -->
                        <div class="form-section">
                            <h6 class="section-title">
                                <i class="bi bi-journal-text me-2"></i>{% trans "Biographical Information" %}
                            </h6>
                            
                            <div class="mb-3">
                                <label for="{{ form.bio.id_for_label }}" class="form-label">
                                    {{ form.bio.label }}
                                </label>
                                {{ form.bio }}
                                <div class="character-count">
                                    <span id="bio-char-count">0</span> {% trans "characters" %}
                                </div>
                                {% if form.bio.help_text %}
                                <div class="help-text">{{ form.bio.help_text }}</div>
                                {% endif %}
                                {% if form.bio.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.bio.errors }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Life Events Section -->
                        <div class="form-section">
                            <h6 class="section-title">
                                <i class="bi bi-calendar-event me-2"></i>{% trans "Life Events" %}
                            </h6>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.date_of_birth.id_for_label }}" class="form-label">
                                        {{ form.date_of_birth.label }}
                                    </label>
                                    {{ form.date_of_birth }}
                                    {% if form.date_of_birth.help_text %}
                                    <div class="help-text">{{ form.date_of_birth.help_text }}</div>
                                    {% endif %}
                                    {% if form.date_of_birth.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.date_of_birth.errors }}
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.date_of_death.id_for_label }}" class="form-label">
                                        {{ form.date_of_death.label }}
                                    </label>
                                    {{ form.date_of_death }}
                                    {% if form.date_of_death.help_text %}
                                    <div class="help-text">{{ form.date_of_death.help_text }}</div>
                                    {% endif %}
                                    {% if form.date_of_death.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.date_of_death.errors }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            {% if form.date_of_birth.value and form.date_of_death.value %}
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                {% blocktrans with birth=form.date_of_birth.value death=form.date_of_death.value %}
                                Author lived from {{ birth }} to {{ death }}
                                {% endblocktrans %}
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Form Errors Display -->
                        {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            <h6 class="alert-heading">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                {% trans "Please correct the following errors:" %}
                            </h6>
                            <ul class="mb-0">
                                {% for error in form.non_field_errors %}
                                <li>{{ error }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Right Column: Preview and Actions -->
            <div class="col-lg-4">
                <!-- Author Preview -->
                <div class="card preview-card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-eye text-success me-2"></i>
                            {% trans "Author Preview" %}
                        </h5>
                    </div>
                    <div class="card-body text-center">
                        <div class="author-avatar-preview mb-3" id="author-avatar-preview">
                            <span id="avatar-initials">AA</span>
                        </div>
                        
                        <h5 id="preview-full-name" class="mb-2">{% trans "Author Name" %}</h5>
                        
                        <div class="mb-3">
                            <span id="preview-nationality" class="badge bg-light text-dark">{% trans "Nationality" %}</span>
                            <span id="preview-status" class="badge bg-success ms-1">{% trans "Status" %}</span>
                        </div>
                        
                        <!-- Timeline Preview -->
                        <div class="timeline-preview text-start">
                            <div id="birth-preview" class="timeline-item" style="display: none;">
                                <strong>{% trans "Born" %}</strong>
                                <div class="text-muted small" id="birth-date">{% trans "Date" %}</div>
                            </div>
                            
                            <div id="death-preview" class="timeline-item" style="display: none;">
                                <strong>{% trans "Died" %}</strong>
                                <div class="text-muted small" id="death-date">{% trans "Date" %}</div>
                            </div>
                            
                            <div id="no-timeline" class="text-muted small">
                                {% trans "No life events added" %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Bio Preview -->
                <div class="card preview-card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-journal-text text-success me-2"></i>
                            {% trans "Biography Preview" %}
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="bio-preview" class="bio-preview">
                            <span class="text-muted">{% trans "Biography will appear here..." %}</span>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-lightning-charge text-warning me-2"></i>
                            {% trans "Quick Actions" %}
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            {% if form.instance.pk %}
                            <a href="{% url 'library:author_detail' form.instance.pk %}" class="btn btn-outline-primary">
                                <i class="bi bi-eye me-2"></i> {% trans "View Author" %}
                            </a>
                            <a href="{% url 'library:book_create' %}?author={{ form.instance.id }}" class="btn btn-outline-success">
                                <i class="bi bi-plus-circle me-2"></i> {% trans "Add Book" %}
                            </a>
                            {% endif %}
                            <a href="{% url 'library:author_list' %}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left me-2"></i> {% trans "Back to List" %}
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="action-buttons">
            <div class="row">
                <div class="col-12">
                    <div class="d-flex gap-2 justify-content-end">
                        <a href="{% url 'library:author_list' %}" class="btn btn-secondary">
                            <i class="bi bi-x-circle me-2"></i> {% trans "Cancel" %}
                        </a>
                        <button type="submit" name="save" class="btn btn-primary">
                            <i class="bi bi-check-circle me-2"></i>
                            {% if form.instance.pk %}
                                {% trans "Update Author" %}
                            {% else %}
                                {% trans "Create Author" %}
                            {% endif %}
                        </button>
                        {% if form.instance.pk %}
                        <button type="submit" name="save_and_continue" class="btn btn-outline-primary">
                            <i class="bi bi-check2-all me-2"></i> {% trans "Save & Continue Editing" %}
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Get form elements
        const firstNameInput = document.getElementById('{{ form.first_name.id_for_label }}');
        const lastNameInput = document.getElementById('{{ form.last_name.id_for_label }}');
        const nationalityInput = document.getElementById('{{ form.nationality.id_for_label }}');
        const statusInput = document.getElementById('{{ form.status.id_for_label }}');
        const bioInput = document.getElementById('{{ form.bio.id_for_label }}');
        const dateOfBirthInput = document.getElementById('{{ form.date_of_birth.id_for_label }}');
        const dateOfDeathInput = document.getElementById('{{ form.date_of_death.id_for_label }}');
        
        // Preview elements
        const avatarPreview = document.getElementById('author-avatar-preview');
        const avatarInitials = document.getElementById('avatar-initials');
        const previewFullName = document.getElementById('preview-full-name');
        const previewNationality = document.getElementById('preview-nationality');
        const previewStatus = document.getElementById('preview-status');
        const bioPreview = document.getElementById('bio-preview');
        const birthPreview = document.getElementById('birth-preview');
        const deathPreview = document.getElementById('death-preview');
        const birthDate = document.getElementById('birth-date');
        const deathDate = document.getElementById('death-date');
        const noTimeline = document.getElementById('no-timeline');
        const bioCharCount = document.getElementById('bio-char-count');
        
        // Update character count for bio
        function updateBioCharCount() {
            if (bioInput && bioCharCount) {
                const count = bioInput.value.length;
                bioCharCount.textContent = count;
                
                if (count > 0) {
                    bioCharCount.classList.remove('text-muted');
                    bioCharCount.classList.add(count > 5000 ? 'text-danger' : 'text-success');
                } else {
                    bioCharCount.classList.add('text-muted');
                    bioCharCount.classList.remove('text-success', 'text-danger');
                }
            }
        }
        
        // Update avatar initials
        function updateAvatarInitials() {
            const firstName = firstNameInput ? firstNameInput.value.trim() : '';
            const lastName = lastNameInput ? lastNameInput.value.trim() : '';
            
            let initials = 'AA';
            if (firstName || lastName) {
                const firstInitial = firstName ? firstName.charAt(0).toUpperCase() : '';
                const lastInitial = lastName ? lastName.charAt(0).toUpperCase() : '';
                initials = firstInitial + lastInitial || 'A';
            }
            
            avatarInitials.textContent = initials;
        }
        
        // Update full name preview
        function updateFullNamePreview() {
            const firstName = firstNameInput ? firstNameInput.value.trim() : '';
            const lastName = lastNameInput ? lastNameInput.value.trim() : '';
            
            if (firstName || lastName) {
                previewFullName.textContent = `${firstName} ${lastName}`.trim();
            } else {
                previewFullName.textContent = '{% trans "Author Name" %}';
            }
        }
        
        // Update nationality preview
        function updateNationalityPreview() {
            const nationality = nationalityInput ? nationalityInput.value.trim() : '';
            
            if (nationality) {
                previewNationality.textContent = nationality;
                previewNationality.style.display = 'inline-block';
            } else {
                previewNationality.style.display = 'none';
            }
        }
        
        // Update status preview
        function updateStatusPreview() {
            const status = statusInput ? statusInput.value : '';
            
            if (status) {
                const statusText = statusInput.options[statusInput.selectedIndex].text;
                previewStatus.textContent = statusText;
                
                if (status === 'active') {
                    previewStatus.className = 'badge bg-success ms-1';
                } else {
                    previewStatus.className = 'badge bg-secondary ms-1';
                }
                previewStatus.style.display = 'inline-block';
            } else {
                previewStatus.style.display = 'none';
            }
        }
        
        // Update bio preview
        function updateBioPreview() {
            const bio = bioInput ? bioInput.value.trim() : '';
            
            if (bio) {
                bioPreview.innerHTML = bio.replace(/\n/g, '<br>');
            } else {
                bioPreview.innerHTML = '<span class="text-muted">{% trans "Biography will appear here..." %}</span>';
            }
        }
        
        // Update timeline preview
        function updateTimelinePreview() {
            const birthDateValue = dateOfBirthInput ? dateOfBirthInput.value : '';
            const deathDateValue = dateOfDeathInput ? dateOfDeathInput.value : '';
            
            let hasTimeline = false;
            
            if (birthDateValue) {
                birthDate.textContent = new Date(birthDateValue).toLocaleDateString();
                birthPreview.style.display = 'block';
                hasTimeline = true;
            } else {
                birthPreview.style.display = 'none';
            }
            
            if (deathDateValue) {
                deathDate.textContent = new Date(deathDateValue).toLocaleDateString();
                deathPreview.style.display = 'block';
                hasTimeline = true;
            } else {
                deathPreview.style.display = 'none';
            }
            
            noTimeline.style.display = hasTimeline ? 'none' : 'block';
        }
        
        // Initialize all previews
        function initializePreviews() {
            updateAvatarInitials();
            updateFullNamePreview();
            updateNationalityPreview();
            updateStatusPreview();
            updateBioPreview();
            updateTimelinePreview();
            updateBioCharCount();
        }
        
        // Add event listeners
        if (firstNameInput) {
            firstNameInput.addEventListener('input', function() {
                updateAvatarInitials();
                updateFullNamePreview();
            });
        }
        
        if (lastNameInput) {
            lastNameInput.addEventListener('input', function() {
                updateAvatarInitials();
                updateFullNamePreview();
            });
        }
        
        if (nationalityInput) {
            nationalityInput.addEventListener('input', updateNationalityPreview);
        }
        
        if (statusInput) {
            statusInput.addEventListener('change', updateStatusPreview);
        }
        
        if (bioInput) {
            bioInput.addEventListener('input', function() {
                updateBioPreview();
                updateBioCharCount();
            });
        }
        
        if (dateOfBirthInput) {
            dateOfBirthInput.addEventListener('change', updateTimelinePreview);
        }
        
        if (dateOfDeathInput) {
            dateOfDeathInput.addEventListener('change', updateTimelinePreview);
        }
        
        // Initialize on page load
        initializePreviews();
        
        // Form validation enhancement
        const form = document.querySelector('form');
        if (form) {
            form.addEventListener('submit', function(event) {
                let isValid = true;
                const requiredFields = form.querySelectorAll('.required-field');
                
                requiredFields.forEach(function(label) {
                    const field = label.closest('.mb-3').querySelector('input, select, textarea');
                    if (field && !field.value.trim()) {
                        isValid = false;
                        field.classList.add('is-invalid');
                    } else if (field) {
                        field.classList.remove('is-invalid');
                    }
                });
                
                if (!isValid) {
                    event.preventDefault();
                    // Scroll to first error
                    const firstError = form.querySelector('.is-invalid');
                    if (firstError) {
                        firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        firstError.focus();
                    }
                }
            });
        }
        
        // Initialize tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
        const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    });
</script>
{% endblock %}