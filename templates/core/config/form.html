{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}{% if object %}Edit{% else %}Create{% endif %} System Configuration{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-{% if object %}edit{% else %}plus{% endif %}"></i>
                        {% if object %}Edit{% else %}Create{% endif %} System Configuration
                    </h3>
                    <div class="card-tools">
                        <a href="{% url 'core:config_list' %}" class="btn btn-secondary btn-sm">
                            <i class="fas fa-arrow-left"></i> Back to List
                        </a>
                    </div>
                </div>
                <form method="post" id="configForm">
                    {% csrf_token %}
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                {{ form.key|as_crispy_field }}
                            </div>
                            <div class="col-md-6">
                                {{ form.config_type|as_crispy_field }}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12">
                                {{ form.description|as_crispy_field }}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12">
                                <div class="form-group">
                                    <label for="{{ form.value.id_for_label }}">Configuration Value</label>
                                    <div class="mb-2">
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button type="button" class="btn btn-outline-secondary" id="formatJson">
                                                <i class="fas fa-magic"></i> Format JSON
                                            </button>
                                            <button type="button" class="btn btn-outline-info" id="validateJson">
                                                <i class="fas fa-check"></i> Validate
                                            </button>
                                            <button type="button" class="btn btn-outline-warning" id="compressJson">
                                                <i class="fas fa-compress"></i> Compress
                                            </button>
                                        </div>
                                        <small class="form-text text-muted">
                                            Enter configuration value as JSON, string, or number.
                                            Use the buttons above to format and validate your input.
                                        </small>
                                    </div>
                                    {{ form.value }}
                                    <div id="jsonValidationResult" class="mt-2" style="display: none;"></div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                {{ form.status|as_crispy_field }}
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    {{ form.is_public|as_crispy_field }}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    {{ form.is_encrypted|as_crispy_field }}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> {% if object %}Update{% else %}Create{% endif %} Configuration
                        </button>
                        <a href="{% url 'core:config_list' %}" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <div class="col-md-4">
            <!-- Help Panel -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-question-circle"></i> Help & Examples
                    </h3>
                </div>
                <div class="card-body">
                    <h6>Configuration Types:</h6>
                    <ul class="list-unstyled">
                        <li><strong>General:</strong> System-wide settings</li>
                        <li><strong>Academic:</strong> School year, terms, grading</li>
                        <li><strong>Finance:</strong> Fees, payments, currency</li>
                        <li><strong>Communication:</strong> Email, SMS settings</li>
                        <li><strong>Security:</strong> Password policies, access control</li>
                        <li><strong>UI:</strong> Theme, layout, display options</li>
                    </ul>

                    <h6 class="mt-3">Value Format Examples:</h6>
                    <div class="mb-2">
                        <small class="text-muted">String:</small>
                        <code class="d-block">"school_name"</code>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">Number:</small>
                        <code class="d-block">100</code>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">Boolean:</small>
                        <code class="d-block">true</code>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">JSON Object:</small>
                        <code class="d-block">{"key": "value", "enabled": true}</code>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">JSON Array:</small>
                        <code class="d-block">["item1", "item2", "item3"]</code>
                    </div>
                </div>
            </div>

            <!-- Preview Panel -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-eye"></i> Live Preview
                    </h3>
                </div>
                <div class="card-body">
                    <div id="configPreview">
                        <p class="text-muted">Enter a value above to see the preview.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.CodeMirror {
    border: 1px solid #ced4da;
    border-radius: 0.25rem;
    height: auto;
}

.json-valid {
    color: #28a745;
}

.json-invalid {
    color: #dc3545;
}

#configPreview {
    font-family: 'Courier New', monospace;
    font-size: 0.875rem;
    background-color: #f8f9fa;
    padding: 0.5rem;
    border-radius: 0.25rem;
    min-height: 100px;
}
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/default.min.css">

<script>
$(document).ready(function() {
    var codeMirrorEditor;

    // Initialize CodeMirror for JSON editing
    if ($('#id_value').length) {
        codeMirrorEditor = CodeMirror.fromTextArea(document.getElementById('id_value'), {
            mode: {name: "javascript", json: true},
            theme: "default",
            lineNumbers: true,
            lineWrapping: true,
            autoCloseBrackets: true,
            matchBrackets: true,
            indentUnit: 2,
            tabSize: 2,
            gutters: ["CodeMirror-lint-markers"],
            lint: true
        });

        // Update preview on change
        codeMirrorEditor.on('change', function() {
            updatePreview();
        });

        // Initial preview
        updatePreview();
    }

    // Format JSON button
    $('#formatJson').on('click', function() {
        try {
            var currentValue = codeMirrorEditor.getValue();
            if (currentValue.trim()) {
                var parsed = JSON.parse(currentValue);
                var formatted = JSON.stringify(parsed, null, 2);
                codeMirrorEditor.setValue(formatted);
                showValidationResult('JSON formatted successfully!', true);
            }
        } catch (e) {
            showValidationResult('Invalid JSON: ' + e.message, false);
        }
    });

    // Validate JSON button
    $('#validateJson').on('click', function() {
        validateJsonValue();
    });

    // Compress JSON button
    $('#compressJson').on('click', function() {
        try {
            var currentValue = codeMirrorEditor.getValue();
            if (currentValue.trim()) {
                var parsed = JSON.parse(currentValue);
                var compressed = JSON.stringify(parsed);
                codeMirrorEditor.setValue(compressed);
                showValidationResult('JSON compressed successfully!', true);
            }
        } catch (e) {
            showValidationResult('Invalid JSON: ' + e.message, false);
        }
    });

    // Form submission - update textarea with CodeMirror content
    $('#configForm').on('submit', function() {
        if (codeMirrorEditor) {
            codeMirrorEditor.save();
        }
    });

    // Update preview function
    function updatePreview() {
        var value = codeMirrorEditor.getValue();
        var preview = $('#configPreview');

        if (!value.trim()) {
            preview.html('<p class="text-muted">Enter a value above to see the preview.</p>');
            return;
        }

        try {
            var parsed = JSON.parse(value);
            var formatted = JSON.stringify(parsed, null, 2);
            preview.html('<pre class="mb-0"><code>' + escapeHtml(formatted) + '</code></pre>');
        } catch (e) {
            // Try to parse as simple value
            try {
                var parsed = JSON.parse('"' + value + '"');
                preview.html('<pre class="mb-0"><code>"' + escapeHtml(value) + '"</code></pre>');
            } catch (e2) {
                preview.html('<pre class="mb-0 text-danger"><code>' + escapeHtml(value) + '</code></pre>');
            }
        }
    }

    // Validate JSON value
    function validateJsonValue() {
        var value = codeMirrorEditor.getValue();

        $.ajax({
            url: '{% url "core:validate_config_value" %}',
            method: 'POST',
            data: {
                'value': value,
                'config_type': $('#id_config_type').val(),
                'csrfmiddlewaretoken': $('input[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                showValidationResult(
                    response.is_valid ? 'Valid configuration value!' : 'Invalid: ' + response.error_message,
                    response.is_valid
                );
            },
            error: function() {
                showValidationResult('Validation failed. Please try again.', false);
            }
        });
    }

    // Show validation result
    function showValidationResult(message, isValid) {
        var resultDiv = $('#jsonValidationResult');
        resultDiv.removeClass('alert-success alert-danger')
                 .addClass(isValid ? 'alert-success' : 'alert-danger')
                 .html('<i class="fas fa-' + (isValid ? 'check' : 'times') + '"></i> ' + message)
                 .show();

        // Hide after 5 seconds
        setTimeout(function() {
            resultDiv.fadeOut();
        }, 5000);
    }

    // Escape HTML function
    function escapeHtml(text) {
        var map = {
            '&': '&',
            '<': '<',
            '>': '>',
            '"': '"',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, function(m) { return map[m]; });
    }
});
</script>
{% endblock %}
