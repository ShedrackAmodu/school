{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% load filters %}

{% block title %}{% trans "Institution Details" %} - {{ institution.name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="fas fa-school text-primary"></i> {{ institution.name }}
                    </h1>
                    <p class="text-muted">{{ institution.get_institution_type_display }} â€¢ {{ institution.get_ownership_type_display }}</p>
                </div>
                <div>
                    <a href="{% url 'core:institution_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> {% trans "Back to List" %}
                    </a>
                    <a href="{% url 'core:institution_update' institution.id %}" class="btn btn-primary">
                        <i class="fas fa-edit"></i> {% trans "Edit Institution" %}
                    </a>
                    <a href="{% url 'core:institution_config_overrides' institution.id %}" class="btn btn-info">
                        <i class="fas fa-cogs"></i> {% trans "Config Overrides" %}
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Banner -->
    {% if not institution.is_active %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i>
                {% trans "This institution is currently inactive and may not be accessible to users." %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Key Metrics Row -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                {% trans "Current Students" %}
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ student_count }}</div>
                            <div class="text-xs text-muted">
                                {% trans "of" %} {{ institution.max_students }} {% trans "capacity" %}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-user-graduate fa-2x text-primary"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                {% trans "Current Staff" %}
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ staff_count }}</div>
                            <div class="text-xs text-muted">
                                {% trans "of" %} {{ institution.max_staff }} {% trans "capacity" %}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-users fa-2x text-success"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                {% trans "Utilization Rate" %}
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ utilization_rate|floatformat:1 }}%</div>
                            <div class="progress mt-2" style="height: 6px;">
                                <div class="progress-bar {% if utilization_rate > 90 %}bg-danger{% elif utilization_rate > 75 %}bg-warning{% else %}bg-success{% endif %}"
                                     style="width: {{ utilization_rate }}%"></div>
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-chart-pie fa-2x text-info"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                {% trans "Config Overrides" %}
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ config_overrides.count }}</div>
                            <div class="text-xs text-muted">
                                {% trans "custom settings" %}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-cogs fa-2x text-warning"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Row -->
    <div class="row">
        <!-- Institution Details -->
        <div class="col-xl-8 col-lg-7">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-info-circle"></i> {% trans "Institution Information" %}
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h5 class="text-primary mb-3">{% trans "Basic Information" %}</h5>
                            <table class="table table-borderless">
                                <tr>
                                    <td class="text-muted" width="40%">{% trans "Institution Code" %}</td>
                                    <td><code>{{ institution.code }}</code></td>
                                </tr>
                                <tr>
                                    <td class="text-muted">{% trans "Short Name" %}</td>
                                    <td>{{ institution.short_name|default:"--" }}</td>
                                </tr>
                                <tr>
                                    <td class="text-muted">{% trans "Type" %}</td>
                                    <td>
                                        <span class="badge badge-primary">{{ institution.get_institution_type_display }}</span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="text-muted">{% trans "Ownership" %}</td>
                                    <td>
                                        <span class="badge badge-secondary">{{ institution.get_ownership_type_display }}</span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="text-muted">{% trans "Established" %}</td>
                                    <td>{{ institution.established_date|date:"M d, Y"|default:"--" }}</td>
                                </tr>
                                <tr>
                                    <td class="text-muted">{% trans "Status" %}</td>
                                    <td>
                                        {% if institution.is_active %}
                                            <span class="badge badge-success">{% trans "Active" %}</span>
                                        {% else %}
                                            <span class="badge badge-warning">{% trans "Inactive" %}</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            </table>
                        </div>

                        <div class="col-md-6">
                            <h5 class="text-primary mb-3">{% trans "Contact Information" %}</h5>
                            <table class="table table-borderless">
                                <tr>
                                    <td class="text-muted" width="40%">{% trans "Address" %}</td>
                                    <td>{{ institution.full_address|default:"--" }}</td>
                                </tr>
                                <tr>
                                    <td class="text-muted">{% trans "Phone" %}</td>
                                    <td>{{ institution.phone|default:"--" }}</td>
                                </tr>
                                <tr>
                                    <td class="text-muted">{% trans "Mobile" %}</td>
                                    <td>{{ institution.mobile|default:"--" }}</td>
                                </tr>
                                <tr>
                                    <td class="text-muted">{% trans "Email" %}</td>
                                    <td>
                                        {% if institution.email %}
                                            <a href="mailto:{{ institution.email }}">{{ institution.email }}</a>
                                        {% else %}
                                            --
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td class="text-muted">{% trans "Website" %}</td>
                                    <td>
                                        {% if institution.website %}
                                            <a href="{{ institution.website }}" target="_blank">{{ institution.website }}</a>
                                        {% else %}
                                            --
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td class="text-muted">{% trans "Timezone" %}</td>
                                    <td>{{ institution.timezone }}</td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    {% if institution.description %}
                    <div class="row mt-3">
                        <div class="col-12">
                            <h5 class="text-primary mb-2">{% trans "Description" %}</h5>
                            <p class="text-muted">{{ institution.description }}</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Capacity Information -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-success">
                        <i class="fas fa-chart-bar"></i> {% trans "Capacity & Enrollment" %}
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label text-muted">{% trans "Student Capacity" %}</label>
                                <div class="d-flex align-items-center">
                                    <div class="progress flex-grow-1 me-3" style="height: 20px;">
                                        <div class="progress-bar {% if utilization_rate > 90 %}bg-danger{% elif utilization_rate > 75 %}bg-warning{% else %}bg-success{% endif %}"
                                             style="width: {{ utilization_rate }}%"></div>
                                    </div>
                                    <span class="badge badge-primary">{{ student_count }} / {{ institution.max_students }}</span>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label text-muted">{% trans "Staff Capacity" %}</label>
                                <div class="d-flex align-items-center">
                                    <div class="progress flex-grow-1 me-3" style="height: 20px;">
                                        {% with staff_utilization=staff_count|div:institution.max_staff|mul:100 %}
                                        <div class="progress-bar {% if staff_utilization > 90 %}bg-danger{% elif staff_utilization > 75 %}bg-warning{% else %}bg-success{% endif %}"
                                             style="width: {{ staff_utilization }}%"></div>
                                        {% endwith %}
                                    </div>
                                    <span class="badge badge-success">{{ staff_count }} / {{ institution.max_staff }}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" {% if institution.allows_online_enrollment %}checked{% endif %} disabled>
                                <label class="form-check-label">
                                    {% trans "Allows Online Enrollment" %}
                                </label>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" {% if institution.requires_parent_approval %}checked{% endif %} disabled>
                                <label class="form-check-label">
                                    {% trans "Requires Parent Approval" %}
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-xl-4 col-lg-5">
            <!-- System Information -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-info">
                        <i class="fas fa-server"></i> {% trans "System Information" %}
                    </h6>
                </div>
                <div class="card-body">
                    <table class="table table-sm table-borderless">
                        <tr>
                            <td class="text-muted">{% trans "API Key" %}</td>
                            <td><code class="small">{{ institution.api_key|truncatechars:20 }}</code></td>
                        </tr>
                        <tr>
                            <td class="text-muted">{% trans "Database Schema" %}</td>
                            <td>{{ institution.database_schema|default:"--" }}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">{% trans "Created" %}</td>
                            <td>{{ institution.created_at|date:"M d, Y" }}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">{% trans "Last Updated" %}</td>
                            <td>{{ institution.updated_at|date:"M d, Y H:i" }}</td>
                        </tr>
                        {% if institution.created_by %}
                        <tr>
                            <td class="text-muted">{% trans "Created By" %}</td>
                            <td>{{ institution.created_by.get_full_name }}</td>
                        </tr>
                        {% endif %}
                    </table>
                </div>
            </div>

            <!-- Configuration Overrides -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-warning">
                        <i class="fas fa-cogs"></i> {% trans "Configuration Overrides" %}
                    </h6>
                </div>
                <div class="card-body">
                    {% if config_overrides %}
                        <div class="list-group list-group-flush">
                            {% for override in config_overrides %}
                            <div class="list-group-item px-0">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <strong class="small">{{ override.system_config.key }}</strong>
                                        <div class="text-muted small">{{ override.system_config.get_config_type_display }}</div>
                                    </div>
                                    <span class="badge badge-info">{% trans "Override" %}</span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        <div class="mt-3">
                            <a href="{% url 'core:institution_config_overrides' institution.id %}" class="btn btn-outline-info btn-sm w-100">
                                <i class="fas fa-edit"></i> {% trans "Manage Overrides" %}
                            </a>
                        </div>
                    {% else %}
                        <div class="text-center text-muted py-3">
                            <i class="fas fa-cogs fa-2x mb-2"></i>
                            <p class="small mb-2">{% trans "No configuration overrides" %}</p>
                            <a href="{% url 'core:institution_config_overrides' institution.id %}" class="btn btn-outline-info btn-sm">
                                {% trans "Add Override" %}
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-bolt"></i> {% trans "Quick Actions" %}
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{% url 'core:institution_update' institution.id %}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-edit"></i> {% trans "Edit Institution" %}
                        </a>
                        <a href="{% url 'core:institution_config_overrides' institution.id %}" class="btn btn-outline-info btn-sm">
                            <i class="fas fa-cogs"></i> {% trans "Config Overrides" %}
                        </a>
                        {% if institution.is_active %}
                        <button class="btn btn-outline-warning btn-sm" onclick="toggleInstitutionStatus()">
                            <i class="fas fa-pause"></i> {% trans "Deactivate" %}
                        </button>
                        {% else %}
                        <button class="btn btn-outline-success btn-sm" onclick="toggleInstitutionStatus()">
                            <i class="fas fa-play"></i> {% trans "Activate" %}
                        </button>
                        {% endif %}
                        <button class="btn btn-outline-danger btn-sm" onclick="deleteInstitution()">
                            <i class="fas fa-trash"></i> {% trans "Delete Institution" %}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.border-left-primary {
    border-left: 0.25rem solid #4e73df !important;
}
.border-left-success {
    border-left: 0.25rem solid #1cc88a !important;
}
.border-left-info {
    border-left: 0.25rem solid #36b9cc !important;
}
.border-left-warning {
    border-left: 0.25rem solid #f6c23e !important;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Initialize any interactive elements
    console.log('Institution detail page loaded');
});

function toggleInstitutionStatus() {
    const isActive = {{ institution.is_active|lower }};
    const action = isActive ? 'deactivate' : 'activate';
    const confirmMessage = isActive
        ? '{% trans "Are you sure you want to deactivate this institution? Users will lose access." %}'
        : '{% trans "Are you sure you want to activate this institution?" %}';

    if (confirm(confirmMessage)) {
        // In real implementation, this would be an AJAX call
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `{% url 'core:institution_update' institution.id %}`;

        const statusField = document.createElement('input');
        statusField.type = 'hidden';
        statusField.name = 'is_active';
        statusField.value = (!isActive).toString();

        const csrfField = document.createElement('input');
        csrfField.type = 'hidden';
        csrfField.name = 'csrfmiddlewaretoken';
        csrfField.value = '{{ csrf_token }}';

        form.appendChild(statusField);
        form.appendChild(csrfField);
        document.body.appendChild(form);
        form.submit();
    }
}

function deleteInstitution() {
    if (confirm('{% trans "Are you sure you want to delete this institution? This action cannot be undone and will permanently remove all associated data." %}')) {
        // In real implementation, this would be an AJAX call or form submission
        window.location.href = `{% url 'core:institution_delete' institution.id %}`;
    }
}
</script>
{% endblock %}
