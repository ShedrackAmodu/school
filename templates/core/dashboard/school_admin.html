{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">{{ page_title }}</h1>
            <p class="text-muted">{% trans "School administration overview and key metrics" %}</p>
        </div>
        <div class="d-flex gap-2">
            {% if current_session %}
                <span class="badge bg-primary fs-6">{{ current_session.name }}</span>
            {% endif %}
            <small class="text-muted">{{ request.user.get_full_name }}</small>
        </div>
    </div>

    <!-- Quick Stats Cards -->
    <div class="row mb-4">
        <!-- Students -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                {% trans "Total Students" %}
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ quick_stats.total_students }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-users fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Teachers -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                {% trans "Total Teachers" %}
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ quick_stats.total_teachers }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-chalkboard-teacher fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Classes -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                {% trans "Total Classes" %}
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ quick_stats.total_classes }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-school fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Attendance Rate -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                {% trans "Avg Attendance" %}
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ quick_stats.attendance_rate }}%</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-calendar-check fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Financial Overview -->
    <div class="row mb-4">
        <div class="col-lg-8 mb-4">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">{% trans "Financial Overview" %}</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-sm-4">
                            <div class="text-center">
                                <h4 class="text-success">${{ quick_stats.total_revenue|floatformat:2 }}</h4>
                                <small class="text-muted">{% trans "Total Revenue" %}</small>
                            </div>
                        </div>
                        <div class="col-sm-4">
                            <div class="text-center">
                                <h4 class="text-danger">${{ quick_stats.total_expenses|floatformat:2 }}</h4>
                                <small class="text-muted">{% trans "Total Expenses" %}</small>
                            </div>
                        </div>
                        <div class="col-sm-4">
                            <div class="text-center">
                                <h4 class="text-warning">${{ quick_stats.pending_payments|floatformat:2 }}</h4>
                                <small class="text-muted">{% trans "Pending Payments" %}</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4 mb-4">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">{% trans "Quick Actions" %}</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{% url 'academics:student_list' %}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-users"></i> {% trans "Manage Students" %}
                        </a>
                        <a href="{% url 'academics:teacher_list' %}" class="btn btn-outline-success btn-sm">
                            <i class="fas fa-chalkboard-teacher"></i> {% trans "Manage Teachers" %}
                        </a>
                        <a href="{% url 'finance:invoice_list' %}" class="btn btn-outline-info btn-sm">
                            <i class="fas fa-dollar-sign"></i> {% trans "View Finances" %}
                        </a>
                        <a href="{% url 'communication:announcement_list' %}" class="btn btn-outline-warning btn-sm">
                            <i class="fas fa-bullhorn"></i> {% trans "Manage Announcements" %}
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Row -->
    <div class="row">
        <!-- Pending Applications -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">{% trans "Pending Applications" %}</h6>
                    <a href="{% url 'users:pending_applications' %}" class="btn btn-sm btn-outline-primary">
                        {% trans "View All" %}
                    </a>
                </div>
                <div class="card-body">
                    {% if pending_student_applications or pending_staff_applications %}
                        <div class="list-group list-group-flush">
                            {% for app in pending_student_applications %}
                            <div class="list-group-item px-0">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>{{ app.first_name }} {{ app.last_name }}</strong>
                                        <br><small class="text-muted">{% trans "Student Application" %} • {{ app.application_date|date:"M d, Y" }}</small>
                                    </div>
                                    <span class="badge bg-warning">{% trans "Pending" %}</span>
                                </div>
                            </div>
                            {% endfor %}

                            {% for app in pending_staff_applications %}
                            <div class="list-group-item px-0">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>{{ app.first_name }} {{ app.last_name }}</strong>
                                        <br><small class="text-muted">{% trans "Staff Application" %} • {{ app.application_date|date:"M d, Y" }}</small>
                                    </div>
                                    <span class="badge bg-info">{% trans "Pending" %}</span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                            <h5>{% trans "All Caught Up!" %}</h5>
                            <p class="text-muted">{% trans "No pending applications to review." %}</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Recent Announcements -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">{% trans "Recent Announcements" %}</h6>
                    <a href="{% url 'communication:announcement_list' %}" class="btn btn-sm btn-outline-primary">
                        {% trans "View All" %}
                    </a>
                </div>
                <div class="card-body">
                    {% if recent_announcements %}
                        <div class="list-group list-group-flush">
                            {% for announcement in recent_announcements %}
                            <div class="list-group-item px-0">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <strong>{{ announcement.title }}</strong>
                                        <br><small class="text-muted">{{ announcement.get_announcement_type_display }} • {{ announcement.published_at|date:"M d, Y" }}</small>
                                    </div>
                                    {% if announcement.priority == 'urgent' %}
                                        <span class="badge bg-danger ms-2">{% trans "Urgent" %}</span>
                                    {% elif announcement.priority == 'high' %}
                                        <span class="badge bg-warning ms-2">{% trans "High" %}</span>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-bullhorn fa-3x text-muted mb-3"></i>
                            <h5>{% trans "No Recent Announcements" %}</h5>
                            <p class="text-muted">{% trans "Create announcements to communicate with stakeholders." %}</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- KPI Dashboard -->
    {% if school_kpis %}
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">{% trans "Key Performance Indicators" %}</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for kpi in school_kpis %}
                        <div class="col-lg-3 col-md-6 mb-4">
                            <div class="card border-left-primary h-100">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                                {{ kpi.name }}
                                            </div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                                {% if kpi_data|length > 0 and kpi.id in kpi_data %}
                                                    {% if kpi.value_type == 'percentage' %}
                                                        {{ kpi_data|get_item:kpi.id.value }}%
                                                    {% elif kpi.value_type == 'currency' %}
                                                        ${{ kpi_data|get_item:kpi.id.value|floatformat:2 }}
                                                    {% else %}
                                                        {{ kpi_data|get_item:kpi.id.value }}
                                                    {% endif %}
                                                {% else %}
                                                    --
                                                {% endif %}
                                            </div>
                                            {% if kpi_data|length > 0 and kpi.id in kpi_data and kpi_data|get_item:kpi.id.change_percentage %}
                                                <div class="text-xs">
                                                    {% if kpi_data|get_item:kpi.id.change_percentage > 0 %}
                                                        <span class="text-success">
                                                            <i class="fas fa-arrow-up"></i> +{{ kpi_data|get_item:kpi.id.change_percentage }}%
                                                        </span>
                                                    {% elif kpi_data|get_item:kpi.id.change_percentage < 0 %}
                                                        <span class="text-danger">
                                                            <i class="fas fa-arrow-down"></i> {{ kpi_data|get_item:kpi.id.change_percentage }}%
                                                        </span>
                                                    {% else %}
                                                        <span class="text-muted">
                                                            <i class="fas fa-minus"></i> 0%
                                                        </span>
                                                    {% endif %}
                                                </div>
                                            {% endif %}
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-chart-line fa-2x text-gray-300"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

</div>

<!-- Custom CSS for this page -->
<style>
.card {
    border: none;
    border-radius: 0.5rem;
}

.card-header {
    border-bottom: 1px solid #e3e6f0;
}

.border-left-primary {
    border-left: 0.25rem solid #4e73df !important;
}

.border-left-success {
    border-left: 0.25rem solid #1cc88a !important;
}

.border-left-info {
    border-left: 0.25rem solid #36b9cc !important;
}

.border-left-warning {
    border-left: 0.25rem solid #f6c23e !important;
}

.text-primary {
    color: #5a5c69 !important;
}

.text-success {
    color: #1cc88a !important;
}

.text-danger {
    color: #e74a3b !important;
}

.text-warning {
    color: #f6c23e !important;
}

.text-muted {
    color: #858796 !important;
}

.btn-outline-primary {
    color: #4e73df;
    border-color: #4e73df;
}

.btn-outline-primary:hover {
    color: #fff;
    background-color: #4e73df;
    border-color: #4e73df;
}

.badge {
    font-size: 0.7em;
}
</style>

<!-- Custom JavaScript for interactive elements -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('School Admin Dashboard loaded');

    // Initialize dashboard
    initializeDashboard();

    // Auto-refresh functionality
    let autoRefreshInterval = setInterval(function() {
        refreshDashboardMetrics();
    }, 300000); // Refresh every 5 minutes

    // Quick action buttons
    initializeQuickActions();

    // KPI trend indicators
    initializeKPITrends();

    // Application status updates
    initializeApplicationUpdates();

    function initializeDashboard() {
        // Add loading states
        addLoadingStates();

        // Initialize tooltips
        initializeTooltips();

        // Setup responsive design
        setupResponsiveDesign();
    }

    function addLoadingStates() {
        // Add loading indicators to cards that might be updated
        const metricCards = document.querySelectorAll('.card');
        metricCards.forEach(card => {
            card.addEventListener('click', function() {
                if (this.querySelector('a')) {
                    showLoadingState(this);
                }
            });
        });
    }

    function showLoadingState(element) {
        const originalContent = element.innerHTML;
        element.innerHTML = `
            <div class="card-body d-flex justify-content-center align-items-center">
                <div class="spinner-border spinner-border-sm text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <span class="ms-2">Loading...</span>
            </div>
        `;

        // Restore after 2 seconds (in case of slow navigation)
        setTimeout(() => {
            element.innerHTML = originalContent;
        }, 2000);
    }

    function initializeTooltips() {
        // Add tooltips to metric cards
        const tooltipElements = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        tooltipElements.forEach(element => {
            new bootstrap.Tooltip(element);
        });

        // Add dynamic tooltips
        const metricCards = document.querySelectorAll('.card');
        metricCards.forEach(card => {
            const header = card.querySelector('.card-header h6');
            if (header) {
                header.setAttribute('data-bs-toggle', 'tooltip');
                header.setAttribute('title', 'Click to view detailed information');
                new bootstrap.Tooltip(header);
            }
        });
    }

    function setupResponsiveDesign() {
        // Handle mobile responsiveness
        const handleResize = () => {
            const width = window.innerWidth;
            const cards = document.querySelectorAll('.col-xl-3, .col-md-6');

            if (width < 768) {
                // Mobile: stack cards vertically
                cards.forEach(card => {
                    card.classList.remove('col-xl-3', 'col-md-6');
                    card.classList.add('col-12', 'mb-3');
                });
            } else {
                // Desktop: restore grid layout
                cards.forEach(card => {
                    card.classList.remove('col-12');
                    card.classList.add('col-xl-3', 'col-md-6');
                });
            }
        };

        window.addEventListener('resize', handleResize);
        handleResize(); // Initial call
    }

    function initializeQuickActions() {
        const quickActionButtons = document.querySelectorAll('.btn-outline-primary, .btn-outline-success, .btn-outline-info, .btn-outline-warning');

        quickActionButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                // Add click tracking
                trackQuickAction(this.textContent.trim());

                // Add visual feedback
                this.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    this.style.transform = 'scale(1)';
                }, 150);
            });
        });
    }

    function initializeKPITrends() {
        const kpiCards = document.querySelectorAll('.card.border-left-primary');

        kpiCards.forEach(card => {
            const trendElement = card.querySelector('.text-success, .text-danger, .text-muted');
            if (trendElement) {
                // Add animation to trend indicators
                trendElement.style.transition = 'all 0.3s ease';
                trendElement.addEventListener('mouseenter', function() {
                    this.style.transform = 'scale(1.1)';
                });
                trendElement.addEventListener('mouseleave', function() {
                    this.style.transform = 'scale(1)';
                });
            }
        });
    }

    function initializeApplicationUpdates() {
        // Add real-time application count updates
        const applicationCards = document.querySelectorAll('.list-group-item');

        applicationCards.forEach(card => {
            card.addEventListener('click', function() {
                // Mark as read or handle click
                this.style.opacity = '0.7';
                setTimeout(() => {
                    this.style.opacity = '1';
                }, 200);
            });
        });
    }

    async function refreshDashboardMetrics() {
        try {
            // Fetch updated metrics from API
            const response = await fetch('/core/api/dashboard/metrics/', {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCSRFToken()
                }
            });

            if (response.ok) {
                const data = await response.json();
                updateDashboardMetrics(data);
            }
        } catch (error) {
            console.warn('Failed to refresh dashboard metrics:', error);
        }
    }

    function updateDashboardMetrics(data) {
        // Update student count
        if (data.total_students !== undefined) {
            updateMetric('.card:contains("Total Students") .h5', data.total_students);
        }

        // Update teacher count
        if (data.total_teachers !== undefined) {
            updateMetric('.card:contains("Total Teachers") .h5', data.total_teachers);
        }

        // Update attendance rate
        if (data.attendance_rate !== undefined) {
            updateMetric('.card:contains("Avg Attendance") .h5', data.attendance_rate + '%');
        }

        // Update financial metrics
        if (data.total_revenue !== undefined) {
            updateMetric('.text-success:contains("$")', '$' + data.total_revenue.toLocaleString());
        }

        if (data.pending_payments !== undefined) {
            updateMetric('.text-warning:contains("$")', '$' + data.pending_payments.toLocaleString());
        }

        // Show update notification
        showUpdateNotification();
    }

    function updateMetric(selector, value) {
        const element = document.querySelector(selector);
        if (element) {
            // Add transition effect
            element.style.transition = 'all 0.3s ease';
            element.style.transform = 'scale(1.05)';

            setTimeout(() => {
                element.textContent = value;
                element.style.transform = 'scale(1)';
            }, 150);
        }
    }

    function showUpdateNotification() {
        // Create and show a small notification
        const notification = document.createElement('div');
        notification.className = 'alert alert-info alert-dismissible fade show position-fixed';
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        notification.innerHTML = `
            <i class="fas fa-sync-alt"></i> Dashboard updated
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        document.body.appendChild(notification);

        // Auto-remove after 3 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 3000);
    }

    function trackQuickAction(action) {
        // Track user interactions (could send to analytics)
        console.log('Quick action clicked:', action);

        // Could send to analytics service
        if (typeof gtag !== 'undefined') {
            gtag('event', 'quick_action', {
                'action_name': action,
                'page_location': window.location.href
            });
        }
    }

    function getCSRFToken() {
        // Get CSRF token from cookies or meta tag
        const tokenElement = document.querySelector('meta[name="csrf-token"]');
        if (tokenElement) {
            return tokenElement.getAttribute('content');
        }

        // Fallback: get from cookies
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            const [name, value] = cookie.trim().split('=');
            if (name === 'csrftoken') {
                return value;
            }
        }
        return '';
    }

    // Add keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Ctrl/Cmd + R to refresh dashboard
        if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
            e.preventDefault();
            refreshDashboardMetrics();
            showUpdateNotification();
        }

        // Alt + A to focus on applications
        if (e.altKey && e.key === 'a') {
            e.preventDefault();
            const applicationsSection = document.querySelector('.card:contains("Pending Applications")');
            if (applicationsSection) {
                applicationsSection.scrollIntoView({ behavior: 'smooth' });
                applicationsSection.style.boxShadow = '0 0 0 3px rgba(0,123,255,0.25)';
                setTimeout(() => {
                    applicationsSection.style.boxShadow = '';
                }, 2000);
            }
        }
    });

    // Add print functionality
    const printButton = document.querySelector('.btn[onclick*="print"]');
    if (printButton) {
        printButton.addEventListener('click', function() {
            window.print();
        });
    }

    // Performance monitoring
    if ('performance' in window && 'getEntriesByType' in performance) {
        window.addEventListener('load', function() {
            setTimeout(() => {
                const navigation = performance.getEntriesByType('navigation')[0];
                const loadTime = navigation.loadEventEnd - navigation.fetchStart;

                console.log(`Dashboard loaded in ${loadTime.toFixed(2)}ms`);

                // Could send performance data to analytics
                if (typeof gtag !== 'undefined') {
                    gtag('event', 'page_load_time', {
                        'page_title': document.title,
                        'load_time': loadTime
                    });
                }
            }, 0);
        });
    }

    // Error handling
    window.addEventListener('error', function(e) {
        console.error('Dashboard error:', e.error);

        // Show user-friendly error message
        const errorDiv = document.createElement('div');
        errorDiv.className = 'alert alert-danger alert-dismissible fade show position-fixed';
        errorDiv.style.cssText = 'bottom: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        errorDiv.innerHTML = `
            <i class="fas fa-exclamation-triangle"></i> Something went wrong. Please refresh the page.
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        document.body.appendChild(errorDiv);

        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (errorDiv.parentNode) {
                errorDiv.remove();
            }
        }, 5000);
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
        }
    });
});
</script>
{% endblock %}
