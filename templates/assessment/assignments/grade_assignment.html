{% extends 'base/base.html' %}
{% load static %}

{% block title %}Grade Assignment - {{ submission.title }}{% endblock %}

{% block page_title %}Grade Assignment{% endblock %}

{% block breadcrumb_items %}
    <li class="breadcrumb-item"><a href="{% url 'assessment:assignment_list' %}">Assignments</a></li>
    <li class="breadcrumb-item"><a href="{% url 'assessment:assignment_detail' assignment_template.pk %}">{{ assignment_template.title|truncatewords:3 }}</a></li>
    <li class="breadcrumb-item active" aria-current="page">Grade Submission</li>
{% endblock %}

{% block page_actions %}
<div class="page-actions">
    <div class="btn-group" role="group">
        <a href="{% url 'assessment:assignment_detail' assignment_template.pk %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i> Back to Assignment
        </a>
        <button type="button" class="btn btn-outline-primary" id="saveDraftBtn">
            <i class="bi bi-file-earmark me-1"></i> Save Draft
        </button>
        <button type="button" class="btn btn-success" id="completeGradingBtn">
            <i class="bi bi-check-lg me-1"></i> Complete Grading
        </button>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="grade-assignment-container">
    <div class="row">
        <!-- Main Grading Area -->
        <div class="col-lg-8">
            <!-- Student Submission Card -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title mb-1">Student Submission</h5>
                            <div class="submission-meta">
                                <span class="badge bg-light text-dark me-2">
                                    <i class="bi bi-person me-1"></i>
                                    {{ submission.student.user.get_full_name }}
                                </span>
                                <span class="badge bg-light text-dark me-2">
                                    Attempt {{ submission.submission_attempt }}
                                </span>
                                {% if submission.is_late_submission %}
                                <span class="badge bg-danger me-2">
                                    <i class="bi bi-clock me-1"></i>Late Submission
                                </span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="submission-status">
                            <span class="badge submission-status submission-{{ submission.submission_status }}">
                                {{ submission.get_submission_status_display }}
                            </span>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Submission Content -->
                    {% if submission.submission_text %}
                    <div class="mb-4">
                        <h6 class="text-muted mb-3">Submission Text</h6>
                        <div class="submission-content p-3 bg-light rounded">
                            {{ submission.submission_text|linebreaks }}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Submission Attachment -->
                    {% if submission.submission_attachment %}
                    <div class="mb-4">
                        <h6 class="text-muted mb-3">Submitted File</h6>
                        <div class="submission-attachment">
                            <a href="{{ submission.submission_attachment.url }}" 
                               class="btn btn-outline-primary" 
                               target="_blank" 
                               download="{{ submission.submission_file_name|default:'submission' }}">
                                <i class="bi bi-download me-1"></i>
                                Download {{ submission.submission_file_name|default:"Attachment" }}
                            </a>
                            <small class="text-muted ms-2">
                                ({{ submission.submission_file_size|filesizeformat }})
                            </small>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Submission Details -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="detail-item">
                                <strong>Submitted:</strong>
                                <span>{{ submission.submission_date|date:"M d, Y H:i" }}</span>
                            </div>
                            {% if submission.is_late_submission %}
                            <div class="detail-item text-danger">
                                <strong>Late by:</strong>
                                <span>{{ submission.late_minutes }} minutes</span>
                            </div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <div class="detail-item">
                                <strong>Current Status:</strong>
                                <span class="badge submission-status submission-{{ submission.submission_status }}">
                                    {{ submission.get_submission_status_display }}
                                </span>
                            </div>
                            {% if submission.original_submission %}
                            <div class="detail-item">
                                <strong>Resubmission of:</strong>
                                <span>Attempt {{ submission.original_submission.submission_attempt }}</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Grading Form -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-check-square me-2"></i>Grading
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" id="gradingForm">
                        {% csrf_token %}
                        
                        <!-- Marks Section -->
                        <div class="grading-section mb-4">
                            <h6 class="section-title mb-3">Marks & Scoring</h6>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="marks-input-group">
                                        <label for="marks_obtained" class="form-label">
                                            Marks Obtained *
                                        </label>
                                        <div class="input-group">
                                            <input type="number" 
                                                   class="form-control" 
                                                   id="marks_obtained" 
                                                   name="marks_obtained"
                                                   min="0" 
                                                   max="{{ assignment_template.total_marks }}"
                                                   step="0.01"
                                                   value="{{ submission.marks_obtained|default:'' }}"
                                                   required>
                                            <span class="input-group-text">
                                                / {{ assignment_template.total_marks }}
                                            </span>
                                        </div>
                                        <div class="form-text">
                                            Enter marks between 0 and {{ assignment_template.total_marks }}
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="calculated-values">
                                        <div class="value-item">
                                            <strong>Percentage:</strong>
                                            <span id="percentageValue">0%</span>
                                        </div>
                                        {% if assignment_template.passing_marks %}
                                        <div class="value-item">
                                            <strong>Passing Status:</strong>
                                            <span id="passingStatus" class="badge bg-secondary">-</span>
                                        </div>
                                        {% endif %}
                                        {% if submission.is_late_submission and assignment_template.late_submission_penalty > 0 %}
                                        <div class="value-item">
                                            <strong>Late Penalty:</strong>
                                            <span class="text-danger">-{{ assignment_template.late_submission_penalty }}%</span>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Rubric Scoring -->
                        {% if assignment_template.grading_criteria %}
                        <div class="grading-section mb-4">
                            <h6 class="section-title mb-3">Rubric Assessment</h6>
                            <div class="rubric-container">
                                <div class="rubric-criteria">
                                    {{ assignment_template.grading_criteria|linebreaks }}
                                </div>
                                <div class="mt-3">
                                    <label class="form-label">Rubric Scores (JSON)</label>
                                    <textarea class="form-control" 
                                              id="rubric_scores" 
                                              name="rubric_scores" 
                                              rows="4" 
                                              placeholder='{"criteria1": 5, "criteria2": 10, ...}'>{{ submission.rubric_scores|default:'' }}</textarea>
                                    <div class="form-text">
                                        Enter rubric scores as JSON object. This is optional.
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Feedback Section -->
                        <div class="grading-section mb-4">
                            <h6 class="section-title mb-3">Feedback & Comments</h6>
                            
                            <div class="mb-3">
                                <label for="feedback" class="form-label">Teacher Feedback</label>
                                <textarea class="form-control" 
                                          id="feedback" 
                                          name="feedback" 
                                          rows="6" 
                                          placeholder="Provide constructive feedback to help the student improve...">{{ submission.feedback|default:'' }}</textarea>
                                <div class="form-text">
                                    Your feedback will be visible to the student.
                                </div>
                            </div>

                            <!-- Quick Feedback Templates -->
                            <div class="quick-feedback mb-3">
                                <label class="form-label">Quick Feedback Templates</label>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-secondary" data-template="excellent">
                                        Excellent Work
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" data-template="good">
                                        Good Effort
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" data-template="improve">
                                        Needs Improvement
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" data-template="resubmit">
                                        Please Resubmit
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Grading Options -->
                        <div class="grading-section">
                            <h6 class="section-title mb-3">Grading Options</h6>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" 
                                               type="checkbox" 
                                               id="notifyStudent" 
                                               name="notify_student" 
                                               checked>
                                        <label class="form-check-label" for="notifyStudent">
                                            Notify student via email
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" 
                                               type="checkbox" 
                                               id="allowResubmission" 
                                               name="allow_resubmission">
                                        <label class="form-check-label" for="allowResubmission">
                                            Allow resubmission
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Assignment Information -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="bi bi-info-circle me-2"></i>Assignment Details
                    </h6>
                </div>
                <div class="card-body">
                    <h6 class="mb-2">{{ assignment_template.title }}</h6>
                    <div class="assignment-meta mb-3">
                        <span class="badge assignment-type assignment-type-{{ assignment_template.assignment_type }} me-2">
                            {{ assignment_template.get_assignment_type_display }}
                        </span>
                        <span class="badge bg-light text-dark">
                            {{ assignment_template.subject.name }}
                        </span>
                    </div>
                    
                    <div class="info-item">
                        <strong>Total Marks:</strong>
                        <span>{{ assignment_template.total_marks }}</span>
                    </div>
                    {% if assignment_template.passing_marks %}
                    <div class="info-item">
                        <strong>Passing Marks:</strong>
                        <span>{{ assignment_template.passing_marks }}</span>
                    </div>
                    {% endif %}
                    <div class="info-item">
                        <strong>Weightage:</strong>
                        <span>{{ assignment_template.weightage }}%</span>
                    </div>
                    <div class="info-item">
                        <strong>Due Date:</strong>
                        <span>{{ assignment_template.due_date|date:"M d, Y H:i" }}</span>
                    </div>
                </div>
            </div>

            <!-- Student Information -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="bi bi-person me-2"></i>Student Information
                    </h6>
                </div>
                <div class="card-body">
                    <div class="student-profile text-center mb-3">
                        <div class="student-avatar bg-primary text-white rounded-circle mx-auto mb-2">
                            {{ submission.student.user.first_name|first }}{{ submission.student.user.last_name|first }}
                        </div>
                        <h6 class="mb-1">{{ submission.student.user.get_full_name }}</h6>
                        <p class="text-muted mb-2">{{ submission.student.roll_number }}</p>
                        <p class="small text-muted">
                            {{ assignment_template.academic_class|default:assignment_template.class_assigned }}
                        </p>
                    </div>
                    
                    <div class="student-stats">
                        <div class="stat-item">
                            <strong>Total Submissions:</strong>
                            <span>{{ submission_count }}</span>
                        </div>
                        <div class="stat-item">
                            <strong>Average Score:</strong>
                            <span id="studentAverage">-</span>
                        </div>
                        <div class="stat-item">
                            <strong>Submission Rate:</strong>
                            <span>{{ submission_rate|floatformat:1 }}%</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Grading Progress -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="bi bi-graph-up me-2"></i>Grading Progress
                    </h6>
                </div>
                <div class="card-body">
                    <div class="progress mb-3" style="height: 20px;">
                        <div class="progress-bar" role="progressbar" style="width: {{ completion_percentage }}%">
                            {{ completion_percentage }}%
                        </div>
                    </div>
                    <div class="grading-stats">
                        <div class="stat-item">
                            <strong>Graded:</strong>
                            <span>{{ graded_count }} / {{ submission_count }}</span>
                        </div>
                        <div class="stat-item">
                            <strong>Remaining:</strong>
                            <span>{{ remaining_count }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Navigation -->
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="bi bi-arrow-left-right me-2"></i>Quick Navigation
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{% url 'assessment:assignment_detail' assignment_template.pk %}" 
                           class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-list-ul me-1"></i> All Submissions
                        </a>
                        {% if previous_submission %}
                        <a href="{% url 'assessment:grade_assignment' previous_submission.pk %}" 
                           class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-arrow-left me-1"></i> Previous Submission
                        </a>
                        {% endif %}
                        {% if next_submission %}
                        <a href="{% url 'assessment:grade_assignment' next_submission.pk %}" 
                           class="btn btn-outline-secondary btn-sm">
                            Next Submission <i class="bi bi-arrow-right ms-1"></i>
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Save Confirmation Modal -->
<div class="modal fade" id="saveConfirmModal" tabindex="-1" aria-labelledby="saveConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="saveConfirmModalLabel">Save Grading Draft</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Save your grading progress as a draft? The student will not see this until you complete grading.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmSaveDraft">Save Draft</button>
            </div>
        </div>
    </div>
</div>

<!-- Complete Grading Modal -->
<div class="modal fade" id="completeGradingModal" tabindex="-1" aria-labelledby="completeGradingModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="completeGradingModalLabel">Complete Grading</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you ready to complete grading for this submission? This will:</p>
                <ul>
                    <li>Finalize the marks and feedback</li>
                    <li>Notify the student (if selected)</li>
                    <li>Update the submission status to "Graded"</li>
                </ul>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="confirmGrading">
                    <label class="form-check-label" for="confirmGrading">
                        I have reviewed all aspects of this submission
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirmCompleteGrading" disabled>
                    Complete Grading
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.grade-assignment-container {
    max-width: 100%;
}

.assignment-type {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.assignment-type-homework { background-color: #6f42c1; }
.assignment-type-classwork { background-color: #20c997; }
.assignment-type-project { background-color: #fd7e14; }
.assignment-type-research { background-color: #e83e8c; }
.assignment-type-presentation { background-color: #6f42c1; }
.assignment-type-quiz { background-color: #20c997; }
.assignment-type-exam { background-color: #dc3545; }
.assignment-type-lab_report { background-color: #0dcaf0; }
.assignment-type-essay { background-color: #ffc107; color: #000; }
.assignment-type-group_project { background-color: #198754; }

.submission-status {
    font-size: 0.875rem;
}

.submission-draft { background-color: #6c757d; }
.submission-submitted { background-color: #0dcaf0; color: #000; }
.submission-late { background-color: #fd7e14; }
.submission-under_review { background-color: #ffc107; color: #000; }
.submission-graded { background-color: #198754; }
.submission-returned { background-color: #6f42c1; }
.submission-resubmitted { background-color: #20c997; }
.submission-rejected { background-color: #dc3545; }

/* Section Styling */
.grading-section {
    padding: 1.5rem;
    border: 1px solid #e9ecef;
    border-radius: 0.5rem;
    background-color: #f8f9fa;
    margin-bottom: 1rem;
}

.grading-section:last-child {
    margin-bottom: 0;
}

.section-title {
    color: #495057;
    font-weight: 600;
    border-bottom: 2px solid #0d6efd;
    padding-bottom: 0.5rem;
}

/* Student Avatar */
.student-avatar {
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    font-weight: 600;
}

/* Info Items */
.info-item, .detail-item, .stat-item, .value-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
    border-bottom: 1px solid #f8f9fa;
}

.info-item:last-child, .detail-item:last-child, .stat-item:last-child, .value-item:last-child {
    border-bottom: none;
}

/* Submission Content */
.submission-content {
    max-height: 400px;
    overflow-y: auto;
    line-height: 1.6;
    background-color: white;
    border: 1px solid #dee2e6;
}

/* Marks Input */
.marks-input-group .input-group {
    max-width: 200px;
}

.calculated-values {
    background-color: white;
    padding: 1rem;
    border-radius: 0.375rem;
    border: 1px solid #dee2e6;
}

/* Quick Feedback */
.quick-feedback .btn-group {
    flex-wrap: wrap;
}

.quick-feedback .btn {
    margin-bottom: 0.25rem;
    font-size: 0.875rem;
}

/* Progress Bars */
.progress {
    background-color: #e9ecef;
}

.progress-bar {
    background-color: #0d6efd;
    transition: width 0.3s ease;
}

/* Rubric Container */
.rubric-container {
    background-color: white;
    padding: 1rem;
    border-radius: 0.375rem;
    border: 1px solid #dee2e6;
}

.rubric-criteria {
    line-height: 1.6;
    color: #495057;
}

/* Form Controls */
.form-control:focus, .form-select:focus {
    border-color: #86b7fe;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

/* Responsive Design */
@media (max-width: 768px) {
    .grading-section {
        padding: 1rem;
    }
    
    .student-avatar {
        width: 40px;
        height: 40px;
        font-size: 1rem;
    }
    
    .btn-group {
        flex-direction: column;
    }
    
    .btn-group .btn {
        margin-bottom: 0.5rem;
        border-radius: 0.375rem !important;
    }
}

/* Animation for marks calculation */
@keyframes highlight {
    0% { background-color: #e7f1ff; }
    100% { background-color: transparent; }
}

.highlight {
    animation: highlight 1s ease;
}

/* Status indicators */
.status-indicator {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 0.5rem;
}

.status-graded { background-color: #198754; }
.status-pending { background-color: #ffc107; }
.status-not-submitted { background-color: #6c757d; }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const gradingForm = document.getElementById('gradingForm');
    const marksInput = document.getElementById('marks_obtained');
    const percentageValue = document.getElementById('percentageValue');
    const passingStatus = document.getElementById('passingStatus');
    const feedbackTextarea = document.getElementById('feedback');
    const rubricScores = document.getElementById('rubric_scores');
    const saveDraftBtn = document.getElementById('saveDraftBtn');
    const completeGradingBtn = document.getElementById('completeGradingBtn');
    const saveConfirmModal = new bootstrap.Modal(document.getElementById('saveConfirmModal'));
    const completeGradingModal = new bootstrap.Modal(document.getElementById('completeGradingModal'));
    const confirmSaveDraft = document.getElementById('confirmSaveDraft');
    const confirmCompleteGrading = document.getElementById('confirmCompleteGrading');
    const confirmGradingCheckbox = document.getElementById('confirmGrading');

    // Initialize calculations
    updateCalculations();
    
    // Initialize event listeners
    initializeEventListeners();
    
    // Initialize quick feedback
    initializeQuickFeedback();
    
    // Initialize rubric helper
    initializeRubricHelper();

    function updateCalculations() {
        if (marksInput.value) {
            const marks = parseFloat(marksInput.value);
            const totalMarks = {{ assignment_template.total_marks }};
            const percentage = (marks / totalMarks) * 100;
            
            percentageValue.textContent = `${percentage.toFixed(1)}%`;
            percentageValue.classList.add('highlight');
            
            // Update passing status
            {% if assignment_template.passing_marks %}
            const passingMarks = {{ assignment_template.passing_marks }};
            if (marks >= passingMarks) {
                passingStatus.textContent = 'PASS';
                passingStatus.className = 'badge bg-success';
            } else {
                passingStatus.textContent = 'FAIL';
                passingStatus.className = 'badge bg-danger';
            }
            {% endif %}
            
            // Remove highlight after animation
            setTimeout(() => {
                percentageValue.classList.remove('highlight');
            }, 1000);
        } else {
            percentageValue.textContent = '0%';
            {% if assignment_template.passing_marks %}
            passingStatus.textContent = '-';
            passingStatus.className = 'badge bg-secondary';
            {% endif %}
        }
    }

    function initializeEventListeners() {
        // Marks calculation
        marksInput.addEventListener('input', updateCalculations);
        
        // Save draft functionality
        saveDraftBtn.addEventListener('click', function() {
            saveConfirmModal.show();
        });
        
        confirmSaveDraft.addEventListener('click', function() {
            saveGrading('draft');
            saveConfirmModal.hide();
        });
        
        // Complete grading functionality
        completeGradingBtn.addEventListener('click', function() {
            completeGradingModal.show();
        });
        
        confirmGradingCheckbox.addEventListener('change', function() {
            confirmCompleteGrading.disabled = !this.checked;
        });
        
        confirmCompleteGrading.addEventListener('click', function() {
            saveGrading('complete');
            completeGradingModal.hide();
        });
        
        // Form validation
        gradingForm.addEventListener('submit', function(e) {
            if (!validateForm()) {
                e.preventDefault();
                showToast('Please fix the errors before submitting', 'error');
            }
        });
        
        // Auto-save every 2 minutes
        setInterval(autoSaveDraft, 120000);
    }

    function initializeQuickFeedback() {
        const feedbackTemplates = {
            excellent: "Excellent work! Your submission demonstrates a thorough understanding of the concepts and shows great attention to detail. The arguments are well-structured and supported by appropriate evidence. Keep up the great work!",
            
            good: "Good effort on this assignment. Your submission addresses the main requirements and shows understanding of the key concepts. To improve further, consider providing more detailed examples and expanding on your analysis. Well done!",
            
            improve: "This submission meets some of the requirements but needs improvement in several areas. Please review the assignment guidelines and ensure you address all aspects of the prompt. Pay attention to [specific area for improvement]. Consider resubmitting after revisions.",
            
            resubmit: "This submission doesn't fully meet the assignment requirements. Please review the grading criteria and resubmit with the necessary improvements. Focus on [specific issues]. I'm available during office hours if you need clarification."
        };
        
        document.querySelectorAll('[data-template]').forEach(button => {
            button.addEventListener('click', function() {
                const template = this.getAttribute('data-template');
                if (feedbackTextarea.value && !feedbackTextarea.value.includes(feedbackTemplates[template])) {
                    if (confirm('Replace current feedback with template?')) {
                        feedbackTextarea.value = feedbackTemplates[template];
                    }
                } else {
                    feedbackTextarea.value = feedbackTemplates[template];
                }
                feedbackTextarea.focus();
            });
        });
    }

    function initializeRubricHelper() {
        // Validate JSON input
        if (rubricScores) {
            rubricScores.addEventListener('blur', function() {
                try {
                    if (this.value.trim()) {
                        JSON.parse(this.value);
                        this.classList.remove('is-invalid');
                        this.classList.add('is-valid');
                    }
                } catch (e) {
                    this.classList.remove('is-valid');
                    this.classList.add('is-invalid');
                    showToast('Invalid JSON format for rubric scores', 'error');
                }
            });
        }
    }

    function validateForm() {
        let isValid = true;
        
        // Validate marks
        if (!marksInput.value || marksInput.value === '') {
            marksInput.classList.add('is-invalid');
            isValid = false;
        } else {
            const marks = parseFloat(marksInput.value);
            if (marks < 0 || marks > {{ assignment_template.total_marks }}) {
                marksInput.classList.add('is-invalid');
                isValid = false;
            } else {
                marksInput.classList.remove('is-invalid');
                marksInput.classList.add('is-valid');
            }
        }
        
        // Validate rubric scores JSON
        if (rubricScores && rubricScores.value.trim()) {
            try {
                JSON.parse(rubricScores.value);
                rubricScores.classList.remove('is-invalid');
                rubricScores.classList.add('is-valid');
            } catch (e) {
                rubricScores.classList.add('is-invalid');
                isValid = false;
            }
        }
        
        return isValid;
    }

    function saveGrading(action) {
        // Create hidden input for action
        const actionInput = document.createElement('input');
        actionInput.type = 'hidden';
        actionInput.name = 'action';
        actionInput.value = action;
        gradingForm.appendChild(actionInput);
        
        // Submit form
        gradingForm.submit();
    }

    function autoSaveDraft() {
        if (marksInput.value || feedbackTextarea.value) {
            console.log('Auto-saving grading draft...');
            // In a real implementation, this would make an AJAX call
            showToast('Grading progress auto-saved', 'info');
        }
    }

    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-bg-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'primary'} border-0`;
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');
        
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;
        
        let toastContainer = document.querySelector('.toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
            document.body.appendChild(toastContainer);
        }
        
        toastContainer.appendChild(toast);
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
        
        toast.addEventListener('hidden.bs.toast', function() {
            toast.remove();
        });
    }

    // Load student average (this would typically come from an API)
    function loadStudentAverage() {
        // Simulate API call
        setTimeout(() => {
            const average = (Math.random() * 100).toFixed(1);
            document.getElementById('studentAverage').textContent = `${average}%`;
        }, 1000);
    }

    loadStudentAverage();
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl/Cmd + S to save draft
    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        document.getElementById('saveDraftBtn').click();
    }
    
    // Ctrl/Cmd + Enter to complete grading
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('completeGradingBtn').click();
    }
    
    // Escape to close modals
    if (e.key === 'Escape') {
        const openModal = document.querySelector('.modal.show');
        if (openModal) {
            bootstrap.Modal.getInstance(openModal).hide();
        }
    }
});
</script>
{% endblock %}