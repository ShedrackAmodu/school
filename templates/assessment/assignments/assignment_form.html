{% extends 'base.html' %}
{% load static %}

{% block title %}Create Assignment - Assessment{% endblock %}

{% block page_title %}
    {% if form.instance.pk %}Edit Assignment{% else %}Create New Assignment{% endif %}
{% endblock %}

{% block breadcrumb_items %}
    <li class="breadcrumb-item"><a href="{% url 'assessment:assignment_list' %}">Assignments</a></li>
    <li class="breadcrumb-item active" aria-current="page">
        {% if form.instance.pk %}Edit Assignment{% else %}Create Assignment{% endif %}
    </li>
{% endblock %}

{% block content %}
<div class="assignment-form-container">
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h5 class="card-title mb-0">
                <i class="bi bi-file-earmark-plus me-2"></i>
                {% if form.instance.pk %}Edit Assignment{% else %}Create New Assignment{% endif %}
            </h5>
        </div>
        <div class="card-body">
            <form method="post" enctype="multipart/form-data" id="assignmentForm" novalidate>
                {% csrf_token %}
                
                {% if form.non_field_errors %}
                <div class="alert alert-danger">
                    {% for error in form.non_field_errors %}
                        <p class="mb-0">{{ error }}</p>
                    {% endfor %}
                </div>
                {% endif %}
                
                <div class="row">
                    <!-- Basic Information Section -->
                    <div class="col-12">
                        <div class="form-section mb-4">
                            <h6 class="section-title border-bottom pb-2 mb-3">
                                <i class="bi bi-info-circle me-2"></i>Basic Information
                            </h6>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.title.id_for_label }}" class="form-label">{{ form.title.label }} *</label>
                                    {{ form.title }}
                                    {% if form.title.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.title.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.assignment_type.id_for_label }}" class="form-label">{{ form.assignment_type.label }} *</label>
                                    {{ form.assignment_type }}
                                    {% if form.assignment_type.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.assignment_type.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="{{ form.description.id_for_label }}" class="form-label">{{ form.description.label }} *</label>
                                {{ form.description }}
                                {% if form.description.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.description.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="mb-3">
                                <label for="{{ form.instructions.id_for_label }}" class="form-label">{{ form.instructions.label }}</label>
                                {{ form.instructions }}
                                {% if form.instructions.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.instructions.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Academic Context Section -->
                    <div class="col-12">
                        <div class="form-section mb-4">
                            <h6 class="section-title border-bottom pb-2 mb-3">
                                <i class="bi bi-book me-2"></i>Academic Context
                            </h6>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.subject.id_for_label }}" class="form-label">{{ form.subject.label }} *</label>
                                    {{ form.subject }}
                                    {% if form.subject.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.subject.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.academic_class.id_for_label }}" class="form-label">{{ form.academic_class.label }}</label>
                                    {{ form.academic_class }}
                                    {% if form.academic_class.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.academic_class.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.class_assigned.id_for_label }}" class="form-label">{{ form.class_assigned.label }}</label>
                                    {{ form.class_assigned }}
                                    {% if form.class_assigned.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.class_assigned.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    <div class="form-text">At least one class must be selected</div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.tags.id_for_label }}" class="form-label">{{ form.tags.label }}</label>
                                    {{ form.tags }}
                                    {% if form.tags.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.tags.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    <div class="form-text">Comma-separated tags</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Timing & Dates Section -->
                    <div class="col-12">
                        <div class="form-section mb-4">
                            <h6 class="section-title border-bottom pb-2 mb-3">
                                <i class="bi bi-calendar-event me-2"></i>Timing & Dates
                            </h6>
                            
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="{{ form.publish_date.id_for_label }}" class="form-label">{{ form.publish_date.label }} *</label>
                                    {{ form.publish_date }}
                                    {% if form.publish_date.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.publish_date.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label for="{{ form.due_date.id_for_label }}" class="form-label">{{ form.due_date.label }} *</label>
                                    {{ form.due_date }}
                                    {% if form.due_date.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.due_date.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label for="{{ form.assigned_date.id_for_label }}" class="form-label">{{ form.assigned_date.label }}</label>
                                    {{ form.assigned_date }}
                                    {% if form.assigned_date.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.assigned_date.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Grading & Marks Section -->
                    <div class="col-12">
                        <div class="form-section mb-4">
                            <h6 class="section-title border-bottom pb-2 mb-3">
                                <i class="bi bi-award me-2"></i>Grading & Marks
                            </h6>
                            
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="{{ form.total_marks.id_for_label }}" class="form-label">{{ form.total_marks.label }} *</label>
                                    {{ form.total_marks }}
                                    {% if form.total_marks.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.total_marks.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label for="{{ form.passing_marks.id_for_label }}" class="form-label">{{ form.passing_marks.label }}</label>
                                    {{ form.passing_marks }}
                                    {% if form.passing_marks.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.passing_marks.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label for="{{ form.weightage.id_for_label }}" class="form-label">{{ form.weightage.label }}</label>
                                    {{ form.weightage }}
                                    {% if form.weightage.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.weightage.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    <div class="form-text">{{ form.weightage.help_text }}</div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="{{ form.grading_criteria.id_for_label }}" class="form-label">{{ form.grading_criteria.label }}</label>
                                {{ form.grading_criteria }}
                                {% if form.grading_criteria.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.grading_criteria.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Submission Management Section -->
                    <div class="col-12">
                        <div class="form-section mb-4">
                            <h6 class="section-title border-bottom pb-2 mb-3">
                                <i class="bi bi-send me-2"></i>Submission Management
                            </h6>
                            
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <div class="form-check form-switch">
                                        {{ form.allow_late_submissions }}
                                        <label class="form-check-label" for="{{ form.allow_late_submissions.id_for_label }}">
                                            {{ form.allow_late_submissions.label }}
                                        </label>
                                    </div>
                                    {% if form.allow_late_submissions.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.allow_late_submissions.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label for="{{ form.late_submission_penalty.id_for_label }}" class="form-label">{{ form.late_submission_penalty.label }}</label>
                                    {{ form.late_submission_penalty }}
                                    {% if form.late_submission_penalty.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.late_submission_penalty.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    <div class="form-text">{{ form.late_submission_penalty.help_text }}</div>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label for="{{ form.max_submission_attempts.id_for_label }}" class="form-label">{{ form.max_submission_attempts.label }}</label>
                                    {{ form.max_submission_attempts }}
                                    {% if form.max_submission_attempts.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.max_submission_attempts.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- File Management Section -->
                    <div class="col-12">
                        <div class="form-section mb-4">
                            <h6 class="section-title border-bottom pb-2 mb-3">
                                <i class="bi bi-paperclip me-2"></i>File Management
                            </h6>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.attachment.id_for_label }}" class="form-label">{{ form.attachment.label }}</label>
                                    {{ form.attachment }}
                                    {% if form.attachment.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.attachment.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.max_file_size.id_for_label }}" class="form-label">{{ form.max_file_size.label }}</label>
                                    {{ form.max_file_size }}
                                    {% if form.max_file_size.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.max_file_size.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    <div class="form-text">{{ form.max_file_size.help_text }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="d-flex justify-content-between mt-4">
                    <a href="{% url 'assessment:assignment_list' %}" class="btn btn-secondary">
                        <i class="bi bi-arrow-left me-1"></i> Cancel
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-lg me-1"></i>
                        {% if form.instance.pk %}Update Assignment{% else %}Create Assignment{% endif %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previewModalLabel">Assignment Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="previewContent">
                <!-- Preview content will be inserted here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.assignment-form-container {
    max-width: 100%;
}

.form-section {
    background-color: #f8f9fa;
    border-radius: 0.5rem;
    padding: 1.5rem;
    border: 1px solid #e9ecef;
}

.section-title {
    color: #495057;
    font-weight: 600;
}

.form-label {
    font-weight: 500;
    margin-bottom: 0.5rem;
}

.form-control, .form-select {
    border-radius: 0.375rem;
    border: 1px solid #ced4da;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.form-control:focus, .form-select:focus {
    border-color: #86b7fe;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

.form-check-input:checked {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

.invalid-feedback {
    display: block;
}

.btn {
    border-radius: 0.375rem;
    padding: 0.5rem 1rem;
    font-weight: 500;
}

.btn-primary {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

.btn-primary:hover {
    background-color: #0b5ed7;
    border-color: #0a58ca;
}

.card {
    border: none;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    border-radius: 0.5rem;
}

.card-header {
    border-radius: 0.5rem 0.5rem 0 0 !important;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .form-section {
        padding: 1rem;
    }
    
    .section-title {
        font-size: 1rem;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const assignmentForm = document.getElementById('assignmentForm');
    const publishDateInput = document.getElementById('id_publish_date');
    const dueDateInput = document.getElementById('id_due_date');
    const totalMarksInput = document.getElementById('id_total_marks');
    const passingMarksInput = document.getElementById('id_passing_marks');
    const weightageInput = document.getElementById('id_weightage');
    const latePenaltyInput = document.getElementById('id_late_submission_penalty');
    const maxAttemptsInput = document.getElementById('id_max_submission_attempts');
    
    // Add Bootstrap validation classes
    const formInputs = assignmentForm.querySelectorAll('input, select, textarea');
    formInputs.forEach(input => {
        input.classList.add('form-control');
        
        // Add validation on blur
        input.addEventListener('blur', function() {
            validateField(this);
        });
    });
    
    // Special handling for checkboxes and file inputs
    const checkboxes = assignmentForm.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
        checkbox.classList.remove('form-control');
        checkbox.classList.add('form-check-input');
    });
    
    const fileInputs = assignmentForm.querySelectorAll('input[type="file"]');
    fileInputs.forEach(fileInput => {
        fileInput.classList.add('form-control');
    });
    
    // Date validation
    if (publishDateInput && dueDateInput) {
        publishDateInput.addEventListener('change', validateDates);
        dueDateInput.addEventListener('change', validateDates);
    }
    
    // Marks validation
    if (totalMarksInput && passingMarksInput) {
        totalMarksInput.addEventListener('change', validateMarks);
        passingMarksInput.addEventListener('change', validateMarks);
    }
    
    // Percentage validation
    if (weightageInput) {
        weightageInput.addEventListener('change', validatePercentage);
    }
    
    if (latePenaltyInput) {
        latePenaltyInput.addEventListener('change', validatePercentage);
    }
    
    // Max attempts validation
    if (maxAttemptsInput) {
        maxAttemptsInput.addEventListener('change', validateMaxAttempts);
    }
    
    // Form submission validation
    assignmentForm.addEventListener('submit', function(e) {
        if (!validateForm()) {
            e.preventDefault();
            showFormErrors();
        }
    });
    
    // Field validation functions
    function validateField(field) {
        const value = field.value.trim();
        const fieldName = field.name;
        
        // Clear previous validation
        field.classList.remove('is-invalid', 'is-valid');
        
        // Required field validation
        if (field.hasAttribute('required') && !value) {
            field.classList.add('is-invalid');
            return false;
        }
        
        // Field-specific validation
        switch(fieldName) {
            case 'total_marks':
                if (value && parseFloat(value) <= 0) {
                    field.classList.add('is-invalid');
                    return false;
                }
                break;
            case 'passing_marks':
                if (value && totalMarksInput.value && parseFloat(value) > parseFloat(totalMarksInput.value)) {
                    field.classList.add('is-invalid');
                    return false;
                }
                break;
            case 'weightage':
            case 'late_submission_penalty':
                if (value && (parseFloat(value) < 0 || parseFloat(value) > 100)) {
                    field.classList.add('is-invalid');
                    return false;
                }
                break;
            case 'max_submission_attempts':
                if (value && (parseInt(value) < 1 || parseInt(value) > 10)) {
                    field.classList.add('is-invalid');
                    return false;
                }
                break;
        }
        
        // If we made it here, field is valid
        if (value) {
            field.classList.add('is-valid');
        }
        return true;
    }
    
    function validateDates() {
        if (publishDateInput.value && dueDateInput.value) {
            const publishDate = new Date(publishDateInput.value);
            const dueDate = new Date(dueDateInput.value);
            
            if (dueDate <= publishDate) {
                dueDateInput.classList.add('is-invalid');
                return false;
            } else {
                dueDateInput.classList.remove('is-invalid');
                dueDateInput.classList.add('is-valid');
            }
        }
        return true;
    }
    
    function validateMarks() {
        if (totalMarksInput.value && passingMarksInput.value) {
            const totalMarks = parseFloat(totalMarksInput.value);
            const passingMarks = parseFloat(passingMarksInput.value);
            
            if (passingMarks > totalMarks) {
                passingMarksInput.classList.add('is-invalid');
                return false;
            } else {
                passingMarksInput.classList.remove('is-invalid');
                if (passingMarksInput.value) {
                    passingMarksInput.classList.add('is-valid');
                }
            }
        }
        return true;
    }
    
    function validatePercentage() {
        const field = this;
        const value = parseFloat(field.value);
        
        if (field.value && (value < 0 || value > 100)) {
            field.classList.add('is-invalid');
            return false;
        } else {
            field.classList.remove('is-invalid');
            if (field.value) {
                field.classList.add('is-valid');
            }
        }
        return true;
    }
    
    function validateMaxAttempts() {
        const value = parseInt(this.value);
        
        if (this.value && (value < 1 || value > 10)) {
            this.classList.add('is-invalid');
            return false;
        } else {
            this.classList.remove('is-invalid');
            if (this.value) {
                this.classList.add('is-valid');
            }
        }
        return true;
    }
    
    function validateForm() {
        let isValid = true;
        
        // Validate all fields
        formInputs.forEach(input => {
            if (!validateField(input)) {
                isValid = false;
            }
        });
        
        // Validate dates
        if (!validateDates()) {
            isValid = false;
        }
        
        // Validate marks
        if (!validateMarks()) {
            isValid = false;
        }
        
        // Validate at least one class is selected
        const academicClass = document.getElementById('id_academic_class');
        const classAssigned = document.getElementById('id_class_assigned');
        
        if ((!academicClass.value || academicClass.value === '') && 
            (!classAssigned.value || classAssigned.value === '')) {
            academicClass.classList.add('is-invalid');
            classAssigned.classList.add('is-invalid');
            isValid = false;
        }
        
        return isValid;
    }
    
    function showFormErrors() {
        // Scroll to first error
        const firstError = assignmentForm.querySelector('.is-invalid');
        if (firstError) {
            firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            firstError.focus();
        }
        
        // Show toast notification
        showToast('Please fix the errors in the form before submitting.', 'error');
    }
    
    function showToast(message, type = 'info') {
        // Create toast element
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-bg-${type === 'error' ? 'danger' : 'primary'} border-0`;
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');
        
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        `;
        
        // Add to toast container
        let toastContainer = document.querySelector('.toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
            document.body.appendChild(toastContainer);
        }
        
        toastContainer.appendChild(toast);
        
        // Initialize and show toast
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
        
        // Remove toast after it's hidden
        toast.addEventListener('hidden.bs.toast', function() {
            toast.remove();
        });
    }
    
    // Auto-calculate due date based on publish date and default offset
    if (publishDateInput && !dueDateInput.value) {
        publishDateInput.addEventListener('change', function() {
            if (this.value && !dueDateInput.value) {
                const publishDate = new Date(this.value);
                const dueDate = new Date(publishDate);
                dueDate.setDate(dueDate.getDate() + 7); // Default 7 days later
                
                // Format date for datetime-local input
                const formattedDueDate = dueDate.toISOString().slice(0, 16);
                dueDateInput.value = formattedDueDate;
            }
        });
    }
    
    // Auto-fill assigned date if empty
    const assignedDateInput = document.getElementById('id_assigned_date');
    if (assignedDateInput && !assignedDateInput.value) {
        const today = new Date().toISOString().split('T')[0];
        assignedDateInput.value = today;
    }
});
</script>
{% endblock %}