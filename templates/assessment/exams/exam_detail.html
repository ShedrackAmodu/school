{% extends 'base/base.html' %}
{% load static %}

{% block title %}{% if form.instance.pk %}Edit CBT{% else %}Create New CBT{% endif %}{% endblock %}

{% block page_title %}
    {% if form.instance.pk %}Edit CBT{% else %}Create New CBT{% endif %}
{% endblock %}

{% block breadcrumb_items %}
    <li class="breadcrumb-item"><a href="{% url 'assessment:exam_list' %}">CBTs</a></li>
    <li class="breadcrumb-item active" aria-current="page">
        {% if form.instance.pk %}Edit CBT{% else %}Create CBT{% endif %}
    </li>
{% endblock %}

{% block page_actions %}
<div class="page-actions">
    <div class="btn-group" role="group">
        <a href="{% url 'assessment:exam_list' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i> Cancel
        </a>
        <button type="button" class="btn btn-outline-primary" id="saveDraftBtn">
            <i class="bi bi-file-earmark me-1"></i> Save Draft
        </button>
        <button type="button" class="btn btn-success" id="publishBtn" {% if not form.instance.pk %}disabled{% endif %}>
            <i class="bi bi-send-check me-1"></i> Publish CBT
        </button>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="exam-form-container">
    <div class="row">
        <!-- Main Form -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-file-earmark-plus me-2"></i>
                        {% if form.instance.pk %}Edit CBT{% else %}Create New CBT{% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" id="examForm" novalidate>
                        {% csrf_token %}
                        
                        {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {% for error in form.non_field_errors %}
                                <p class="mb-0">{{ error }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}
                        
                        <!-- Basic Information Section -->
                        <div class="form-section mb-4">
                            <h6 class="section-title border-bottom pb-2 mb-3">
                                <i class="bi bi-info-circle me-2"></i>Basic Information
                            </h6>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.name.id_for_label }}" class="form-label">{{ form.name.label }} *</label>
                                    {{ form.name }}
                                    {% if form.name.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.name.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    <div class="form-text">Enter a descriptive name for the CBT</div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.code.id_for_label }}" class="form-label">{{ form.code.label }} *</label>
                                    {{ form.code }}
                                    {% if form.code.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.code.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    <div class="form-text">Unique CBT code identifier</div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.exam_type.id_for_label }}" class="form-label">{{ form.exam_type.label }} *</label>
                                    {{ form.exam_type }}
                                    {% if form.exam_type.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.exam_type.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.academic_class.id_for_label }}" class="form-label">{{ form.academic_class.label }} *</label>
                                    {{ form.academic_class }}
                                    {% if form.academic_class.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.academic_class.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.subject.id_for_label }}" class="form-label">{{ form.subject.label }} *</label>
                                    {{ form.subject }}
                                    {% if form.subject.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.subject.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.venue.id_for_label }}" class="form-label">{{ form.venue.label }}</label>
                                    {{ form.venue }}
                                    {% if form.venue.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.venue.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    <div class="form-text">CBT venue or room location</div>
                                </div>
                            </div>
                        </div>

                        <!-- Schedule Section -->
                        <div class="form-section mb-4">
                            <h6 class="section-title border-bottom pb-2 mb-3">
                                <i class="bi bi-calendar-event me-2"></i>Schedule
                            </h6>
                            
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="{{ form.exam_date.id_for_label }}" class="form-label">{{ form.exam_date.label }} *</label>
                                    {{ form.exam_date }}
                                    {% if form.exam_date.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.exam_date.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label for="{{ form.start_time.id_for_label }}" class="form-label">{{ form.start_time.label }} *</label>
                                    {{ form.start_time }}
                                    {% if form.start_time.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.start_time.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label for="{{ form.end_time.id_for_label }}" class="form-label">{{ form.end_time.label }} *</label>
                                    {{ form.end_time }}
                                    {% if form.end_time.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.end_time.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    <div class="form-text" id="durationDisplay">Duration: 0 minutes</div>
                                </div>
                            </div>
                        </div>

                        <!-- Marks Configuration -->
                        <div class="form-section mb-4">
                            <h6 class="section-title border-bottom pb-2 mb-3">
                                <i class="bi bi-award me-2"></i>Marks Configuration
                            </h6>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.total_marks.id_for_label }}" class="form-label">{{ form.total_marks.label }} *</label>
                                    {{ form.total_marks }}
                                    {% if form.total_marks.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.total_marks.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    <div class="form-text">Maximum marks for this CBT</div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.passing_marks.id_for_label }}" class="form-label">{{ form.passing_marks.label }} *</label>
                                    {{ form.passing_marks }}
                                    {% if form.passing_marks.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.passing_marks.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    <div class="form-text" id="passingPercentage">Passing percentage: 0%</div>
                                </div>
                            </div>
                        </div>

                        <!-- Instructions Section -->
                        <div class="form-section mb-4">
                            <h6 class="section-title border-bottom pb-2 mb-3">
                                <i class="bi bi-journal-text me-2"></i>Instructions & Guidelines
                            </h6>
                            
                            <div class="mb-3">
                                <label for="{{ form.instructions.id_for_label }}" class="form-label">{{ form.instructions.label }}</label>
                                {{ form.instructions }}
                                {% if form.instructions.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.instructions.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">Provide clear instructions for students</div>
                            </div>
                        </div>

                        <!-- Publication Settings -->
                        {% if form.instance.pk %}
                        <div class="form-section">
                            <h6 class="section-title border-bottom pb-2 mb-3">
                                <i class="bi bi-send me-2"></i>Publication Settings
                            </h6>
                            
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    {{ form.is_published }}
                                    <label class="form-check-label" for="{{ form.is_published.id_for_label }}">
                                        {{ form.is_published.label }}
                                    </label>
                                </div>
                                {% if form.is_published.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.is_published.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    Published CBTs are visible to students. Once published, changes may be restricted.
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </form>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Form Summary -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="bi bi-eye me-2"></i>Form Summary
                    </h6>
                </div>
                <div class="card-body">
                    <div class="summary-item mb-2">
                        <strong>CBT Name:</strong>
                        <span id="summaryName" class="text-muted">Not set</span>
                    </div>
                    <div class="summary-item mb-2">
                        <strong>Class:</strong>
                        <span id="summaryClass" class="text-muted">Not set</span>
                    </div>
                    <div class="summary-item mb-2">
                        <strong>Subject:</strong>
                        <span id="summarySubject" class="text-muted">Not set</span>
                    </div>
                    <div class="summary-item mb-2">
                        <strong>Date & Time:</strong>
                        <span id="summaryDateTime" class="text-muted">Not set</span>
                    </div>
                    <div class="summary-item mb-2">
                        <strong>Duration:</strong>
                        <span id="summaryDuration" class="text-muted">0 minutes</span>
                    </div>
                    <div class="summary-item">
                        <strong>Total Marks:</strong>
                        <span id="summaryMarks" class="text-muted">0</span>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="bi bi-lightning me-2"></i>Quick Actions
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-outline-primary" id="validateFormBtn">
                            <i class="bi bi-check-circle me-1"></i> Validate Form
                        </button>
                        <button type="button" class="btn btn-outline-secondary" id="clearFormBtn">
                            <i class="bi bi-arrow-clockwise me-1"></i> Clear Form
                        </button>
                        <button type="button" class="btn btn-outline-info" id="previewExamBtn">
                            <i class="bi bi-eye me-1"></i> Preview CBT
                        </button>
                    </div>
                </div>
            </div>

            <!-- Form Status -->
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="bi bi-clipboard-check me-2"></i>Form Status
                    </h6>
                </div>
                <div class="card-body">
                    <div class="status-indicators">
                        <div class="status-item mb-2">
                            <i class="bi bi-circle-fill text-success me-2" id="basicInfoStatus"></i>
                            <span>Basic Information</span>
                        </div>
                        <div class="status-item mb-2">
                            <i class="bi bi-circle-fill text-muted me-2" id="scheduleStatus"></i>
                            <span>Schedule</span>
                        </div>
                        <div class="status-item mb-2">
                            <i class="bi bi-circle-fill text-muted me-2" id="marksStatus"></i>
                            <span>Marks Configuration</span>
                        </div>
                        <div class="status-item">
                            <i class="bi bi-circle-fill text-success me-2" id="instructionsStatus"></i>
                            <span>Instructions (Optional)</span>
                        </div>
                    </div>
                    
                    <div class="completion-progress mt-3">
                        <div class="progress mb-2" style="height: 8px;">
                            <div class="progress-bar" id="completionProgress" style="width: 0%"></div>
                        </div>
                        <small class="text-muted" id="completionText">0% complete</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previewModalLabel">CBT Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="previewContent">
                <!-- Preview content will be inserted here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="document.getElementById('examForm').submit()">
                    Save CBT
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Save Options Modal -->
<div class="modal fade" id="saveOptionsModal" tabindex="-1" aria-labelledby="saveOptionsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="saveOptionsModalLabel">Save Options</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>How would you like to save this CBT?</p>
                <div class="form-check mb-2">
                    <input class="form-check-input" type="radio" name="saveOption" id="saveDraftOption" value="draft" checked>
                    <label class="form-check-label" for="saveDraftOption">
                        <strong>Save as Draft</strong><br>
                        <small class="text-muted">Save without publishing. Students won't see this CBT.</small>
                    </label>
                </div>
                {% if form.instance.pk %}
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="saveOption" id="savePublishOption" value="publish">
                    <label class="form-check-label" for="savePublishOption">
                        <strong>Save and Publish</strong><br>
                        <small class="text-muted">Publish this CBT to make it visible to students.</small>
                    </label>
                </div>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmSaveBtn">Save</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.exam-form-container {
    max-width: 100%;
}

.form-section {
    background-color: #f8f9fa;
    border-radius: 0.5rem;
    padding: 1.5rem;
    border: 1px solid #e9ecef;
}

.section-title {
    color: #495057;
    font-weight: 600;
}

.form-label {
    font-weight: 500;
    margin-bottom: 0.5rem;
}

.form-control, .form-select {
    border-radius: 0.375rem;
    border: 1px solid #ced4da;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.form-control:focus, .form-select:focus {
    border-color: #86b7fe;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

.invalid-feedback {
    display: block;
}

/* Summary Items */
.summary-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
    border-bottom: 1px solid #f8f9fa;
}

.summary-item:last-child {
    border-bottom: none;
}

/* Status Indicators */
.status-item {
    display: flex;
    align-items: center;
}

.status-item i {
    font-size: 0.75rem;
}

/* Progress Bar */
.progress {
    background-color: #e9ecef;
}

.progress-bar {
    transition: width 0.3s ease;
}

/* Form Validation States */
.is-valid {
    border-color: #198754;
    padding-right: calc(1.5em + 0.75rem);
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23198754' d='M2.3 6.73L.6 4.53c-.4-1.04.46-1.4 1.1-.8l1.1 1.4 3.4-3.8c.6-.63 1.6-.27 1.2.7l-4 4.6c-.43.5-.8.4-1.1.1z'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}

.is-invalid {
    border-color: #dc3545;
    padding-right: calc(1.5em + 0.75rem);
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath d='m5.8 3.6.4.4.4-.4'/%3e%3cpath d='M6 7v1'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}

/* Preview Styles */
.preview-content {
    max-height: 60vh;
    overflow-y: auto;
}

.preview-exam {
    padding: 1rem;
    background-color: #f8f9fa;
    border-radius: 0.375rem;
}

.preview-section {
    margin-bottom: 1.5rem;
    padding: 1rem;
    background-color: white;
    border-radius: 0.375rem;
    border: 1px solid #e9ecef;
}

.preview-section:last-child {
    margin-bottom: 0;
}

/* Responsive Design */
@media (max-width: 768px) {
    .form-section {
        padding: 1rem;
    }
    
    .section-title {
        font-size: 1rem;
    }
    
    .summary-item {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .summary-item strong {
        margin-bottom: 0.25rem;
    }
    
    .btn-group {
        flex-direction: column;
        width: 100%;
    }
    
    .btn-group .btn {
        margin-bottom: 0.5rem;
        border-radius: 0.375rem !important;
    }
}

/* Animation for status updates */
@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

.status-update {
    animation: pulse 0.5s ease-in-out;
}

/* Custom switch styling */
.form-check-input:checked {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

.form-check-input:focus {
    border-color: #86b7fe;
    outline: 0;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const examForm = document.getElementById('examForm');
    const saveDraftBtn = document.getElementById('saveDraftBtn');
    const publishBtn = document.getElementById('publishBtn');
    const validateFormBtn = document.getElementById('validateFormBtn');
    const clearFormBtn = document.getElementById('clearFormBtn');
    const previewExamBtn = document.getElementById('previewExamBtn');
    const previewModal = new bootstrap.Modal(document.getElementById('previewModal'));
    const saveOptionsModal = new bootstrap.Modal(document.getElementById('saveOptionsModal'));
    const confirmSaveBtn = document.getElementById('confirmSaveBtn');
    
    // Form elements
    const nameInput = document.getElementById('id_name');
    const codeInput = document.getElementById('id_code');
    const examTypeInput = document.getElementById('id_exam_type');
    const classInput = document.getElementById('id_academic_class');
    const subjectInput = document.getElementById('id_subject');
    const examDateInput = document.getElementById('id_exam_date');
    const startTimeInput = document.getElementById('id_start_time');
    const endTimeInput = document.getElementById('id_end_time');
    const totalMarksInput = document.getElementById('id_total_marks');
    const passingMarksInput = document.getElementById('id_passing_marks');
    const instructionsInput = document.getElementById('id_instructions');
    
    // Summary elements
    const summaryName = document.getElementById('summaryName');
    const summaryClass = document.getElementById('summaryClass');
    const summarySubject = document.getElementById('summarySubject');
    const summaryDateTime = document.getElementById('summaryDateTime');
    const summaryDuration = document.getElementById('summaryDuration');
    const summaryMarks = document.getElementById('summaryMarks');
    
    // Status elements
    const basicInfoStatus = document.getElementById('basicInfoStatus');
    const scheduleStatus = document.getElementById('scheduleStatus');
    const marksStatus = document.getElementById('marksStatus');
    const instructionsStatus = document.getElementById('instructionsStatus');
    const completionProgress = document.getElementById('completionProgress');
    const completionText = document.getElementById('completionText');
    
    // Initialize form
    initializeForm();
    
    // Initialize event listeners
    initializeEventListeners();
    
    // Auto-save every 30 seconds
    setInterval(autoSaveDraft, 30000);

    function initializeForm() {
        // Add Bootstrap classes to form inputs
        const formInputs = examForm.querySelectorAll('input, select, textarea');
        formInputs.forEach(input => {
            input.classList.add('form-control');
            
            // Add validation on blur
            input.addEventListener('blur', function() {
                validateField(this);
                updateSummary();
                updateCompletion();
            });
            
            // Add real-time validation for key fields
            if (input.name === 'total_marks' || input.name === 'passing_marks') {
                input.addEventListener('input', validateMarks);
            }
            
            if (input.name === 'start_time' || input.name === 'end_time') {
                input.addEventListener('change', calculateDuration);
            }
        });
        
        // Special handling for checkbox
        const isPublishedCheckbox = document.getElementById('id_is_published');
        if (isPublishedCheckbox) {
            isPublishedCheckbox.classList.remove('form-control');
            isPublishedCheckbox.classList.add('form-check-input');
        }
        
        // Set minimum date to today
        if (examDateInput) {
            const today = new Date().toISOString().split('T')[0];
            examDateInput.min = today;
        }
        
        // Initial calculations
        calculateDuration();
        validateMarks();
        updateSummary();
        updateCompletion();
    }

    function initializeEventListeners() {
        // Save draft button
        saveDraftBtn.addEventListener('click', function() {
            showSaveOptions('draft');
        });
        
        // Publish button
        publishBtn.addEventListener('click', function() {
            showSaveOptions('publish');
        });
        
        // Validate form button
        validateFormBtn.addEventListener('click', validateForm);
        
        // Clear form button
        clearFormBtn.addEventListener('click', clearForm);
        
        // Preview exam button
        previewExamBtn.addEventListener('click', previewExam);
        
        // Confirm save button
        confirmSaveBtn.addEventListener('click', confirmSave);
        
        // Class change handler for subject filtering
        if (classInput) {
            classInput.addEventListener('change', function() {
                updateSubjectsForClass(this.value);
            });
        }
    }

    function validateField(field) {
        const value = field.value.trim();
        const fieldName = field.name;
        
        // Clear previous validation
        field.classList.remove('is-invalid', 'is-valid');
        
        // Required field validation
        if (field.hasAttribute('required') && !value) {
            field.classList.add('is-invalid');
            return false;
        }
        
        // Field-specific validation
        switch(fieldName) {
            case 'code':
                if (value && !/^[A-Za-z0-9_-]+$/.test(value)) {
                    field.classList.add('is-invalid');
                    return false;
                }
                break;
                
            case 'total_marks':
                if (value && parseFloat(value) <= 0) {
                    field.classList.add('is-invalid');
                    return false;
                }
                break;
                
            case 'passing_marks':
                if (value && totalMarksInput.value && parseFloat(value) > parseFloat(totalMarksInput.value)) {
                    field.classList.add('is-invalid');
                    return false;
                }
                break;
                
            case 'exam_date':
                if (value) {
                    const selectedDate = new Date(value);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    
                    if (selectedDate < today) {
                        field.classList.add('is-invalid');
                        return false;
                    }
                }
                break;
        }
        
        // If we made it here, field is valid
        if (value) {
            field.classList.add('is-valid');
        }
        return true;
    }

    function validateMarks() {
        if (totalMarksInput.value && passingMarksInput.value) {
            const totalMarks = parseFloat(totalMarksInput.value);
            const passingMarks = parseFloat(passingMarksInput.value);
            
            if (passingMarks > totalMarks) {
                passingMarksInput.classList.add('is-invalid');
            } else {
                passingMarksInput.classList.remove('is-invalid');
                passingMarksInput.classList.add('is-valid');
                
                // Update passing percentage
                const passingPercentage = (passingMarks / totalMarks) * 100;
                document.getElementById('passingPercentage').textContent = 
                    `Passing percentage: ${passingPercentage.toFixed(1)}%`;
            }
        }
    }

    function calculateDuration() {
        if (startTimeInput.value && endTimeInput.value) {
            const startTime = new Date(`2000-01-01T${startTimeInput.value}`);
            const endTime = new Date(`2000-01-01T${endTimeInput.value}`);
            
            if (endTime > startTime) {
                const duration = (endTime - startTime) / (1000 * 60); // Convert to minutes
                document.getElementById('durationDisplay').textContent = `Duration: ${Math.round(duration)} minutes`;
                document.getElementById('durationDisplay').classList.remove('text-danger');
            } else {
                document.getElementById('durationDisplay').textContent = 'End time must be after start time';
                document.getElementById('durationDisplay').classList.add('text-danger');
            }
        }
    }

    function updateSubjectsForClass(classId) {
        // This would typically make an AJAX call to get subjects for the selected class
        // For now, we'll just enable/disable the subject dropdown
        if (classId) {
            subjectInput.disabled = false;
        } else {
            subjectInput.disabled = true;
            subjectInput.value = '';
        }
    }

    function updateSummary() {
        // Update name
        summaryName.textContent = nameInput.value || 'Not set';
        summaryName.className = nameInput.value ? 'text-primary' : 'text-muted';
        
        // Update class
        if (classInput.value) {
            const selectedOption = classInput.options[classInput.selectedIndex];
            summaryClass.textContent = selectedOption.text;
            summaryClass.className = 'text-primary';
        } else {
            summaryClass.textContent = 'Not set';
            summaryClass.className = 'text-muted';
        }
        
        // Update subject
        if (subjectInput.value) {
            const selectedOption = subjectInput.options[subjectInput.selectedIndex];
            summarySubject.textContent = selectedOption.text;
            summarySubject.className = 'text-primary';
        } else {
            summarySubject.textContent = 'Not set';
            summarySubject.className = 'text-muted';
        }
        
        // Update date and time
        if (examDateInput.value && startTimeInput.value && endTimeInput.value) {
            const date = new Date(examDateInput.value).toLocaleDateString();
            summaryDateTime.textContent = `${date} ${startTimeInput.value} - ${endTimeInput.value}`;
            summaryDateTime.className = 'text-primary';
        } else {
            summaryDateTime.textContent = 'Not set';
            summaryDateTime.className = 'text-muted';
        }
        
        // Update duration
        if (startTimeInput.value && endTimeInput.value) {
            const start = new Date(`2000-01-01T${startTimeInput.value}`);
            const end = new Date(`2000-01-01T${endTimeInput.value}`);
            const duration = Math.round((end - start) / (1000 * 60));
            summaryDuration.textContent = `${duration} minutes`;
            summaryDuration.className = 'text-primary';
        } else {
            summaryDuration.textContent = '0 minutes';
            summaryDuration.className = 'text-muted';
        }
        
        // Update marks
        summaryMarks.textContent = totalMarksInput.value || '0';
        summaryMarks.className = totalMarksInput.value ? 'text-primary' : 'text-muted';
    }

    function updateCompletion() {
        let completedFields = 0;
        const totalFields = 8; // Adjust based on required fields
        
        // Check required fields
        const requiredFields = [
            nameInput, codeInput, examTypeInput, classInput, subjectInput,
            examDateInput, startTimeInput, endTimeInput, totalMarksInput, passingMarksInput
        ];
        
        requiredFields.forEach(field => {
            if (field && field.value && field.value.trim()) {
                completedFields++;
            }
        });
        
        const completionPercentage = Math.round((completedFields / totalFields) * 100);
        
        // Update progress bar
        completionProgress.style.width = `${completionPercentage}%`;
        completionText.textContent = `${completionPercentage}% complete`;
        
        // Update status indicators
        updateStatusIndicators(completedFields, totalFields);
        
        // Enable/disable publish button
        publishBtn.disabled = completionPercentage < 80;
    }

    function updateStatusIndicators(completed, total) {
        const basicInfoComplete = nameInput.value && codeInput.value && examTypeInput.value && classInput.value && subjectInput.value;
        const scheduleComplete = examDateInput.value && startTimeInput.value && endTimeInput.value;
        const marksComplete = totalMarksInput.value && passingMarksInput.value;
        const instructionsComplete = true; // Instructions are optional
        
        // Update status colors
        basicInfoStatus.className = `bi bi-circle-fill me-2 ${basicInfoComplete ? 'text-success' : 'text-muted'}`;
        scheduleStatus.className = `bi bi-circle-fill me-2 ${scheduleComplete ? 'text-success' : 'text-muted'}`;
        marksStatus.className = `bi bi-circle-fill me-2 ${marksComplete ? 'text-success' : 'text-muted'}`;
        instructionsStatus.className = `bi bi-circle-fill me-2 ${instructionsComplete ? 'text-success' : 'text-muted'}`;
        
        // Add animation for status updates
        [basicInfoStatus, scheduleStatus, marksStatus, instructionsStatus].forEach(status => {
            status.classList.add('status-update');
            setTimeout(() => {
                status.classList.remove('status-update');
            }, 500);
        });
    }

    function validateForm() {
        let isValid = true;
        const formInputs = examForm.querySelectorAll('input, select, textarea');
        
        formInputs.forEach(input => {
            if (!validateField(input)) {
                isValid = false;
            }
        });
        
        if (isValid) {
            showToast('Form validation passed!', 'success');
        } else {
            showToast('Please fix the errors in the form', 'error');
            
            // Scroll to first error
            const firstError = examForm.querySelector('.is-invalid');
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                firstError.focus();
            }
        }
        
        return isValid;
    }

    function clearForm() {
        if (confirm('Are you sure you want to clear the form? All unsaved changes will be lost.')) {
            examForm.reset();
            updateSummary();
            updateCompletion();
            showToast('Form cleared successfully', 'info');
        }
    }

    function previewExam() {
        if (!validateForm()) {
            showToast('Please fix form errors before previewing', 'error');
            return;
        }
        
        const previewContent = document.getElementById('previewContent');
        previewContent.innerHTML = generatePreviewContent();
        previewModal.show();
    }

    function generatePreviewContent() {
        return `
            <div class="preview-exam">
                <div class="preview-section">
                    <h4>${nameInput.value || 'Exam Name'}</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Exam Code:</strong> ${codeInput.value || 'N/A'}</p>
                            <p><strong>Exam Type:</strong> ${examTypeInput.options[examTypeInput.selectedIndex]?.text || 'N/A'}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Class:</strong> ${classInput.options[classInput.selectedIndex]?.text || 'N/A'}</p>
                            <p><strong>Subject:</strong> ${subjectInput.options[subjectInput.selectedIndex]?.text || 'N/A'}</p>
                        </div>
                    </div>
                </div>
                
                <div class="preview-section">
                    <h5>Schedule</h5>
                    <div class="row">
                        <div class="col-md-4">
                            <p><strong>Date:</strong> ${examDateInput.value || 'N/A'}</p>
                        </div>
                        <div class="col-md-4">
                            <p><strong>Start Time:</strong> ${startTimeInput.value || 'N/A'}</p>
                        </div>
                        <div class="col-md-4">
                            <p><strong>End Time:</strong> ${endTimeInput.value || 'N/A'}</p>
                        </div>
                    </div>
                    ${examDateInput.value && startTimeInput.value && endTimeInput.value ? `
                    <p><strong>Duration:</strong> ${document.getElementById('durationDisplay').textContent}</p>
                    ` : ''}
                    ${document.getElementById('id_venue').value ? `
                    <p><strong>Venue:</strong> ${document.getElementById('id_venue').value}</p>
                    ` : ''}
                </div>
                
                <div class="preview-section">
                    <h5>Marks Configuration</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Total Marks:</strong> ${totalMarksInput.value || '0'}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Passing Marks:</strong> ${passingMarksInput.value || '0'}</p>
                        <p><strong>${document.getElementById('passingPercentage').textContent}</strong></p>
                        </div>
                    </div>
                </div>
                
                ${instructionsInput.value ? `
                <div class="preview-section">
                    <h5>Instructions</h5>
                    <div class="instructions-preview">
                        ${instructionsInput.value.replace(/\n/g, '<br>')}
                    </div>
                </div>
                ` : ''}
            </div>
        `;
    }

    function showSaveOptions(defaultOption) {
        // Set the default option
        document.getElementById(`save${defaultOption.charAt(0).toUpperCase() + defaultOption.slice(1)}Option`).checked = true;
        saveOptionsModal.show();
    }

    function confirmSave() {
        const saveOption = document.querySelector('input[name="saveOption"]:checked').value;
        
        if (saveOption === 'publish') {
            // Add publish parameter
            const publishInput = document.createElement('input');
            publishInput.type = 'hidden';
            publishInput.name = 'publish';
            publishInput.value = 'true';
            examForm.appendChild(publishInput);
        }
        
        saveOptionsModal.hide();
        
        if (validateForm()) {
            examForm.submit();
        }
    }

    function autoSaveDraft() {
        // Check if form has any data
        const hasData = Array.from(examForm.elements).some(element => 
            (element.type === 'text' || element.type === 'textarea' || element.type === 'select-one') && 
            element.value && element.value.trim()
        );
        
        if (hasData) {
            console.log('Auto-saving exam draft...');
            // In a real implementation, this would make an AJAX call
        }
    }

    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-bg-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'primary'} border-0`;
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');
        
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;
        
        let toastContainer = document.querySelector('.toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
            document.body.appendChild(toastContainer);
        }
        
        toastContainer.appendChild(toast);
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
        
        toast.addEventListener('hidden.bs.toast', function() {
            toast.remove();
        });
    }
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl/Cmd + S to save
    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        document.getElementById('saveDraftBtn').click();
    }
    
    // Ctrl/Cmd + Enter to validate
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('validateFormBtn').click();
    }
    
    // Ctrl/Cmd + P to preview
    if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
        e.preventDefault();
        document.getElementById('previewExamBtn').click();
    }
});
</script>
{% endblock %}