{% extends 'base/base.html' %}
{% load static %}

{% block title %}Exams - Assessment{% endblock %}

{% block page_title %}Exams{% endblock %}

{% block breadcrumb_items %}
    <li class="breadcrumb-item"><a href="{% url 'assessment:dashboard' %}">Dashboard</a></li>
    <li class="breadcrumb-item active" aria-current="page">Exams</li>
{% endblock %}

{% block page_actions %}
<div class="page-actions">
    <div class="btn-group" role="group">
        {% if user.teacher_profile %}
        <a href="{% url 'assessment:exam_create' %}" class="btn btn-primary">
            <i class="bi bi-plus-circle me-1"></i> Create Exam
        </a>
        {% endif %}
        <button type="button" class="btn btn-outline-secondary" id="filterToggle">
            <i class="bi bi-funnel me-1"></i> Filters
        </button>
        <button type="button" class="btn btn-outline-secondary" id="exportBtn">
            <i class="bi bi-download me-1"></i> Export
        </button>
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                <i class="bi bi-view-list me-1"></i> View
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item view-option active" href="#" data-view="list">List View</a></li>
                <li><a class="dropdown-item view-option" href="#" data-view="calendar">Calendar View</a></li>
                <li><a class="dropdown-item view-option" href="#" data-view="grid">Grid View</a></li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="exam-list-container">
    <!-- Filters Section -->
    <div class="card mb-4" id="filtersCard" style="display: none;">
        <div class="card-header">
            <h6 class="card-title mb-0">
                <i class="bi bi-funnel me-2"></i>Filter Exams
            </h6>
        </div>
        <div class="card-body">
            <form method="get" id="filterForm">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label for="class_id" class="form-label">Class</label>
                        <select class="form-select" id="class_id" name="class_id">
                            <option value="">All Classes</option>
                            {% for class in classes %}
                            <option value="{{ class.id }}" 
                                    {% if request.GET.class_id == class.id|stringformat:"i" %}selected{% endif %}>
                                {{ class.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-3">
                        <label for="subject_id" class="form-label">Subject</label>
                        <select class="form-select" id="subject_id" name="subject_id">
                            <option value="">All Subjects</option>
                            {% for subject in subjects %}
                            <option value="{{ subject.id }}" 
                                    {% if request.GET.subject_id == subject.id|stringformat:"i" %}selected{% endif %}>
                                {{ subject.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-3">
                        <label for="exam_type_id" class="form-label">Exam Type</label>
                        <select class="form-select" id="exam_type_id" name="exam_type_id">
                            <option value="">All Types</option>
                            {% for exam_type in exam_types %}
                            <option value="{{ exam_type.id }}" 
                                    {% if request.GET.exam_type_id == exam_type.id|stringformat:"i" %}selected{% endif %}>
                                {{ exam_type.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-3">
                        <label for="status" class="form-label">Status</label>
                        <select class="form-select" id="status" name="status">
                            <option value="">All Status</option>
                            <option value="upcoming" {% if request.GET.status == 'upcoming' %}selected{% endif %}>
                                Upcoming
                            </option>
                            <option value="today" {% if request.GET.status == 'today' %}selected{% endif %}>
                                Today
                            </option>
                            <option value="completed" {% if request.GET.status == 'completed' %}selected{% endif %}>
                                Completed
                            </option>
                            <option value="published" {% if request.GET.status == 'published' %}selected{% endif %}>
                                Published Only
                            </option>
                        </select>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-md-6">
                        <label for="exam_date_from" class="form-label">From Date</label>
                        <input type="date" class="form-control" id="exam_date_from" name="exam_date_from"
                               value="{{ request.GET.exam_date_from }}">
                    </div>
                    
                    <div class="col-md-6">
                        <label for="exam_date_to" class="form-label">To Date</label>
                        <input type="date" class="form-control" id="exam_date_to" name="exam_date_to"
                               value="{{ request.GET.exam_date_to }}">
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="d-flex justify-content-between">
                            <a href="{% url 'assessment:exam_list' %}" class="btn btn-outline-secondary">
                                Clear Filters
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-search me-1"></i> Apply Filters
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="stat-icon bg-primary">
                            <i class="bi bi-calendar-event"></i>
                        </div>
                        <div class="ms-3">
                            <h4 class="mb-0">{{ total_exams }}</h4>
                            <p class="text-muted mb-0">Total Exams</p>
                        </div>
                    </div>
                    <div class="stat-trend mt-2">
                        <span class="text-success">
                            <i class="bi bi-arrow-up me-1"></i>
                            {{ published_count }} published
                        </span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="stat-icon bg-warning">
                            <i class="bi bi-clock"></i>
                        </div>
                        <div class="ms-3">
                            <h4 class="mb-0" id="upcomingCount">0</h4>
                            <p class="text-muted mb-0">Upcoming</p>
                        </div>
                    </div>
                    <div class="stat-trend mt-2">
                        <span class="text-warning" id="nextExamText">No upcoming exams</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="stat-icon bg-success">
                            <i class="bi bi-check-circle"></i>
                        </div>
                        <div class="ms-3">
                            <h4 class="mb-0" id="completedCount">0</h4>
                            <p class="text-muted mb-0">Completed</p>
                        </div>
                    </div>
                    <div class="stat-trend mt-2">
                        <span class="text-success">
                            <i class="bi bi-graph-up me-1"></i>
                            This month
                        </span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="stat-icon bg-info">
                            <i class="bi bi-people"></i>
                        </div>
                        <div class="ms-3">
                            <h4 class="mb-0">{{ class_count }}</h4>
                            <p class="text-muted mb-0">Classes</p>
                        </div>
                    </div>
                    <div class="stat-trend mt-2">
                        <span class="text-info">
                            <i class="bi bi-book me-1"></i>
                            {{ subject_count }} subjects
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Exams List View -->
    <div class="view-container" id="listView">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-list-task me-2"></i>
                        Exam Schedule
                    </h5>
                    <div class="exam-stats">
                        <span class="badge bg-primary">{{ exams.paginator.count }} exams</span>
                    </div>
                </div>
            </div>
            <div class="card-body">
                {% if exams %}
                <div class="table-responsive">
                    <table class="table table-hover" id="examsTable">
                        <thead>
                            <tr>
                                <th>Exam Name</th>
                                <th>Class & Subject</th>
                                <th>Type</th>
                                <th>Date & Time</th>
                                <th>Marks</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for exam in exams %}
                            <tr class="exam-row" 
                                data-exam-date="{{ exam.exam_date|date:'Y-m-d' }}"
                                data-exam-type="{{ exam.exam_type.id }}"
                                data-class-id="{{ exam.academic_class.id }}"
                                data-subject-id="{{ exam.subject.id }}"
                                data-status="{% if exam.is_overdue %}completed{% elif exam.is_today %}today{% else %}upcoming{% endif %}">
                                <td>
                                    <div class="d-flex align-items-center">
                                        {% if not exam.is_published %}
                                        <i class="bi bi-eye-slash text-warning me-2" title="Not Published"></i>
                                        {% endif %}
                                        <div>
                                            <h6 class="mb-0">
                                                <a href="{% url 'assessment:exam_detail' exam.pk %}" class="text-decoration-none">
                                                    {{ exam.name }}
                                                </a>
                                            </h6>
                                            <small class="text-muted">{{ exam.code }}</small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div class="class-subject-info">
                                        <div class="class-name">{{ exam.academic_class }}</div>
                                        <div class="subject-name text-muted">{{ exam.subject.name }}</div>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge exam-type exam-type-{{ exam.exam_type.code|lower }}">
                                        {{ exam.exam_type.name }}
                                    </span>
                                </td>
                                <td>
                                    <div class="datetime-info">
                                        <div class="exam-date">{{ exam.exam_date|date:"M d, Y" }}</div>
                                        <div class="exam-time text-muted small">
                                            {{ exam.start_time|time:"H:i" }} - {{ exam.end_time|time:"H:i" }}
                                        </div>
                                        {% if exam.is_today %}
                                        <div class="today-badge badge bg-warning mt-1">Today</div>
                                        {% elif exam.is_upcoming %}
                                        <div class="countdown-badge badge bg-info mt-1">
                                            {{ exam.days_until }} days
                                        </div>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    <div class="marks-info">
                                        <small class="text-muted">{{ exam.total_marks }} total</small>
                                        <div class="passing-marks">
                                            Pass: {{ exam.passing_marks }}
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div class="status-badges">
                                        <span class="badge {% if exam.is_published %}bg-success{% else %}bg-warning{% endif %}">
                                            {% if exam.is_published %}Published{% else %}Draft{% endif %}
                                        </span>
                                        {% if exam.is_overdue %}
                                        <span class="badge bg-secondary mt-1">Completed</span>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <a href="{% url 'assessment:exam_detail' exam.pk %}" 
                                           class="btn btn-outline-primary" title="View Details">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        
                                        {% if user.teacher_profile and exam.academic_class in taught_classes %}
                                        <a href="{% url 'assessment:exam_update' exam.pk %}" 
                                           class="btn btn-outline-warning" title="Edit Exam">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        
                                        {% if exam.is_published %}
                                        <a href="{% url 'assessment:enter_marks' exam.pk %}" 
                                           class="btn btn-outline-success" title="Enter Marks">
                                            <i class="bi bi-pencil-square"></i>
                                        </a>
                                        {% endif %}
                                        
                                        {% if exam.is_upcoming %}
                                        <a href="{% url 'assessment:exam_attendance' exam.pk %}" 
                                           class="btn btn-outline-info" title="Take Attendance">
                                            <i class="bi bi-clipboard-check"></i>
                                        </a>
                                        {% endif %}
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                {% if exams.has_other_pages %}
                <nav aria-label="Exam pagination" class="mt-4">
                    <ul class="pagination justify-content-center">
                        {% if exams.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ exams.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                Previous
                            </a>
                        </li>
                        {% endif %}

                        {% for num in exams.paginator.page_range %}
                            {% if exams.number == num %}
                            <li class="page-item active">
                                <span class="page-link">{{ num }}</span>
                            </li>
                            {% else %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                    {{ num }}
                                </a>
                            </li>
                            {% endif %}
                        {% endfor %}

                        {% if exams.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ exams.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                Next
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}

                {% else %}
                <div class="text-center py-5">
                    <div class="empty-state">
                        <i class="bi bi-calendar-x display-1 text-muted"></i>
                        <h4 class="mt-3">No Exams Found</h4>
                        <p class="text-muted">
                            {% if user.student_profile %}
                            You don't have any exams scheduled yet.
                            {% else %}
                            No exams have been created yet.
                            {% endif %}
                        </p>
                        {% if user.teacher_profile %}
                        <a href="{% url 'assessment:exam_create' %}" class="btn btn-primary mt-3">
                            <i class="bi bi-plus-circle me-1"></i> Create Your First Exam
                        </a>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Calendar View (Hidden by default) -->
    <div class="view-container" id="calendarView" style="display: none;">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-calendar-week me-2"></i>Calendar View
                </h5>
            </div>
            <div class="card-body">
                <div id="examCalendar"></div>
            </div>
        </div>
    </div>

    <!-- Grid View (Hidden by default) -->
    <div class="view-container" id="gridView" style="display: none;">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-grid-3x3-gap me-2"></i>Grid View
                </h5>
            </div>
            <div class="card-body">
                <div class="row" id="examGrid">
                    {% for exam in exams %}
                    <div class="col-xl-4 col-lg-6 mb-4">
                        <div class="card exam-card h-100 
                                    {% if exam.is_today %}border-warning{% elif exam.is_overdue %}border-secondary{% else %}border-primary{% endif %}">
                            <div class="card-header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="card-title mb-0">{{ exam.name }}</h6>
                                    <span class="badge {% if exam.is_published %}bg-success{% else %}bg-warning{% endif %}">
                                        {% if exam.is_published %}Published{% else %}Draft{% endif %}
                                    </span>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="exam-meta mb-3">
                                    <div class="meta-item">
                                        <i class="bi bi-book text-muted me-2"></i>
                                        {{ exam.subject.name }}
                                    </div>
                                    <div class="meta-item">
                                        <i class="bi bi-people text-muted me-2"></i>
                                        {{ exam.academic_class }}
                                    </div>
                                    <div class="meta-item">
                                        <i class="bi bi-tag text-muted me-2"></i>
                                        {{ exam.exam_type.name }}
                                    </div>
                                </div>
                                
                                <div class="exam-schedule mb-3">
                                    <div class="schedule-item">
                                        <i class="bi bi-calendar text-muted me-2"></i>
                                        {{ exam.exam_date|date:"M d, Y" }}
                                    </div>
                                    <div class="schedule-item">
                                        <i class="bi bi-clock text-muted me-2"></i>
                                        {{ exam.start_time|time:"H:i" }} - {{ exam.end_time|time:"H:i" }}
                                    </div>
                                    {% if exam.venue %}
                                    <div class="schedule-item">
                                        <i class="bi bi-geo-alt text-muted me-2"></i>
                                        {{ exam.venue }}
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <div class="exam-marks">
                                    <div class="marks-total">
                                        <strong>Total Marks:</strong> {{ exam.total_marks }}
                                    </div>
                                    <div class="marks-passing">
                                        <strong>Passing:</strong> {{ exam.passing_marks }}
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer bg-transparent">
                                <div class="btn-group w-100" role="group">
                                    <a href="{% url 'assessment:exam_detail' exam.pk %}" class="btn btn-outline-primary btn-sm">
                                        View
                                    </a>
                                    {% if user.teacher_profile and exam.academic_class in taught_classes %}
                                    <a href="{% url 'assessment:exam_update' exam.pk %}" class="btn btn-outline-warning btn-sm">
                                        Edit
                                    </a>
                                    {% if exam.is_published %}
                                    <a href="{% url 'assessment:enter_marks' exam.pk %}" class="btn btn-outline-success btn-sm">
                                        Marks
                                    </a>
                                    {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Export Modal -->
<div class="modal fade" id="exportModal" tabindex="-1" aria-labelledby="exportModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exportModalLabel">Export Exams</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="exportForm">
                    <div class="mb-3">
                        <label for="exportFormat" class="form-label">Format</label>
                        <select class="form-select" id="exportFormat">
                            <option value="csv">CSV</option>
                            <option value="excel">Excel</option>
                            <option value="pdf">PDF</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="exportRange" class="form-label">Date Range</label>
                        <select class="form-select" id="exportRange">
                            <option value="all">All Exams</option>
                            <option value="upcoming">Upcoming Only</option>
                            <option value="completed">Completed Only</option>
                            <option value="custom">Custom Range</option>
                        </select>
                    </div>
                    <div class="mb-3" id="customRangeFields" style="display: none;">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="exportFrom" class="form-label">From Date</label>
                                <input type="date" class="form-control" id="exportFrom">
                            </div>
                            <div class="col-md-6">
                                <label for="exportTo" class="form-label">To Date</label>
                                <input type="date" class="form-control" id="exportTo">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmExport">Export</button>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions Modal -->
<div class="modal fade" id="quickActionsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Quick Actions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-grid gap-2">
                    {% if user.teacher_profile %}
                    <a href="{% url 'assessment:exam_create' %}" class="btn btn-outline-primary">
                        <i class="bi bi-plus-circle me-2"></i>Create Exam
                    </a>
                    <a href="{% url 'assessment:grading_overview' %}" class="btn btn-outline-success">
                        <i class="bi bi-check-square me-2"></i>Grade Exams
                    </a>
                    {% endif %}
                    <a href="{% url 'assessment:analytics' %}" class="btn btn-outline-info">
                        <i class="bi bi-graph-up me-2"></i>View Analytics
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.exam-list-container {
    max-width: 100%;
}

/* Stat Cards */
.stat-card {
    border: none;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    transition: transform 0.2s ease-in-out;
}

.stat-card:hover {
    transform: translateY(-2px);
}

.stat-icon {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.25rem;
}

.stat-trend {
    font-size: 0.875rem;
}

/* Exam Type Badges */
.exam-type {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.exam-type-midterm { background-color: #fd7e14; }
.exam-type-final { background-color: #dc3545; }
.exam-type-quiz { background-color: #20c997; }
.exam-type-unit-test { background-color: #6f42c1; }
.exam-type-practical { background-color: #0dcaf0; }
.exam-type-assignment { background-color: #ffc107; color: #000; }

/* Table Styling */
.table th {
    border-top: none;
    font-weight: 600;
    color: #495057;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.table td {
    vertical-align: middle;
}

.exam-row:hover {
    background-color: #f8f9fa;
}

/* Class and Subject Info */
.class-subject-info .class-name {
    font-weight: 500;
}

.class-subject-info .subject-name {
    font-size: 0.875rem;
}

/* DateTime Info */
.datetime-info {
    min-width: 140px;
}

.exam-date {
    font-weight: 500;
}

.exam-time {
    font-size: 0.875rem;
}

/* Status Badges */
.status-badges .badge {
    font-size: 0.75rem;
}

/* Grid View Cards */
.exam-card {
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
}

.exam-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
}

.exam-meta .meta-item {
    font-size: 0.875rem;
    margin-bottom: 0.5rem;
}

.exam-schedule .schedule-item {
    font-size: 0.875rem;
    margin-bottom: 0.25rem;
}

.exam-marks {
    font-size: 0.875rem;
    padding-top: 0.5rem;
    border-top: 1px solid #e9ecef;
}

/* Empty State */
.empty-state {
    color: #6c757d;
}

.empty-state i {
    opacity: 0.5;
}

/* Button Groups */
.btn-group-sm > .btn {
    padding: 0.25rem 0.5rem;
}

/* Calendar View */
#examCalendar {
    min-height: 600px;
}

/* Filter Tags */
.filter-tags .badge {
    font-size: 0.75rem;
    padding: 0.375rem 0.75rem;
}

/* Responsive Design */
@media (max-width: 768px) {
    .stat-card .d-flex {
        flex-direction: column;
        text-align: center;
    }
    
    .stat-icon {
        margin: 0 auto 0.5rem auto;
    }
    
    .table-responsive {
        font-size: 0.875rem;
    }
    
    .btn-group {
        flex-direction: column;
    }
    
    .btn-group-sm > .btn {
        margin-bottom: 0.25rem;
        border-radius: 0.375rem !important;
    }
    
    .exam-card .btn-group {
        flex-direction: row;
    }
}

/* Animation for view switching */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.view-container {
    animation: fadeIn 0.3s ease-in-out;
}

/* Custom scrollbar for tables */
.table-responsive::-webkit-scrollbar {
    height: 6px;
}

.table-responsive::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.table-responsive::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

.table-responsive::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* Highlight for today's exams */
.exam-row[data-status="today"] {
    background-color: #fff3cd;
    border-left: 4px solid #ffc107;
}

/* Countdown animation */
@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

.countdown-badge {
    animation: pulse 2s infinite;
}

/* Quick actions */
.quick-actions {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    z-index: 1000;
}

.quick-actions-btn {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    font-size: 1.5rem;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const filterToggle = document.getElementById('filterToggle');
    const filtersCard = document.getElementById('filtersCard');
    const exportBtn = document.getElementById('exportBtn');
    const exportModal = new bootstrap.Modal(document.getElementById('exportModal'));
    const confirmExport = document.getElementById('confirmExport');
    const viewOptions = document.querySelectorAll('.view-option');
    const viewContainers = document.querySelectorAll('.view-container');
    const examsTable = document.getElementById('examsTable');
    const exportRange = document.getElementById('exportRange');
    const customRangeFields = document.getElementById('customRangeFields');
    
    // Initialize dashboard
    initializeDashboard();
    
    // Initialize event listeners
    initializeEventListeners();
    
    // Calculate statistics
    calculateStatistics();
    
    // Initialize table features
    initializeTableFeatures();

    function initializeDashboard() {
        // Show filters if any filter is active
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.toString() && !urlParams.has('page')) {
            filtersCard.style.display = 'block';
            filterToggle.classList.add('active');
        }
        
        // Set current date as default for date inputs
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('exam_date_from').value = today;
    }

    function initializeEventListeners() {
        // Filter toggle functionality
        if (filterToggle && filtersCard) {
            filterToggle.addEventListener('click', function() {
                if (filtersCard.style.display === 'none') {
                    filtersCard.style.display = 'block';
                    filterToggle.classList.add('active');
                } else {
                    filtersCard.style.display = 'none';
                    filterToggle.classList.remove('active');
                }
            });
        }
        
        // Export functionality
        if (exportBtn) {
            exportBtn.addEventListener('click', function() {
                exportModal.show();
            });
        }
        
        if (confirmExport) {
            confirmExport.addEventListener('click', function() {
                exportData();
                exportModal.hide();
            });
        }
        
        // View switching
        viewOptions.forEach(option => {
            option.addEventListener('click', function(e) {
                e.preventDefault();
                const view = this.getAttribute('data-view');
                switchView(view);
                
                // Update active state
                viewOptions.forEach(opt => opt.classList.remove('active'));
                this.classList.add('active');
            });
        });
        
        // Export range change
        if (exportRange) {
            exportRange.addEventListener('change', function() {
                if (this.value === 'custom') {
                    customRangeFields.style.display = 'block';
                } else {
                    customRangeFields.style.display = 'none';
                }
            });
        }
        
        // Auto-refresh every minute for real-time updates
        setInterval(updateExamStatus, 60000);
    }

    function calculateStatistics() {
        const rows = document.querySelectorAll('.exam-row');
        let upcomingCount = 0;
        let completedCount = 0;
        let nextExam = null;
        const now = new Date();
        
        rows.forEach(row => {
            const examDate = new Date(row.getAttribute('data-exam-date'));
            const status = row.getAttribute('data-status');
            
            if (status === 'upcoming') {
                upcomingCount++;
                
                // Find the next upcoming exam
                if (!nextExam || examDate < nextExam.date) {
                    nextExam = {
                        date: examDate,
                        element: row
                    };
                }
            } else if (status === 'completed') {
                completedCount++;
            }
        });
        
        document.getElementById('upcomingCount').textContent = upcomingCount;
        document.getElementById('completedCount').textContent = completedCount;
        
        // Update next exam text
        const nextExamText = document.getElementById('nextExamText');
        if (nextExam) {
            const daysUntil = Math.ceil((nextExam.date - now) / (1000 * 60 * 60 * 24));
            nextExamText.textContent = `${daysUntil} days until next exam`;
            nextExamText.className = 'text-warning';
        } else {
            nextExamText.textContent = 'No upcoming exams';
            nextExamText.className = 'text-muted';
        }
    }

    function initializeTableFeatures() {
        if (examsTable) {
            // Add search functionality
            addTableSearch(examsTable);
            
            // Add sorting functionality
            addTableSorting(examsTable);
            
            // Add row highlighting
            addRowHighlighting();
        }
    }

    function addTableSearch(table) {
        const searchInput = document.createElement('input');
        searchInput.type = 'text';
        searchInput.className = 'form-control mb-3';
        searchInput.placeholder = 'Search exams...';
        searchInput.style.maxWidth = '300px';
        
        searchInput.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const rows = table.querySelectorAll('tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
            
            // Recalculate statistics after filtering
            calculateStatistics();
        });
        
        // Insert search input before the table
        const tableContainer = table.parentElement;
        tableContainer.insertBefore(searchInput, table);
    }

    function addTableSorting(table) {
        const headers = table.querySelectorAll('th');
        headers.forEach((header, index) => {
            if (index < headers.length - 1) { // Exclude actions column
                header.style.cursor = 'pointer';
                header.addEventListener('click', function() {
                    sortTable(table, index);
                });
            }
        });
    }

    function sortTable(table, columnIndex) {
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        const isAscending = !table.getAttribute('data-sort-asc');
        
        rows.sort((a, b) => {
            let aValue = a.cells[columnIndex].textContent.trim();
            let bValue = b.cells[columnIndex].textContent.trim();
            
            // Special handling for dates
            if (columnIndex === 3) {
                aValue = new Date(a.getAttribute('data-exam-date'));
                bValue = new Date(b.getAttribute('data-exam-date'));
            }
            
            // Special handling for marks
            if (columnIndex === 4) {
                aValue = extractMarksValue(aValue);
                bValue = extractMarksValue(bValue);
            }
            
            if (aValue < bValue) return isAscending ? -1 : 1;
            if (aValue > bValue) return isAscending ? 1 : -1;
            return 0;
        });
        
        // Remove existing rows
        while (tbody.firstChild) {
            tbody.removeChild(tbody.firstChild);
        }
        
        // Add sorted rows
        rows.forEach(row => tbody.appendChild(row));
        
        // Update sort indicator
        table.setAttribute('data-sort-asc', isAscending);
        updateSortIndicator(table, columnIndex, isAscending);
    }

    function extractMarksValue(text) {
        const match = text.match(/(\d+(\.\d+)?)/);
        return match ? parseFloat(match[1]) : 0;
    }

    function updateSortIndicator(table, columnIndex, isAscending) {
        const headers = table.querySelectorAll('th');
        headers.forEach(header => {
            header.classList.remove('sort-asc', 'sort-desc');
        });
        
        const currentHeader = headers[columnIndex];
        currentHeader.classList.add(isAscending ? 'sort-asc' : 'sort-desc');
    }

    function addRowHighlighting() {
        const rows = document.querySelectorAll('.exam-row');
        const now = new Date();
        
        rows.forEach(row => {
            const examDate = new Date(row.getAttribute('data-exam-date'));
            const isToday = examDate.toDateString() === now.toDateString();
            
            if (isToday) {
                row.classList.add('table-warning');
            }
        });
    }

    function switchView(view) {
        // Hide all views
        viewContainers.forEach(container => {
            container.style.display = 'none';
        });
        
        // Show selected view
        document.getElementById(`${view}View`).style.display = 'block';
        
        // Initialize calendar if switching to calendar view
        if (view === 'calendar') {
            initializeCalendar();
        }
    }

    function initializeCalendar() {
        const calendarEl = document.getElementById('examCalendar');
        
        // In a real implementation, this would use FullCalendar or similar
        // For now, we'll show a message
        calendarEl.innerHTML = `
            <div class="text-center py-5">
                <i class="bi bi-calendar-week display-4 text-muted mb-3"></i>
                <h5>Calendar View</h5>
                <p class="text-muted">Calendar integration would be implemented here.</p>
                <p class="text-muted">Showing ${document.querySelectorAll('.exam-row').length} exams.</p>
            </div>
        `;
    }

    function exportData() {
        const format = document.getElementById('exportFormat').value;
        const range = document.getElementById('exportRange').value;
        
        // Show loading state
        const exportBtn = document.querySelector('#exportBtn');
        const originalText = exportBtn.innerHTML;
        exportBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i> Exporting...';
        exportBtn.disabled = true;
        
        // Simulate export process
        setTimeout(() => {
            showToast(`Exams exported as ${format.toUpperCase()} successfully`, 'success');
            
            // Reset button
            exportBtn.innerHTML = originalText;
            exportBtn.disabled = false;
            
            // In real implementation, this would trigger a download
            console.log(`Exporting exams as ${format}, range: ${range}`);
        }, 2000);
    }

    function updateExamStatus() {
        // Update countdown badges and status in real-time
        const rows = document.querySelectorAll('.exam-row');
        const now = new Date();
        
        rows.forEach(row => {
            const examDate = new Date(row.getAttribute('data-exam-date'));
            const daysUntil = Math.ceil((examDate - now) / (1000 * 60 * 60 * 24));
            
            // Update countdown badge
            const countdownBadge = row.querySelector('.countdown-badge');
            if (countdownBadge && daysUntil >= 0) {
                countdownBadge.textContent = `${daysUntil} days`;
            }
            
            // Update status if exam date has passed
            if (daysUntil < 0 && row.getAttribute('data-status') === 'upcoming') {
                row.setAttribute('data-status', 'completed');
                const statusBadges = row.querySelector('.status-badges');
                if (statusBadges) {
                    statusBadges.innerHTML += '<span class="badge bg-secondary mt-1">Completed</span>';
                }
            }
        });
        
        // Recalculate statistics
        calculateStatistics();
    }

    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-bg-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'primary'} border-0`;
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');
        
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;
        
        let toastContainer = document.querySelector('.toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
            document.body.appendChild(toastContainer);
        }
        
        toastContainer.appendChild(toast);
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
        
        toast.addEventListener('hidden.bs.toast', function() {
            toast.remove();
        });
    }
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl/Cmd + F to toggle filters
    if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
        e.preventDefault();
        document.getElementById('filterToggle').click();
    }
    
    // Ctrl/Cmd + E to export
    if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
        e.preventDefault();
        document.getElementById('exportBtn').click();
    }
    
    // Ctrl/Cmd + 1/2/3 for view switching
    if ((e.ctrlKey || e.metaKey) && e.key >= '1' && e.key <= '3') {
        e.preventDefault();
        const viewIndex = parseInt(e.key) - 1;
        const viewOptions = document.querySelectorAll('.view-option');
        if (viewOptions[viewIndex]) {
            viewOptions[viewIndex].click();
        }
    }
});

// Add quick actions button for mobile
document.addEventListener('DOMContentLoaded', function() {
    if (window.innerWidth < 768) {
        const quickActionsBtn = document.createElement('button');
        quickActionsBtn.className = 'btn btn-primary quick-actions-btn';
        quickActionsBtn.innerHTML = '<i class="bi bi-lightning"></i>';
        quickActionsBtn.setAttribute('data-bs-toggle', 'modal');
        quickActionsBtn.setAttribute('data-bs-target', '#quickActionsModal');
        quickActionsBtn.style.position = 'fixed';
        quickActionsBtn.style.bottom = '2rem';
        quickActionsBtn.style.right = '2rem';
        quickActionsBtn.style.zIndex = '1000';
        
        document.body.appendChild(quickActionsBtn);
    }
});
</script>
{% endblock %}