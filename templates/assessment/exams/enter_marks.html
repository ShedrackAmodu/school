{% extends 'base/base.html' %}
{% load static %}

{% block title %}Enter Marks - {{ exam.name }}{% endblock %}

{% block page_title %}
    Enter Marks - {{ exam.name }}
{% endblock %}

{% block breadcrumb_items %}
    <li class="breadcrumb-item"><a href="{% url 'assessment:exam_list' %}">Exams</a></li>
    <li class="breadcrumb-item"><a href="{% url 'assessment:exam_detail' exam.id %}">{{ exam.name }}</a></li>
    <li class="breadcrumb-item active" aria-current="page">Enter Marks</li>
{% endblock %}

{% block page_actions %}
<div class="page-actions">
    <div class="btn-group" role="group">
        <a href="{% url 'assessment:exam_detail' exam.id %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i> Back to Exam
        </a>
        <button type="button" class="btn btn-outline-primary" id="saveDraftBtn">
            <i class="bi bi-file-earmark me-1"></i> Save Draft
        </button>
        <button type="button" class="btn btn-success" id="publishMarksBtn">
            <i class="bi bi-send-check me-1"></i> Publish Marks
        </button>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="enter-marks-container">
    <div class="row">
        <!-- Main Form -->
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-pencil-square me-2"></i>
                        Enter Marks - {{ exam.name }}
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Exam Summary -->
                    <div class="exam-summary mb-4 p-3 bg-light rounded">
                        <div class="row">
                            <div class="col-md-3">
                                <strong>Class:</strong> {{ exam.academic_class.name }}
                            </div>
                            <div class="col-md-3">
                                <strong>Subject:</strong> {{ exam.subject.name }}
                            </div>
                            <div class="col-md-3">
                                <strong>Total Marks:</strong> {{ exam.total_marks }}
                            </div>
                            <div class="col-md-3">
                                <strong>Passing Marks:</strong> {{ exam.passing_marks }}
                            </div>
                        </div>
                    </div>

                    <!-- Marks Entry Form -->
                    <form method="post" id="marksForm" novalidate>
                        {% csrf_token %}
                        
                        {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {% for error in form.non_field_errors %}
                                <p class="mb-0">{{ error }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}
                        
                        <!-- Student Marks Table -->
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="marksTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th width="5%">#</th>
                                        <th width="25%">Student Name</th>
                                        <th width="15%">Roll Number</th>
                                        <th width="15%">Marks Obtained</th>
                                        <th width="10%">Absent</th>
                                        <th width="10%">Grace Marks</th>
                                        <th width="20%">Remarks</th>
                                        <th width="10%">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for student in students %}
                                    {% with mark=existing_marks|get_item:student.student.id %}
                                    <tr class="student-row" data-student-id="{{ student.student.id }}">
                                        <td>{{ forloop.counter }}</td>
                                        <td>
                                            <strong>{{ student.student.user.get_full_name }}</strong>
                                        </td>
                                        <td>{{ student.student.roll_number|default:"-" }}</td>
                                        <td>
                                            <input type="number" 
                                                   class="form-control marks-input" 
                                                   name="marks_{{ student.student.id }}" 
                                                   value="{% if mark and not mark.is_absent %}{{ mark.marks_obtained }}{% endif %}"
                                                   min="0" 
                                                   max="{{ exam.total_marks }}" 
                                                   step="0.01"
                                                   {% if mark and mark.is_absent %}disabled{% endif %}>
                                            <small class="form-text text-muted">Max: {{ exam.total_marks }}</small>
                                        </td>
                                        <td class="text-center">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input absent-checkbox" 
                                                       type="checkbox" 
                                                       name="absent_{{ student.student.id }}"
                                                       {% if mark and mark.is_absent %}checked{% endif %}>
                                            </div>
                                        </td>
                                        <td>
                                            <input type="number" 
                                                   class="form-control grace-marks-input" 
                                                   name="grace_{{ student.student.id }}" 
                                                   value="{% if mark %}{{ mark.grace_marks }}{% else %}0{% endif %}"
                                                   min="0" 
                                                   max="{{ exam.total_marks }}" 
                                                   step="0.01">
                                        </td>
                                        <td>
                                            <input type="text" 
                                                   class="form-control remarks-input" 
                                                   name="remarks_{{ student.student.id }}" 
                                                   value="{% if mark %}{{ mark.remarks }}{% endif %}"
                                                   placeholder="Optional remarks">
                                        </td>
                                        <td class="status-cell">
                                            <span class="badge {% if mark %}bg-success{% else %}bg-secondary{% endif %}">
                                                {% if mark %}Saved{% else %}Pending{% endif %}
                                            </span>
                                        </td>
                                    </tr>
                                    {% endwith %}
                                    {% empty %}
                                    <tr>
                                        <td colspan="8" class="text-center text-muted py-4">
                                            <i class="bi bi-people display-4 d-block mb-2"></i>
                                            No students found in this class.
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Bulk Actions -->
                        <div class="bulk-actions mt-4 p-3 bg-light rounded">
                            <h6 class="mb-3">
                                <i class="bi bi-lightning me-2"></i>Bulk Actions
                            </h6>
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <button type="button" class="btn btn-outline-primary w-100" id="markAllPresentBtn">
                                        <i class="bi bi-check-circle me-1"></i> Mark All Present
                                    </button>
                                </div>
                                <div class="col-md-3">
                                    <button type="button" class="btn btn-outline-warning w-100" id="markAllAbsentBtn">
                                        <i class="bi bi-x-circle me-1"></i> Mark All Absent
                                    </button>
                                </div>
                                <div class="col-md-3">
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="bulkMarksInput" placeholder="Marks">
                                        <button type="button" class="btn btn-outline-info" id="applyBulkMarksBtn">
                                            Apply
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="bulkGraceInput" placeholder="Grace" value="0">
                                        <button type="button" class="btn btn-outline-info" id="applyBulkGraceBtn">
                                            Apply
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Statistics Sidebar -->
<div class="row mt-4">
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi bi-graph-up me-2"></i>Marks Statistics
                </h6>
            </div>
            <div class="card-body">
                <div class="stats-grid">
                    <div class="stat-item text-center p-3 border rounded">
                        <div class="stat-value text-primary" id="totalStudents">0</div>
                        <div class="stat-label">Total Students</div>
                    </div>
                    <div class="stat-item text-center p-3 border rounded">
                        <div class="stat-value text-success" id="marksEntered">0</div>
                        <div class="stat-label">Marks Entered</div>
                    </div>
                    <div class="stat-item text-center p-3 border rounded">
                        <div class="stat-value text-warning" id="absentCount">0</div>
                        <div class="stat-label">Absent</div>
                    </div>
                    <div class="stat-item text-center p-3 border rounded">
                        <div class="stat-value text-info" id="completionRate">0%</div>
                        <div class="stat-label">Completion</div>
                    </div>
                </div>
                
                <div class="progress mt-3" style="height: 10px;">
                    <div class="progress-bar" id="completionProgress" style="width: 0%"></div>
                </div>
                <small class="text-muted" id="completionText">No marks entered yet</small>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi bi-speedometer2 me-2"></i>Performance Overview
                </h6>
            </div>
            <div class="card-body">
                <div class="performance-stats">
                    <div class="performance-item mb-3">
                        <div class="d-flex justify-content-between">
                            <span>Average Marks:</span>
                            <strong id="averageMarks">-</strong>
                        </div>
                    </div>
                    <div class="performance-item mb-3">
                        <div class="d-flex justify-content-between">
                            <span>Highest Marks:</span>
                            <strong id="highestMarks">-</strong>
                        </div>
                    </div>
                    <div class="performance-item mb-3">
                        <div class="d-flex justify-content-between">
                            <span>Lowest Marks:</span>
                            <strong id="lowestMarks">-</strong>
                        </div>
                    </div>
                    <div class="performance-item">
                        <div class="d-flex justify-content-between">
                            <span>Pass Percentage:</span>
                            <strong id="passPercentage">-</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi bi-lightning me-2"></i>Quick Actions
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-outline-primary" id="validateAllBtn">
                        <i class="bi bi-check-circle me-1"></i> Validate All Marks
                    </button>
                    <button type="button" class="btn btn-outline-warning" id="clearAllBtn">
                        <i class="bi bi-arrow-clockwise me-1"></i> Clear All Marks
                    </button>
                    <button type="button" class="btn btn-outline-info" id="exportMarksBtn">
                        <i class="bi bi-download me-1"></i> Export to CSV
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Save Options Modal -->
<div class="modal fade" id="saveOptionsModal" tabindex="-1" aria-labelledby="saveOptionsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="saveOptionsModalLabel">Save Options</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>How would you like to save the marks?</p>
                <div class="form-check mb-2">
                    <input class="form-check-input" type="radio" name="saveOption" id="saveDraftOption" value="draft" checked>
                    <label class="form-check-label" for="saveDraftOption">
                        <strong>Save as Draft</strong><br>
                        <small class="text-muted">Save without publishing. Students won't see these marks.</small>
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="saveOption" id="savePublishOption" value="publish">
                    <label class="form-check-label" for="savePublishOption">
                        <strong>Save and Publish</strong><br>
                        <small class="text-muted">Publish these marks to make them visible to students.</small>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmSaveBtn">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Export Modal -->
<div class="modal fade" id="exportModal" tabindex="-1" aria-labelledby="exportModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exportModalLabel">Export Marks</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Select export format:</p>
                <div class="form-check mb-2">
                    <input class="form-check-input" type="radio" name="exportFormat" id="exportCSV" value="csv" checked>
                    <label class="form-check-label" for="exportCSV">
                        <strong>CSV Format</strong><br>
                        <small class="text-muted">Comma-separated values, compatible with Excel</small>
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="exportFormat" id="exportExcel" value="excel">
                    <label class="form-check-label" for="exportExcel">
                        <strong>Excel Format</strong><br>
                        <small class="text-muted">Microsoft Excel format (.xlsx)</small>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmExportBtn">Export</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.enter-marks-container {
    max-width: 100%;
}

.exam-summary {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-left: 4px solid #0d6efd;
}

.table th {
    font-weight: 600;
    font-size: 0.875rem;
}

.student-row:hover {
    background-color: #f8f9fa !important;
}

.marks-input:focus, .grace-marks-input:focus, .remarks-input:focus {
    border-color: #86b7fe;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

.stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
}

.stat-item {
    background-color: white;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 0.25rem;
}

.stat-label {
    font-size: 0.75rem;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.performance-stats {
    font-size: 0.9rem;
}

.bulk-actions {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border: 1px solid #dee2e6;
}

/* Form Validation States */
.is-valid {
    border-color: #198754;
    padding-right: calc(1.5em + 0.75rem);
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23198754' d='M2.3 6.73L.6 4.53c-.4-1.04.46-1.4 1.1-.8l1.1 1.4 3.4-3.8c.6-.63 1.6-.27 1.2.7l-4 4.6c-.43.5-.8.4-1.1.1z'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}

.is-invalid {
    border-color: #dc3545;
    padding-right: calc(1.5em + 0.75rem);
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath d='m5.8 3.6.4.4.4-.4'/%3e%3cpath d='M6 7v1'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}

/* Custom switch styling */
.form-check-input:checked {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

.form-check-input:focus {
    border-color: #86b7fe;
    outline: 0;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

/* Progress Bar */
.progress {
    background-color: #e9ecef;
}

.progress-bar {
    transition: width 0.3s ease;
}

/* Status badges */
.badge {
    font-size: 0.7rem;
    padding: 0.35em 0.65em;
}

/* Responsive Design */
@media (max-width: 768px) {
    .table-responsive {
        font-size: 0.875rem;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .bulk-actions .row {
        flex-direction: column;
    }
    
    .bulk-actions .col-md-3 {
        margin-bottom: 0.5rem;
    }
}

/* Animation for status updates */
@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

.status-update {
    animation: pulse 0.5s ease-in-out;
}

/* Highlight rows with changes */
.row-modified {
    background-color: #fff3cd !important;
    border-left: 4px solid #ffc107;
}

.row-error {
    background-color: #f8d7da !important;
    border-left: 4px solid #dc3545;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const marksForm = document.getElementById('marksForm');
    const saveDraftBtn = document.getElementById('saveDraftBtn');
    const publishMarksBtn = document.getElementById('publishMarksBtn');
    const validateAllBtn = document.getElementById('validateAllBtn');
    const clearAllBtn = document.getElementById('clearAllBtn');
    const exportMarksBtn = document.getElementById('exportMarksBtn');
    const saveOptionsModal = new bootstrap.Modal(document.getElementById('saveOptionsModal'));
    const exportModal = new bootstrap.Modal(document.getElementById('exportModal'));
    const confirmSaveBtn = document.getElementById('confirmSaveBtn');
    const confirmExportBtn = document.getElementById('confirmExportBtn');
    
    // Bulk action elements
    const markAllPresentBtn = document.getElementById('markAllPresentBtn');
    const markAllAbsentBtn = document.getElementById('markAllAbsentBtn');
    const bulkMarksInput = document.getElementById('bulkMarksInput');
    const applyBulkMarksBtn = document.getElementById('applyBulkMarksBtn');
    const bulkGraceInput = document.getElementById('bulkGraceInput');
    const applyBulkGraceBtn = document.getElementById('applyBulkGraceBtn');
    
    // Statistics elements
    const totalStudents = document.getElementById('totalStudents');
    const marksEntered = document.getElementById('marksEntered');
    const absentCount = document.getElementById('absentCount');
    const completionRate = document.getElementById('completionRate');
    const completionProgress = document.getElementById('completionProgress');
    const completionText = document.getElementById('completionText');
    const averageMarks = document.getElementById('averageMarks');
    const highestMarks = document.getElementById('highestMarks');
    const lowestMarks = document.getElementById('lowestMarks');
    const passPercentage = document.getElementById('passPercentage');
    
    // Initialize
    initializeMarksForm();
    updateStatistics();
    
    // Initialize event listeners
    initializeEventListeners();
    
    // Auto-save every 30 seconds
    setInterval(autoSaveDraft, 30000);

    function initializeMarksForm() {
        // Add event listeners to all input fields
        const marksInputs = document.querySelectorAll('.marks-input, .grace-marks-input, .remarks-input');
        marksInputs.forEach(input => {
            input.addEventListener('input', function() {
                validateField(this);
                updateStudentStatus(this);
                updateStatistics();
            });
            
            input.addEventListener('blur', function() {
                validateField(this);
                updateStatistics();
            });
        });
        
        // Add event listeners to absent checkboxes
        const absentCheckboxes = document.querySelectorAll('.absent-checkbox');
        absentCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                handleAbsentChange(this);
                updateStudentStatus(this);
                updateStatistics();
            });
        });
        
        // Initialize student status
        document.querySelectorAll('.student-row').forEach(row => {
            updateStudentStatus(row);
        });
    }

    function initializeEventListeners() {
        // Save buttons
        saveDraftBtn.addEventListener('click', function() {
            showSaveOptions('draft');
        });
        
        publishMarksBtn.addEventListener('click', function() {
            showSaveOptions('publish');
        });
        
        // Validation and actions
        validateAllBtn.addEventListener('click', validateAllMarks);
        clearAllBtn.addEventListener('click', clearAllMarks);
        exportMarksBtn.addEventListener('click', showExportModal);
        
        // Bulk actions
        markAllPresentBtn.addEventListener('click', markAllPresent);
        markAllAbsentBtn.addEventListener('click', markAllAbsent);
        applyBulkMarksBtn.addEventListener('click', applyBulkMarks);
        applyBulkGraceBtn.addEventListener('click', applyBulkGrace);
        
        // Confirm buttons
        confirmSaveBtn.addEventListener('click', confirmSave);
        confirmExportBtn.addEventListener('click', confirmExport);
    }

    function validateField(field) {
        const value = field.value.trim();
        const fieldType = field.classList.contains('marks-input') ? 'marks' : 
                         field.classList.contains('grace-marks-input') ? 'grace' : 'remarks';
        
        // Clear previous validation
        field.classList.remove('is-invalid', 'is-valid');
        
        if (fieldType === 'marks') {
            const maxMarks = parseFloat(field.max);
            const studentRow = field.closest('.student-row');
            const isAbsent = studentRow.querySelector('.absent-checkbox').checked;
            
            if (isAbsent && value) {
                field.classList.add('is-invalid');
                return false;
            }
            
            if (!isAbsent && !value && studentRow.querySelector('.marks-input').required) {
                field.classList.add('is-invalid');
                return false;
            }
            
            if (value && (parseFloat(value) < 0 || parseFloat(value) > maxMarks)) {
                field.classList.add('is-invalid');
                return false;
            }
        }
        
        if (fieldType === 'grace') {
            if (value && parseFloat(value) < 0) {
                field.classList.add('is-invalid');
                return false;
            }
        }
        
        // If we made it here, field is valid
        if (value || fieldType === 'remarks') {
            field.classList.add('is-valid');
        }
        return true;
    }

    function handleAbsentChange(checkbox) {
        const studentRow = checkbox.closest('.student-row');
        const marksInput = studentRow.querySelector('.marks-input');
        const graceInput = studentRow.querySelector('.grace-marks-input');
        
        if (checkbox.checked) {
            // Student is absent
            marksInput.disabled = true;
            marksInput.value = '';
            marksInput.classList.remove('is-valid', 'is-invalid');
            graceInput.value = '0';
        } else {
            // Student is present
            marksInput.disabled = false;
            if (!marksInput.value) {
                marksInput.focus();
            }
        }
        
        // Update row styling
        if (checkbox.checked) {
            studentRow.classList.add('table-warning');
        } else {
            studentRow.classList.remove('table-warning');
        }
    }

    function updateStudentStatus(element) {
        const studentRow = element.closest('.student-row');
        const statusCell = studentRow.querySelector('.status-cell .badge');
        const marksInput = studentRow.querySelector('.marks-input');
        const isAbsent = studentRow.querySelector('.absent-checkbox').checked;
        
        let hasData = false;
        
        if (isAbsent) {
            hasData = true;
        } else if (marksInput.value && marksInput.value.trim()) {
            hasData = true;
        }
        
        if (hasData) {
            statusCell.textContent = 'Modified';
            statusCell.className = 'badge bg-warning';
            studentRow.classList.add('row-modified');
        } else {
            statusCell.textContent = 'Pending';
            statusCell.className = 'badge bg-secondary';
            studentRow.classList.remove('row-modified');
        }
        
        statusCell.classList.add('status-update');
        setTimeout(() => {
            statusCell.classList.remove('status-update');
        }, 500);
    }

    function updateStatistics() {
        const studentRows = document.querySelectorAll('.student-row');
        let total = studentRows.length;
        let entered = 0;
        let absent = 0;
        let marks = [];
        
        studentRows.forEach(row => {
            const marksInput = row.querySelector('.marks-input');
            const isAbsent = row.querySelector('.absent-checkbox').checked;
            const marksValue = parseFloat(marksInput.value) || 0;
            
            if (isAbsent) {
                absent++;
                entered++;
            } else if (marksInput.value && marksInput.value.trim()) {
                entered++;
                marks.push(marksValue);
            }
        });
        
        // Update basic statistics
        totalStudents.textContent = total;
        marksEntered.textContent = entered;
        absentCount.textContent = absent;
        
        const completionPercentage = total > 0 ? Math.round((entered / total) * 100) : 0;
        completionRate.textContent = `${completionPercentage}%`;
        completionProgress.style.width = `${completionPercentage}%`;
        completionText.textContent = `${entered} of ${total} students completed`;
        
        // Update performance statistics
        if (marks.length > 0) {
            const sum = marks.reduce((a, b) => a + b, 0);
            const avg = sum / marks.length;
            const max = Math.max(...marks);
            const min = Math.min(...marks);
            const passCount = marks.filter(m => m >= {{ exam.passing_marks }}).length;
            const passRate = (passCount / marks.length) * 100;
            
            averageMarks.textContent = avg.toFixed(2);
            highestMarks.textContent = max.toFixed(2);
            lowestMarks.textContent = min.toFixed(2);
            passPercentage.textContent = `${passRate.toFixed(1)}%`;
        } else {
            averageMarks.textContent = '-';
            highestMarks.textContent = '-';
            lowestMarks.textContent = '-';
            passPercentage.textContent = '-';
        }
        
        // Update progress bar color based on completion
        if (completionPercentage === 100) {
            completionProgress.classList.remove('bg-warning', 'bg-info');
            completionProgress.classList.add('bg-success');
        } else if (completionPercentage >= 50) {
            completionProgress.classList.remove('bg-info', 'bg-success');
            completionProgress.classList.add('bg-warning');
        } else {
            completionProgress.classList.remove('bg-warning', 'bg-success');
            completionProgress.classList.add('bg-info');
        }
    }

    function validateAllMarks() {
        let isValid = true;
        const marksInputs = document.querySelectorAll('.marks-input, .grace-marks-input');
        
        marksInputs.forEach(input => {
            if (!validateField(input)) {
                isValid = false;
                
                // Scroll to first error
                if (isValid === false) {
                    input.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    input.focus();
                    isValid = true; // Prevent multiple scrolls
                }
            }
        });
        
        if (isValid) {
            showToast('All marks validation passed!', 'success');
        } else {
            showToast('Please fix the errors in the marks', 'error');
        }
        
        return isValid;
    }

    function clearAllMarks() {
        if (confirm('Are you sure you want to clear all marks? This action cannot be undone.')) {
            document.querySelectorAll('.marks-input').forEach(input => {
                input.value = '';
                input.classList.remove('is-valid', 'is-invalid');
            });
            
            document.querySelectorAll('.grace-marks-input').forEach(input => {
                input.value = '0';
                input.classList.remove('is-valid', 'is-invalid');
            });
            
            document.querySelectorAll('.absent-checkbox').forEach(checkbox => {
                checkbox.checked = false;
                handleAbsentChange(checkbox);
            });
            
            document.querySelectorAll('.remarks-input').forEach(input => {
                input.value = '';
            });
            
            updateStatistics();
            showToast('All marks cleared successfully', 'info');
        }
    }

    function markAllPresent() {
        document.querySelectorAll('.absent-checkbox').forEach(checkbox => {
            checkbox.checked = false;
            handleAbsentChange(checkbox);
        });
        updateStatistics();
        showToast('All students marked as present', 'info');
    }

    function markAllAbsent() {
        document.querySelectorAll('.absent-checkbox').forEach(checkbox => {
            checkbox.checked = true;
            handleAbsentChange(checkbox);
        });
        updateStatistics();
        showToast('All students marked as absent', 'warning');
    }

    function applyBulkMarks() {
        const marksValue = bulkMarksInput.value.trim();
        if (!marksValue) {
            showToast('Please enter marks value', 'error');
            return;
        }
        
        const marks = parseFloat(marksValue);
        if (marks < 0 || marks > {{ exam.total_marks }}) {
            showToast(`Marks must be between 0 and {{ exam.total_marks }}`, 'error');
            return;
        }
        
        document.querySelectorAll('.student-row').forEach(row => {
            const isAbsent = row.querySelector('.absent-checkbox').checked;
            const marksInput = row.querySelector('.marks-input');
            
            if (!isAbsent) {
                marksInput.value = marks;
                validateField(marksInput);
                updateStudentStatus(marksInput);
            }
        });
        
        updateStatistics();
        showToast(`Applied ${marks} marks to all present students`, 'success');
    }

    function applyBulkGrace() {
        const graceValue = bulkGraceInput.value.trim();
        if (!graceValue) {
            showToast('Please enter grace marks value', 'error');
            return;
        }
        
        const grace = parseFloat(graceValue);
        if (grace < 0) {
            showToast('Grace marks cannot be negative', 'error');
            return;
        }
        
        document.querySelectorAll('.grace-marks-input').forEach(input => {
            input.value = grace;
            validateField(input);
            updateStudentStatus(input);
        });
        
        updateStatistics();
        showToast(`Applied ${grace} grace marks to all students`, 'success');
    }

    function showSaveOptions(defaultOption) {
        if (!validateAllMarks()) {
            return;
        }
        
        // Set the default option
        document.getElementById(`save${defaultOption.charAt(0).toUpperCase() + defaultOption.slice(1)}Option`).checked = true;
        saveOptionsModal.show();
    }

    function confirmSave() {
        const saveOption = document.querySelector('input[name="saveOption"]:checked').value;
        
        // Create form data
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        // Collect all marks data
        const marksData = {};
        document.querySelectorAll('.student-row').forEach(row => {
            const studentId = row.dataset.studentId;
            const marksInput = row.querySelector('.marks-input');
            const absentCheckbox = row.querySelector('.absent-checkbox');
            const graceInput = row.querySelector('.grace-marks-input');
            const remarksInput = row.querySelector('.remarks-input');
            
            marksData[studentId] = {
                marks_obtained: absentCheckbox.checked ? null : marksInput.value,
                is_absent: absentCheckbox.checked,
                grace_marks: graceInput.value || 0,
                remarks: remarksInput.value
            };
        });
        
        formData.append('marks_data', JSON.stringify(marksData));
        
        if (saveOption === 'publish') {
            formData.append('publish', 'true');
        }
        
        // Submit via AJAX
        fetch('{% url "assessment:enter_marks" exam.id %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                saveOptionsModal.hide();
                showToast('Marks saved successfully!', 'success');
                
                // Update status to saved
                document.querySelectorAll('.student-row').forEach(row => {
                    const statusCell = row.querySelector('.status-cell .badge');
                    statusCell.textContent = 'Saved';
                    statusCell.className = 'badge bg-success';
                    row.classList.remove('row-modified');
                });
            } else {
                showToast('Error saving marks', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Error saving marks', 'error');
        });
    }

    function showExportModal() {
        exportModal.show();
    }

    function confirmExport() {
        const exportFormat = document.querySelector('input[name="exportFormat"]:checked').value;
        
        // In a real implementation, this would make an API call to export the data
        // For now, we'll simulate it
        showToast(`Exporting marks as ${exportFormat.toUpperCase()}...`, 'info');
        exportModal.hide();
        
        // Simulate download
        setTimeout(() => {
            showToast('Export completed successfully!', 'success');
        }, 1500);
    }

    function autoSaveDraft() {
        // Check if there are any modified rows
        const modifiedRows = document.querySelectorAll('.row-modified');
        if (modifiedRows.length === 0) {
            return;
        }
        
        // Auto-save draft
        console.log('Auto-saving draft...');
        // In a real implementation, this would save the draft via AJAX
    }

    function showToast(message, type = 'info') {
        // Create toast element
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-bg-${type === 'error' ? 'danger' : type} border-0`;
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');
        
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        `;
        
        // Add to toast container
        let toastContainer = document.querySelector('.toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
            document.body.appendChild(toastContainer);
        }
        
        toastContainer.appendChild(toast);
        
        // Initialize and show toast
        const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
        bsToast.show();
        
        // Remove from DOM after hiding
        toast.addEventListener('hidden.bs.toast', function() {
            toast.remove();
        });
    }
});
</script>
{% endblock %}