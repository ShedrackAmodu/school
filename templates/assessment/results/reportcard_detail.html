{% extends 'base/base.html' %}
{% load i18n static %}

{% block title %}Report Card – {{ report_card.student.user.get_full_name }}{% endblock %}
{% block page_title %}Report Card{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'assessment:reportcard_list' %}">Report Cards</a></li>
<li class="breadcrumb-item active">{{ report_card.student.user.get_full_name }}</li>
{% endblock %}

{% block page_actions %}
<div class="btn-group">
  <button onclick="window.print()" class="btn btn-outline-secondary btn-sm d-print-none">
    <i class="bi bi-printer me-1"></i>Print
  </button>
  {% if is_teacher and not report_card.is_approved %}
  <form method="post" action="{% url 'assessment:approve_report_card' reportcard_id=report_card.pk %}" class="d-inline d-print-none">
    {% csrf_token %}
    <button type="submit" class="btn btn-success btn-sm ms-1">
      <i class="bi bi-check2-circle me-1"></i>Approve
    </button>
  </form>
  {% endif %}
</div>
{% endblock %}

{% block extra_css %}
<style>
@media print {
  .sidebar, .page-header, .page-actions, .btn, nav, footer, #backToTop, .d-print-none { display:none!important; }
  .main-content-area { margin:0!important; padding:0!important; }
  .card { box-shadow:none!important; border:1px solid #dee2e6!important; }
  body { font-size:12pt; }
  .report-card-header { -webkit-print-color-adjust:exact; print-color-adjust:exact; }
}
.grade-badge { font-size:.85rem; font-weight:600; min-width:36px; text-align:center; }
.perf-bar { height:6px; border-radius:3px; }
</style>
{% endblock %}

{% block content %}

<!-- ── REPORT CARD PAPER ──────────────────────────────────────────── -->
<div class="card border-0 shadow-sm mb-4" id="reportCardPrint">

  <!-- School Header -->
  <div class="card-header report-card-header text-white py-4" style="background:linear-gradient(135deg,#0d6efd,#0a3fa8);">
    <div class="row align-items-center">
      <div class="col-auto">
        <div class="bg-white rounded-circle d-flex align-items-center justify-content-center" style="width:60px;height:60px;">
          <i class="bi bi-mortarboard-fill text-primary fs-3"></i>
        </div>
      </div>
      <div class="col text-center">
        <h4 class="fw-bold mb-0">{{ institution.name|default:"Excellence Academy" }}</h4>
        <p class="mb-0 small opacity-75">{{ institution.address|default:"School Address" }}</p>
        <p class="mb-0 small opacity-75">Tel: {{ institution.phone|default:"" }} | Email: {{ institution.email|default:"" }}</p>
      </div>
      <div class="col-auto text-end">
        <div class="badge bg-white text-primary fs-6 px-3 py-2">REPORT CARD</div>
        {% if report_card.is_approved %}
        <div class="badge bg-success mt-1 d-block">Approved</div>
        {% else %}
        <div class="badge bg-warning text-dark mt-1 d-block">Pending Approval</div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="card-body p-4">

    <!-- Student Info Row -->
    <div class="row g-3 mb-4">
      <div class="col-12 col-md-8">
        <div class="row g-2">
          <div class="col-6">
            <label class="text-muted small text-uppercase">Student Name</label>
            <p class="fw-bold mb-0">{{ report_card.student.user.get_full_name }}</p>
          </div>
          <div class="col-6">
            <label class="text-muted small text-uppercase">Admission No.</label>
            <p class="fw-bold mb-0">{{ report_card.student.admission_number|default:"—" }}</p>
          </div>
          <div class="col-6">
            <label class="text-muted small text-uppercase">Class</label>
            <p class="fw-bold mb-0">{{ report_card.academic_class.name }}</p>
          </div>
          <div class="col-6">
            <label class="text-muted small text-uppercase">CBT Period</label>
            <p class="fw-bold mb-0">{{ report_card.exam_type.name }}</p>
          </div>
          <div class="col-6">
            <label class="text-muted small text-uppercase">Academic Session</label>
            <p class="fw-bold mb-0">{{ report_card.academic_class.academic_session.name|default:"—" }}</p>
          </div>
          <div class="col-6">
            <label class="text-muted small text-uppercase">Date Generated</label>
            <p class="fw-bold mb-0">{{ report_card.generated_at|date:"d M Y" }}</p>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-4">
        <!-- Performance Summary Box -->
        <div class="bg-light rounded-3 p-3 h-100">
          <div class="text-center mb-2">
            <span class="display-4 fw-bold text-primary">{{ result.percentage|floatformat:1 }}%</span>
            <p class="text-muted small mb-0">Overall Score</p>
          </div>
          {% if result.grade %}
          <div class="text-center mb-2">
            <span class="badge bg-primary fs-5 px-3">{{ result.grade.grade }}</span>
            <p class="text-muted small mb-0">{{ result.grade.description }}</p>
          </div>
          {% endif %}
          <hr class="my-2">
          <div class="row text-center g-1">
            <div class="col-6">
              <p class="mb-0 fw-bold">{% if result.rank %}{{ result.rank }}/{{ result.total_students }}{% else %}—{% endif %}</p>
              <p class="text-muted mb-0" style="font-size:.7rem;">Class Rank</p>
            </div>
            <div class="col-6">
              <p class="mb-0 fw-bold">{{ result.attendance_percentage|floatformat:0 }}%</p>
              <p class="text-muted mb-0" style="font-size:.7rem;">Attendance</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Subject Marks Table -->
    <h6 class="fw-semibold mb-3 text-uppercase text-muted border-bottom pb-2">
      <i class="bi bi-table me-2"></i>Subject Performance
    </h6>
    <div class="table-responsive mb-4">
      <table class="table table-bordered align-middle mb-0">
        <thead class="table-primary">
          <tr>
            <th>Subject</th>
            <th class="text-center">Max Marks</th>
            <th class="text-center">Marks Obtained</th>
            <th class="text-center">Percentage</th>
            <th class="text-center">Grade</th>
            <th class="d-print-none">Performance</th>
            <th class="text-center">Remark</th>
          </tr>
        </thead>
        <tbody>
          {% for sm in subject_marks %}
          <tr>
            <td class="fw-semibold">{{ sm.subject.name }}</td>
            <td class="text-center">{{ sm.max_marks|floatformat:0 }}</td>
            <td class="text-center fw-semibold">{{ sm.marks_obtained|floatformat:0 }}</td>
            <td class="text-center">{{ sm.percentage|floatformat:1 }}%</td>
            <td class="text-center">
              {% if sm.grade %}
                <span class="badge grade-badge
                  {% if sm.percentage >= 75 %}bg-success
                  {% elif sm.percentage >= 60 %}bg-primary
                  {% elif sm.percentage >= 50 %}bg-info
                  {% elif sm.percentage >= 40 %}bg-warning text-dark
                  {% else %}bg-danger{% endif %}">
                  {{ sm.grade.grade }}
                </span>
              {% else %}—{% endif %}
            </td>
            <td class="d-print-none" style="min-width:100px;">
              <div class="progress perf-bar">
                <div class="progress-bar
                  {% if sm.percentage >= 75 %}bg-success
                  {% elif sm.percentage >= 60 %}bg-primary
                  {% elif sm.percentage >= 50 %}bg-info
                  {% elif sm.percentage >= 40 %}bg-warning
                  {% else %}bg-danger{% endif %}"
                  style="width:{{ sm.percentage|floatformat:0 }}%"></div>
              </div>
            </td>
            <td class="text-center small">
              {% if sm.percentage >= 75 %}Excellent
              {% elif sm.percentage >= 60 %}Good
              {% elif sm.percentage >= 50 %}Average
              {% elif sm.percentage >= 40 %}Pass
              {% else %}<span class="text-danger">Fail</span>{% endif %}
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="7" class="text-center text-muted py-3">No subject marks recorded</td></tr>
          {% endfor %}
        </tbody>
        <tfoot class="table-light fw-bold">
          <tr>
            <td>TOTAL</td>
            <td class="text-center">{{ result.total_marks|floatformat:0 }}</td>
            <td class="text-center text-primary">{{ result.marks_obtained|floatformat:0 }}</td>
            <td class="text-center text-primary">{{ result.percentage|floatformat:1 }}%</td>
            <td class="text-center" colspan="3">
              {% if result.grade %}{{ result.grade.grade }}{% endif %}
            </td>
          </tr>
        </tfoot>
      </table>
    </div>

    <!-- Charts Row (screen only) -->
    <div class="row g-3 mb-4 d-print-none">
      <div class="col-12 col-md-7">
        <div class="card border-0 bg-light">
          <div class="card-body">
            <h6 class="fw-semibold mb-3">Subject Performance</h6>
            <canvas id="subjectChart" height="180"></canvas>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-5">
        <div class="card border-0 bg-light">
          <div class="card-body text-center">
            <h6 class="fw-semibold mb-3">Grade Distribution</h6>
            <canvas id="gradeChart" height="180"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Stats Row -->
    {% if best_subject or worst_subject %}
    <div class="row g-3 mb-4">
      {% if best_subject %}
      <div class="col-6 col-md-3">
        <div class="card border-0 bg-success bg-opacity-10 text-center p-3">
          <i class="bi bi-trophy text-success fs-4 mb-1"></i>
          <p class="mb-0 small text-muted">Best Subject</p>
          <p class="mb-0 fw-bold small">{{ best_subject.subject.name }}</p>
          <p class="mb-0 text-success fw-bold">{{ best_subject.percentage|floatformat:1 }}%</p>
        </div>
      </div>
      {% endif %}
      {% if worst_subject %}
      <div class="col-6 col-md-3">
        <div class="card border-0 bg-warning bg-opacity-10 text-center p-3">
          <i class="bi bi-graph-down text-warning fs-4 mb-1"></i>
          <p class="mb-0 small text-muted">Needs Work</p>
          <p class="mb-0 fw-bold small">{{ worst_subject.subject.name }}</p>
          <p class="mb-0 text-warning fw-bold">{{ worst_subject.percentage|floatformat:1 }}%</p>
        </div>
      </div>
      {% endif %}
      {% if subjects_passed is not None %}
      <div class="col-6 col-md-3">
        <div class="card border-0 bg-primary bg-opacity-10 text-center p-3">
          <i class="bi bi-check-circle text-primary fs-4 mb-1"></i>
          <p class="mb-0 small text-muted">Subjects Passed</p>
          <p class="mb-0 fw-bold fs-4 text-primary">{{ subjects_passed }}</p>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="card border-0 bg-danger bg-opacity-10 text-center p-3">
          <i class="bi bi-x-circle text-danger fs-4 mb-1"></i>
          <p class="mb-0 small text-muted">Below Pass</p>
          <p class="mb-0 fw-bold fs-4 text-danger">{{ subjects_failed }}</p>
        </div>
      </div>
      {% endif %}
    </div>
    {% endif %}

    <!-- Remarks -->
    {% if result.remarks or report_card.comments %}
    <div class="row g-3 mb-4">
      {% if result.remarks %}
      <div class="col-12 col-md-6">
        <label class="text-muted small text-uppercase fw-semibold">Teacher's Remarks</label>
        <div class="border rounded-2 p-3 bg-light">{{ result.remarks }}</div>
      </div>
      {% endif %}
      {% if report_card.comments %}
      <div class="col-12 col-md-6">
        <label class="text-muted small text-uppercase fw-semibold">Principal's Comments</label>
        <div class="border rounded-2 p-3 bg-light">{{ report_card.comments }}</div>
      </div>
      {% endif %}
    </div>
    {% endif %}

    <!-- Promotion Status -->
    {% if result.is_promoted %}
    <div class="alert alert-success d-flex align-items-center gap-2 mb-4">
      <i class="bi bi-arrow-up-circle-fill fs-4"></i>
      <div>
        <strong>Promoted!</strong>
        This student has been promoted{% if result.promoted_to_class %} to <strong>{{ result.promoted_to_class.name }}</strong>{% endif %}.
      </div>
    </div>
    {% endif %}

    <!-- Signature Section -->
    <div class="row mt-4 pt-3 border-top">
      <div class="col-4 text-center">
        <div class="border-bottom pb-1 mb-1" style="height:40px;"></div>
        <p class="small text-muted mb-0">Class Teacher</p>
        {% if report_card.generated_by %}
        <p class="small fw-semibold mb-0">{{ report_card.generated_by.user.get_full_name }}</p>
        {% endif %}
      </div>
      <div class="col-4 text-center">
        <div class="border-bottom pb-1 mb-1" style="height:40px;"></div>
        <p class="small text-muted mb-0">Principal / Head Teacher</p>
        {% if report_card.approved_by %}
        <p class="small fw-semibold mb-0">{{ report_card.approved_by.user.get_full_name }}</p>
        {% endif %}
      </div>
      <div class="col-4 text-center">
        <div class="border-bottom pb-1 mb-1" style="height:40px;"></div>
        <p class="small text-muted mb-0">Parent / Guardian</p>
        <p class="small mb-0">Date: _____________</p>
      </div>
    </div>

  </div><!-- /card-body -->
</div><!-- /report card -->

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const subjectNames = {{ subject_names|safe }};
const subjectPcts  = {{ subject_percentages|safe }};
const gradeLabels  = {{ grade_labels|safe }};
const gradeCounts  = {{ grade_counts|safe }};

const colors = subjectPcts.map(p =>
  p >= 75 ? '#198754' : p >= 60 ? '#0d6efd' : p >= 50 ? '#0dcaf0' : p >= 40 ? '#ffc107' : '#dc3545'
);

// Bar chart – subject performance
if (document.getElementById('subjectChart')) {
  new Chart(document.getElementById('subjectChart'), {
    type: 'bar',
    data: {
      labels: subjectNames,
      datasets: [{
        label: 'Score (%)',
        data: subjectPcts,
        backgroundColor: colors,
        borderRadius: 4,
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        y: { min: 0, max: 100, ticks: { callback: v => v + '%' }, grid: { color: 'rgba(0,0,0,.05)' } },
        x: { grid: { display: false } }
      }
    }
  });
}

// Doughnut – grade distribution
if (document.getElementById('gradeChart') && gradeLabels.length) {
  const dColors = ['#198754','#0d6efd','#0dcaf0','#ffc107','#dc3545','#6f42c1'];
  new Chart(document.getElementById('gradeChart'), {
    type: 'doughnut',
    data: {
      labels: gradeLabels,
      datasets: [{
        data: gradeCounts,
        backgroundColor: dColors.slice(0, gradeLabels.length),
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { position: 'bottom', labels: { boxWidth: 12 } } },
      cutout: '65%'
    }
  });
}
</script>
{% endblock %}
