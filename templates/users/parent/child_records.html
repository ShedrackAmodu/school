{% extends 'base/base.html' %}
{% load static i18n %}

{% block title %}{% trans "Academic Records" %} - {{ child.user.get_full_name }}{% endblock %}

{% block page_title %}{% trans "Academic Records - " %}{{ child.user.get_full_name }}{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'users:dashboard' %}">{% trans "Dashboard" %}</a></li>
<li class="breadcrumb-item"><a href="{% url 'users:parent_student_relationships' %}">{% trans "My Children" %}</a></li>
<li class="breadcrumb-item active" aria-current="page">{% trans "Academic Records" %}</li>
{% endblock %}

{% block content %}
<div class="child-records">
    <!-- Child Info Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="d-flex align-items-center">
                                <div class="avatar avatar-xl bg-primary text-white me-3">
                                    {{ child.user.get_initials }}
                                </div>
                                <div>
                                    <h4 class="mb-1">{{ child.user.get_full_name }}</h4>
                                    <p class="text-muted mb-1">{{ child.student_id }}</p>
                                    <small class="text-muted">
                                        {% with current_class=child.current_class %}
                                            {% if current_class %}
                                                {% trans "Current Class" %}: {{ current_class.name }}
                                            {% else %}
                                                {% trans "Not currently enrolled" %}
                                            {% endif %}
                                        {% endwith %}
                                    </small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 text-md-end">
                            <div class="btn-group">
                                <a href="{% url 'users:child_attendance' child.id %}" class="btn btn-outline-success">
                                    <i class="bi bi-calendar-check me-1"></i>{% trans "Attendance" %}
                                </a>
                                <a href="{% url 'users:child_fees' child.id %}" class="btn btn-outline-warning">
                                    <i class="bi bi-cash me-1"></i>{% trans "Fees" %}
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Overview -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="avatar avatar-lg bg-primary text-white mx-auto mb-3">
                        <i class="bi bi-graph-up fs-2"></i>
                    </div>
                    <h3 class="fw-bold text-primary mb-1">{{ average_percentage|floatformat:1 }}%</h3>
                    <p class="text-muted small mb-0">{% trans "Average Score" %}</p>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="avatar avatar-lg bg-success text-white mx-auto mb-3">
                        <i class="bi bi-trophy fs-2"></i>
                    </div>
                    <h3 class="fw-bold text-success mb-1">{{ total_exams }}</h3>
                    <p class="text-muted small mb-0">{% trans "Total CBTs" %}</p>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="avatar avatar-lg bg-info text-white mx-auto mb-3">
                        <i class="bi bi-calendar-check fs-2"></i>
                    </div>
                    <h3 class="fw-bold text-info mb-1">
                        {% if attendance_summary %}
                            {{ attendance_summary.attendance_percentage }}%
                        {% else %}
                            N/A
                        {% endif %}
                    </h3>
                    <p class="text-muted small mb-0">{% trans "Attendance Rate" %}</p>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="avatar avatar-lg bg-warning text-white mx-auto mb-3">
                        <i class="bi bi-star fs-2"></i>
                    </div>
                    <h3 class="fw-bold text-warning mb-1">{{ academic_records|length }}</h3>
                    <p class="text-muted small mb-0">{% trans "Academic Records" %}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Subject Performance -->
    {% if subject_performance %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-bar-chart me-2"></i>
                        {% trans "Subject-wise Performance" %}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>{% trans "Subject" %}</th>
                                    <th>{% trans "CBTs Taken" %}</th>
                                    <th>{% trans "Average Score" %}</th>
                                    <th>{% trans "Highest Score" %}</th>
                                    <th>{% trans "Lowest Score" %}</th>
                                    <th>{% trans "Performance" %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for subject, data in subject_performance.items %}
                                <tr>
                                    <td>
                                        <strong>{{ subject }}</strong>
                                    </td>
                                    <td>{{ data.exams }}</td>
                                    <td>
                                        <span class="badge bg-primary">{{ data.average|floatformat:1 }}%</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-success">{{ data.highest }}%</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-warning">{{ data.lowest }}%</span>
                                    </td>
                                    <td>
                                        {% if data.average >= 85 %}
                                            <span class="badge bg-success">{% trans "Excellent" %}</span>
                                        {% elif data.average >= 75 %}
                                            <span class="badge bg-info">{% trans "Good" %}</span>
                                        {% elif data.average >= 60 %}
                                            <span class="badge bg-warning">{% trans "Average" %}</span>
                                        {% else %}
                                            <span class="badge bg-danger">{% trans "Needs Improvement" %}</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Recent Marks -->
    {% if marks %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-file-earmark-text me-2"></i>
                        {% trans "Recent CBT Results" %}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>{% trans "CBT" %}</th>
                                    <th>{% trans "Subject" %}</th>
                                    <th>{% trans "CBT Type" %}</th>
                                    <th>{% trans "Date" %}</th>
                                    <th>{% trans "Score" %}</th>
                                    <th>{% trans "Percentage" %}</th>
                                    <th>{% trans "Status" %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for mark in marks %}
                                <tr>
                                    <td>
                                        <strong>{{ mark.exam.name }}</strong>
                                    </td>
                                    <td>{{ mark.exam.subject.name }}</td>
                                    <td>
                                        <span class="badge bg-secondary">{{ mark.exam.exam_type.name }}</span>
                                    </td>
                                    <td>{{ mark.exam.exam_date|date:"M d, Y" }}</td>
                                    <td>
                                        {% if mark.is_absent %}
                                            <span class="text-muted">{% trans "Absent" %}</span>
                                        {% else %}
                                            {{ mark.marks_obtained }}/{{ mark.max_marks }}
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if not mark.is_absent %}
                                            <span class="badge bg-{% if mark.percentage >= 75 %}success{% elif mark.percentage >= 60 %}warning{% else %}danger{% endif %}">
                                                {{ mark.percentage|floatformat:1 }}%
                                            </span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if mark.is_absent %}
                                            <span class="badge bg-danger">{% trans "Absent" %}</span>
                                        {% elif mark.is_pass %}
                                            <span class="badge bg-success">{% trans "Pass" %}</span>
                                        {% else %}
                                            <span class="badge bg-danger">{% trans "Fail" %}</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Academic Records History -->
    {% if academic_records %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-journal-text me-2"></i>
                        {% trans "Academic Records History" %}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>{% trans "Academic Session" %}</th>
                                    <th>{% trans "Class" %}</th>
                                    <th>{% trans "Overall Grade" %}</th>
                                    <th>{% trans "Total Marks" %}</th>
                                    <th>{% trans "Percentage" %}</th>
                                    <th>{% trans "Rank" %}</th>
                                    <th>{% trans "Remarks" %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for record in academic_records %}
                                <tr>
                                    <td>
                                        <strong>{{ record.academic_session.name }}</strong>
                                    </td>
                                    <td>{{ record.class_enrolled.name }}</td>
                                    <td>
                                        {% if record.overall_grade %}
                                            <span class="badge bg-primary">{{ record.overall_grade }}</span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if record.total_marks %}
                                            {{ record.total_marks }}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if record.percentage %}
                                            <span class="badge bg-info">{{ record.percentage|floatformat:1 }}%</span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if record.rank_in_class %}
                                            #{{ record.rank_in_class }}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if record.remarks %}
                                            {{ record.remarks }}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Results and Report Cards -->
    {% if results %}
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-file-earmark-check me-2"></i>
                        {% trans "CBT Results & Report Cards" %}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>{% trans "CBT Type" %}</th>
                                    <th>{% trans "Class" %}</th>
                                    <th>{% trans "Grade" %}</th>
                                    <th>{% trans "Total Marks" %}</th>
                                    <th>{% trans "Percentage" %}</th>
                                    <th>{% trans "Rank" %}</th>
                                    <th>{% trans "Status" %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for result in results %}
                                <tr>
                                    <td>
                                        <strong>{{ result.exam_type.name }}</strong>
                                    </td>
                                    <td>{{ result.academic_class.name }}</td>
                                    <td>
                                        {% if result.grade %}
                                            <span class="badge bg-primary">{{ result.grade.grade }}</span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ result.total_marks }}</td>
                                    <td>
                                        <span class="badge bg-info">{{ result.percentage|floatformat:1 }}%</span>
                                    </td>
                                    <td>
                                        {% if result.rank %}
                                            #{{ result.rank }}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if result.is_promoted %}
                                            <span class="badge bg-success">{% trans "Promoted" %}</span>
                                        {% else %}
                                            <span class="badge bg-warning">{% trans "Pending" %}</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_css %}
<style>
.child-records {
    background-color: #f8f9fa;
}

.avatar {
    width: 48px;
    height: 48px;
    display: flex;
    align-items-center;
    justify-content: center;
    border-radius: 50%;
}

.avatar-xl {
    width: 80px;
    height: 80px;
    font-size: 2rem;
}

.avatar-lg {
    width: 64px;
    height: 64px;
    font-size: 1.5rem;
}

.table th {
    border-top: none;
    font-weight: 600;
    color: #495057;
    background-color: #f8f9fa;
}

.card-header {
    border-bottom: none;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .table-responsive {
        font-size: 0.875rem;
    }

    .btn-group {
        flex-direction: column;
        gap: 0.5rem;
    }

    .btn-group .btn {
        border-radius: 0.375rem !important;
    }
}

/* Dark theme support */
[data-bs-theme="dark"] {
    .child-records {
        background-color: #212529;
    }

    .table th {
        background-color: #2d3338;
        color: #adb5bd;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Add animation to stat cards
    const statCards = document.querySelectorAll('.card-body.text-center');
    statCards.forEach((card, index) => {
        setTimeout(() => {
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';
            card.style.transition = 'opacity 0.5s ease, transform 0.5s ease';

            setTimeout(() => {
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, 100);
        }, index * 100);
    });
});
</script>
{% endblock %}
