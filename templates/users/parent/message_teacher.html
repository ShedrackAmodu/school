{% extends 'base/base.html' %}
{% load static i18n %}

{% block title %}{% trans "Message Teacher" %}{% endblock %}

{% block page_title %}{% trans "Message Teacher" %}{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'users:dashboard' %}">{% trans "Dashboard" %}</a></li>
<li class="breadcrumb-item active" aria-current="page">{% trans "Message Teacher" %}</li>
{% endblock %}

{% block content %}
<div class="message-teacher">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-envelope me-2"></i>
                        {% trans "Send Message to Teacher" %}
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}

                        <!-- Teacher Selection -->
                        <div class="mb-4">
                            <label for="id_teacher" class="form-label fw-bold">
                                <i class="bi bi-person me-2"></i>{% trans "Select Teacher" %}
                            </label>
                            <select class="form-select form-select-lg" id="id_teacher" name="teacher" required>
                                <option value="">{% trans "Choose a teacher..." %}</option>
                                {% for teacher in teachers %}
                                <option value="{{ teacher.user.id }}" {% if teacher.user.id == form.initial.teacher %}selected{% endif %}>
                                    {{ teacher.user.get_full_name }} - {{ teacher.department.name }}
                                    {% if teacher.is_class_teacher %}
                                        <span class="badge bg-info ms-2">{% trans "Class Teacher" %}</span>
                                    {% endif %}
                                </option>
                                {% endfor %}
                            </select>
                            {% if not teachers %}
                            <div class="alert alert-warning mt-2">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                {% trans "No teachers found for your children. Please ensure your children are properly enrolled in classes." %}
                            </div>
                            {% endif %}
                        </div>

                        <!-- Subject -->
                        <div class="mb-4">
                            <label for="id_subject" class="form-label fw-bold">
                                <i class="bi bi-tag me-2"></i>{% trans "Subject" %}
                            </label>
                            <input type="text" class="form-control form-control-lg" id="id_subject" name="subject"
                                   placeholder="{% trans 'Enter message subject...' %}" required
                                   value="{{ form.subject.value|default:'' }}">
                        </div>

                        <!-- Message Content -->
                        <div class="mb-4">
                            <label for="id_content" class="form-label fw-bold">
                                <i class="bi bi-chat-text me-2"></i>{% trans "Message" %}
                            </label>
                            <textarea class="form-control" id="id_content" name="content" rows="8"
                                      placeholder="{% trans 'Type your message here...' %}" required></textarea>
                            <div class="form-text">
                                {% trans "Please be respectful and clear in your communication. Teachers will respond as soon as possible." %}
                            </div>
                        </div>

                        <!-- Message Options -->
                        <div class="mb-4">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="id_is_important" name="is_important">
                                        <label class="form-check-label fw-bold" for="id_is_important">
                                            <i class="bi bi-exclamation-circle text-warning me-1"></i>
                                            {% trans "Mark as Important" %}
                                        </label>
                                        <div class="form-text">
                                            {% trans "Important messages are prioritized by teachers." %}
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="id_requires_confirmation" name="requires_confirmation">
                                        <label class="form-check-label fw-bold" for="id_requires_confirmation">
                                            <i class="bi bi-check-circle text-success me-1"></i>
                                            {% trans "Require Read Confirmation" %}
                                        </label>
                                        <div class="form-text">
                                            {% trans "You'll be notified when the teacher reads your message." %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Message Templates -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="bi bi-lightning me-2"></i>{% trans "Quick Templates" %}
                            </label>
                            <div class="row">
                                <div class="col-md-6 mb-2">
                                    <button type="button" class="btn btn-outline-secondary btn-sm w-100 text-start quick-template"
                                            data-subject="{% trans 'Question about homework' %}"
                                            data-content="{% trans 'Dear Teacher, I have a question about the homework assignment. Could you please provide more clarification on [specific topic]? Thank you.' %}">
                                        <i class="bi bi-question-circle me-1"></i>{% trans "Homework Question" %}
                                    </button>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <button type="button" class="btn btn-outline-secondary btn-sm w-100 text-start quick-template"
                                            data-subject="{% trans 'Concern about child's performance' %}"
                                            data-content="{% trans 'Dear Teacher, I am writing to discuss my child's recent performance in class. I would like to schedule a meeting to discuss how we can support their learning. Thank you.' %}">
                                        <i class="bi bi-graph-up me-1"></i>{% trans "Performance Concern" %}
                                    </button>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <button type="button" class="btn btn-outline-secondary btn-sm w-100 text-start quick-template"
                                            data-subject="{% trans 'Request for meeting' %}"
                                            data-content="{% trans 'Dear Teacher, I would like to schedule a parent-teacher meeting to discuss my child's progress. Please let me know your availability. Thank you.' %}">
                                        <i class="bi bi-calendar-event me-1"></i>{% trans "Meeting Request" %}
                                    </button>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <button type="button" class="btn btn-outline-secondary btn-sm w-100 text-start quick-template"
                                            data-subject="{% trans 'Positive feedback' %}"
                                            data-content="{% trans 'Dear Teacher, I wanted to express my appreciation for the excellent work you are doing with the students. My child really enjoys your class and has shown great improvement. Thank you for your dedication.' %}">
                                        <i class="bi bi-heart me-1"></i>{% trans "Positive Feedback" %}
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Buttons -->
                        <div class="d-flex justify-content-between align-items-center">
                            <a href="{% url 'users:dashboard' %}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left me-2"></i>{% trans "Back to Dashboard" %}
                            </a>
                            <div>
                                <button type="button" class="btn btn-outline-primary me-2" onclick="saveDraft()">
                                    <i class="bi bi-save me-1"></i>{% trans "Save Draft" %}
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-send me-2"></i>{% trans "Send Message" %}
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Communication Guidelines -->
            <div class="card border-0 shadow-sm mt-4">
                <div class="card-header bg-light">
                    <h6 class="card-title mb-0">
                        <i class="bi bi-info-circle me-2"></i>
                        {% trans "Communication Guidelines" %}
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-success mb-2">
                                <i class="bi bi-check-circle me-1"></i>{% trans "Do's" %}
                            </h6>
                            <ul class="list-unstyled small">
                                <li class="mb-1"><i class="bi bi-dot text-success"></i> {% trans "Be clear and specific about your concerns" %}</li>
                                <li class="mb-1"><i class="bi bi-dot text-success"></i> {% trans "Include relevant details and context" %}</li>
                                <li class="mb-1"><i class="bi bi-dot text-success"></i> {% trans "Express appreciation for teacher's efforts" %}</li>
                                <li class="mb-1"><i class="bi bi-dot text-success"></i> {% trans "Suggest specific times for meetings" %}</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-danger mb-2">
                                <i class="bi bi-x-circle me-1"></i>{% trans "Don'ts" %}
                            </h6>
                            <ul class="list-unstyled small">
                                <li class="mb-1"><i class="bi bi-dot text-danger"></i> {% trans "Use accusatory or demanding language" %}</li>
                                <li class="mb-1"><i class="bi bi-dot text-danger"></i> {% trans "Send messages outside school hours for urgent matters" %}</li>
                                <li class="mb-1"><i class="bi bi-dot text-danger"></i> {% trans "Share confidential student information" %}</li>
                                <li class="mb-1"><i class="bi bi-dot text-danger"></i> {% trans "Expect immediate responses to non-urgent messages" %}</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Messages -->
            {% if recent_messages %}
            <div class="card border-0 shadow-sm mt-4">
                <div class="card-header bg-light">
                    <h6 class="card-title mb-0">
                        <i class="bi bi-clock-history me-2"></i>
                        {% trans "Recent Messages" %}
                    </h6>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        {% for message in recent_messages %}
                        <div class="list-group-item px-0">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">{{ message.subject }}</h6>
                                    <p class="text-muted small mb-1">{{ message.content|truncatechars:100 }}</p>
                                    <small class="text-muted">
                                        {% trans "To:" %} {{ message.recipients.first.get_full_name }} â€¢
                                        {{ message.created_at|timesince }} {% trans "ago" %}
                                    </small>
                                </div>
                                <span class="badge bg-{% if message.is_important %}warning{% else %}secondary{% endif %}">
                                    {% if message.is_important %}{% trans "Important" %}{% else %}{% trans "Normal" %}{% endif %}
                                </span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.message-teacher {
    background-color: #f8f9fa;
    min-height: 100vh;
    padding: 2rem 0;
}

.card {
    border-radius: 0.75rem;
}

.form-select, .form-control {
    border-radius: 0.5rem;
}

.form-select:focus, .form-control:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

.quick-template {
    border-radius: 0.5rem;
    transition: all 0.2s ease;
}

.quick-template:hover {
    background-color: #f8f9fa;
    border-color: #0d6efd;
    color: #0d6efd;
}

.btn-group .btn {
    border-radius: 0.5rem !important;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .message-teacher {
        padding: 1rem 0;
    }

    .card-body {
        padding: 1.5rem 1rem;
    }

    .d-flex.justify-content-between {
        flex-direction: column;
        gap: 1rem;
    }

    .d-flex.justify-content-between .btn {
        width: 100%;
    }
}

/* Dark theme support */
[data-bs-theme="dark"] {
    .message-teacher {
        background-color: #212529;
    }

    .card-header.bg-light {
        background-color: #2d3338 !important;
        border-color: #495057;
    }

    .form-select, .form-control {
        background-color: #2d3338;
        border-color: #495057;
        color: #adb5bd;
    }

    .form-select:focus, .form-control:focus {
        background-color: #2d3338;
        border-color: #0d6efd;
        color: #adb5bd;
    }

    .quick-template {
        background-color: #2d3338;
        border-color: #495057;
        color: #adb5bd;
    }

    .quick-template:hover {
        background-color: #343a40;
        border-color: #0d6efd;
        color: #0d6efd;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Quick template functionality
    document.querySelectorAll('.quick-template').forEach(button => {
        button.addEventListener('click', function() {
            const subject = this.getAttribute('data-subject');
            const content = this.getAttribute('data-content');

            document.getElementById('id_subject').value = subject;
            document.getElementById('id_content').value = content;

            // Scroll to form
            document.querySelector('.card-body').scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });

            // Highlight the subject field briefly
            const subjectField = document.getElementById('id_subject');
            subjectField.style.backgroundColor = '#e3f2fd';
            setTimeout(() => {
                subjectField.style.backgroundColor = '';
            }, 1000);
        });
    });

    // Form validation
    const form = document.querySelector('form');
    form.addEventListener('submit', function(e) {
        const teacher = document.getElementById('id_teacher').value;
        const subject = document.getElementById('id_subject').value.trim();
        const content = document.getElementById('id_content').value.trim();

        if (!teacher) {
            e.preventDefault();
            alert('{% trans "Please select a teacher." %}');
            document.getElementById('id_teacher').focus();
            return;
        }

        if (!subject) {
            e.preventDefault();
            alert('{% trans "Please enter a subject." %}');
            document.getElementById('id_subject').focus();
            return;
        }

        if (!content) {
            e.preventDefault();
            alert('{% trans "Please enter your message." %}');
            document.getElementById('id_content').focus();
            return;
        }

        if (content.length < 10) {
            e.preventDefault();
            alert('{% trans "Please provide a more detailed message (at least 10 characters)." %}');
            document.getElementById('id_content').focus();
            return;
        }
    });

    // Character counter for message
    const contentTextarea = document.getElementById('id_content');
    const charCounter = document.createElement('small');
    charCounter.className = 'form-text text-muted';
    charCounter.style.display = 'none';
    contentTextarea.parentNode.appendChild(charCounter);

    contentTextarea.addEventListener('input', function() {
        const length = this.value.length;
        if (length > 0) {
            charCounter.textContent = `{% trans "Characters:" %} ${length}`;
            charCounter.style.display = 'block';
        } else {
            charCounter.style.display = 'none';
        }
    });
});

// Save draft functionality (placeholder)
function saveDraft() {
    // In a real implementation, this would save the message as a draft
    alert('{% trans "Draft saving functionality would be implemented here." %}');
}
</script>
{% endblock %}
