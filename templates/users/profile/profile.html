{% extends 'base/base.html' %}
{% load static i18n %}

{% block title %}{% trans "My Profile - School Management System" %}{% endblock %}

{% block meta_description %}{% trans "Manage your personal information, contact details, and account settings in your School Management System profile." %}{% endblock %}

{% block body_class %}profile-page{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Profile Sidebar -->
        <div class="col-lg-4 col-xl-3">
            <div class="card profile-sidebar border-0 shadow-sm mb-4">
                <div class="card-body text-center p-4">
                    <!-- Profile Picture -->
                    <div class="profile-picture-section mb-4">
                        <div class="profile-picture-wrapper position-relative mx-auto">
                            {% if user.profile.profile_picture %}
                            <img src="{{ user.profile.profile_picture.url }}" 
                                 alt="{{ user.display_name }}" 
                                 class="profile-picture rounded-circle"
                                 id="profilePicture">
                            {% else %}
                            <div class="profile-picture-placeholder rounded-circle bg-primary text-white d-flex align-items-center justify-content-center mx-auto"
                                 id="profilePicturePlaceholder">
                                <span class="fw-bold fs-3">{{ user.get_initials }}</span>
                            </div>
                            {% endif %}
                            
                            <!-- Profile Picture Upload -->
                            <button type="button" class="btn btn-primary btn-sm rounded-circle position-absolute bottom-0 end-0 profile-picture-upload"
                                    data-bs-toggle="modal" data-bs-target="#profilePictureModal">
                                <i class="bi bi-camera"></i>
                            </button>
                        </div>
                        
                        <div class="mt-3">
                            <h4 class="fw-bold mb-1">{{ user.display_name }}</h4>
                            <p class="text-muted mb-2">
                                {% with primary_role=user.user_roles.filter.is_primary.first %}
                                    {{ primary_role.role.name|default:"User" }}
                                {% endwith %}
                            </p>
                            <span class="badge bg-{% if user.is_verified %}success{% else %}warning{% endif %}">
                                <i class="bi bi-{% if user.is_verified %}check-circle{% else %}clock{% endif %} me-1"></i>
                                {% if user.is_verified %}{% trans "Verified" %}{% else %}{% trans "Pending Verification" %}{% endif %}
                            </span>
                        </div>
                    </div>

                    <!-- Quick Stats -->
                    <div class="profile-stats row g-2 mb-4">
                        <div class="col-4">
                            <div class="stat-item p-2 rounded bg-light">
                                <div class="fw-bold text-primary">{{ user.login_count }}</div>
                                <small class="text-muted">{% trans "Logins" %}</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="stat-item p-2 rounded bg-light">
                                <div class="fw-bold text-success">
                                   {% with unread_count=user.notifications.unread.count %}
                                        {{ unread_count|default:0 }}
                                        {% endwith %}
                                </div>
                                <small class="text-muted">{% trans "Alerts" %}</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="stat-item p-2 rounded bg-light">
                                <div class="fw-bold text-info">
                                    {{ user.user_roles.count }}
                                </div>
                                <small class="text-muted">{% trans "Roles" %}</small>
                            </div>
                        </div>
                    </div>

                    <!-- Navigation Menu -->
                    <div class="profile-navigation">
                        <div class="nav flex-column nav-pills" id="profileTab" role="tablist">
                            <button class="nav-link active" id="personal-tab" data-bs-toggle="pill" data-bs-target="#personal" type="button">
                                <i class="bi bi-person me-2"></i>
                                {% trans "Personal Info" %}
                            </button>
                            <button class="nav-link" id="contact-tab" data-bs-toggle="pill" data-bs-target="#contact" type="button">
                                <i class="bi bi-telephone me-2"></i>
                                {% trans "Contact Details" %}
                            </button>
                            <button class="nav-link" id="account-tab" data-bs-toggle="pill" data-bs-target="#account" type="button">
                                <i class="bi bi-shield-lock me-2"></i>
                                {% trans "Account Settings" %}
                            </button>
                            <button class="nav-link" id="preferences-tab" data-bs-toggle="pill" data-bs-target="#preferences" type="button">
                                <i class="bi bi-gear me-2"></i>
                                {% trans "Preferences" %}
                            </button>
                            {% if user.user_roles.count > 0 %}
                            <button class="nav-link" id="roles-tab" data-bs-toggle="pill" data-bs-target="#roles" type="button">
                                <i class="bi bi-person-badge me-2"></i>
                                {% trans "My Roles" %}
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Security Status Card -->
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h6 class="fw-bold mb-3">{% trans "Security Status" %}</h6>
                    <div class="security-status">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="small">{% trans "Email Verification" %}</span>
                            {% if user.is_verified %}
                            <i class="bi bi-check-circle-fill text-success"></i>
                            {% else %}
                            <i class="bi bi-exclamation-circle-fill text-warning"></i>
                            {% endif %}
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="small">{% trans "Password Strength" %}</span>
                            <i class="bi bi-shield-check text-success"></i>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="small">{% trans "Two-Factor Auth" %}</span>
                            <i class="bi bi-shield-x text-muted"></i>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="small">{% trans "Last Login" %}</span>
                            <span class="small text-muted">{{ user.last_login|timesince }} ago</span>
                        </div>
                    </div>
                    <hr>
                    <a href="{% url 'users:password_change' %}" class="btn btn-outline-primary btn-sm w-100">
                        <i class="bi bi-key me-1"></i>
                        {% trans "Change Password" %}
                    </a>
                </div>
            </div>
        </div>

        <!-- Profile Content -->
        <div class="col-lg-8 col-xl-9">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <!-- Tab Content -->
                    <div class="tab-content" id="profileTabContent">
                        <!-- Personal Information Tab -->
                        <div class="tab-pane fade show active" id="personal" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h4 class="fw-bold mb-0">{% trans "Personal Information" %}</h4>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="enableEditing('personal')">
                                    <i class="bi bi-pencil me-1"></i>
                                    {% trans "Edit" %}
                                </button>
                            </div>

                            <form method="post" id="personalForm">
                                {% csrf_token %}
                                <input type="hidden" name="form_type" value="personal">
                                
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="{{ user_form.first_name.id_for_label }}" class="form-label">
                                            {% trans "First Name" %} *
                                        </label>
                                        {{ user_form.first_name }}
                                        {% if user_form.first_name.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ user_form.first_name.errors.0 }}
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6">
                                        <label for="{{ user_form.last_name.id_for_label }}" class="form-label">
                                            {% trans "Last Name" %} *
                                        </label>
                                        {{ user_form.last_name }}
                                        {% if user_form.last_name.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ user_form.last_name.errors.0 }}
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6">
                                        <label for="{{ profile_form.date_of_birth.id_for_label }}" class="form-label">
                                            {% trans "Date of Birth" %}
                                        </label>
                                        {{ profile_form.date_of_birth }}
                                    </div>
                                    <div class="col-md-6">
                                        <label for="{{ profile_form.gender.id_for_label }}" class="form-label">
                                            {% trans "Gender" %}
                                        </label>
                                        {{ profile_form.gender }}
                                    </div>
                                    <div class="col-md-6">
                                        <label for="{{ profile_form.nationality.id_for_label }}" class="form-label">
                                            {% trans "Nationality" %}
                                        </label>
                                        {{ profile_form.nationality }}
                                    </div>
                                    <div class="col-md-6">
                                        <label for="{{ profile_form.identification_number.id_for_label }}" class="form-label">
                                            {% trans "Identification Number" %}
                                        </label>
                                        {{ profile_form.identification_number }}
                                    </div>
                                    <div class="col-12">
                                        <label for="{{ profile_form.bio.id_for_label }}" class="form-label">
                                            {% trans "Biography" %}
                                        </label>
                                        {{ profile_form.bio }}
                                        <div class="form-text">{% trans "Tell us a bit about yourself" %}</div>
                                    </div>
                                </div>

                                <div class="mt-4">
                                    <button type="submit" class="btn btn-primary" name="save_personal">
                                        <i class="bi bi-check-lg me-1"></i>
                                        {% trans "Save Changes" %}
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="disableEditing('personal')">
                                        {% trans "Cancel" %}
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- Contact Details Tab -->
                        <div class="tab-pane fade" id="contact" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h4 class="fw-bold mb-0">{% trans "Contact Details" %}</h4>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="enableEditing('contact')">
                                    <i class="bi bi-pencil me-1"></i>
                                    {% trans "Edit" %}
                                </button>
                            </div>

                            <form method="post" id="contactForm">
                                {% csrf_token %}
                                <input type="hidden" name="form_type" value="contact">
                                
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">{% trans "Primary Email" %}</label>
                                        <input type="email" class="form-control" value="{{ user.email }}" readonly>
                                        <div class="form-text">{% trans "Primary email cannot be changed" %}</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="{{ user_form.mobile.id_for_label }}" class="form-label">
                                            {% trans "Mobile Number" %}
                                        </label>
                                        {{ user_form.mobile }}
                                    </div>
                                    <div class="col-md-6">
                                        <label for="{{ profile_form.phone.id_for_label }}" class="form-label">
                                            {% trans "Phone Number" %}
                                        </label>
                                        {{ profile_form.phone }}
                                    </div>
                                    <div class="col-md-6">
                                        <label for="{{ profile_form.email.id_for_label }}" class="form-label">
                                            {% trans "Alternative Email" %}
                                        </label>
                                        {{ profile_form.email }}
                                    </div>
                                </div>

                                <h6 class="mt-4 mb-3 fw-semibold">{% trans "Emergency Contact" %}</h6>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="{{ profile_form.emergency_contact.id_for_label }}" class="form-label">
                                            {% trans "Emergency Contact Name" %}
                                        </label>
                                        {{ profile_form.emergency_contact }}
                                    </div>
                                    <div class="col-md-6">
                                        <label for="{{ profile_form.emergency_phone.id_for_label }}" class="form-label">
                                            {% trans "Emergency Phone" %}
                                        </label>
                                        {{ profile_form.emergency_phone }}
                                    </div>
                                </div>

                                <h6 class="mt-4 mb-3 fw-semibold">{% trans "Address" %}</h6>
                                <div class="row g-3">
                                    <div class="col-12">
                                        <label for="{{ profile_form.address_line_1.id_for_label }}" class="form-label">
                                            {% trans "Address Line 1" %}
                                        </label>
                                        {{ profile_form.address_line_1 }}
                                    </div>
                                    <div class="col-12">
                                        <label for="{{ profile_form.address_line_2.id_for_label }}" class="form-label">
                                            {% trans "Address Line 2" %}
                                        </label>
                                        {{ profile_form.address_line_2 }}
                                    </div>
                                    <div class="col-md-4">
                                        <label for="{{ profile_form.city.id_for_label }}" class="form-label">
                                            {% trans "City" %}
                                        </label>
                                        {{ profile_form.city }}
                                    </div>
                                    <div class="col-md-4">
                                        <label for="{{ profile_form.state.id_for_label }}" class="form-label">
                                            {% trans "State/Province" %}
                                        </label>
                                        {{ profile_form.state }}
                                    </div>
                                    <div class="col-md-4">
                                        <label for="{{ profile_form.postal_code.id_for_label }}" class="form-label">
                                            {% trans "Postal Code" %}
                                        </label>
                                        {{ profile_form.postal_code }}
                                    </div>
                                    <div class="col-12">
                                        <label for="{{ profile_form.country.id_for_label }}" class="form-label">
                                            {% trans "Country" %}
                                        </label>
                                        {{ profile_form.country }}
                                    </div>
                                </div>

                                <div class="mt-4">
                                    <button type="submit" class="btn btn-primary" name="save_contact">
                                        <i class="bi bi-check-lg me-1"></i>
                                        {% trans "Save Changes" %}
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="disableEditing('contact')">
                                        {% trans "Cancel" %}
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- Account Settings Tab -->
                        <div class="tab-pane fade" id="account" role="tabpanel">
                            <h4 class="fw-bold mb-4">{% trans "Account Settings" %}</h4>
                            
                            <div class="row g-4">
                                <!-- Email Verification -->
                                <div class="col-12">
                                    <div class="card border-0 bg-light">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <h6 class="fw-semibold mb-1">{% trans "Email Verification" %}</h6>
                                                    <p class="text-muted mb-0 small">
                                                        {% if user.is_verified %}
                                                        {% trans "Your email address has been verified" %}
                                                        {% else %}
                                                        {% trans "Please verify your email address to access all features" %}
                                                        {% endif %}
                                                    </p>
                                                </div>
                                                <div>
                                                    {% if user.is_verified %}
                                                    <span class="badge bg-success">
                                                        <i class="bi bi-check-circle me-1"></i>
                                                        {% trans "Verified" %}
                                                    </span>
                                                    {% else %}
                                                    <button class="btn btn-outline-warning btn-sm">
                                                        <i class="bi bi-envelope me-1"></i>
                                                        {% trans "Verify Email" %}
                                                    </button>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Password Change -->
                                <div class="col-12">
                                    <div class="card border-0 bg-light">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <h6 class="fw-semibold mb-1">{% trans "Password Security" %}</h6>
                                                    <p class="text-muted mb-0 small">
                                                        {% trans "Last changed" %} {{ user.password_history.last.changed_at|timesince|default:"never" }} ago
                                                    </p>
                                                </div>
                                                <div>
                                                    <a href="{% url 'users:password_change' %}" class="btn btn-primary btn-sm">
                                                        <i class="bi bi-key me-1"></i>
                                                        {% trans "Change Password" %}
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Login History -->
                                <div class="col-12">
                                    <div class="card border-0 bg-light">
                                        <div class="card-body">
                                            <h6 class="fw-semibold mb-3">{% trans "Recent Login Activity" %}</h6>
                                            <div class="login-history">
                                                {% for login in user.login_history.all|slice:":5" %}
                                                <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                                                    <div>
                                                        <div class="fw-semibold">
                                                            <i class="bi bi-{{ login.login_method }} me-1"></i>
                                                            {{ login.get_login_method_display }}
                                                        </div>
                                                        <small class="text-muted">
                                                            {{ login.ip_address }} â€¢ {{ login.created_at|timesince }} ago
                                                        </small>
                                                    </div>
                                                    <span class="badge bg-{% if login.was_successful %}success{% else %}danger{% endif %}">
                                                        {% if login.was_successful %}{% trans "Success" %}{% else %}{% trans "Failed" %}{% endif %}
                                                    </span>
                                                </div>
                                                {% empty %}
                                                <p class="text-muted text-center mb-0">{% trans "No login history available" %}</p>
                                                {% endfor %}
                                            </div>
                                            <div class="mt-3">
                                                {% comment %} <a href="{% url 'users:login_history' %}" class="btn btn-outline-secondary btn-sm w-100">
                                                    {% trans "View Full History" %}
                                                </a> {% endcomment %}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Account Status -->
                                <div class="col-12">
                                    <div class="card border-0 bg-light">
                                        <div class="card-body">
                                            <h6 class="fw-semibold mb-3">{% trans "Account Status" %}</h6>
                                            <div class="row g-2">
                                                <div class="col-6">
                                                    <small class="text-muted">{% trans "Status" %}</small>
                                                    <div class="fw-semibold">
                                                        <span class="badge bg-{% if user.status == 'active' %}success{% else %}warning{% endif %}">
                                                            {{ user.get_status_display }}
                                                        </span>
                                                    </div>
                                                </div>
                                                <div class="col-6">
                                                    <small class="text-muted">{% trans "Member Since" %}</small>
                                                    <div class="fw-semibold">{{ user.created_at|date:"M j, Y" }}</div>
                                                </div>
                                                <div class="col-6">
                                                    <small class="text-muted">{% trans "Last Login" %}</small>
                                                    <div class="fw-semibold">{{ user.last_login|timesince }} ago</div>
                                                </div>
                                                <div class="col-6">
                                                    <small class="text-muted">{% trans "Login Count" %}</small>
                                                    <div class="fw-semibold">{{ user.login_count }}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Preferences Tab -->
                        <div class="tab-pane fade" id="preferences" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h4 class="fw-bold mb-0">{% trans "Preferences" %}</h4>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="enableEditing('preferences')">
                                    <i class="bi bi-pencil me-1"></i>
                                    {% trans "Edit" %}
                                </button>
                            </div>

                            <form method="post" id="preferencesForm">
                                {% csrf_token %}
                                <input type="hidden" name="form_type" value="preferences">
                                
                                <div class="row g-4">
                                    <div class="col-md-6">
                                        <label for="{{ user_form.language.id_for_label }}" class="form-label">
                                            {% trans "Language" %}
                                        </label>
                                        {{ user_form.language }}
                                    </div>
                                    <div class="col-md-6">
                                        <label for="{{ user_form.timezone.id_for_label }}" class="form-label">
                                            {% trans "Timezone" %}
                                        </label>
                                        {{ user_form.timezone }}
                                    </div>
                                </div>

                                <h6 class="mt-4 mb-3 fw-semibold">{% trans "Notification Preferences" %}</h6>
                                <div class="row g-3">
                                    <div class="col-12">
                                        <div class="form-check form-switch">
                                            {{ profile_form.email_notifications }}
                                            <label class="form-check-label" for="{{ profile_form.email_notifications.id_for_label }}">
                                                {% trans "Email Notifications" %}
                                            </label>
                                        </div>
                                        <div class="form-text">{% trans "Receive important updates via email" %}</div>
                                    </div>
                                    <div class="col-12">
                                        <div class="form-check form-switch">
                                            {{ profile_form.sms_notifications }}
                                            <label class="form-check-label" for="{{ profile_form.sms_notifications.id_for_label }}">
                                                {% trans "SMS Notifications" %}
                                            </label>
                                        </div>
                                        <div class="form-text">{% trans "Receive urgent alerts via SMS" %}</div>
                                    </div>
                                    <div class="col-12">
                                        <div class="form-check form-switch">
                                            {{ profile_form.push_notifications }}
                                            <label class="form-check-label" for="{{ profile_form.push_notifications.id_for_label }}">
                                                {% trans "Push Notifications" %}
                                            </label>
                                        </div>
                                        <div class="form-text">{% trans "Receive notifications in your browser" %}</div>
                                    </div>
                                </div>

                                <h6 class="mt-4 mb-3 fw-semibold">{% trans "Social Media" %}</h6>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="{{ profile_form.website.id_for_label }}" class="form-label">
                                            {% trans "Website" %}
                                        </label>
                                        {{ profile_form.website }}
                                    </div>
                                    <div class="col-md-6">
                                        <label for="{{ profile_form.linkedin.id_for_label }}" class="form-label">
                                            {% trans "LinkedIn" %}
                                        </label>
                                        {{ profile_form.linkedin }}
                                    </div>
                                    <div class="col-md-6">
                                        <label for="{{ profile_form.facebook.id_for_label }}" class="form-label">
                                            {% trans "Facebook" %}
                                        </label>
                                        {{ profile_form.facebook }}
                                    </div>
                                    <div class="col-md-6">
                                        <label for="{{ profile_form.twitter.id_for_label }}" class="form-label">
                                            {% trans "Twitter" %}
                                        </label>
                                        {{ profile_form.twitter }}
                                    </div>
                                </div>

                                <div class="mt-4">
                                    <button type="submit" class="btn btn-primary" name="save_preferences">
                                        <i class="bi bi-check-lg me-1"></i>
                                        {% trans "Save Preferences" %}
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="disableEditing('preferences')">
                                        {% trans "Cancel" %}
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- Roles Tab -->
                        {% if user.user_roles.count > 0 %}
                        <div class="tab-pane fade" id="roles" role="tabpanel">
                            <h4 class="fw-bold mb-4">{% trans "My Roles" %}</h4>
                            
                            <div class="row g-4">
                                {% for user_role in user.user_roles.all %}
                                <div class="col-lg-6">
                                    <div class="card border-0 shadow-sm h-100">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-start mb-3">
                                                <div>
                                                    <h5 class="fw-bold mb-1">{{ user_role.role.name }}</h5>
                                                    <span class="badge bg-{% if user_role.is_primary %}primary{% else %}secondary{% endif %}">
                                                        {% if user_role.is_primary %}{% trans "Primary" %}{% else %}{% trans "Secondary" %}{% endif %}
                                                    </span>
                                                </div>
                                                <i class="bi bi-person-badge fs-4 text-{{ user_role.role.role_type }}"></i>
                                            </div>
                                            
                                            <p class="text-muted small mb-3">{{ user_role.role.description }}</p>
                                            
                                            <div class="role-meta">
                                                <div class="d-flex justify-content-between small text-muted mb-1">
                                                    <span>{% trans "Academic Session" %}</span>
                                                    <span>{{ user_role.academic_session.name|default:"N/A" }}</span>
                                                </div>
                                                <div class="d-flex justify-content-between small text-muted mb-1">
                                                    <span>{% trans "Context" %}</span>
                                                    <span>{{ user_role.context_id|default:"N/A" }}</span>
                                                </div>
                                                <div class="d-flex justify-content-between small text-muted">
                                                    <span>{% trans "Assigned" %}</span>
                                                    <span>{{ user_role.created_at|timesince }} ago</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Profile Picture Modal -->
<div class="modal fade" id="profilePictureModal" tabindex="-1" aria-labelledby="profilePictureModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="profilePictureModalLabel">{% trans "Update Profile Picture" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="profilePictureForm" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="text-center mb-4">
                        <div class="profile-picture-preview mx-auto mb-3">
                            {% if user.profile.profile_picture %}
                            <img src="{{ user.profile.profile_picture.url }}" alt="Preview" class="rounded-circle" id="picturePreview" style="width: 150px; height: 150px; object-fit: cover;">
                            {% else %}
                            <div class="rounded-circle bg-light d-flex align-items-center justify-content-center mx-auto" id="picturePreviewPlaceholder" style="width: 150px; height: 150px;">
                                <span class="fw-bold fs-1">{{ user.get_initials }}</span>
                            </div>
                            {% endif %}
                        </div>
                        <input type="file" class="form-control" id="profile_picture" name="profile_picture" accept="image/*" style="display: none;">
                        <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('profile_picture').click()">
                            <i class="bi bi-upload me-1"></i>
                            {% trans "Choose Image" %}
                        </button>
                    </div>
                    <div class="form-text text-center">
                        {% trans "Recommended: Square image, 500x500 pixels, JPG or PNG format" %}
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
                <button type="button" class="btn btn-primary" onclick="uploadProfilePicture()">{% trans "Save Picture" %}</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.profile-page {
    background-color: #f8f9fa;
}

.profile-sidebar {
    position: sticky;
    top: 1rem;
}

.profile-picture-wrapper {
    width: 120px;
    height: 120px;
}

.profile-picture,
.profile-picture-placeholder {
    width: 120px;
    height: 120px;
    object-fit: cover;
}

.profile-picture-upload {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.profile-navigation .nav-link {
    text-align: left;
    padding: 0.75rem 1rem;
    border-radius: 0.5rem;
    margin-bottom: 0.5rem;
    color: #495057;
    border: none;
    transition: all 0.3s ease;
}

.profile-navigation .nav-link:hover,
.profile-navigation .nav-link.active {
    background-color: #0d6efd;
    color: white;
}

.profile-navigation .nav-link i {
    width: 20px;
    text-align: center;
}

.stat-item {
    transition: all 0.3s ease;
}

.stat-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* Form Styles */
.form-control:disabled,
.form-control[readonly] {
    background-color: #f8f9fa;
    opacity: 1;
}

.form-control:not(:disabled):not([readonly]) {
    background-color: white;
}

/* Tab Content Animations */
.tab-pane {
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

/* Role Cards */
.role-meta {
    border-top: 1px solid #e9ecef;
    padding-top: 1rem;
}

/* Security Status */
.security-status .bi-check-circle-fill {
    font-size: 1.1rem;
}

/* Dark Theme Support */
[data-bs-theme="dark"] .profile-page {
    background-color: #212529;
}

[data-bs-theme="dark"] .card.bg-light {
    background-color: #343a40 !important;
}

[data-bs-theme="dark"] .form-control:disabled,
[data-bs-theme="dark"] .form-control[readonly] {
    background-color: #495057;
}

[data-bs-theme="dark"] .text-muted {
    color: #adb5bd !important;
}

/* Responsive Design */
@media (max-width: 991.98px) {
    .profile-sidebar {
        position: static;
        margin-bottom: 1rem;
    }
    
    .profile-picture-wrapper {
        width: 100px;
        height: 100px;
    }
    
    .profile-picture,
    .profile-picture-placeholder {
        width: 100px;
        height: 100px;
    }
}

@media (max-width: 575.98px) {
    .profile-stats .col-4 {
        margin-bottom: 0.5rem;
    }
    
    .profile-navigation .nav-link {
        padding: 0.5rem 0.75rem;
        font-size: 0.9rem;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize form states
    disableAllEditing();
    
    // Profile picture preview
    const profilePictureInput = document.getElementById('profile_picture');
    if (profilePictureInput) {
        profilePictureInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('picturePreview');
                    const placeholder = document.getElementById('picturePreviewPlaceholder');
                    
                    if (preview) {
                        preview.src = e.target.result;
                    } else if (placeholder) {
                        placeholder.innerHTML = `<img src="${e.target.result}" class="rounded-circle" style="width: 150px; height: 150px; object-fit: cover;">`;
                    }
                };
                reader.readAsDataURL(file);
            }
        });
    }
    
    // Tab persistence
    const activeTab = localStorage.getItem('activeProfileTab');
    if (activeTab) {
        const tab = document.querySelector(`[data-bs-target="${activeTab}"]`);
        if (tab) {
            new bootstrap.Tab(tab).show();
        }
    }
    
    // Save active tab on change
    const tabEl = document.querySelector('a[data-bs-toggle="pill"]');
    if (tabEl) {
        tabEl.addEventListener('shown.bs.tab', function (e) {
            localStorage.setItem('activeProfileTab', e.target.getAttribute('data-bs-target'));
        });
    }
});

function enableEditing(formType) {
    const form = document.getElementById(formType + 'Form');
    const inputs = form.querySelectorAll('input, select, textarea');
    
    inputs.forEach(input => {
        if (!input.hasAttribute('readonly') && input.type !== 'hidden') {
            input.disabled = false;
        }
    });
    
    // Show save/cancel buttons
    const saveButton = form.querySelector('button[type="submit"]');
    const cancelButton = form.querySelector('button[type="button"]');
    
    if (saveButton) saveButton.style.display = 'inline-block';
    if (cancelButton) cancelButton.style.display = 'inline-block';
}

function disableEditing(formType) {
    const form = document.getElementById(formType + 'Form');
    const inputs = form.querySelectorAll('input, select, textarea');
    
    inputs.forEach(input => {
        if (!input.hasAttribute('readonly') && input.type !== 'hidden') {
            input.disabled = true;
        }
    });
    
    // Hide save/cancel buttons
    const saveButton = form.querySelector('button[type="submit"]');
    const cancelButton = form.querySelector('button[type="button"]');
    
    if (saveButton) saveButton.style.display = 'none';
    if (cancelButton) cancelButton.style.display = 'none';
    
    // Reset form to original values
    form.reset();
}

function disableAllEditing() {
    const forms = ['personal', 'contact', 'preferences'];
    forms.forEach(formType => {
        disableEditing(formType);
    });
}

function uploadProfilePicture() {
    const form = document.getElementById('profilePictureForm');
    const formData = new FormData(form);
    const fileInput = document.getElementById('profile_picture');

    // Check if a file is selected
    if (!fileInput.files || fileInput.files.length === 0) {
        showToast('{% trans "Please select a file first" %}', 'warning');
        return;
    }

    // Show loading state
    const saveButton = document.querySelector('#profilePictureModal .btn-primary');
    const originalText = saveButton.innerHTML;
    saveButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Uploading...';
    saveButton.disabled = true;

    // Add CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfToken) {
        formData.append('csrfmiddlewaretoken', csrfToken.value);
    }

    // Make AJAX request
    fetch('{% url "users:upload_profile_picture" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update profile picture in sidebar
            const profilePicture = document.getElementById('profilePicture');
            const profilePicturePlaceholder = document.getElementById('profilePicturePlaceholder');

            if (data.picture_url) {
                if (profilePicture) {
                    profilePicture.src = data.picture_url;
                } else if (profilePicturePlaceholder) {
                    profilePicturePlaceholder.innerHTML = `<img src="${data.picture_url}" alt="{{ user.display_name }}" class="profile-picture rounded-circle">`;
                }
            }

            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('profilePictureModal'));
            modal.hide();

            // Show success message
            showToast(data.message, 'success');

            // Reset form
            form.reset();
            const picturePreview = document.getElementById('picturePreview');
            const picturePreviewPlaceholder = document.getElementById('picturePreviewPlaceholder');
            if (picturePreview) picturePreview.src = '';
            if (picturePreviewPlaceholder) picturePreviewPlaceholder.innerHTML = '<span class="fw-bold fs-1">{{ user.get_initials }}</span>';

        } else {
            // Show error message
            showToast(data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Error uploading profile picture:', error);
        showToast('{% trans "An error occurred while uploading the picture" %}', 'danger');
    })
    .finally(() => {
        // Reset button state
        saveButton.innerHTML = originalText;
        saveButton.disabled = false;
    });
}

function showToast(message, type = 'info') {
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    // Add to container
    const container = document.querySelector('.toast-container') || createToastContainer();
    container.appendChild(toast);
    
    // Show toast
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    // Remove after hide
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}

function createToastContainer() {
    const container = document.createElement('div');
    container.className = 'toast-container position-fixed top-0 end-0 p-3';
    container.style.zIndex = '9999';
    document.body.appendChild(container);
    return container;
}

// Form submission handling
document.addEventListener('submit', function(e) {
    if (e.target.matches('form')) {
        // Show loading state
        const submitButton = e.target.querySelector('button[type="submit"]');
        if (submitButton) {
            const originalText = submitButton.innerHTML;
            submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';
            submitButton.disabled = true;
            
            // Re-enable after submission (in case of error)
            setTimeout(() => {
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
            }, 3000);
        }
    }
});
</script>
{% endblock %}
