{% extends 'base/base.html' %}
{% load static i18n %}

{% block title %}{% trans "Dashboard - School Management System" %}{% endblock %}

{% block meta_description %}{% trans "Your personalized dashboard with quick access to important information, announcements, and system features." %}{% endblock %}

{% block body_class %}dashboard-page{% endblock %}

{% block page_title %}{% trans "Dashboard" %}{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'users:dashboard' %}">{% trans "Dashboard" %}</a></li>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Welcome Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 bg-primary text-white welcome-card">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h2 class="card-title h4 mb-2">
                                {% trans "Welcome back" %}, {{ user.display_name }}!
                            </h2>
                            <p class="card-text mb-0 opacity-75">
                                {% now "l, F j, Y" %}
                            </p>
                            {% if primary_role %}
                            <span class="badge bg-light text-primary mt-2">
                                {{ primary_role.role.name }}
                            </span>
                            {% endif %}
                        </div>
                        <div class="col-md-4 text-md-end">
                            <div class="dashboard-stats-mini">
                                <div class="stat-item">
                                    <i class="bi bi-bell fs-1 opacity-50"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Stats Row -->
    <div class="row mb-4">
        <!-- Notifications Card -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title text-muted mb-2">{% trans "Notifications" %}</h6>
                            <h3 class="fw-bold text-primary mb-0">
                                {% with unread_count=user.notifications.unread.count %}
                                    {{ unread_count|default:0 }}
                                {% endwith %}
                            </h3>
                        </div>
                        <div class="avatar avatar-sm bg-primary text-white rounded-circle">
                            <i class="bi bi-bell"></i>
                        </div>
                    </div>
                    <p class="text-muted small mb-0 mt-2">
                        {% trans "Unread messages" %}
                    </p>
                </div>
                <div class="card-footer bg-transparent border-0 pt-0">
                    <a href="{% url 'communication:notification_list' %}" class="btn btn-outline-primary btn-sm">
                        {% trans "View All" %}
                    </a>
                </div>
            </div>
        </div>

        <!-- Login History Card -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title text-muted mb-2">{% trans "Last Login" %}</h6>
                            <h3 class="fw-bold text-success mb-0">
                                {{ user.last_login|timesince }}
                            </h3>
                        </div>
                        <div class="avatar avatar-sm bg-success text-white rounded-circle">
                            <i class="bi bi-clock-history"></i>
                        </div>
                    </div>
                    <p class="text-muted small mb-0 mt-2">
                        {% trans "ago" %}
                    </p>
                </div>
                <div class="card-footer bg-transparent border-0 pt-0">
                    <small class="text-muted">
                        IP: {{ user.current_login_ip|default:"N/A" }}
                    </small>
                </div>
            </div>
        </div>

        <!-- System Status Card -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title text-muted mb-2">{% trans "System Status" %}</h6>
                            <h3 class="fw-bold text-success mb-0">{% trans "Online" %}</h3>
                        </div>
                        <div class="avatar avatar-sm bg-success text-white rounded-circle">
                            <i class="bi bi-check-circle"></i>
                        </div>
                    </div>
                    <p class="text-muted small mb-0 mt-2">
                        {% trans "All systems operational" %}
                    </p>
                </div>
                <div class="card-footer bg-transparent border-0 pt-0">
                    <small class="text-muted">
                        v{{ SYSTEM_VERSION|default:"1.0.0" }}
                    </small>
                </div>
            </div>
        </div>

        <!-- Quick Actions Card -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title text-muted mb-2">{% trans "Quick Actions" %}</h6>
                            <h3 class="fw-bold text-info mb-0">{% trans "Ready" %}</h3>
                        </div>
                        <div class="avatar avatar-sm bg-info text-white rounded-circle">
                            <i class="bi bi-lightning"></i>
                        </div>
                    </div>
                    <p class="text-muted small mb-0 mt-2">
                        {% trans "Access frequently used features" %}
                    </p>
                </div>
                <div class="card-footer bg-transparent border-0 pt-0">
                    <button class="btn btn-outline-info btn-sm" data-bs-toggle="modal" data-bs-target="#quickActionModal">
                        {% trans "Show Actions" %}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="row">
        <!-- Left Column - Role Specific Content -->
        <div class="col-lg-8">
            {% if primary_role and primary_role.role.role_type == 'student' %}
                <!-- Student Dashboard -->
                {% include 'users/dashboard/student_dashboard.html' %}
            {% elif primary_role and primary_role.role.role_type == 'teacher' %}
                <!-- Teacher Dashboard -->
                {% include 'users/dashboard/teacher_dashboard.html' %}
            {% elif primary_role and primary_role.role.role_type == 'parent' %}
                <!-- Parent Dashboard -->
                {% include 'users/dashboard/parent_dashboard.html' %}
            {% elif is_admin_staff %}
                <!-- Admin/Staff Dashboard -->
                {% include 'users/dashboard/staff_dashboard.html' %}
            {% else %}
                <!-- Default Dashboard for users without specific roles -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-body">
                        <h5 class="card-title">{% trans "Welcome to Your Dashboard" %}</h5>
                        <p class="card-text">
                            {% trans "This is your personal dashboard. As you start using the system, you'll see relevant information and quick links here based on your role and activities." %}
                        </p>
                        
                        <div class="row mt-4">
                            <div class="col-md-6 mb-3">
                                <div class="d-flex align-items-center p-3 border rounded">
                                    <i class="bi bi-person fs-2 text-primary me-3"></i>
                                    <div>
                                        <h6 class="mb-1">{% trans "Complete Your Profile" %}</h6>
                                        <p class="text-muted mb-0 small">{% trans "Add your personal information" %}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="d-flex align-items-center p-3 border rounded">
                                    <i class="bi bi-bell fs-2 text-success me-3"></i>
                                    <div>
                                        <h6 class="mb-1">{% trans "Check Notifications" %}</h6>
                                        <p class="text-muted mb-0 small">{% trans "View your latest alerts" %}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}

            <!-- Recent Activity -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent border-0 pb-0">
                    <h5 class="card-title mb-0">{% trans "Recent Activity" %}</h5>
                </div>
                <div class="card-body">
                    {% with recent_logins=user.login_history.all|slice:":5" %}
                        {% if recent_logins %}
                            <div class="list-group list-group-flush">
                                {% for login in recent_logins %}
                                <div class="list-group-item px-0">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <i class="bi bi-{{ login.login_method }} text-{% if login.was_successful %}success{% else %}danger{% endif %} me-2"></i>
                                            <span class="fw-semibold">
                                                {{ login.get_login_method_display }}
                                            </span>
                                            <small class="text-muted ms-2">
                                                {{ login.ip_address }}
                                            </small>
                                        </div>
                                        <div class="text-end">
                                            <small class="text-muted">{{ login.created_at|timesince }} ago</small>
                                            <br>
                                            <span class="badge bg-{% if login.was_successful %}success{% else %}danger{% endif %}">
                                                {% if login.was_successful %}{% trans "Success" %}{% else %}{% trans "Failed" %}{% endif %}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <p class="text-muted text-center mb-0">{% trans "No recent activity found" %}</p>
                        {% endif %}
                    {% endwith %}
                </div>
            </div>
        </div>

        <!-- Right Column - Common Widgets -->
        <div class="col-lg-4">
            <!-- Quick Links -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-transparent border-0 pb-0">
                    <h5 class="card-title mb-0">{% trans "Quick Links" %}</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{% url 'users:profile' %}" class="btn btn-outline-primary text-start">
                            <i class="bi bi-person me-2"></i>
                            {% trans "My Profile" %}
                        </a>
                        <a href="{% url 'communication:notification_list' %}" class="btn btn-outline-success text-start">
                            <i class="bi bi-bell me-2"></i>
                            {% trans "Notifications" %}
                            {% with unread_count=user.notifications.unread.count %}
                                {% if unread_count > 0 %}
                                <span class="badge bg-danger float-end">{{ unread_count }}</span>
                                {% endif %}
                            {% endwith %}
                        </a>
                        {% if primary_role %}
                            {% if primary_role.role.role_type == 'parent' or primary_role.role.role_type == 'student' %}
                            <a href="{% url 'users:parent_student_relationships' %}" class="btn btn-outline-info text-start">
                                <i class="bi bi-people me-2"></i>
                                {% if primary_role.role.role_type == 'parent' %}
                                    {% trans "My Children" %}
                                {% else %}
                                    {% trans "My Parents" %}
                                {% endif %}
                            </a>
                            {% endif %}
                        {% endif %}
                        <a href="{% url 'users:password_change' %}" class="btn btn-outline-warning text-start">
                            <i class="bi bi-shield-lock me-2"></i>
                            {% trans "Change Password" %}
                        </a>
                    </div>
                </div>
            </div>

            <!-- System Announcements -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-transparent border-0 pb-0">
                    <h5 class="card-title mb-0">{% trans "Announcements" %}</h5>
                </div>
                <div class="card-body">
                    <div class="announcement-list">
                        <!-- Sample announcements - replace with dynamic content -->
                        <div class="announcement-item mb-3 pb-3 border-bottom">
                            <h6 class="fw-semibold mb-1">{% trans "System Maintenance" %}</h6>
                            <p class="text-muted small mb-1">{% trans "Scheduled maintenance this weekend. System may be unavailable for 2 hours." %}</p>
                            <small class="text-muted">{% trans "Posted 2 days ago" %}</small>
                        </div>
                        <div class="announcement-item">
                            <h6 class="fw-semibold mb-1">{% trans "Welcome to New School Year" %}</h6>
                            <p class="text-muted small mb-1">{% trans "We're excited to start the new academic year with you!" %}</p>
                            <small class="text-muted">{% trans "Posted 1 week ago" %}</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Upcoming Events -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent border-0 pb-0">
                    <h5 class="card-title mb-0">{% trans "Upcoming Events" %}</h5>
                </div>
                <div class="card-body">
                    <div class="event-list">
                        <!-- Sample events - replace with dynamic content -->
                        <div class="event-item mb-3 pb-3 border-bottom">
                            <div class="d-flex align-items-center">
                                <div class="event-date bg-primary text-white text-center rounded me-3" style="min-width: 50px;">
                                    <div class="fw-bold">15</div>
                                    <small>MAR</small>
                                </div>
                                <div>
                                    <h6 class="mb-1">{% trans "Parent-Teacher Meeting" %}</h6>
                                    <small class="text-muted">{% trans "10:00 AM - 12:00 PM" %}</small>
                                </div>
                            </div>
                        </div>
                        <div class="event-item">
                            <div class="d-flex align-items-center">
                                <div class="event-date bg-success text-white text-center rounded me-3" style="min-width: 50px;">
                                    <div class="fw-bold">20</div>
                                    <small>MAR</small>
                                </div>
                                <div>
                                    <h6 class="mb-1">{% trans "Sports Day" %}</h6>
                                    <small class="text-muted">{% trans "All Day" %}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.dashboard-page {
    background-color: #f8f9fa;
}

.welcome-card {
    background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
    border-radius: 1rem;
}

.avatar {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.avatar-sm {
    width: 40px;
    height: 40px;
    font-size: 1rem;
}

.stat-item {
    transition: transform 0.2s ease;
}

.stat-item:hover {
    transform: translateY(-2px);
}

.announcement-item:last-child,
.event-item:last-child {
    border-bottom: none !important;
    margin-bottom: 0 !important;
    padding-bottom: 0 !important;
}

.event-date {
    padding: 0.5rem;
}

/* Dark theme support */
[data-bs-theme="dark"] .dashboard-page {
    background-color: #212529;
}

[data-bs-theme="dark"] .card {
    background-color: #2d3338;
    border-color: #495057;
}

[data-bs-theme="dark"] .text-muted {
    color: #adb5bd !important;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .welcome-card .row {
        text-align: center;
    }
    
    .dashboard-stats-mini {
        margin-top: 1rem;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize any dashboard-specific JavaScript here
    
    // Auto-refresh notifications count
    function refreshNotifications() {
        // This would typically make an AJAX call to get updated counts
        console.log('Refreshing notification counts...');
    }
    
    // Refresh every 2 minutes
    setInterval(refreshNotifications, 120000);
    
    // Dashboard statistics animation
    const stats = document.querySelectorAll('.fw-bold');
    stats.forEach(stat => {
        if (stat.textContent.match(/^\d+$/)) {
            animateValue(stat, 0, parseInt(stat.textContent), 1000);
        }
    });
});

function animateValue(element, start, end, duration) {
    let startTimestamp = null;
    const step = (timestamp) => {
        if (!startTimestamp) startTimestamp = timestamp;
        const progress = Math.min((timestamp - startTimestamp) / duration, 1);
        element.innerHTML = Math.floor(progress * (end - start) + start);
        if (progress < 1) {
            window.requestAnimationFrame(step);
        }
    };
    window.requestAnimationFrame(step);
}

// Quick action handlers
function quickAction(action) {
    switch(action) {
        case 'profile':
            window.location.href = "{% url 'users:profile' %}";
            break;
        case 'notifications':
            window.location.href = "{% url 'communication:notification_list' %}";
            break;
        case 'password':
            window.location.href = "{% url 'users:password_change' %}";
            break;
        default:
            console.log('Quick action:', action);
    }
}
</script>
{% endblock %}
