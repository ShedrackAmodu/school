{% extends 'base/base.html' %}
{% load static i18n %}

{% block title %}{% trans "User Management" %} - {{ block.super }}{% endblock %}

{% block page_title %}{% trans "User Management" %}{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item active" aria-current="page">{% trans "Users" %}</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <!-- Quick Stats Cards -->
            <div class="row">
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card border-start border-primary border-4">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1">
                                    <h6 class="text-muted fw-normal mb-2">{% trans "Total Users" %}</h6>
                                    <h4 class="mb-0">{{ users.paginator.count }}</h4>
                                </div>
                                <div class="flex-shrink-0">
                                    <i class="bi bi-people-fill text-primary display-6"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card border-start border-success border-4">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1">
                                    <h6 class="text-muted fw-normal mb-2">{% trans "Active Users" %}</h6>
                                    <h4 class="mb-0">{{ active_users_count }}</h4>
                                </div>
                                <div class="flex-shrink-0">
                                    <i class="bi bi-person-check text-success display-6"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card border-start border-warning border-4">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1">
                                    <h6 class="text-muted fw-normal mb-2">{% trans "Unverified Users" %}</h6>
                                    <h4 class="mb-0">{{ unverified_users_count }}</h4>
                                </div>
                                <div class="flex-shrink-0">
                                    <i class="bi bi-person-x text-warning display-6"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card border-start border-info border-4">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1">
                                    <h6 class="text-muted fw-normal mb-2">{% trans "Staff Members" %}</h6>
                                    <h4 class="mb-0">{{ staff_users_count }}</h4>
                                </div>
                                <div class="flex-shrink-0">
                                    <i class="bi bi-person-gear text-info display-6"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-people-fill me-2"></i>
                        {% trans "Users" %}
                    </h5>
                    <div class="d-flex gap-2">
                        <!-- Bulk Actions Dropdown -->
                        <div class="dropdown">
                            <button class="btn btn-sm btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown" 
                                    id="bulkActionsButton" disabled>
                                <i class="bi bi-check-square me-1"></i>{% trans "Bulk Actions" %}
                            </button>
                            <ul class="dropdown-menu">
                                <li>
                                    <a class="dropdown-item" href="#" data-bulk-action="activate">
                                        <i class="bi bi-play-circle text-success me-2"></i>{% trans "Activate" %}
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="#" data-bulk-action="deactivate">
                                        <i class="bi bi-pause-circle text-warning me-2"></i>{% trans "Deactivate" %}
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a class="dropdown-item" href="#" data-bulk-action="assign_role">
                                        <i class="bi bi-person-gear text-primary me-2"></i>{% trans "Assign Role" %}
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a class="dropdown-item text-danger" href="#" data-bulk-action="delete">
                                        <i class="bi bi-trash me-2"></i>{% trans "Delete" %}
                                    </a>
                                </li>
                            </ul>
                        </div>
                        
                        <!-- Export Button -->
                        <button class="btn btn-sm btn-light" id="exportUsers">
                            <i class="bi bi-download me-1"></i>{% trans "Export" %}
                        </button>
                        
                        <!-- Bulk Import Button -->
                        <a href="{% url 'users:user_bulk_import' %}" class="btn btn-sm btn-info">
                            <i class="bi bi-cloud-upload me-1"></i>{% trans "Bulk Import" %}
                        </a>

                        <!-- Create User Button -->
                        <a href="{% url 'users:user_create' %}" class="btn btn-sm btn-success">
                            <i class="bi bi-person-plus me-1"></i>{% trans "Add User" %}
                        </a>
                    </div>
                </div>
                
                <div class="card-body">
                    <!-- Search and Filters -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="bi bi-search"></i>
                                </span>
                                <input type="text" class="form-control" id="searchInput" 
                                       placeholder="{% trans 'Search users...' %}" value="{{ request.GET.q|default:'' }}">
                                <button class="btn btn-outline-secondary" type="button" id="clearSearch">
                                    <i class="bi bi-x"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="row g-2">
                                <div class="col-md-4">
                                    <select class="form-select" id="statusFilter">
                                        <option value="">{% trans "All Status" %}</option>
                                        <option value="active" {% if request.GET.status == 'active' %}selected{% endif %}>{% trans "Active" %}</option>
                                        <option value="inactive" {% if request.GET.status == 'inactive' %}selected{% endif %}>{% trans "Inactive" %}</option>
                                        <option value="pending" {% if request.GET.status == 'pending' %}selected{% endif %}>{% trans "Pending" %}</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <select class="form-select" id="roleFilter">
                                        <option value="">{% trans "All Roles" %}</option>
                                        {% for role in roles %}
                                            <option value="{{ role.role_type }}" {% if request.GET.role == role.role_type %}selected{% endif %}>
                                                {{ role.name }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <select class="form-select" id="verifiedFilter">
                                        <option value="">{% trans "All Verification" %}</option>
                                        <option value="verified" {% if request.GET.verified == 'verified' %}selected{% endif %}>{% trans "Verified" %}</option>
                                        <option value="unverified" {% if request.GET.verified == 'unverified' %}selected{% endif %}>{% trans "Unverified" %}</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Users Table -->
                    <div class="table-responsive">
                        <table class="table table-hover table-striped" id="usersTable">
                            <thead class="table-light">
                                <tr>
                                    <th width="40">
                                        <input type="checkbox" class="form-check-input" id="selectAll">
                                    </th>
                                    <th>{% trans "User" %}</th>
                                    <th>{% trans "Roles" %}</th>
                                    <th>{% trans "Status" %}</th>
                                    <th>{% trans "Last Login" %}</th>
                                    <th>{% trans "Created" %}</th>
                                    <th width="120">{% trans "Actions" %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in users %}
                                <tr data-user-id="{{ user.id }}" class="{% if not user.is_active %}table-secondary{% endif %}">
                                    <td>
                                        <input type="checkbox" class="form-check-input user-checkbox" value="{{ user.id }}">
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="flex-shrink-0 me-3">
                                                {% if user.profile.profile_picture %}
                                                    <img src="{{ user.profile.profile_picture.url }}" 
                                                         alt="{{ user.display_name }}" 
                                                         class="rounded-circle" 
                                                         style="width: 40px; height: 40px; object-fit: cover;">
                                                {% else %}
                                                    <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center" 
                                                         style="width: 40px; height: 40px;">
                                                        <span class="text-white small">{{ user.get_initials }}</span>
                                                    </div>
                                                {% endif %}
                                            </div>
                                            <div class="flex-grow-1">
                                                <h6 class="mb-1">
                                                    <a href="{% url 'users:user_detail' user.id %}" class="text-decoration-none">
                                                        {{ user.display_name }}
                                                    </a>
                                                    {% if user.is_superuser %}
                                                        <i class="bi bi-shield-shaded text-danger ms-1" title="{% trans 'Superuser' %}"></i>
                                                    {% elif user.is_staff %}
                                                        <i class="bi bi-person-gear text-info ms-1" title="{% trans 'Staff' %}"></i>
                                                    {% endif %}
                                                </h6>
                                                <p class="text-muted mb-0 small">{{ user.email }}</p>
                                                {% if user.mobile %}
                                                    <p class="text-muted mb-0 small">{{ user.mobile }}</p>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="d-flex flex-wrap gap-1">
                                            {% for user_role in user.user_roles.all|slice:":3" %}
                                                <span class="badge bg-primary small">
                                                    {{ user_role.role.name }}
                                                    {% if user_role.is_primary %}
                                                        <i class="bi bi-star-fill ms-1" title="{% trans 'Primary Role' %}"></i>
                                                    {% endif %}
                                                </span>
                                            {% empty %}
                                                <span class="text-muted small">{% trans "No roles" %}</span>
                                            {% endfor %}
                                            {% if user.user_roles.count > 3 %}
                                                <span class="badge bg-secondary small">
                                                    +{{ user.user_roles.count|add:"-3" }}
                                                </span>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="d-flex flex-column">
                                            <span class="badge bg-{% if user.status == 'active' %}success{% elif user.status == 'inactive' %}danger{% else %}warning{% endif %} mb-1">
                                                {{ user.get_status_display }}
                                            </span>
                                            {% if not user.is_verified %}
                                                <span class="badge bg-warning small">
                                                    <i class="bi bi-clock me-1"></i>{% trans "Unverified" %}
                                                </span>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        {% if user.last_login %}
                                            <span class="text-muted small" title="{{ user.last_login|date:'DATETIME_FORMAT' }}">
                                                {{ user.last_login|timesince }} {% trans "ago" %}
                                            </span>
                                        {% else %}
                                            <span class="text-muted small">{% trans "Never" %}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="text-muted small" title="{{ user.created_at|date:'DATETIME_FORMAT' }}">
                                            {{ user.created_at|date:"SHORT_DATE_FORMAT" }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <a href="{% url 'users:user_detail' user.id %}" 
                                               class="btn btn-outline-primary" 
                                               title="{% trans 'View Details' %}">
                                                <i class="bi bi-eye"></i>
                                            </a>
                                            {% if can_edit %}
                                            <a href="{% url 'users:user_update' user.id %}" 
                                               class="btn btn-outline-secondary" 
                                               title="{% trans 'Edit User' %}">
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                            <button type="button" 
                                                    class="btn btn-outline-{% if user.is_active %}warning{% else %}success{% endif %}" 
                                                    title="{% if user.is_active %}{% trans 'Deactivate User' %}{% else %}{% trans 'Activate User' %}{% endif %}"
                                                    onclick="toggleUserStatus('{{ user.id }}', '{{ user.display_name }}', {{ user.is_active|yesno:"true,false" }})">
                                                <i class="bi bi-{% if user.is_active %}pause{% else %}play{% endif %}-circle"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="7" class="text-center py-4">
                                        <div class="text-muted">
                                            <i class="bi bi-people display-4 d-block mb-2"></i>
                                            <h5>{% trans "No users found" %}</h5>
                                            <p>{% trans "Try adjusting your search or filters to find what you're looking for." %}</p>
                                            <a href="{% url 'users:user_create' %}" class="btn btn-primary">
                                                <i class="bi bi-person-plus me-1"></i>{% trans "Add First User" %}
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    {% if users.paginator.num_pages > 1 %}
                    <div class="d-flex justify-content-between align-items-center mt-4">
                        <div class="text-muted">
                            {% blocktrans with start=users.start_index end=users.end_index total=users.paginator.count %}
                                Showing {{ start }} to {{ end }} of {{ total }} entries
                            {% endblocktrans %}
                        </div>
                        <nav>
                            <ul class="pagination mb-0">
                                {% if users.has_previous %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                            <i class="bi bi-chevron-double-left"></i>
                                        </a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ users.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                            <i class="bi bi-chevron-left"></i>
                                        </a>
                                    </li>
                                {% endif %}

                                {% for num in users.paginator.page_range %}
                                    {% if users.number == num %}
                                        <li class="page-item active">
                                            <span class="page-link">{{ num }}</span>
                                        </li>
                                    {% elif num > users.number|add:'-3' and num < users.number|add:'3' %}
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                                {{ num }}
                                            </a>
                                        </li>
                                    {% endif %}
                                {% endfor %}

                                {% if users.has_next %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ users.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                            <i class="bi bi-chevron-right"></i>
                                        </a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ users.paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                            <i class="bi bi-chevron-double-right"></i>
                                        </a>
                                    </li>
                                {% endif %}
                            </ul>
                        </nav>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Action Confirmation Modal -->
<div class="modal fade" id="bulkActionModal" tabindex="-1" aria-labelledby="bulkActionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bulkActionModalLabel">{% trans "Confirm Bulk Action" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="bulkActionText"></p>
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>{% trans "Warning:" %}</strong> {% trans "This action will affect" %} <span id="selectedCount" class="fw-bold">0</span> {% trans "users." %}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
                <button type="button" class="btn btn-primary" id="confirmBulkAction">{% trans "Confirm" %}</button>
            </div>
        </div>
    </div>
</div>

<!-- Export Modal -->
<div class="modal fade" id="exportModal" tabindex="-1" aria-labelledby="exportModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exportModalLabel">{% trans "Export Users" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            {% comment %} <form method="get" action="{% url 'users:user_export' %}"> {% endcomment %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">{% trans "Export Format" %}</label>
                        <select class="form-select" name="format">
                            <option value="csv">CSV</option>
                            <option value="excel">Excel</option>
                            <option value="json">JSON</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">{% trans "Fields to Include" %}</label>
                        <div class="border rounded p-3">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input export-field" type="checkbox" name="fields" value="email" checked>
                                        <label class="form-check-label">{% trans "Email" %}</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input export-field" type="checkbox" name="fields" value="first_name" checked>
                                        <label class="form-check-label">{% trans "First Name" %}</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input export-field" type="checkbox" name="fields" value="last_name" checked>
                                        <label class="form-check-label">{% trans "Last Name" %}</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input export-field" type="checkbox" name="fields" value="mobile">
                                        <label class="form-check-label">{% trans "Mobile" %}</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input export-field" type="checkbox" name="fields" value="status">
                                        <label class="form-check-label">{% trans "Status" %}</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input export-field" type="checkbox" name="fields" value="is_active">
                                        <label class="form-check-label">{% trans "Active" %}</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input export-field" type="checkbox" name="fields" value="last_login">
                                        <label class="form-check-label">{% trans "Last Login" %}</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input export-field" type="checkbox" name="fields" value="created_at">
                                        <label class="form-check-label">{% trans "Created Date" %}</label>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-2">
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="selectAllFields">
                                    <i class="bi bi-check-all me-1"></i>{% trans "Select All" %}
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="deselectAllFields">
                                    <i class="bi bi-x-circle me-1"></i>{% trans "Deselect All" %}
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="include_inactive" id="includeInactive">
                        <label class="form-check-label" for="includeInactive">
                            {% trans "Include inactive users" %}
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
                    <button type="submit" class="btn btn-primary">{% trans "Export" %}</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .table th {
        border-top: none;
        font-weight: 600;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .user-avatar {
        width: 40px;
        height: 40px;
        object-fit: cover;
    }
    
    .initials-avatar {
        width: 40px;
        height: 40px;
        font-size: 0.875rem;
    }
    
    .stats-card {
        transition: transform 0.2s ease;
    }
    
    .stats-card:hover {
        transform: translateY(-2px);
    }
    
    .table-hover tbody tr:hover {
        background-color: rgba(101, 160, 249, 0.05);
    }
    
    .badge {
        font-size: 0.75rem;
    }
    
    .pagination .page-link {
        color: #65a0f9;
    }
    
    .pagination .page-item.active .page-link {
        background-color: #65a0f9;
        border-color: #65a0f9;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const selectAllCheckbox = document.getElementById('selectAll');
        const userCheckboxes = document.querySelectorAll('.user-checkbox');
        const bulkActionsButton = document.getElementById('bulkActionsButton');
        const bulkActionModal = new bootstrap.Modal(document.getElementById('bulkActionModal'));
        const exportModal = new bootstrap.Modal(document.getElementById('exportModal'));
        const searchInput = document.getElementById('searchInput');
        const clearSearch = document.getElementById('clearSearch');
        const statusFilter = document.getElementById('statusFilter');
        const roleFilter = document.getElementById('roleFilter');
        const verifiedFilter = document.getElementById('verifiedFilter');
        const exportUsersButton = document.getElementById('exportUsers');
        let currentBulkAction = '';
        
        // Select All functionality
        selectAllCheckbox.addEventListener('change', function() {
            userCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateBulkActionsButton();
        });
        
        // Individual checkbox handlers
        userCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                updateBulkActionsButton();
                updateSelectAllCheckbox();
            });
        });
        
        // Bulk action handlers
        document.querySelectorAll('[data-bulk-action]').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const action = this.getAttribute('data-bulk-action');
                showBulkActionConfirmation(action);
            });
        });
        
        // Export button handler
        exportUsersButton.addEventListener('click', function() {
            exportModal.show();
        });
        
        // Search and filter handlers
        searchInput.addEventListener('input', debounce(applyFilters, 300));
        clearSearch.addEventListener('click', function() {
            searchInput.value = '';
            applyFilters();
        });
        statusFilter.addEventListener('change', applyFilters);
        roleFilter.addEventListener('change', applyFilters);
        verifiedFilter.addEventListener('change', applyFilters);
        
        // Export field selection handlers
        document.getElementById('selectAllFields')?.addEventListener('click', selectAllExportFields);
        document.getElementById('deselectAllFields')?.addEventListener('click', deselectAllExportFields);
        
        function updateBulkActionsButton() {
            const selectedCount = getSelectedUserIds().length;
            bulkActionsButton.disabled = selectedCount === 0;
            bulkActionsButton.textContent = `${selectedCount} ${selectedCount === 1 ? '{% trans "user selected" %}' : '{% trans "users selected" %}'}`;
        }
        
        function updateSelectAllCheckbox() {
            const selectedCount = getSelectedUserIds().length;
            const totalCount = userCheckboxes.length;
            selectAllCheckbox.checked = selectedCount === totalCount;
            selectAllCheckbox.indeterminate = selectedCount > 0 && selectedCount < totalCount;
        }
        
        function getSelectedUserIds() {
            return Array.from(userCheckboxes)
                .filter(checkbox => checkbox.checked)
                .map(checkbox => checkbox.value);
        }
        
        function showBulkActionConfirmation(action) {
            const selectedCount = getSelectedUserIds().length;
            currentBulkAction = action;
            
            let actionText = '';
            switch (action) {
                case 'activate':
                    actionText = '{% trans "Are you sure you want to activate the selected users?" %}';
                    break;
                case 'deactivate':
                    actionText = '{% trans "Are you sure you want to deactivate the selected users?" %}';
                    break;
                case 'assign_role':
                    actionText = '{% trans "Are you sure you want to assign a role to the selected users?" %}';
                    break;
                case 'delete':
                    actionText = '{% trans "Are you sure you want to delete the selected users? This action cannot be undone." %}';
                    break;
            }
            
            document.getElementById('bulkActionText').textContent = actionText;
            document.getElementById('selectedCount').textContent = selectedCount;
            bulkActionModal.show();
        }
        
        // Confirm bulk action
        document.getElementById('confirmBulkAction').addEventListener('click', function() {
            const selectedUserIds = getSelectedUserIds();
            
            if (selectedUserIds.length === 0) {
                showToast('{% trans "Error" %}', '{% trans "No users selected." %}', 'danger');
                return;
            }
            
            // Prepare form data
            const formData = new FormData();
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
            selectedUserIds.forEach(id => {
                formData.append('users', id);
            });
            formData.append('action', currentBulkAction);
            
            // Show loading state
            const confirmButton = this;
            const originalText = confirmButton.innerHTML;
            confirmButton.innerHTML = '<i class="bi bi-arrow-repeat spinner"></i> {% trans "Processing..." %}';
            confirmButton.disabled = true;
            
            // Send bulk action request
            fetch('{% url "users:user_bulk_action" %}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('{% trans "Success" %}', data.message, 'success');
                    // Reload the page to reflect changes
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    showToast('{% trans "Error" %}', data.message, 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('{% trans "Error" %}', '{% trans "An error occurred while processing the request." %}', 'danger');
            })
            .finally(() => {
                confirmButton.innerHTML = originalText;
                confirmButton.disabled = false;
                bulkActionModal.hide();
            });
        });
        
        function applyFilters() {
            const params = new URLSearchParams();
            
            if (searchInput.value) {
                params.append('q', searchInput.value);
            }
            
            if (statusFilter.value) {
                params.append('status', statusFilter.value);
            }
            
            if (roleFilter.value) {
                params.append('role', roleFilter.value);
            }
            
            if (verifiedFilter.value) {
                params.append('verified', verifiedFilter.value);
            }
            
            window.location.href = '?' + params.toString();
        }
        
        function selectAllExportFields() {
            document.querySelectorAll('.export-field').forEach(field => {
                field.checked = true;
            });
        }
        
        function deselectAllExportFields() {
            document.querySelectorAll('.export-field').forEach(field => {
                field.checked = false;
            });
        }
        
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        function showToast(title, message, type) {
            // Toast implementation (same as previous templates)
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type} border-0`;
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        <strong>${title}</strong>: ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            
            const toastContainer = document.getElementById('toastContainer') || createToastContainer();
            toastContainer.appendChild(toast);
            
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
        }
        
        function createToastContainer() {
            const container = document.createElement('div');
            container.id = 'toastContainer';
            container.className = 'toast-container position-fixed top-0 end-0 p-3';
            container.style.zIndex = '9999';
            document.body.appendChild(container);
            return container;
        }
        
        // Initialize bulk actions button state
        updateBulkActionsButton();
    });
    
    function toggleUserStatus(userId, userName, isActive) {
        const action = isActive ? 'deactivate' : 'activate';
        const actionText = isActive ? '{% trans "deactivate" %}' : '{% trans "activate" %}';
        
        if (confirm(`{% trans "Are you sure you want to" %} ${actionText} {% trans "the user" %} "${userName}"?`)) {
            window.location.href = `{% url 'users:user_toggle_status' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', userId);
        }
    }
</script>

<!-- Toast Container -->
<div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="toastContainer"></div>
</div>
{% endblock %}
