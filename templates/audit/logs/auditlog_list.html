<!-- templates/audit/logs/auditlog_list.html -->
{% extends 'base/base.html' %}
{% load static i18n %}

{% block title %}{% trans "Audit Logs" %}{% endblock %}

{% block page_title %}{% trans "Audit Logs" %}{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'users:dashboard' %}">{% trans "Home" %}</a></li>
<li class="breadcrumb-item"><a href="{% url 'audit:auditlog_dashboard' %}">{% trans "Audit" %}</a></li>
<li class="breadcrumb-item active" aria-current="page">{% trans "Audit Logs" %}</li>
{% endblock %}

{% block extra_css %}
<style>
    .audit-log-table {
        font-size: 0.875rem;
    }
    
    .action-badge {
        font-size: 0.75rem;
    }
    
    .user-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        object-fit: cover;
    }
    
    .filter-card {
        background-color: var(--bs-light);
        border: 1px solid var(--bs-border-color);
    }
    
    .log-details {
        max-height: 100px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 0.8rem;
        background-color: var(--bs-light);
        padding: 0.5rem;
        border-radius: 0.25rem;
    }
    
    .timestamp-cell {
        white-space: nowrap;
    }
    
    .object-link {
        font-family: monospace;
        font-size: 0.8rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- Stats Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 class="mb-0">{{ total_logs }}</h4>
                                <p class="mb-0">{% trans "Total Logs" %}</p>
                            </div>
                            <div class="align-self-center">
                                <i class="bi bi-journal-text fs-1"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 class="mb-0">{{ today_logs }}</h4>
                                <p class="mb-0">{% trans "Today's Logs" %}</p>
                            </div>
                            <div class="align-self-center">
                                <i class="bi bi-calendar-day fs-1"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 class="mb-0">{{ action_types|length }}</h4>
                                <p class="mb-0">{% trans "Action Types" %}</p>
                            </div>
                            <div class="align-self-center">
                                <i class="bi bi-activity fs-1"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-dark">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 class="mb-0">{{ model_names|length }}</h4>
                                <p class="mb-0">{% trans "Models Tracked" %}</p>
                            </div>
                            <div class="align-self-center">
                                <i class="bi bi-table fs-1"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters Card -->
        <div class="card filter-card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-funnel me-2"></i>{% trans "Filters" %}
                </h5>
            </div>
            <div class="card-body">
                <form method="get" id="audit-filter-form">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="action" class="form-label">{% trans "Action Type" %}</label>
                            <select class="form-select" id="action" name="action">
                                <option value="all">{% trans "All Actions" %}</option>
                                {% for action_value, action_label in action_types %}
                                <option value="{{ action_value }}" 
                                    {% if current_filters.action == action_value %}selected{% endif %}>
                                    {{ action_label }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="model_name" class="form-label">{% trans "Model" %}</label>
                            <select class="form-select" id="model_name" name="model_name">
                                <option value="all">{% trans "All Models" %}</option>
                                {% for model in model_names %}
                                <option value="{{ model }}" 
                                    {% if current_filters.model_name == model %}selected{% endif %}>
                                    {{ model }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="date_from" class="form-label">{% trans "From Date" %}</label>
                            <input type="date" class="form-control" id="date_from" name="date_from" 
                                   value="{{ current_filters.date_from }}">
                        </div>
                        <div class="col-md-3">
                            <label for="date_to" class="form-label">{% trans "To Date" %}</label>
                            <input type="date" class="form-control" id="date_to" name="date_to" 
                                   value="{{ current_filters.date_to }}">
                        </div>
                        <div class="col-md-6">
                            <label for="search" class="form-label">{% trans "Search" %}</label>
                            <input type="text" class="form-control" id="search" name="search" 
                                   placeholder="{% trans 'Search by user, model, object ID...' %}" 
                                   value="{{ current_filters.search }}">
                        </div>
                        <div class="col-md-6 d-flex align-items-end">
                            <div class="btn-group w-100" role="group">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-search me-2"></i>{% trans "Apply Filters" %}
                                </button>
                                <a href="{% url 'audit:auditlog_list' %}" class="btn btn-outline-secondary">
                                    <i class="bi bi-arrow-clockwise me-2"></i>{% trans "Reset" %}
                                </a>
                                <a href="{% url 'audit:auditlog_export' %}?{{ request.GET.urlencode }}" 
                                   class="btn btn-success">
                                    <i class="bi bi-download me-2"></i>{% trans "Export" %}
                                </a>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Audit Logs Table -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-list-check me-2"></i>{% trans "Audit Logs" %}
                </h5>
                <div class="d-flex align-items-center">
                    <span class="text-muted me-3">
                        {% blocktrans with count=page_obj.paginator.count %}Showing {{ count }} records{% endblocktrans %}
                    </span>
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" 
                                data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-gear me-2"></i>{% trans "Options" %}
                        </button>
                        <ul class="dropdown-menu">
                            <li>
                                <a class="dropdown-item" href="{% url 'audit:auditlog_dashboard' %}">
                                    <i class="bi bi-speedometer2 me-2"></i>{% trans "Dashboard" %}
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{% url 'audit:auditlog_statistics' %}">
                                    <i class="bi bi-bar-chart me-2"></i>{% trans "Statistics" %}
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item" href="{% url 'audit:auditlog_export' %}?{{ request.GET.urlencode }}&format=csv">
                                    <i class="bi bi-file-earmark-spreadsheet me-2"></i>{% trans "Export as CSV" %}
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{% url 'audit:auditlog_export' %}?{{ request.GET.urlencode }}&format=json">
                                    <i class="bi bi-file-code me-2"></i>{% trans "Export as JSON" %}
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover audit-log-table mb-0">
                        <thead class="table-light">
                            <tr>
                                <th scope="col">{% trans "Timestamp" %}</th>
                                <th scope="col">{% trans "User" %}</th>
                                <th scope="col">{% trans "Action" %}</th>
                                <th scope="col">{% trans "Model" %}</th>
                                <th scope="col">{% trans "Object ID" %}</th>
                                <th scope="col">{% trans "IP Address" %}</th>
                                <th scope="col" class="text-center">{% trans "Details" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for log in audit_logs %}
                            <tr>
                                <td class="timestamp-cell">
                                    <small class="text-muted">{{ log.timestamp|date:"Y-m-d H:i" }}</small>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        {% if log.user %}
                                        <div class="me-2">
                                            {% if log.user.profile.avatar %}
                                            <img src="{{ log.user.profile.avatar.url }}" alt="{{ log.user.get_full_name }}" 
                                                 class="user-avatar">
                                            {% else %}
                                            <div class="user-avatar bg-secondary d-flex align-items-center justify-content-center text-white">
                                                <i class="bi bi-person"></i>
                                            </div>
                                            {% endif %}
                                        </div>
                                        <div>
                                            <div class="fw-medium">{{ log.user.get_full_name|default:log.user.email }}</div>
                                            <small class="text-muted">{{ log.user.email }}</small>
                                        </div>
                                        {% else %}
                                        <div class="text-muted fst-italic">{% trans "System" %}</div>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    {% if log.action == 'create' %}
                                    <span class="badge bg-success action-badge">
                                        <i class="bi bi-plus-circle me-1"></i>{{ log.get_action_display }}
                                    </span>
                                    {% elif log.action == 'update' %}
                                    <span class="badge bg-primary action-badge">
                                        <i class="bi bi-pencil-square me-1"></i>{{ log.get_action_display }}
                                    </span>
                                    {% elif log.action == 'delete' %}
                                    <span class="badge bg-danger action-badge">
                                        <i class="bi bi-trash me-1"></i>{{ log.get_action_display }}
                                    </span>
                                    {% elif log.action == 'login' %}
                                    <span class="badge bg-info action-badge">
                                        <i class="bi bi-box-arrow-in-right me-1"></i>{{ log.get_action_display }}
                                    </span>
                                    {% elif log.action == 'logout' %}
                                    <span class="badge bg-secondary action-badge">
                                        <i class="bi bi-box-arrow-left me-1"></i>{{ log.get_action_display }}
                                    </span>
                                    {% else %}
                                    <span class="badge bg-warning text-dark action-badge">
                                        <i class="bi bi-eye me-1"></i>{{ log.get_action_display }}
                                    </span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="fw-medium">{{ log.model_name }}</span>
                                </td>
                                <td>
                                    <code class="object-link">{{ log.object_id|truncatechars:20 }}</code>
                                </td>
                                <td>
                                    {% if log.ip_address %}
                                    <small class="text-muted">{{ log.ip_address }}</small>
                                    {% else %}
                                    <span class="text-muted fst-italic">{% trans "N/A" %}</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <button type="button" class="btn btn-sm btn-outline-primary" 
                                            data-bs-toggle="modal" data-bs-target="#detailsModal{{ log.id }}">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </td>
                            </tr>
                            
                            <!-- Details Modal -->
                            <div class="modal fade" id="detailsModal{{ log.id }}" tabindex="-1" 
                                 aria-labelledby="detailsModalLabel{{ log.id }}" aria-hidden="true">
                                <div class="modal-dialog modal-lg">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="detailsModalLabel{{ log.id }}">
                                                {% trans "Audit Log Details" %}
                                            </h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <strong>{% trans "Timestamp:" %}</strong> 
                                                    {{ log.timestamp|date:"Y-m-d H:i:s" }}
                                                </div>
                                                <div class="col-md-6">
                                                    <strong>{% trans "Action:" %}</strong> 
                                                    {{ log.get_action_display }}
                                                </div>
                                            </div>
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <strong>{% trans "User:" %}</strong> 
                                                    {% if log.user %}
                                                    {{ log.user.get_full_name|default:log.user.email }}
                                                    {% else %}
                                                    {% trans "System" %}
                                                    {% endif %}
                                                </div>
                                                <div class="col-md-6">
                                                    <strong>{% trans "IP Address:" %}</strong> 
                                                    {{ log.ip_address|default:"N/A" }}
                                                </div>
                                            </div>
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <strong>{% trans "Model:" %}</strong> 
                                                    {{ log.model_name }}
                                                </div>
                                                <div class="col-md-6">
                                                    <strong>{% trans "Object ID:" %}</strong> 
                                                    {{ log.object_id }}
                                                </div>
                                            </div>
                                            {% if log.user_agent %}
                                            <div class="row mb-3">
                                                <div class="col-12">
                                                    <strong>{% trans "User Agent:" %}</strong>
                                                    <div class="log-details mt-1">{{ log.user_agent }}</div>
                                                </div>
                                            </div>
                                            {% endif %}
                                            {% if log.details %}
                                            <div class="row">
                                                <div class="col-12">
                                                    <strong>{% trans "Details:" %}</strong>
                                                    <div class="log-details mt-1">
                                                        <pre>{{ log.details|pprint }}</pre>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endif %}
                                        </div>
                                        <div class="modal-footer">
                                            <a href="{% url 'audit:auditlog_detail' log.id %}" 
                                               class="btn btn-primary">
                                                <i class="bi bi-info-circle me-2"></i>{% trans "View Full Details" %}
                                            </a>
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                                {% trans "Close" %}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% empty %}
                            <tr>
                                <td colspan="7" class="text-center py-4">
                                    <div class="text-muted">
                                        <i class="bi bi-inbox display-4 d-block mb-2"></i>
                                        <h5>{% trans "No audit logs found" %}</h5>
                                        <p class="mb-0">{% trans "Try adjusting your filters or check back later." %}</p>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Pagination -->
            {% if is_paginated %}
            <div class="card-footer">
                <nav aria-label="Audit log pagination">
                    <ul class="pagination justify-content-center mb-0">
                        {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                {% trans "First" %}
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                {% trans "Previous" %}
                            </a>
                        </li>
                        {% endif %}
                        
                        {% for num in page_obj.paginator.page_range %}
                            {% if page_obj.number == num %}
                            <li class="page-item active">
                                <span class="page-link">{{ num }}</span>
                            </li>
                            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                    {{ num }}
                                </a>
                            </li>
                            {% endif %}
                        {% endfor %}
                        
                        {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                {% trans "Next" %}
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                {% trans "Last" %}
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                    <div class="text-center mt-2">
                        <small class="text-muted">
                            {% blocktrans with number=page_obj.number num_pages=page_obj.paginator.num_pages %}
                            Page {{ number }} of {{ num_pages }}
                            {% endblocktrans %}
                        </small>
                    </div>
                </nav>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Auto-submit form when certain filters change
        const autoSubmitElements = document.querySelectorAll('#action, #model_name');
        autoSubmitElements.forEach(element => {
            element.addEventListener('change', function() {
                document.getElementById('audit-filter-form').submit();
            });
        });
        
        // Format timestamps with relative time
        const timestampCells = document.querySelectorAll('.timestamp-cell');
        timestampCells.forEach(cell => {
            const timestamp = cell.querySelector('small').textContent;
            // You could add relative time formatting here if desired
            // Example: "2 hours ago", "Yesterday", etc.
        });
        
        // Initialize tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    });
</script>
{% endblock %}